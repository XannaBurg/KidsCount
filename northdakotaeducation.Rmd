---
title: "North Dakota Education"
author: "Xanna Burg"
date: "June 2020"
output: html_document
---

## Indicator 1: Eligible recipients of free or reduced-price lunch
## Indicator 2: Students who are homeless
## Indicator 3: Children ages 3 to 21 enrolled in special education in public schools
## Indicator 4: Children enrolled in special education in public schools by age (percent of special education enrollment)
## Indicator 5: Children enrolled in special education in public schools, by type of impairment (percent of special education enrollment)
## Indicator 6: Average daily membership of public schools
## Indicator 7: Average expenditures per student in public schools
## Indicator 8: Four-year high school cohort graduation rate
## Indicator 9: Grades 7 to 12 event drop-out rate


**Created by:** Xanna Burg
**Date:** June 2020
**Updated by:**

**Data Source:** North Dakota Department of Public Instruction
**Purpose:** Import DPI data, clean data, and output dataset to upload to KIDS COUNT Data Center.

**Data format:** Final output csv to upload is in long format with the following variables: Location (character: name of location), TimeFrame (text: years), Category (character), Data (numeric: number, percentage), DataFormat (character: "number" or "percent"), LocationId (numeric: assigned for KIDS COUNT system)


**To use this code for a new year:**
* Update the year in the second code chunk for variable 'year'
* Manually enter the statewide data (from PDF)
* Check each dataset visually and through the report logs prior to commiting to the database.


```{r,message=FALSE}
#load required packages
library(tidyverse)
library(RPostgreSQL)
library(readxl)
library(naniar)
library(stringr)
```

```{r}
####UPDATE to reflect the current year data working with
year <- '19-20'
fullyear <- '2019/20' 
#fiscal year is the spring of reference school year
fiscalyear <- '2020'


statefile <- 'northdakota'
statename <- 'North Dakota'

#input location ID file for ND
locationids <- read.csv("./Input/ND KC Location IDs.csv")
locationids$Location <- as.character(locationids$Location)

#input region ID file for ND
regionids <- read.csv("./Input/ND KC Region List.csv")
regionids$county <- as.character(regionids$county)

#import the lookup table for county name
countyids <- read.csv("./Documentation/Indicator Documentation/North Dakota Data Requests/ND County Codes.csv")

#input the lookup table for schools on reservations
tribalschools <- read.csv("./Documentation/Indicator Documentation/North Dakota Data Requests/ND schools on reservations.csv",colClasses=c(id_nodash="character"))
tribalschools$schoolname <- as.character(tribalschools$schoolname)
tribalschools$id_dash <- as.character(paste((tribalschools$id_dash)))

```


## ################################################## ##
## ELIGIBLE RECIPIENTS OF FREE OR REDUCED PRICE LUNCH ##
## ################################################## ##

# STEP 1: IMPORT AND CLEAN DATA
```{r}
#import data
frl_data <- read_excel(path=paste0("/Users/xannaburg/Desktop/ND Education/Enrollment_inclusive_",year,".xlsx"),guess_max = 1048576)


############
#COUNTY DATA
frl_county <- frl_data %>%
  
  #import county name
  left_join(countyids,by=c("County"="ndcounty_number")) %>%

  #change FRL into indicator variable
  rename(lunchstatus='Lunch Status') %>%
  mutate(frl_indicator=case_when(
    lunchstatus == 'Not Eligible' ~ 0,
    lunchstatus == 'F/R Lunch' ~ 1)) %>%
  
  #create an indicator variable for counting total population
  mutate(enroll_indicator=case_when(
    !is.na(GradeName) ~ 1)) %>%
  
  #remove nonpublic schools (district ID >200) and students not enrolled in a school
  separate(SchoolStateIssuedID,c('county','district','school'),sep="-") %>%
  mutate(district=as.numeric(paste(district))) %>%
  subset(district<200) %>%
  subset(!is.na(school)) %>%
  
  #remove non counties
  subset(!is.na(ndcounty_name)) %>%

  #sum by county
  group_by(ndcounty_name) %>%
  summarise(frl_number=sum(frl_indicator),
            totalenroll=sum(enroll_indicator)) %>%
  ungroup %>%
  
  #create percent
  mutate(frl_percent=frl_number/totalenroll) %>%
  
  #add in locationtype
  rename(location=ndcounty_name) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='County')

###########
#STATE DATA
#start with  cleaned county data
frl_state <- frl_county %>%
  mutate(location='North Dakota') %>%
  group_by(location) %>%
  summarise(frl_number=sum(frl_number),
      totalenroll=sum(totalenroll)) %>%
  ungroup %>%
  #create percent
  mutate(frl_percent=frl_number/totalenroll) %>%

  #add in locationtype
  mutate(locationtype='State')

############
#REGION DATA
#start with cleaned county data
frl_region <- frl_county %>%
  
  #add in regions
  mutate(location=as.character(paste(location))) %>%
  left_join(regionids,by=c('location'='county')) %>%
  group_by(region) %>%
  summarise(frl_number=sum(frl_number),
      totalenroll=sum(totalenroll)) %>%
  ungroup %>%
  #create percent
  mutate(frl_percent=frl_number/totalenroll) %>%
  
  #add in locationtype
  rename(location=region) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='Planning Region')


#################
#TRIBAL AREA DATA
frl_tribal <- frl_data %>%
  
  #import tribal name
  left_join(tribalschools,by=c('SchoolStateIssuedID'='id_dash')) %>%
  subset(!is.na(tribalarea)) %>%
  
  #remove students not assigned to a school
  separate(SchoolStateIssuedID,c('county','district','school'),sep="-") %>%
  subset(!is.na(school)) %>%
  
  #change FRL into indicator variable
  rename(lunchstatus='Lunch Status') %>%
  mutate(frl_indicator=case_when(
    lunchstatus == 'Not Eligible' ~ 0,
    lunchstatus == 'F/R Lunch' ~ 1)) %>%
  
  #create an indicator variable for counting total population
  mutate(enroll_indicator=case_when(
    !is.na(GradeName) ~ 1)) %>%

  #sum by tribal area
  group_by(tribalarea) %>%
  summarise(frl_number=sum(frl_indicator),
            totalenroll=sum(enroll_indicator)) %>%
  ungroup %>%
  
  #create percent
  mutate(frl_percent=frl_number/totalenroll) %>%
  
  #add in locationtype
  rename(location=tribalarea) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='Tribal Area')
  
  
######################## 
#combine all geographies
frl_all <- frl_county %>%
  bind_rows(frl_state) %>%
  bind_rows(frl_region) %>%
  bind_rows(frl_tribal) %>%
  
  mutate(state='North Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(varname='freereducedlunch') %>%
  
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) %>%
  
  #create indicators to suppress data

  #supress if denominator is less than 10
  mutate(suppress_denominator=if_else(totalenroll<10 | is.na(totalenroll),1,0)) %>%
 
  #suppress percentages of 0-1 if more than 300 in denominator
  mutate(suppress_0to1_300=if_else(totalenroll>300 & frl_percent<=.01,1,0)) %>%
  #suppress percentages of 99-100 if more than 300 in denominator
  mutate(suppress_99to100_300=if_else(totalenroll>300 & frl_percent>=.99,1,0)) %>%

  
  #suppress percentages of 0-2 if between 101 to 300 in denominator
  mutate(suppress_0to2_101=if_else((totalenroll>100 & totalenroll<=300) & 
                                     frl_percent<=0.02,1,0)) %>%
  #suppress percentages of 98-100 if between 101 to 300 in denominator
  mutate(suppress_98to100_101=if_else((totalenroll>100 & totalenroll<=300) & 
                                     frl_percent>=0.98,1,0)) %>%
  
  #suppress percentages of 0-5 if between 41 to 100 in denominator
  mutate(suppress_0to5_41=if_else((totalenroll>40 & totalenroll<=100) & 
                                     frl_percent<=0.05,1,0)) %>%
  #suppress percentages of 95-100 if between 41 to 100 in denominator
  mutate(suppress_95to100_41=if_else((totalenroll>40 & totalenroll<=100) & 
                                     frl_percent>=0.95,1,0)) %>%
  
  #suppress percentages of 0-10 if between 21 to 40 in denominator
  mutate(suppress_0to10_21=if_else((totalenroll>20 & totalenroll<=40) & 
                                     frl_percent<=0.10,1,0)) %>%
  #suppress percentages of 90-100 if between 21 to 40 in denominator
  mutate(suppress_90to100_21=if_else((totalenroll>20 & totalenroll<=40) & 
                                     frl_percent>=0.90,1,0)) %>%
  
  #suppress percentages of 0-20 if between 10 to 20 in denominator
  mutate(suppress_0to20_10=if_else((totalenroll>=10 & totalenroll<=20) & 
                                     frl_percent<=0.20,1,0)) %>%
  #suppress percentages of 80-100 if between 10 to 20 in denominator
  mutate(suppress_80to100_10=if_else((totalenroll>=10 & totalenroll<=20) & 
                                     frl_percent>=0.80,1,0)) %>%
  
  #create updated percent and number based on suppression rules
  mutate(frl_percent=as.character(paste(frl_percent))) %>%
  mutate(frl_percent_suppressed=case_when(
    suppress_denominator==1 ~ 'NA',
    suppress_0to1_300==1 ~ "<= 1%",
    suppress_99to100_300==1 ~ ">= 99%",
    suppress_0to2_101==1 ~ "<= 2%",
    suppress_98to100_101==1 ~ ">= 98%",
    suppress_0to5_41==1 ~ "<= 5%",
    suppress_95to100_41==1 ~ ">= 95%",
    suppress_0to10_21==1 ~ "<= 10%",
    suppress_90to100_21==1 ~ ">= 90%",
    suppress_0to20_10==1 ~ "<= 20%",
    suppress_80to100_10==1 ~ ">= 80%",
    suppress_denominator==0 & suppress_0to1_300==0 & suppress_99to100_300==0 & 
      suppress_0to2_101==0 & suppress_98to100_101==0 & 
      suppress_0to5_41==0 & suppress_95to100_41==0 & 
      suppress_0to10_21==0 & suppress_90to100_21==0 & 
      suppress_0to20_10==0 & suppress_80to100_10==0 ~ frl_percent)) %>%
  
  mutate(frl_number=as.character(paste(frl_number))) %>%
  mutate(frl_number_suppressed=case_when(
    suppress_denominator==1 | suppress_0to1_300==1 | suppress_99to100_300==1 | 
    suppress_0to2_101==1 |  suppress_98to100_101==1 |  suppress_0to5_41==1 | 
    suppress_95to100_41==1 | suppress_0to10_21==1 | suppress_90to100_21==1 | 
    suppress_0to20_10==1 |   suppress_80to100_10==1 ~ 'NA',
    suppress_denominator==0 & suppress_0to1_300==0 & suppress_99to100_300==0 & 
      suppress_0to2_101==0 & suppress_98to100_101==0 & 
      suppress_0to5_41==0 & suppress_95to100_41==0 & 
      suppress_0to10_21==0 & suppress_90to100_21==0 & 
      suppress_0to20_10==0 & suppress_80to100_10==0 ~ frl_number)) %>%
  
  select(c(location,locationtype,locationid,state,timeframe,varname,frl_number_suppressed,frl_percent_suppressed)) %>%
  
  #change from wide to long
  rename(Number=frl_number_suppressed,
         Percent=frl_percent_suppressed) %>%
  pivot_longer(cols=c(Number,Percent),names_to='dataformat',values_to='data')
  


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(frl_all$locationid))>=1) {
  print(frl_all$location[is.na(frl_all$locationid)])
} else if (sum(is.na(frl_all$locationid))==0) {
  'all locations match'
}

# 2. Output cases where percent data is greater than 1
temp_percheck <- frl_all %>%
  subset(dataformat=='Percent' & data>1 & is.na(data))
temp_rows <- as.numeric(nrow(temp_percheck))

if (temp_rows==0) {
  'no percents greater than 1'
} else if (temp_rows>=1) {
  print(temp_percheck)
}

# 3. Visually inspect output data
View(frl_all)

```

## STEP 2: COMMIT TO DATABASE 
```{r}
#CHECK DATASET NAMED frl_all TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
dbWriteTable(con,'northdakota',frl_all,append=TRUE,row.names=FALSE)
```

## STEP 3: OUTPUT DATASET FOR UPLOADING TO KC DATA CENTER
```{r}
#########################
##OUTPUT DATA CENTER FILE

datacenter_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM northdakota WHERE timeframe='",fullyear,"' AND varname='freereducedlunch';")

upload_data <- dbGetQuery(con,datacenter_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/education/northdakota_",year,"_freereducedlunch.csv"),row.names=FALSE)

```




## ######################### ##
## STUDENTS WHO ARE HOMELESS ##
## ######################### ##

# STEP 1: IMPORT AND CLEAN DATA
**need to update for new data format in 2021**
```{r}
#import data
homeless_data <- read.csv(paste0("/Users/xannaburg/Desktop/ND Education/Homeless_2020_June5.csv"))


############
#COUNTY DATA
homeless_county <- homeless_data %>%
  
  separate(EntityID,c('county','district'),sep="-") %>%
  mutate(county=as.numeric(paste(county))) %>%
  
  #import county name
  left_join(countyids,by=c("county"="ndcounty_number")) %>%

  #sum by county
  group_by(ndcounty_name) %>%
  summarise(homeless_number=sum(X2018.19.Homeless),
            totalenroll=sum(X2018.19.Denominator),
            homeless_percent=sum(X2018.19.Homeless)/sum(X2018.19.Denominator)) %>%
  ungroup %>%

  #add in locationtype
  rename(location=ndcounty_name) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='County')

###########
#STATE DATA
#start with  cleaned county data
homeless_state <- homeless_county %>%
  mutate(location='North Dakota') %>%
  group_by(location) %>%
  summarise(homeless_number_state=sum(homeless_number),
      totalenroll_state=sum(totalenroll),
      homeless_percent=sum(homeless_number)/sum(totalenroll)) %>%
  ungroup %>%
  rename(homeless_number=homeless_number_state,
         totalenroll=totalenroll_state) %>%

  #add in locationtype
  mutate(locationtype='State')

############
#REGION DATA
#start with cleaned county data
homeless_region <- homeless_county %>%
  
  #add in regions
  mutate(location=as.character(paste(location))) %>%
  left_join(regionids,by=c('location'='county')) %>%
  group_by(region) %>%
  summarise(homeless_number_region=sum(homeless_number),
      totalenroll_region=sum(totalenroll),
      homeless_percent=sum(homeless_number)/sum(totalenroll)) %>%
  ungroup %>%
  rename(homeless_number=homeless_number_region,
         totalenroll=totalenroll_region) %>%

  
  #add in locationtype
  rename(location=region) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='Planning Region')


#################
#TRIBAL AREA DATA
#format tribal lookup table with county and dsitrict id only
tribalschools_updated <- tribalschools %>%
  separate(id_dash,c('county','district','school'),sep="-") %>%
  distinct(county,district,.keep_all=TRUE)

homeless_tribal <- homeless_data %>%
  
  separate(EntityID,c('county','district'),sep="-") %>%
  
  #import tribal name
  left_join(tribalschools_updated,by=c('county'='county','district'='district')) %>%
  subset(!is.na(tribalarea)) %>%


  #sum by tribal area
  group_by(tribalarea) %>%
  summarise(homeless_number=sum(X2018.19.Homeless),
            totalenroll=sum(X2018.19.Denominator),
            homeless_percent=sum(X2018.19.Homeless)/sum(X2018.19.Denominator)) %>%
  ungroup %>%
  

  #add in locationtype
  rename(location=tribalarea) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='Tribal Area')
  
  
######################## 
#combine all geographies
homeless_all <- homeless_county %>%
  bind_rows(homeless_state) %>%
  bind_rows(homeless_region) %>%
  bind_rows(homeless_tribal) %>%
  
  mutate(state='North Dakota') %>%
  mutate(varname='studentshomeless') %>%
  
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) %>%
  mutate(timeframe=fullyear) %>%
  
  #create indicators to suppress data

  #supress if denominator is less than 10
  mutate(suppress_denominator=if_else(totalenroll<10 | is.na(totalenroll),1,0)) %>%
 
  #suppress percentages of 0-1 if more than 300 in denominator
  mutate(suppress_0to1_300=if_else(totalenroll>300 & homeless_percent<=.01,1,0)) %>%
  #suppress percentages of 99-100 if more than 300 in denominator
  mutate(suppress_99to100_300=if_else(totalenroll>300 & homeless_percent>=.99,1,0)) %>%

  
  #suppress percentages of 0-2 if between 101 to 300 in denominator
  mutate(suppress_0to2_101=if_else((totalenroll>100 & totalenroll<=300) & 
                                     homeless_percent<=0.02,1,0)) %>%
  #suppress percentages of 98-100 if between 101 to 300 in denominator
  mutate(suppress_98to100_101=if_else((totalenroll>100 & totalenroll<=300) & 
                                     homeless_percent>=0.98,1,0)) %>%
  
  #suppress percentages of 0-5 if between 41 to 100 in denominator
  mutate(suppress_0to5_41=if_else((totalenroll>40 & totalenroll<=100) & 
                                     homeless_percent<=0.05,1,0)) %>%
  #suppress percentages of 95-100 if between 41 to 100 in denominator
  mutate(suppress_95to100_41=if_else((totalenroll>40 & totalenroll<=100) & 
                                     homeless_percent>=0.95,1,0)) %>%
  
  #suppress percentages of 0-10 if between 21 to 40 in denominator
  mutate(suppress_0to10_21=if_else((totalenroll>20 & totalenroll<=40) & 
                                     homeless_percent<=0.10,1,0)) %>%
  #suppress percentages of 90-100 if between 21 to 40 in denominator
  mutate(suppress_90to100_21=if_else((totalenroll>20 & totalenroll<=40) & 
                                     homeless_percent>=0.90,1,0)) %>%
  
  #suppress percentages of 0-20 if between 10 to 20 in denominator
  mutate(suppress_0to20_10=if_else((totalenroll>=10 & totalenroll<=20) & 
                                     homeless_percent<=0.20,1,0)) %>%
  #suppress percentages of 80-100 if between 10 to 20 in denominator
  mutate(suppress_80to100_10=if_else((totalenroll>=10 & totalenroll<=20) & 
                                     homeless_percent>=0.80,1,0)) %>%
  
  #create updated percent and number based on suppression rules
  mutate(homeless_percent=as.character(paste(homeless_percent))) %>%
  mutate(homeless_percent_suppressed=case_when(
    suppress_denominator==1 ~ 'NA',
    suppress_0to1_300==1 ~ "<= 1%",
    suppress_99to100_300==1 ~ ">= 99%",
    suppress_0to2_101==1 ~ "<= 2%",
    suppress_98to100_101==1 ~ ">= 98%",
    suppress_0to5_41==1 ~ "<= 5%",
    suppress_95to100_41==1 ~ ">= 95%",
    suppress_0to10_21==1 ~ "<= 10%",
    suppress_90to100_21==1 ~ ">= 90%",
    suppress_0to20_10==1 ~ "<= 20%",
    suppress_80to100_10==1 ~ ">= 80%",
    suppress_denominator==0 & suppress_0to1_300==0 & suppress_99to100_300==0 & 
      suppress_0to2_101==0 & suppress_98to100_101==0 & 
      suppress_0to5_41==0 & suppress_95to100_41==0 & 
      suppress_0to10_21==0 & suppress_90to100_21==0 & 
      suppress_0to20_10==0 & suppress_80to100_10==0 ~ homeless_percent)) %>%
  
  mutate(homeless_number=as.character(paste(homeless_number))) %>%
  mutate(homeless_number_suppressed=case_when(
    suppress_denominator==1 | suppress_0to1_300==1 | suppress_99to100_300==1 | 
    suppress_0to2_101==1 |  suppress_98to100_101==1 |  suppress_0to5_41==1 | 
    suppress_95to100_41==1 | suppress_0to10_21==1 | suppress_90to100_21==1 | 
    suppress_0to20_10==1 |   suppress_80to100_10==1 ~ 'NA',
    suppress_denominator==0 & suppress_0to1_300==0 & suppress_99to100_300==0 & 
      suppress_0to2_101==0 & suppress_98to100_101==0 & 
      suppress_0to5_41==0 & suppress_95to100_41==0 & 
      suppress_0to10_21==0 & suppress_90to100_21==0 & 
      suppress_0to20_10==0 & suppress_80to100_10==0 ~ homeless_number)) %>%
  
  select(c(location,locationtype,locationid,state,timeframe,varname,homeless_number_suppressed,homeless_percent_suppressed)) %>%
  
  #change from wide to long
  rename(Number=homeless_number_suppressed,
         Percent=homeless_percent_suppressed) %>%
  pivot_longer(cols=c(Number,Percent),names_to='dataformat',values_to='data')
  


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(homeless_all$locationid))>=1) {
  print(homeless_all$location[is.na(homeless_all$locationid)])
} else if (sum(is.na(homeless_all$locationid))==0) {
  'all locations match'
}

# 2. Output cases where percent data is greater than 1
temp_percheck <- homeless_all %>%
  subset(dataformat=='Percent' & data>1 & is.na(data))
temp_rows <- as.numeric(nrow(temp_percheck))

if (temp_rows==0) {
  'no percents greater than 1'
} else if (temp_rows>=1) {
  print(temp_percheck)
}

# 3. Visually inspect output data
View(homeless_all)

```

## STEP 2: COMMIT TO DATABASE 
```{r}
#CHECK DATASET NAMED homeless_all TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
dbWriteTable(con,'northdakota',homeless_all,append=TRUE,row.names=FALSE)
```

## STEP 3: OUTPUT DATASET FOR UPLOADING TO KC DATA CENTER
```{r}
#########################
##OUTPUT DATA CENTER FILE

datacenter_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM northdakota WHERE timeframe='",fullyear,"' AND varname='studentshomeless';")

upload_data <- dbGetQuery(con,datacenter_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/education/northdakota_",year,"_studentshomeless.csv"),row.names=FALSE)

```



## ##################################################################### ##
## CHILDREN AGES 3 TO 21 ENROLLED IN SPECIAL EDUCATION IN PUBLIC SCHOOLS ##
## ##################################################################### ##

## STEP 1: IMPORT AND CLEAN SPECIAL EDUCATION DATA
```{r}
#import data
specialed_data <- read_excel(path=paste0("/Users/xannaburg/Desktop/ND Education/December1_SpecialEdSnapShots_",year,".xlsx"),guess_max = 1048576)


############
#COUNTY DATA
specialed_county <- specialed_data %>%
  
  #import county name
  left_join(countyids,by=c("County"="ndcounty_number")) %>%

  #change into indicator variable
  mutate(specialed_indicator=case_when(
    !is.na(Age) ~ 1)) %>%
  
  #remove nonpublic schools (district ID >200) 
  separate(SchoolStateIssuedID,c('county','district','school'),sep="-") %>%
  mutate(district=as.numeric(paste(district))) %>%
  subset(district<200) %>%
  #this remove students only enrolled in district if needed, TBD
  #subset(!is.na(school)) %>%
  
  #remove non counties
  subset(!is.na(ndcounty_name)) %>%

  #sum by county
  group_by(ndcounty_name) %>%
  summarise(specialed_number=sum(specialed_indicator)) %>%
  ungroup %>%

  #add in locationtype
  rename(location=ndcounty_name) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='County')

###########
#STATE DATA
#start with  cleaned county data
specialed_state <- specialed_county %>%
  mutate(location='North Dakota') %>%
  group_by(location) %>%
  summarise(specialed_number=sum(specialed_number)) %>%
  ungroup %>%

  #add in locationtype
  mutate(locationtype='State')

############
#REGION DATA
#start with cleaned county data
specialed_region <- specialed_county %>%
  
  #add in regions
  mutate(location=as.character(paste(location))) %>%
  left_join(regionids,by=c('location'='county')) %>%
  group_by(region) %>%
  summarise(specialed_number=sum(specialed_number)) %>%
  ungroup %>%

  
  #add in locationtype
  rename(location=region) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='Planning Region')


#################
#TRIBAL AREA DATA
specialed_tribal <- specialed_data %>%
  
  #import tribal name
  left_join(tribalschools,by=c('SchoolStateIssuedID'='id_dash')) %>%
  subset(!is.na(tribalarea)) %>%
  
  #change into indicator variable
  mutate(specialed_indicator=case_when(
    !is.na(Age) ~ 1)) %>%
  
  #remove nonpublic schools (district ID >200) 
  separate(SchoolStateIssuedID,c('county','district','school'),sep="-") %>%
  mutate(district=as.numeric(paste(district))) %>%
  subset(district<200) %>%
  #this remove students only enrolled in district if needed, TBD
  #subset(!is.na(school)) %>%


  #sum by tribal area
  group_by(tribalarea) %>%
  summarise(specialed_number=sum(specialed_indicator)) %>%
  ungroup %>%

  #add in locationtype
  rename(location=tribalarea) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='Tribal Area')
  
  
######################## 
#combine all geographies
specialed_all <- specialed_county %>%
  bind_rows(specialed_state) %>%
  bind_rows(specialed_region) %>%
  bind_rows(specialed_tribal) %>%
  
  mutate(state='North Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(varname='totalspecialeducation') %>%
  
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId)
```

## STEP 2: CALCULATE DENOMINATOR FROM ENROLLMENT SNAPSHOT
```{r}
#import data
enroll_data <- read_excel(path=paste0("/Users/xannaburg/Desktop/ND Education/Enrollment_inclusive_",year,".xlsx"),guess_max = 1048576)


############
#COUNTY DATA
enroll_county <- enroll_data %>%
  
  #import county name
  left_join(countyids,by=c("County"="ndcounty_number")) %>%

  #create an indicator variable for counting total population
  mutate(enroll_indicator=case_when(
    !is.na(GradeName) ~ 1)) %>%
  
  #remove nonpublic schools (district ID >200) 
  separate(SchoolStateIssuedID,c('county','district','school'),sep="-") %>%
  mutate(district=as.numeric(paste(district))) %>%
  subset(district<200) %>%
  
  #remove non counties
  subset(!is.na(ndcounty_name)) %>%

  #sum by county
  group_by(ndcounty_name) %>%
  summarise(totalenroll=sum(enroll_indicator)) %>%
  ungroup %>%

  #add in locationtype
  rename(location=ndcounty_name) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='County')

###########
#STATE DATA
#start with  cleaned county data
enroll_state <- enroll_county %>%
  mutate(location='North Dakota') %>%
  group_by(location) %>%
  summarise(totalenroll=sum(totalenroll)) %>%
  ungroup %>%

  #add in locationtype
  mutate(locationtype='State')

############
#REGION DATA
#start with cleaned county data
enroll_region <- enroll_county %>%
  
  #add in regions
  mutate(location=as.character(paste(location))) %>%
  left_join(regionids,by=c('location'='county')) %>%
  group_by(region) %>%
  summarise(totalenroll=sum(totalenroll)) %>%
  ungroup %>%

  #add in locationtype
  rename(location=region) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='Planning Region')


#################
#TRIBAL AREA DATA
enroll_tribal <- enroll_data %>%
  
  #import tribal name
  left_join(tribalschools,by=c('SchoolStateIssuedID'='id_dash')) %>%
  subset(!is.na(tribalarea)) %>%
  
  #remove nonpublic schools (district ID >200) 
  separate(SchoolStateIssuedID,c('county','district','school'),sep="-") %>%
  mutate(district=as.numeric(paste(district))) %>%
  subset(district<200) %>%
  
  #create an indicator variable for counting total population
  mutate(enroll_indicator=case_when(
    !is.na(GradeName) ~ 1)) %>%

  #sum by tribal area
  group_by(tribalarea) %>%
  summarise(totalenroll=sum(enroll_indicator)) %>%
  ungroup %>%

  #add in locationtype
  rename(location=tribalarea) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='Tribal Area')

######################## 
#combine all geographies
enroll_all <- enroll_county %>%
  bind_rows(enroll_state) %>%
  bind_rows(enroll_region) %>%
  bind_rows(enroll_tribal) %>%
  
  mutate(state='North Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(varname='totalspecialeducation') %>%
  
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId)

```

## STEP 3: COMBINE NUMERATOR AND DENOMINATOR TO CALCULATE PERCENTAGES
```{r}
specialed_enroll <- specialed_all %>%
  left_join(enroll_all,by = c("location", "locationtype", "state", "timeframe", "varname", "locationid")) %>%
  
  #calculate percent
  mutate(specialed_percent=specialed_number/totalenroll) %>%


  #create indicators to suppress data

  #supress if denominator is less than 10
  mutate(suppress_denominator=if_else(totalenroll<10 | is.na(totalenroll),1,0)) %>%
 
  #suppress percentages of 0-1 if more than 300 in denominator
  mutate(suppress_0to1_300=if_else(totalenroll>300 & specialed_percent<=.01,1,0)) %>%
  #suppress percentages of 99-100 if more than 300 in denominator
  mutate(suppress_99to100_300=if_else(totalenroll>300 & specialed_percent>=.99,1,0)) %>%

  
  #suppress percentages of 0-2 if between 101 to 300 in denominator
  mutate(suppress_0to2_101=if_else((totalenroll>100 & totalenroll<=300) & 
                                     specialed_percent<=0.02,1,0)) %>%
  #suppress percentages of 98-100 if between 101 to 300 in denominator
  mutate(suppress_98to100_101=if_else((totalenroll>100 & totalenroll<=300) & 
                                     specialed_percent>=0.98,1,0)) %>%
  
  #suppress percentages of 0-5 if between 41 to 100 in denominator
  mutate(suppress_0to5_41=if_else((totalenroll>40 & totalenroll<=100) & 
                                     specialed_percent<=0.05,1,0)) %>%
  #suppress percentages of 95-100 if between 41 to 100 in denominator
  mutate(suppress_95to100_41=if_else((totalenroll>40 & totalenroll<=100) & 
                                     specialed_percent>=0.95,1,0)) %>%
  
  #suppress percentages of 0-10 if between 21 to 40 in denominator
  mutate(suppress_0to10_21=if_else((totalenroll>20 & totalenroll<=40) & 
                                     specialed_percent<=0.10,1,0)) %>%
  #suppress percentages of 90-100 if between 21 to 40 in denominator
  mutate(suppress_90to100_21=if_else((totalenroll>20 & totalenroll<=40) & 
                                     specialed_percent>=0.90,1,0)) %>%
  
  #suppress percentages of 0-20 if between 10 to 20 in denominator
  mutate(suppress_0to20_10=if_else((totalenroll>=10 & totalenroll<=20) & 
                                     specialed_percent<=0.20,1,0)) %>%
  #suppress percentages of 80-100 if between 10 to 20 in denominator
  mutate(suppress_80to100_10=if_else((totalenroll>=10 & totalenroll<=20) & 
                                     specialed_percent>=0.80,1,0)) %>%
  
  #create updated percent and number based on suppression rules
  mutate(specialed_percent=as.character(paste(specialed_percent))) %>%
  mutate(specialed_percent_suppressed=case_when(
    suppress_denominator==1 ~ 'NA',
    suppress_0to1_300==1 ~ "<= 1%",
    suppress_99to100_300==1 ~ ">= 99%",
    suppress_0to2_101==1 ~ "<= 2%",
    suppress_98to100_101==1 ~ ">= 98%",
    suppress_0to5_41==1 ~ "<= 5%",
    suppress_95to100_41==1 ~ ">= 95%",
    suppress_0to10_21==1 ~ "<= 10%",
    suppress_90to100_21==1 ~ ">= 90%",
    suppress_0to20_10==1 ~ "<= 20%",
    suppress_80to100_10==1 ~ ">= 80%",
    suppress_denominator==0 & suppress_0to1_300==0 & suppress_99to100_300==0 & 
      suppress_0to2_101==0 & suppress_98to100_101==0 & 
      suppress_0to5_41==0 & suppress_95to100_41==0 & 
      suppress_0to10_21==0 & suppress_90to100_21==0 & 
      suppress_0to20_10==0 & suppress_80to100_10==0 ~ specialed_percent)) %>%
  
  mutate(specialed_number=as.character(paste(specialed_number))) %>%
  mutate(specialed_number_suppressed=case_when(
    suppress_denominator==1 | suppress_0to1_300==1 | suppress_99to100_300==1 | 
    suppress_0to2_101==1 |  suppress_98to100_101==1 |  suppress_0to5_41==1 | 
    suppress_95to100_41==1 | suppress_0to10_21==1 | suppress_90to100_21==1 | 
    suppress_0to20_10==1 |   suppress_80to100_10==1 ~ 'NA',
    suppress_denominator==0 & suppress_0to1_300==0 & suppress_99to100_300==0 & 
      suppress_0to2_101==0 & suppress_98to100_101==0 & 
      suppress_0to5_41==0 & suppress_95to100_41==0 & 
      suppress_0to10_21==0 & suppress_90to100_21==0 & 
      suppress_0to20_10==0 & suppress_80to100_10==0 ~ specialed_number)) %>%
  
  select(c(location,locationtype,locationid,state,timeframe,varname,specialed_number_suppressed,specialed_percent_suppressed)) %>%
  
  #change from wide to long
  rename(Number=specialed_number_suppressed,
         Percent=specialed_percent_suppressed) %>%
  pivot_longer(cols=c(Number,Percent),names_to='dataformat',values_to='data')
  


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(specialed_enroll$locationid))>=1) {
  print(specialed_enroll$location[is.na(specialed_enroll$locationid)])
} else if (sum(is.na(specialed_enroll$locationid))==0) {
  'all locations match'
}

# 2. Output cases where percent data is greater than 1
temp_percheck <- specialed_enroll %>%
  subset(dataformat=='Percent' & data>1 & is.na(data))
temp_rows <- as.numeric(nrow(temp_percheck))

if (temp_rows==0) {
  'no percents greater than 1'
} else if (temp_rows>=1) {
  print(temp_percheck)
}

# 3. Visually inspect output data
View(specialed_enroll)
```

## STEP 4: COMMIT TO DATABASE 
```{r}
#CHECK DATASET NAMED specialed_enroll TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
dbWriteTable(con,'northdakota',specialed_enroll,append=TRUE,row.names=FALSE)
```

## STEP 5: OUTPUT DATASET FOR UPLOADING TO KC DATA CENTER
```{r}
#########################
##OUTPUT DATA CENTER FILE

datacenter_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM northdakota WHERE timeframe='",fullyear,"' AND varname='totalspecialeducation';")

upload_data <- dbGetQuery(con,datacenter_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/education/northdakota_",year,"_totalspecialeducation.csv"),row.names=FALSE)

```




## ############################################################### ##
## CHILDREN ENROLLED IN SPECIAL EDUCATION IN PUBLIC SCHOOLS BY AGE ##
##            (PERCENT OF SPECIAL EDUCATION ENROLLMENT)            ##
## ############################################################### ##
*Total children ages 3 to 21 enrolled in special education (above) must have already been calculated before running this code. That indicator is used as a denominator*

## STEP 1: IMPORT AND CLEAN SPECIAL EDUCATION DATA
```{r}
#import data
specialed_data <- read_excel(path=paste0("/Users/xannaburg/Desktop/ND Education/December1_SpecialEdSnapShots_",year,".xlsx"),guess_max = 1048576) 


############
#STATE DATA
specialed_age_state <- specialed_data %>%
  
  mutate(location='North Dakota') %>%

  #change age into categories
  mutate(age_group=case_when(
    Age>=3 & Age<=5 ~ '3 to 5',
    Age>=6 & Age <=11 ~ '6 to 11',
    Age>=12 & Age<=17 ~ '12 to 17',
    Age>=18 & Age<=21 ~ '18 to 21')) %>%
  
  #change into indicator variable
  mutate(specialed_indicator=case_when(
  !is.na(Age) ~ 1)) %>%
  
  #remove nonpublic schools (district ID >200) 
  separate(SchoolStateIssuedID,c('county','district','school'),sep="-") %>%
  mutate(district=as.numeric(paste(district))) %>%
  subset(district<200) %>%
  

  #sums
  group_by(location,age_group) %>%
  summarise(specialed_number=sum(specialed_indicator,na.rm=TRUE)) %>%
  ungroup %>%

  #add in locationtype
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='State') %>%

  mutate(state='North Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(varname='totalspecialeducationbyage') %>%
  
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId)
```

## STEP 2: IMPORT DATA FOR TOTAL SPECIAL EDUCATION ENROLLMENT FROM DATABASE
```{r}
enroll_specialed_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM northdakota WHERE timeframe='",fullyear,"' AND varname='totalspecialeducation' AND dataformat='Number' AND locationtype='State';")

enroll_specialed <- dbGetQuery(con,enroll_specialed_sql) %>%
  rename(totalenroll=data)


#merge total special education enrollment and by age data
specialed_age_enroll <- specialed_age_state %>%
  left_join(enroll_specialed,by = c("location", "timeframe", "locationid")) %>%
  
  #calculate percent
  mutate(totalenroll=as.numeric(paste(totalenroll))) %>%
  mutate(specialed_percent=specialed_number/totalenroll) %>%
  
  #create indicators to suppress data

  #supress if denominator is less than 10
  mutate(suppress_denominator=if_else(totalenroll<10 | is.na(totalenroll),1,0)) %>%
 
  #suppress percentages of 0-1 if more than 300 in denominator
  mutate(suppress_0to1_300=if_else(totalenroll>300 & specialed_percent<=.01,1,0)) %>%
  #suppress percentages of 99-100 if more than 300 in denominator
  mutate(suppress_99to100_300=if_else(totalenroll>300 & specialed_percent>=.99,1,0)) %>%

  
  #suppress percentages of 0-2 if between 101 to 300 in denominator
  mutate(suppress_0to2_101=if_else((totalenroll>100 & totalenroll<=300) & 
                                     specialed_percent<=0.02,1,0)) %>%
  #suppress percentages of 98-100 if between 101 to 300 in denominator
  mutate(suppress_98to100_101=if_else((totalenroll>100 & totalenroll<=300) & 
                                     specialed_percent>=0.98,1,0)) %>%
  
  #suppress percentages of 0-5 if between 41 to 100 in denominator
  mutate(suppress_0to5_41=if_else((totalenroll>40 & totalenroll<=100) & 
                                     specialed_percent<=0.05,1,0)) %>%
  #suppress percentages of 95-100 if between 41 to 100 in denominator
  mutate(suppress_95to100_41=if_else((totalenroll>40 & totalenroll<=100) & 
                                     specialed_percent>=0.95,1,0)) %>%
  
  #suppress percentages of 0-10 if between 21 to 40 in denominator
  mutate(suppress_0to10_21=if_else((totalenroll>20 & totalenroll<=40) & 
                                     specialed_percent<=0.10,1,0)) %>%
  #suppress percentages of 90-100 if between 21 to 40 in denominator
  mutate(suppress_90to100_21=if_else((totalenroll>20 & totalenroll<=40) & 
                                     specialed_percent>=0.90,1,0)) %>%
  
  #suppress percentages of 0-20 if between 10 to 20 in denominator
  mutate(suppress_0to20_10=if_else((totalenroll>=10 & totalenroll<=20) & 
                                     specialed_percent<=0.20,1,0)) %>%
  #suppress percentages of 80-100 if between 10 to 20 in denominator
  mutate(suppress_80to100_10=if_else((totalenroll>=10 & totalenroll<=20) & 
                                     specialed_percent>=0.80,1,0)) %>%
  
  #create updated percent and number based on suppression rules
  mutate(specialed_percent=as.character(paste(specialed_percent))) %>%
  mutate(specialed_percent_suppressed=case_when(
    suppress_denominator==1 ~ 'NA',
    suppress_0to1_300==1 ~ "<= 1%",
    suppress_99to100_300==1 ~ ">= 99%",
    suppress_0to2_101==1 ~ "<= 2%",
    suppress_98to100_101==1 ~ ">= 98%",
    suppress_0to5_41==1 ~ "<= 5%",
    suppress_95to100_41==1 ~ ">= 95%",
    suppress_0to10_21==1 ~ "<= 10%",
    suppress_90to100_21==1 ~ ">= 90%",
    suppress_0to20_10==1 ~ "<= 20%",
    suppress_80to100_10==1 ~ ">= 80%",
    suppress_denominator==0 & suppress_0to1_300==0 & suppress_99to100_300==0 & 
      suppress_0to2_101==0 & suppress_98to100_101==0 & 
      suppress_0to5_41==0 & suppress_95to100_41==0 & 
      suppress_0to10_21==0 & suppress_90to100_21==0 & 
      suppress_0to20_10==0 & suppress_80to100_10==0 ~ specialed_percent)) %>%
  
  mutate(specialed_number=as.character(paste(specialed_number))) %>%
  mutate(specialed_number_suppressed=case_when(
    suppress_denominator==1 | suppress_0to1_300==1 | suppress_99to100_300==1 | 
    suppress_0to2_101==1 |  suppress_98to100_101==1 |  suppress_0to5_41==1 | 
    suppress_95to100_41==1 | suppress_0to10_21==1 | suppress_90to100_21==1 | 
    suppress_0to20_10==1 |   suppress_80to100_10==1 ~ 'NA',
    suppress_denominator==0 & suppress_0to1_300==0 & suppress_99to100_300==0 & 
      suppress_0to2_101==0 & suppress_98to100_101==0 & 
      suppress_0to5_41==0 & suppress_95to100_41==0 & 
      suppress_0to10_21==0 & suppress_90to100_21==0 & 
      suppress_0to20_10==0 & suppress_80to100_10==0 ~ specialed_number)) %>%
  
  select(c(location,locationtype,locationid,state,timeframe,varname,age_group,specialed_number_suppressed,specialed_percent_suppressed)) %>%
  
  #change from wide to long
  rename(Number=specialed_number_suppressed,
         Percent=specialed_percent_suppressed) %>%
  pivot_longer(cols=c(Number,Percent),names_to='dataformat',values_to='data')
  


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(specialed_age_enroll$locationid))>=1) {
  print(specialed_age_enroll$location[is.na(specialed_age_enroll$locationid)])
} else if (sum(is.na(specialed_age_enroll$locationid))==0) {
  'all locations match'
}

# 2. Output cases where percent data is greater than 1
temp_percheck <- specialed_age_enroll %>%
  subset(dataformat=='Percent' & data>1 & is.na(data))
temp_rows <- as.numeric(nrow(temp_percheck))

if (temp_rows==0) {
  'no percents greater than 1'
} else if (temp_rows>=1) {
  print(temp_percheck)
}

# 3. Visually inspect output data
View(specialed_age_enroll)
```

## STEP 3: COMMIT TO DATABASE 
```{r}
#CHECK DATASET NAMED specialed_age_enroll TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
dbWriteTable(con,'northdakota',specialed_age_enroll,append=TRUE,row.names=FALSE)
```

## STEP 3: OUTPUT DATASET FOR UPLOADING TO KC DATA CENTER
```{r}
#########################
##OUTPUT DATA CENTER FILE

datacenter_sql <- paste0("SELECT locationid, location, timeframe, dataformat, age_group, data FROM northdakota WHERE timeframe='",fullyear,"' AND varname='totalspecialeducationbyage';")

upload_data <- dbGetQuery(con,datacenter_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data,
         'Age group'=age_group)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/education/northdakota_",year,"_totalspecialeducationbyage.csv"),row.names=FALSE)

```



## ############################################################################## ##
## CHILDREN ENROLLED IN SPECIAL EDUCATION IN PUBLIC SCHOOLS BY TYPE OF IMPAIRMENT ##
##                     (PERCENT OF SPECIAL EDUCATION ENROLLMENT)                  ##
## ############################################################################## ##
*Total children ages 3 to 21 enrolled in special education (above) must have already been calculated before running this code. That indicator is used as a denominator*

## STEP 1: IMPORT AND CLEAN SPECIAL EDUCATION DATA
```{r}
#import data
specialed_data <- read_excel(path=paste0("/Users/xannaburg/Desktop/ND Education/December1_SpecialEdSnapShots_",year,".xlsx"),guess_max = 1048576)


############
#STATE DATA
specialed_type_state <- specialed_data %>%
  
  mutate(location='North Dakota') %>%

  #change age into categories
  mutate(category=case_when(
    PrimaryDisabilityDesc=='Autism'  ~ 'Autism',
    PrimaryDisabilityDesc=='Emotional Disturbance' ~ 'Emotionally Disturbed',
    PrimaryDisabilityDesc=='Speech/Language Impairments' ~ 'Speech or Language Impaired',
    PrimaryDisabilityDesc=='Intellectual Disability' ~ 'Intellectual Disability',
    PrimaryDisabilityDesc=='Specific Learning Disabilities' ~ 'Specific Learning Disability')) %>%
  
  #change into indicator variable
  mutate(specialed_indicator=case_when(
  !is.na(Age) ~ 1)) %>%
  
  #remove nonpublic schools (district ID >200) 
  separate(SchoolStateIssuedID,c('county','district','school'),sep="-") %>%
  mutate(district=as.numeric(paste(district))) %>%
  subset(district<200) %>%
  
  #sums
  group_by(location,category) %>%
  summarise(specialed_number=sum(specialed_indicator,na.rm=TRUE)) %>%
  ungroup %>%
  
  subset(!is.na(category)) %>%

  #add in locationtype
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='State') %>%

  mutate(state='North Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(varname='totalspecialeducationbyimpairment') %>%
  
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId)
```

## STEP 2: IMPORT DATA FOR TOTAL SPECIAL EDUCATION ENROLLMENT FROM DATABASE
```{r}
enroll_specialed_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM northdakota WHERE timeframe='",fullyear,"' AND varname='totalspecialeducation' AND dataformat='Number' AND locationtype='State';")

enroll_specialed <- dbGetQuery(con,enroll_specialed_sql) %>%
  rename(totalenroll=data)


#merge total special education enrollment and by age data
specialed_type_enroll <- specialed_type_state %>%
  left_join(enroll_specialed,by = c("location", "timeframe", "locationid")) %>%
  
  #calculate percent
  mutate(totalenroll=as.numeric(paste(totalenroll))) %>%
  mutate(specialed_percent=specialed_number/totalenroll) %>%
  
  #create indicators to suppress data

  #supress if denominator is less than 10
  mutate(suppress_denominator=if_else(totalenroll<10 | is.na(totalenroll),1,0)) %>%
 
  #suppress percentages of 0-1 if more than 300 in denominator
  mutate(suppress_0to1_300=if_else(totalenroll>300 & specialed_percent<=.01,1,0)) %>%
  #suppress percentages of 99-100 if more than 300 in denominator
  mutate(suppress_99to100_300=if_else(totalenroll>300 & specialed_percent>=.99,1,0)) %>%

  
  #suppress percentages of 0-2 if between 101 to 300 in denominator
  mutate(suppress_0to2_101=if_else((totalenroll>100 & totalenroll<=300) & 
                                     specialed_percent<=0.02,1,0)) %>%
  #suppress percentages of 98-100 if between 101 to 300 in denominator
  mutate(suppress_98to100_101=if_else((totalenroll>100 & totalenroll<=300) & 
                                     specialed_percent>=0.98,1,0)) %>%
  
  #suppress percentages of 0-5 if between 41 to 100 in denominator
  mutate(suppress_0to5_41=if_else((totalenroll>40 & totalenroll<=100) & 
                                     specialed_percent<=0.05,1,0)) %>%
  #suppress percentages of 95-100 if between 41 to 100 in denominator
  mutate(suppress_95to100_41=if_else((totalenroll>40 & totalenroll<=100) & 
                                     specialed_percent>=0.95,1,0)) %>%
  
  #suppress percentages of 0-10 if between 21 to 40 in denominator
  mutate(suppress_0to10_21=if_else((totalenroll>20 & totalenroll<=40) & 
                                     specialed_percent<=0.10,1,0)) %>%
  #suppress percentages of 90-100 if between 21 to 40 in denominator
  mutate(suppress_90to100_21=if_else((totalenroll>20 & totalenroll<=40) & 
                                     specialed_percent>=0.90,1,0)) %>%
  
  #suppress percentages of 0-20 if between 10 to 20 in denominator
  mutate(suppress_0to20_10=if_else((totalenroll>=10 & totalenroll<=20) & 
                                     specialed_percent<=0.20,1,0)) %>%
  #suppress percentages of 80-100 if between 10 to 20 in denominator
  mutate(suppress_80to100_10=if_else((totalenroll>=10 & totalenroll<=20) & 
                                     specialed_percent>=0.80,1,0)) %>%
  
  #create updated percent and number based on suppression rules
  mutate(specialed_percent=as.character(paste(specialed_percent))) %>%
  mutate(specialed_percent_suppressed=case_when(
    suppress_denominator==1 ~ 'NA',
    suppress_0to1_300==1 ~ "<= 1%",
    suppress_99to100_300==1 ~ ">= 99%",
    suppress_0to2_101==1 ~ "<= 2%",
    suppress_98to100_101==1 ~ ">= 98%",
    suppress_0to5_41==1 ~ "<= 5%",
    suppress_95to100_41==1 ~ ">= 95%",
    suppress_0to10_21==1 ~ "<= 10%",
    suppress_90to100_21==1 ~ ">= 90%",
    suppress_0to20_10==1 ~ "<= 20%",
    suppress_80to100_10==1 ~ ">= 80%",
    suppress_denominator==0 & suppress_0to1_300==0 & suppress_99to100_300==0 & 
      suppress_0to2_101==0 & suppress_98to100_101==0 & 
      suppress_0to5_41==0 & suppress_95to100_41==0 & 
      suppress_0to10_21==0 & suppress_90to100_21==0 & 
      suppress_0to20_10==0 & suppress_80to100_10==0 ~ specialed_percent)) %>%
  
  mutate(specialed_number=as.character(paste(specialed_number))) %>%
  mutate(specialed_number_suppressed=case_when(
    suppress_denominator==1 | suppress_0to1_300==1 | suppress_99to100_300==1 | 
    suppress_0to2_101==1 |  suppress_98to100_101==1 |  suppress_0to5_41==1 | 
    suppress_95to100_41==1 | suppress_0to10_21==1 | suppress_90to100_21==1 | 
    suppress_0to20_10==1 |   suppress_80to100_10==1 ~ 'NA',
    suppress_denominator==0 & suppress_0to1_300==0 & suppress_99to100_300==0 & 
      suppress_0to2_101==0 & suppress_98to100_101==0 & 
      suppress_0to5_41==0 & suppress_95to100_41==0 & 
      suppress_0to10_21==0 & suppress_90to100_21==0 & 
      suppress_0to20_10==0 & suppress_80to100_10==0 ~ specialed_number)) %>%
  
  select(c(location,locationtype,locationid,state,timeframe,varname,category,specialed_number_suppressed,specialed_percent_suppressed)) %>%
  
  #change from wide to long
  rename(Number=specialed_number_suppressed,
         Percent=specialed_percent_suppressed) %>%
  pivot_longer(cols=c(Number,Percent),names_to='dataformat',values_to='data')
  


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(specialed_type_enroll$locationid))>=1) {
  print(specialed_type_enroll$location[is.na(specialed_type_enroll$locationid)])
} else if (sum(is.na(specialed_type_enroll$locationid))==0) {
  'all locations match'
}

# 2. Output cases where percent data is greater than 1
temp_percheck <- specialed_type_enroll %>%
  subset(dataformat=='Percent' & data>1 & is.na(data))
temp_rows <- as.numeric(nrow(temp_percheck))

if (temp_rows==0) {
  'no percents greater than 1'
} else if (temp_rows>=1) {
  print(temp_percheck)
}

# 3. Visually inspect output data
View(specialed_type_enroll)
```

## STEP 3: COMMIT TO DATABASE 
```{r}
#CHECK DATASET NAMED specialed_type_enroll TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
dbWriteTable(con,'northdakota',specialed_type_enroll,append=TRUE,row.names=FALSE)
```

## STEP 3: OUTPUT DATASET FOR UPLOADING TO KC DATA CENTER
```{r}
#########################
##OUTPUT DATA CENTER FILE

datacenter_sql <- paste0("SELECT locationid, location, timeframe, dataformat, category, data FROM northdakota WHERE timeframe='",fullyear,"' AND varname='totalspecialeducationbyimpairment';")

upload_data <- dbGetQuery(con,datacenter_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data,
         Category=category)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/education/northdakota_",year,"_totalspecialeducationbyimpairment.csv"),row.names=FALSE)

```



## ########################################## ##
## AVERAGE DAILY MEMBERSHIP OF PUBLIC SCHOOLS ##
## ########################################## ##

## STEP 1: IMPORT THE FINANCIALS DATA
```{r}
#import data
financials <- read.csv(paste0("/Users/xannaburg/Desktop/ND Education/FinancialData_",year,".csv"))

############
#COUNTY DATA
adm_county <- financials %>%
  subset(FY==fiscalyear) %>%
  
  #join county names
  separate(Codist,into=c("county","district"),sep="-") %>%
  mutate(county=as.numeric(paste(county))) %>%
  left_join(countyids,by=c('county'='ndcounty_number')) %>%
  
  #change adm to numeric
  mutate(ADMPK12=gsub(",","",ADMPK12)) %>%
  mutate(ADMPK12=as.numeric(paste(ADMPK12))) %>%
  
  #group by and sum adm
  group_by(ndcounty_name) %>%
  summarise(data=sum(ADMPK12,na.rm=TRUE)) %>%
  ungroup %>%
  
  rename(location=ndcounty_name) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='County')

############
#STATE DATA
adm_state <- adm_county %>%
  
 mutate(location='North Dakota') %>%
  
  #group by and sum adm
  group_by(location) %>%
  summarise(data=sum(data,na.rm=TRUE)) %>%
  ungroup %>%
  
  mutate(locationtype='State') 

############
#REGION DATA
adm_region <- adm_county %>%
  
  #merge in region ids
  left_join(regionids,by=c('location'='county')) %>%
  
  #group by and sum adm
  group_by(region) %>%
  summarise(data=sum(data,na.rm=TRUE)) %>%
  ungroup %>%
  
  rename(location=region) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='Planning Region')


############
#TRIBAL DATA
tribalschools_updated <- tribalschools %>%
  separate(id_dash,into=c('codist','school'),sep=6) %>%
  distinct(codist,.keep_all=TRUE)


adm_tribal <- financials %>%
  subset(FY==fiscalyear) %>%
  
  #join tribal names
  mutate(Codist=as.character(paste(Codist))) %>%
  left_join(tribalschools_updated,by=c('Codist'='codist')) %>%
  subset(!is.na(tribalarea)) %>%
  
  #change adm to numeric
  mutate(ADMPK12=gsub(",","",ADMPK12)) %>%
  mutate(ADMPK12=as.numeric(paste(ADMPK12))) %>%
  
  #group by and sum adm
  group_by(tribalarea) %>%
  summarise(data=sum(ADMPK12,na.rm=TRUE)) %>%
  ungroup %>%
  
  rename(location=tribalarea) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='Tribal Area')


######################## 
#combine all geographies
adm_all <- adm_county %>%
  bind_rows(adm_state) %>%
  bind_rows(adm_region) %>%
  bind_rows(adm_tribal) %>%
  
  mutate(state='North Dakota') %>%
  mutate(varname='avgdailystudentsperschool') %>%
  mutate(timeframe=fullyear) %>%
  
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) %>%
  
  #create indicators to suppress data

  #supress if denominator is less than 10
  mutate(suppress_denominator=if_else(data<10 | is.na(data),1,0)) %>%
 
  
  mutate(data=as.character(paste(data))) %>%
  mutate(data=case_when(
    suppress_denominator==1  ~ 'NA',
    suppress_denominator==0 ~ data)) %>%
  
  select(c(location,locationtype,locationid,state,timeframe,varname,data)) %>%

  mutate(dataformat='Number')
  


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(adm_all$locationid))>=1) {
  print(adm_all$location[is.na(adm_all$locationid)])
} else if (sum(is.na(adm_all$locationid))==0) {
  'all locations match'
}

# 2. Visually inspect output data
View(adm_all)


```

## STEP 2: COMMIT TO DATABASE 
```{r}
#CHECK DATASET NAMED adm_all TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
dbWriteTable(con,'northdakota',adm_all,append=TRUE,row.names=FALSE)
```

## STEP 3: OUTPUT DATASET FOR UPLOADING TO KC DATA CENTER
```{r}
#########################
##OUTPUT DATA CENTER FILE

datacenter_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM northdakota WHERE timeframe='",fullyear,"' AND varname='avgdailystudentsperschool';")

upload_data <- dbGetQuery(con,datacenter_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/education/northdakota_",year,"_avgdailystudentsperschool.csv"),row.names=FALSE)

```



## ################################################## ##
## AVERAGE EXPENDITURES PER STUDENT IN PUBLIC SCHOOLS ##
## ################################################## ##

## STEP 1: IMPORT THE FINANCIALS DATA
```{r}
#import data
financials <- read.csv(paste0("/Users/xannaburg/Desktop/ND Education/FinancialData_",year,".csv"))

############
#COUNTY DATA
expend_county <- financials %>%
  subset(FY==fiscalyear) %>%
  
  #join county names
  separate(Codist,into=c("county","district"),sep="-") %>%
  mutate(county=as.numeric(paste(county))) %>%
  left_join(countyids,by=c('county'='ndcounty_number')) %>%
  
  #change adm to numeric
  mutate(ADMPK12=gsub(",","",ADMPK12)) %>%
  mutate(ADMPK12=as.numeric(paste(ADMPK12))) %>%
  
  #change expenditure variables to numeric
  mutate(SBTCH=gsub(",","",SBTCH)) %>%
  mutate(SBTCH=as.numeric(paste(SBTCH))) %>%
  
  mutate(SBSUP=gsub(",","",SBSUP)) %>%
  mutate(SBSUP=as.numeric(paste(SBSUP))) %>%
  
  mutate(OTHINS=gsub(",","",OTHINS)) %>%
  mutate(OTHINS=as.numeric(paste(OTHINS))) %>%
  
  mutate(SADMIN=gsub(",","",SADMIN)) %>%
  mutate(SADMIN=as.numeric(paste(SADMIN))) %>%
  
  mutate(GADMIN=gsub(",","",GADMIN)) %>%
  mutate(GADMIN=as.numeric(paste(GADMIN))) %>%
  
  mutate(OMOP=gsub(",","",OMOP)) %>%
  mutate(OMOP=as.numeric(paste(OMOP))) %>%
  
  #group by and sum adm
  group_by(ndcounty_name) %>%
  summarise(data=(sum(SBTCH,na.rm=TRUE)+sum(SBSUP,na.rm=TRUE)+sum(OTHINS,na.rm=TRUE)+sum(SADMIN,na.rm=TRUE)+sum(GADMIN,na.rm=TRUE)+sum(OMOP,na.rm=TRUE))/sum(ADMPK12,na.rm=TRUE)) %>%
  ungroup %>%
  
  rename(location=ndcounty_name) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='County')

############
#STATE DATA
expend_state <- financials %>%
  subset(FY==fiscalyear) %>%
  
  mutate(location='North Dakota') %>%
  
  #change adm to numeric
  mutate(ADMPK12=gsub(",","",ADMPK12)) %>%
  mutate(ADMPK12=as.numeric(paste(ADMPK12))) %>%
  
  #change expenditure variables to numeric
  mutate(SBTCH=gsub(",","",SBTCH)) %>%
  mutate(SBTCH=as.numeric(paste(SBTCH))) %>%
  
  mutate(SBSUP=gsub(",","",SBSUP)) %>%
  mutate(SBSUP=as.numeric(paste(SBSUP))) %>%
  
  mutate(OTHINS=gsub(",","",OTHINS)) %>%
  mutate(OTHINS=as.numeric(paste(OTHINS))) %>%
  
  mutate(SADMIN=gsub(",","",SADMIN)) %>%
  mutate(SADMIN=as.numeric(paste(SADMIN))) %>%
  
  mutate(GADMIN=gsub(",","",GADMIN)) %>%
  mutate(GADMIN=as.numeric(paste(GADMIN))) %>%
  
  mutate(OMOP=gsub(",","",OMOP)) %>%
  mutate(OMOP=as.numeric(paste(OMOP))) %>%
  
  #group by and sum adm
  group_by(location) %>%
  summarise(data=(sum(SBTCH,na.rm=TRUE)+sum(SBSUP,na.rm=TRUE)+sum(OTHINS,na.rm=TRUE)+sum(SADMIN,na.rm=TRUE)+sum(GADMIN,na.rm=TRUE)+sum(OMOP,na.rm=TRUE))/sum(ADMPK12,na.rm=TRUE)) %>%
  ungroup %>%
  
  mutate(locationtype='State')

############
#REGION DATA
expend_region <- financials %>%
  subset(FY==fiscalyear) %>%
  
  #join county names
  separate(Codist,into=c("county","district"),sep="-") %>%
  mutate(county=as.numeric(paste(county))) %>%
  left_join(countyids,by=c('county'='ndcounty_number')) %>%
  
  #join region names
  left_join(regionids,by=c('ndcounty_name'='county')) %>%
  
  #change adm to numeric
  mutate(ADMPK12=gsub(",","",ADMPK12)) %>%
  mutate(ADMPK12=as.numeric(paste(ADMPK12))) %>%
  
  #change expenditure variables to numeric
  mutate(SBTCH=gsub(",","",SBTCH)) %>%
  mutate(SBTCH=as.numeric(paste(SBTCH))) %>%
  
  mutate(SBSUP=gsub(",","",SBSUP)) %>%
  mutate(SBSUP=as.numeric(paste(SBSUP))) %>%
  
  mutate(OTHINS=gsub(",","",OTHINS)) %>%
  mutate(OTHINS=as.numeric(paste(OTHINS))) %>%
  
  mutate(SADMIN=gsub(",","",SADMIN)) %>%
  mutate(SADMIN=as.numeric(paste(SADMIN))) %>%
  
  mutate(GADMIN=gsub(",","",GADMIN)) %>%
  mutate(GADMIN=as.numeric(paste(GADMIN))) %>%
  
  mutate(OMOP=gsub(",","",OMOP)) %>%
  mutate(OMOP=as.numeric(paste(OMOP))) %>%
  
  #group by and sum adm
  group_by(region) %>%
  summarise(data=(sum(SBTCH,na.rm=TRUE)+sum(SBSUP,na.rm=TRUE)+sum(OTHINS,na.rm=TRUE)+sum(SADMIN,na.rm=TRUE)+sum(GADMIN,na.rm=TRUE)+sum(OMOP,na.rm=TRUE))/sum(ADMPK12,na.rm=TRUE)) %>%
  ungroup %>%
  
  rename(location=region) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='Planning Region')


############
#TRIBAL DATA
tribalschools_updated <- tribalschools %>%
  separate(id_dash,into=c('codist','school'),sep=6) %>%
  distinct(codist,.keep_all=TRUE)


expend_tribal <- financials %>%
  subset(FY==fiscalyear) %>%
  
  #join tribal names
  mutate(Codist=as.character(paste(Codist))) %>%
  left_join(tribalschools_updated,by=c('Codist'='codist')) %>%
  subset(!is.na(tribalarea)) %>%
  
  #change adm to numeric
  mutate(ADMPK12=gsub(",","",ADMPK12)) %>%
  mutate(ADMPK12=as.numeric(paste(ADMPK12))) %>%
  
 #change expenditure variables to numeric
  mutate(SBTCH=gsub(",","",SBTCH)) %>%
  mutate(SBTCH=as.numeric(paste(SBTCH))) %>%
  
  mutate(SBSUP=gsub(",","",SBSUP)) %>%
  mutate(SBSUP=as.numeric(paste(SBSUP))) %>%
  
  mutate(OTHINS=gsub(",","",OTHINS)) %>%
  mutate(OTHINS=as.numeric(paste(OTHINS))) %>%
  
  mutate(SADMIN=gsub(",","",SADMIN)) %>%
  mutate(SADMIN=as.numeric(paste(SADMIN))) %>%
  
  mutate(GADMIN=gsub(",","",GADMIN)) %>%
  mutate(GADMIN=as.numeric(paste(GADMIN))) %>%
  
  mutate(OMOP=gsub(",","",OMOP)) %>%
  mutate(OMOP=as.numeric(paste(OMOP))) %>%
  
  #group by and sum adm
  group_by(tribalarea) %>%
  summarise(data=(sum(SBTCH,na.rm=TRUE)+sum(SBSUP,na.rm=TRUE)+sum(OTHINS,na.rm=TRUE)+sum(SADMIN,na.rm=TRUE)+sum(GADMIN,na.rm=TRUE)+sum(OMOP,na.rm=TRUE))/sum(ADMPK12,na.rm=TRUE)) %>%
  ungroup %>%
  
  rename(location=tribalarea) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='Tribal Area')


######################## 
#combine all geographies
expend_all <- expend_county %>%
  bind_rows(expend_state) %>%
  bind_rows(expend_region) %>%
  bind_rows(expend_tribal) %>%
  
  mutate(state='North Dakota') %>%
  mutate(varname='avgexpenditureperstudent') %>%
  mutate(timeframe=fullyear) %>%
  
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) %>%
  
  #create indicators to suppress data

  select(c(location,locationtype,locationid,state,timeframe,varname,data)) %>%

  mutate(dataformat='Currency')
  


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(expend_all$locationid))>=1) {
  print(expend_all$location[is.na(expend_all$locationid)])
} else if (sum(is.na(expend_all$locationid))==0) {
  'all locations match'
}

# 2. Visually inspect output data
View(expend_all)


```

## STEP 2: COMMIT TO DATABASE 
```{r}
#CHECK DATASET NAMED expend_all TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
dbWriteTable(con,'northdakota',expend_all,append=TRUE,row.names=FALSE)
```

## STEP 3: OUTPUT DATASET FOR UPLOADING TO KC DATA CENTER
```{r}
#########################
##OUTPUT DATA CENTER FILE

datacenter_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM northdakota WHERE timeframe='",fullyear,"' AND varname='avgexpenditureperstudent';")

upload_data <- dbGetQuery(con,datacenter_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/education/northdakota_",year,"_avgexpenditureperstudent.csv"),row.names=FALSE)

```



## ############################################ ##
## FOUR-YEAR HIGH SCHOOL COHORT GRADUATION RATE ##
## ############################################ ##

# STEP 1: IMPORT AND CLEAN DATA
```{r}
#import data
grad_data <- read_excel(path=paste0("/Users/xannaburg/Desktop/ND Education/Grad_Rates_",year,".xlsx"),guess_max = 1048576) %>%
  rename(ontime_Count='On-Time Grads',
         Total_Students='Cohort')


############
#COUNTY DATA
grad_county <- grad_data %>%
  
  subset(Entity_Level=='District') %>%
  separate(col=Entity_ID,into=c('county','district'),sep=2) %>%
  mutate(county=as.numeric(paste(county))) %>%
  
  #import county name
  full_join(countyids,by=c("county"="ndcounty_number")) %>%

  #sum by county
  group_by(ndcounty_name) %>%
  summarise(grad_number=sum(ontime_Count),
            totalenroll=sum(Total_Students),
            grad_percent=sum(ontime_Count)/sum(Total_Students)) %>%
  ungroup %>%

  #add in locationtype
  rename(location=ndcounty_name) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='County')

###########
#STATE DATA
#start with  cleaned county data
grad_state <- grad_county %>%
  mutate(location='North Dakota') %>%
  group_by(location) %>%
  summarise(grad_number_state=sum(grad_number,na.rm=TRUE),
            totalenroll_state=sum(totalenroll,na.rm=TRUE),
            grad_percent=sum(grad_number,na.rm=TRUE)/sum(totalenroll,na.rm=TRUE)) %>%
  ungroup %>%
  rename(grad_number=grad_number_state,
         totalenroll=totalenroll_state) %>%

  #add in locationtype
  mutate(locationtype='State')

############
#REGION DATA
#start with cleaned county data
grad_region <- grad_county %>%
  
  #add in regions
  mutate(location=as.character(paste(location))) %>%
  left_join(regionids,by=c('location'='county')) %>%
  group_by(region) %>%
  summarise(grad_number_region=sum(grad_number,na.rm=TRUE),
            totalenroll_region=sum(totalenroll,na.rm=TRUE),
            grad_percent=sum(grad_number,na.rm=TRUE)/sum(totalenroll,na.rm=TRUE)) %>%
  ungroup %>%
  rename(grad_number=grad_number_region,
         totalenroll=totalenroll_region) %>%

  #add in locationtype
  rename(location=region) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='Planning Region')


#################
#TRIBAL AREA DATA
#subset tribal schools lookup table to just county and district
tribalschools_updated <- tribalschools %>%
  separate(col=id_nodash,into=c('first','last'),sep=5)

grad_tribal <- grad_data %>%
  
  subset(Entity_Level=='District') %>%
  
  #import tribal name
  left_join(tribalschools_updated,by=c('Entity_ID'='first')) %>%
  subset(!is.na(tribalarea)) %>%

  #sum by tribal area
  group_by(tribalarea) %>%
  summarise(grad_number=sum(ontime_Count),
            totalenroll=sum(Total_Students),
            grad_percent=sum(ontime_Count)/sum(Total_Students)) %>%
  ungroup %>%

  #add in locationtype
  rename(location=tribalarea) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='Tribal Area')
  
######################## 
#combine all geographies
grad_all <- grad_county %>%
  bind_rows(grad_state) %>%
  bind_rows(grad_region) %>%
  bind_rows(grad_tribal) %>%
  
  mutate(state='North Dakota') %>%
  mutate(varname='graduationrate4cohort') %>%
  mutate(timeframe=fullyear) %>%
  
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) %>%
  
  #create indicators to suppress data

  #supress if denominator is less than 10
  mutate(suppress_denominator=if_else(totalenroll<10 | is.na(totalenroll),1,0)) %>%
 
  #suppress percentages of 0-1 if more than 300 in denominator
  mutate(suppress_0to1_300=if_else(totalenroll>300 & grad_percent<=.01,1,0)) %>%
  #suppress percentages of 99-100 if more than 300 in denominator
  mutate(suppress_99to100_300=if_else(totalenroll>300 & grad_percent>=.99,1,0)) %>%

  
  #suppress percentages of 0-2 if between 101 to 300 in denominator
  mutate(suppress_0to2_101=if_else((totalenroll>100 & totalenroll<=300) & 
                                     grad_percent<=0.02,1,0)) %>%
  #suppress percentages of 98-100 if between 101 to 300 in denominator
  mutate(suppress_98to100_101=if_else((totalenroll>100 & totalenroll<=300) & 
                                     grad_percent>=0.98,1,0)) %>%
  
  #suppress percentages of 0-5 if between 41 to 100 in denominator
  mutate(suppress_0to5_41=if_else((totalenroll>40 & totalenroll<=100) & 
                                     grad_percent<=0.05,1,0)) %>%
  #suppress percentages of 95-100 if between 41 to 100 in denominator
  mutate(suppress_95to100_41=if_else((totalenroll>40 & totalenroll<=100) & 
                                     grad_percent>=0.95,1,0)) %>%
  
  #suppress percentages of 0-10 if between 21 to 40 in denominator
  mutate(suppress_0to10_21=if_else((totalenroll>20 & totalenroll<=40) & 
                                     grad_percent<=0.10,1,0)) %>%
  #suppress percentages of 90-100 if between 21 to 40 in denominator
  mutate(suppress_90to100_21=if_else((totalenroll>20 & totalenroll<=40) & 
                                     grad_percent>=0.90,1,0)) %>%
  
  #suppress percentages of 0-20 if between 10 to 20 in denominator
  mutate(suppress_0to20_10=if_else((totalenroll>=10 & totalenroll<=20) & 
                                     grad_percent<=0.20,1,0)) %>%
  #suppress percentages of 80-100 if between 10 to 20 in denominator
  mutate(suppress_80to100_10=if_else((totalenroll>=10 & totalenroll<=20) & 
                                     grad_percent>=0.80,1,0)) %>%
  
  #create updated percent and number based on suppression rules
  mutate(grad_percent=as.character(paste(grad_percent))) %>%
  mutate(grad_percent_suppressed=case_when(
    suppress_denominator==1 ~ 'NA',
    suppress_0to1_300==1 ~ "<= 1%",
    suppress_99to100_300==1 ~ ">= 99%",
    suppress_0to2_101==1 ~ "<= 2%",
    suppress_98to100_101==1 ~ ">= 98%",
    suppress_0to5_41==1 ~ "<= 5%",
    suppress_95to100_41==1 ~ ">= 95%",
    suppress_0to10_21==1 ~ "<= 10%",
    suppress_90to100_21==1 ~ ">= 90%",
    suppress_0to20_10==1 ~ "<= 20%",
    suppress_80to100_10==1 ~ ">= 80%",
    suppress_denominator==0 & suppress_0to1_300==0 & suppress_99to100_300==0 & 
      suppress_0to2_101==0 & suppress_98to100_101==0 & 
      suppress_0to5_41==0 & suppress_95to100_41==0 & 
      suppress_0to10_21==0 & suppress_90to100_21==0 & 
      suppress_0to20_10==0 & suppress_80to100_10==0 ~ grad_percent)) %>%
  
  mutate(grad_number=as.character(paste(grad_number))) %>%
  mutate(grad_number_suppressed=case_when(
    suppress_denominator==1 | suppress_0to1_300==1 | suppress_99to100_300==1 | 
    suppress_0to2_101==1 |  suppress_98to100_101==1 |  suppress_0to5_41==1 | 
    suppress_95to100_41==1 | suppress_0to10_21==1 | suppress_90to100_21==1 | 
    suppress_0to20_10==1 |   suppress_80to100_10==1 ~ 'NA',
    suppress_denominator==0 & suppress_0to1_300==0 & suppress_99to100_300==0 & 
      suppress_0to2_101==0 & suppress_98to100_101==0 & 
      suppress_0to5_41==0 & suppress_95to100_41==0 & 
      suppress_0to10_21==0 & suppress_90to100_21==0 & 
      suppress_0to20_10==0 & suppress_80to100_10==0 ~ grad_number)) %>%
  
  select(c(location,locationtype,locationid,state,timeframe,varname,grad_percent_suppressed)) %>%
  
  rename(data=grad_percent_suppressed) %>%
  mutate(dataformat='Percent')
  


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(grad_all$locationid))>=1) {
  print(grad_all$location[is.na(grad_all$locationid)])
} else if (sum(is.na(grad_all$locationid))==0) {
  'all locations match'
}

# 2. Output cases where percent data is greater than 1
temp_percheck <- grad_all %>%
  subset(dataformat=='Percent' & data>1 & is.na(data))
temp_rows <- as.numeric(nrow(temp_percheck))

if (temp_rows==0) {
  'no percents greater than 1'
} else if (temp_rows>=1) {
  print(temp_percheck)
}

# 3. Visually inspect output data
View(grad_all)

```

## STEP 2: COMMIT TO DATABASE 
```{r}
#CHECK DATASET NAMED grad_all TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
dbWriteTable(con,'northdakota',grad_all,append=TRUE,row.names=FALSE)
```

## STEP 3: OUTPUT DATASET FOR UPLOADING TO KC DATA CENTER
```{r}
#########################
##OUTPUT DATA CENTER FILE

datacenter_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM northdakota WHERE timeframe='",fullyear,"' AND varname='graduationrate4cohort';")

upload_data <- dbGetQuery(con,datacenter_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/education/northdakota_",year,"_graduationrate4cohort.csv"),row.names=FALSE)

```



## ################################## ##
## GRADES 7 TO 12 EVENT DROP-OUT RATE ##
## ################################## ##

# STEP 1: IMPORT AND CLEAN DATA
```{r}
#import data
dropout_data <- read_excel(path=paste0("/Users/xannaburg/Desktop/ND Education/Dropout_Rates_7th-12th_",year,".xlsx"),guess_max = 1048576)


############
#COUNTY DATA
dropout_county <- dropout_data %>%
  
  subset(Entity_Level=='District') %>%
  separate(col=Entity_ID,into=c('county','district'),sep=2) %>%
  mutate(county=as.numeric(paste(county))) %>%
  
  #import county name
  full_join(countyids,by=c("county"="ndcounty_number")) %>%

  #sum by county
  group_by(ndcounty_name,Academic_Year) %>%
  summarise(dropout_number=sum(Dropout_Count),
            totalenroll=sum(Total_Students),
            dropout_percent=sum(Dropout_Count)/sum(Total_Students)) %>%
  ungroup %>%

  #add in locationtype
  rename(location=ndcounty_name) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='County')

###########
#STATE DATA
#start with  cleaned county data
dropout_state <- dropout_county %>%
  mutate(location='North Dakota') %>%
  group_by(location,Academic_Year) %>%
  summarise(dropout_number_state=sum(dropout_number,na.rm=TRUE),
            totalenroll_state=sum(totalenroll,na.rm=TRUE),
            dropout_percent=sum(dropout_number,na.rm=TRUE)/sum(totalenroll,na.rm=TRUE)) %>%
  ungroup %>%
  rename(dropout_number=dropout_number_state,
         totalenroll=totalenroll_state) %>%

  #add in locationtype
  mutate(locationtype='State')

############
#REGION DATA
#start with cleaned county data
dropout_region <- dropout_county %>%
  
  #add in regions
  mutate(location=as.character(paste(location))) %>%
  left_join(regionids,by=c('location'='county')) %>%
  group_by(region,Academic_Year) %>%
  summarise(dropout_number_region=sum(dropout_number,na.rm=TRUE),
            totalenroll_region=sum(totalenroll,na.rm=TRUE),
            dropout_percent=sum(dropout_number,na.rm=TRUE)/sum(totalenroll,na.rm=TRUE)) %>%
  ungroup %>%
  rename(dropout_number=dropout_number_region,
         totalenroll=totalenroll_region) %>%

  #add in locationtype
  rename(location=region) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='Planning Region')


#################
#TRIBAL AREA DATA
#subset tribal schools lookup table to just county and district
tribalschools_updated <- tribalschools %>%
  separate(col=id_nodash,into=c('first','last'),sep=5)

dropout_tribal <- dropout_data %>%
  
  subset(Entity_Level=='District') %>%
  
  #import tribal name
  left_join(tribalschools_updated,by=c('Entity_ID'='first')) %>%
  subset(!is.na(tribalarea)) %>%

  #sum by tribal area
  group_by(tribalarea,Academic_Year) %>%
  summarise(dropout_number=sum(Dropout_Count),
            totalenroll=sum(Total_Students),
            dropout_percent=sum(Dropout_Count)/sum(Total_Students)) %>%
  ungroup %>%

  #add in locationtype
  rename(location=tribalarea) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='Tribal Area')
  
######################## 
#combine all geographies
dropout_all <- dropout_county %>%
  bind_rows(dropout_state) %>%
  bind_rows(dropout_region) %>%
  bind_rows(dropout_tribal) %>%
  
  mutate(state='North Dakota') %>%
  mutate(varname='grades7to12eventdropoutrate') %>%
  mutate(timeframe=fullyear) %>%

  
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) %>%
  
  #create indicators to suppress data

  #supress if denominator is less than 10
  mutate(suppress_denominator=if_else(totalenroll<10 | is.na(totalenroll),1,0)) %>%
 
  #suppress percentages of 0-1 if more than 300 in denominator
  mutate(suppress_0to1_300=if_else(totalenroll>300 & dropout_percent<=.01,1,0)) %>%
  #suppress percentages of 99-100 if more than 300 in denominator
  mutate(suppress_99to100_300=if_else(totalenroll>300 & dropout_percent>=.99,1,0)) %>%

  
  #suppress percentages of 0-2 if between 101 to 300 in denominator
  mutate(suppress_0to2_101=if_else((totalenroll>100 & totalenroll<=300) & 
                                     dropout_percent<=0.02,1,0)) %>%
  #suppress percentages of 98-100 if between 101 to 300 in denominator
  mutate(suppress_98to100_101=if_else((totalenroll>100 & totalenroll<=300) & 
                                     dropout_percent>=0.98,1,0)) %>%
  
  #suppress percentages of 0-5 if between 41 to 100 in denominator
  mutate(suppress_0to5_41=if_else((totalenroll>40 & totalenroll<=100) & 
                                     dropout_percent<=0.05,1,0)) %>%
  #suppress percentages of 95-100 if between 41 to 100 in denominator
  mutate(suppress_95to100_41=if_else((totalenroll>40 & totalenroll<=100) & 
                                     dropout_percent>=0.95,1,0)) %>%
  
  #suppress percentages of 0-10 if between 21 to 40 in denominator
  mutate(suppress_0to10_21=if_else((totalenroll>20 & totalenroll<=40) & 
                                     dropout_percent<=0.10,1,0)) %>%
  #suppress percentages of 90-100 if between 21 to 40 in denominator
  mutate(suppress_90to100_21=if_else((totalenroll>20 & totalenroll<=40) & 
                                     dropout_percent>=0.90,1,0)) %>%
  
  #suppress percentages of 0-20 if between 10 to 20 in denominator
  mutate(suppress_0to20_10=if_else((totalenroll>=10 & totalenroll<=20) & 
                                     dropout_percent<=0.20,1,0)) %>%
  #suppress percentages of 80-100 if between 10 to 20 in denominator
  mutate(suppress_80to100_10=if_else((totalenroll>=10 & totalenroll<=20) & 
                                     dropout_percent>=0.80,1,0)) %>%
  
  #create updated percent and number based on suppression rules
  mutate(dropout_percent=as.character(paste(dropout_percent))) %>%
  mutate(dropout_percent_suppressed=case_when(
    suppress_denominator==1 ~ 'NA',
    suppress_0to1_300==1 ~ "<= 1%",
    suppress_99to100_300==1 ~ ">= 99%",
    suppress_0to2_101==1 ~ "<= 2%",
    suppress_98to100_101==1 ~ ">= 98%",
    suppress_0to5_41==1 ~ "<= 5%",
    suppress_95to100_41==1 ~ ">= 95%",
    suppress_0to10_21==1 ~ "<= 10%",
    suppress_90to100_21==1 ~ ">= 90%",
    suppress_0to20_10==1 ~ "<= 20%",
    suppress_80to100_10==1 ~ ">= 80%",
    suppress_denominator==0 & suppress_0to1_300==0 & suppress_99to100_300==0 & 
      suppress_0to2_101==0 & suppress_98to100_101==0 & 
      suppress_0to5_41==0 & suppress_95to100_41==0 & 
      suppress_0to10_21==0 & suppress_90to100_21==0 & 
      suppress_0to20_10==0 & suppress_80to100_10==0 ~ dropout_percent)) %>%
  
  mutate(dropout_number=as.character(paste(dropout_number))) %>%
  mutate(dropout_number_suppressed=case_when(
    suppress_denominator==1 | suppress_0to1_300==1 | suppress_99to100_300==1 | 
    suppress_0to2_101==1 |  suppress_98to100_101==1 |  suppress_0to5_41==1 | 
    suppress_95to100_41==1 | suppress_0to10_21==1 | suppress_90to100_21==1 | 
    suppress_0to20_10==1 |   suppress_80to100_10==1 ~ 'NA',
    suppress_denominator==0 & suppress_0to1_300==0 & suppress_99to100_300==0 & 
      suppress_0to2_101==0 & suppress_98to100_101==0 & 
      suppress_0to5_41==0 & suppress_95to100_41==0 & 
      suppress_0to10_21==0 & suppress_90to100_21==0 & 
      suppress_0to20_10==0 & suppress_80to100_10==0 ~ dropout_number)) %>%
  
  select(c(location,locationtype,locationid,state,timeframe,varname,dropout_percent_suppressed)) %>%
  
  rename(data=dropout_percent_suppressed) %>%
  mutate(dataformat='Percent')
  


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(dropout_all$locationid))>=1) {
  print(dropout_all$location[is.na(dropout_all$locationid)])
} else if (sum(is.na(dropout_all$locationid))==0) {
  'all locations match'
}

# 2. Output cases where percent data is greater than 1
temp_percheck <- dropout_all %>%
  subset(dataformat=='Percent' & data>1 & is.na(data))
temp_rows <- as.numeric(nrow(temp_percheck))

if (temp_rows==0) {
  'no percents greater than 1'
} else if (temp_rows>=1) {
  print(temp_percheck)
}

# 3. Visually inspect output data
View(dropout_all)

```

## STEP 2: COMMIT TO DATABASE 
```{r}
#CHECK DATASET NAMED dropout_all TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
dbWriteTable(con,'northdakota',dropout_all,append=TRUE,row.names=FALSE)
```

## STEP 3: OUTPUT DATASET FOR UPLOADING TO KC DATA CENTER
```{r}
#########################
##OUTPUT DATA CENTER FILE

datacenter_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM northdakota WHERE timeframe='",fullyear,"' AND varname='grades7to12eventdropoutrate';")

upload_data <- dbGetQuery(con,datacenter_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/education/northdakota_",year,"_grades7to12eventdropoutrate.csv"),row.names=FALSE)

```

