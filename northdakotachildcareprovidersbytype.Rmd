---
title: "Child Care Providers by Type"
author: "Xanna Burg"
date: "2/10/2020"
output: html_document
---

## Indicator 1: Child Care Providers by Type
## Indicator 2: Child Care Capacity by Type
**Created by:** Xanna Burg
**Date:** February, 2020
**Updated by:**

**Data Source:** North Dakota Department of Human Services 
**Purpose:** Clean the child care data provided by the Department of Human Services and update KIDS COUNT data for North Dakota.
**Description:** this program calculates two indicators 
**Child care providers by type for statewide, county, and state planning regions**
**Child care capacity by type for statewide, county, and state planning regions**
* Types: categories of child care providers include: Licensed, Standard Compliance Certification (SCC) and In-Home, Registered Tribal, Approved Relative
* Geographies: state total, county, state planning regions (where applicable, which are groups of counties)
* Number - count of child care centers, sum of child care capacity
* Percent - For child care capacity, the percent calculates the percent of capacity out of the number of children 0-13 for all parents working (ACS). [Numerator: child care capacity, Denominator: childrent 0-13 with all parents working from ACS **two years prior**] 

**Data format:** final output csv to upload is in long format with the following variables: Location (character: name of location), Category (character), TimeFrame (numeric: year), Data (numeric: number or percentage), DataFormat (character: "number" or "percent"), LocationId (numeric: assigned for KIDS COUNT system)


```{r,message=FALSE}
#load required packages
library(tidyverse)
library(RPostgreSQL)

```

```{r}
#UPDATE to reflect the current year data working with
year <- '2020'
state <- 'northdakota'
```

```{r}

#read in the most recent year of child care data
child_data <- read.csv(paste0("./Input/education/northdakota_",year,"_childcaredata.csv"))

#read in the codes for county name
countymatch <- read.csv("./Documentation/Indicator Documentation/childcareproviders/ND County Codes.csv")

#create dataset to match the provider type
provider_code <- c('C','E','F','G','H','I','K','M','P','Q','R','S','Z')
provider_name <- c('Child Care Center','Preschool','Family Child Care',
             'Group Child Care in a home','Group Child Care in a facility',
             'In-home registered provider','School Age Care',
             'Multiple License (most often center and Preschool)',
             'Early Head Start-Child Care Partnerships','Approved Relative',
             'Tribal Registration','Self Certification Affidavit',
             'Early Head Start-Child Care Partnerships')
providertype <- data.frame(provider_code,provider_name)


#read in a blank shell for provider type and county data
#this is to account for the fact that some combinations will be 0
county_type <- read.csv("./Documentation/Indicator Documentation/childcareproviders/ND County Type Full List.csv")

#input location ID file for ND
locationids <- read.csv("./Input/ND KC Location IDs.csv")

```

```{r}
#merge in full names for coded variables
child_data_2 <- child_data %>%
  left_join(countymatch,by=c('Provider.county'='ndcounty_number')) %>%
  left_join(providertype, by=c('Provider.Type'='provider_code')) %>%
  select(-Provider.county) %>%
  rename(county=ndcounty_name,
         providertype_name=provider_name,
         providertype=Provider.Type,
         capacity=Max...Children)

#create new variable matching type on KC data center
child_data_2 <- child_data_2 %>% mutate(providertype_group = case_when(
  providertype=='C' | providertype=='E' | providertype=='F' | providertype=='G' | 
    providertype=='H' | providertype=='K' | providertype=='M' ~ 'Licensed',
  providertype=='S' | 
    providertype=='I' ~ 'Standard Compliance Certification (SCC) and In-Home',
  providertype=='R' ~ 'Registered Tribal',
  providertype=='Q' ~ 'Approved Relative',
  providertype=='P' | providertype=='Z' ~ 'Early Head Start-Child Care Partnerships'
))

```


```{r}
####CREATE STATEWIDE SUMMARY COUNT OF CHILD CARE
statesums <- child_data_2 %>%
  group_by(providertype_group) %>%
  summarise(count=n()) %>%
  mutate(location='North Dakota')

#left merge with full list in order to capture when 0 occurs
location <- c('North Dakota','North Dakota','North Dakota','North Dakota')
category <- c('Licensed','Standard Compliance Certification (SCC) and In-Home','Registered Tribal',
         'Approved Relative')
stateshell <- data.frame(location,category)

statesums_full <- stateshell %>%
  left_join(statesums,by=c('location'='location',
                           'category'='providertype_group')) %>%
  mutate(count = replace_na(count,0)) %>%
  mutate(locationtype='State')

####CREATE COUNTY SUMMARY COUNT OF CHILD CARE
countysums <- child_data_2 %>%
  drop_na(county) %>%
  group_by(county,providertype_group) %>%
  summarise(count = n())

#left merge with blank shell in order to capture when 0 occurs
countysums_full <- county_type %>% 
  left_join(countysums,by=c('ndcounty_name'='county',
                            'providertype_group'='providertype_group')) %>%
  mutate(count = replace_na(count, 0)) %>%
  rename(location=ndcounty_name,
         category=providertype_group) %>%
  mutate(locationtype='County')



####CREATE STATE PLANNING REGIONS SUMMARY COUNT OF CHILD CARE
child_data_3 <- child_data_2 %>% mutate(region = case_when(
  county=="Divide" | county=="McKenzie" | county=="Williams" ~
    "Planning Region 1",
  county=="Bottineau" | county=="Burke" | county=="McHenry" | 
    county=="Mountrail" | county=="Pierce" | county=="Pierce" | 
    county=="Renville" | county=="Ward" ~ "Planning Region 2",
  county=="Benson" | county=="Cavalier" | county=="Eddy" | 
    county=="Ramsey" | county=="Rolette" | county=="Towner"~
    "Planning Region 3",
  county=="Grand Forks" | county=="Nelson" | county=="Pembina" | 
    county=="Walsh" ~ "Planning Region 4",
  county=="Cass" | county=="Ransom" | county=="Richland" | 
    county=="Sargent" | county=="Steele" | county=="Traill" ~ 
    "Planning Region 5",
  county=="Barnes"| county=="Dickey" | county=="Foster" | 
    county=="Griggs" | county=="LaMoure" | county=="Logan" | 
    county=="McIntosh" | county=="Stutsman" | county=="Wells" ~ 
    "Planning Region 6",
  county=="Burleigh" | county=="Emmons" | county=="Grant" | 
    county=="Kidder" | county=="McLean" | county=="Mercer" | 
    county=="Morton" | county=="Oliver" | county=="Sheridan" |
    county=="Sioux" ~ "Planning Region 7",
  county=="Adams" | county=="Billings" | county=="Bowman" | 
    county=="Dunn" | county=="Golden Valley" | county=="Hettinger" | 
    county=="Slope" | county=="Stark" ~ "Planning Region 8"
))

regionsums <- child_data_3 %>%
  drop_na(region) %>%
  group_by(region,providertype_group) %>%
  summarise(count = n())

#left merge with blank shell in order to capture when 0 occurs
location <- c('Planning Region 1','Planning Region 1','Planning Region 1',
              'Planning Region 1',
              'Planning Region 2','Planning Region 2','Planning Region 2',
              'Planning Region 2',
              'Planning Region 3','Planning Region 3','Planning Region 3',
              'Planning Region 3',
              'Planning Region 4','Planning Region 4','Planning Region 4',
              'Planning Region 4',
              'Planning Region 5','Planning Region 5','Planning Region 5',
              'Planning Region 5',
              'Planning Region 6','Planning Region 6','Planning Region 6',
              'Planning Region 6',
              'Planning Region 7','Planning Region 7','Planning Region 7',
              'Planning Region 7',
              'Planning Region 8','Planning Region 8','Planning Region 8',
              'Planning Region 8')
category <- c('Licensed','Standard Compliance Certification (SCC) and In-Home',
              'Registered Tribal','Approved Relative',
              'Licensed','Standard Compliance Certification (SCC) and In-Home',
              'Registered Tribal','Approved Relative',
              'Licensed','Standard Compliance Certification (SCC) and In-Home',
              'Registered Tribal','Approved Relative',
              'Licensed','Standard Compliance Certification (SCC) and In-Home',
              'Registered Tribal','Approved Relative',
              'Licensed','Standard Compliance Certification (SCC) and In-Home',
              'Registered Tribal','Approved Relative',
              'Licensed','Standard Compliance Certification (SCC) and In-Home',
              'Registered Tribal','Approved Relative',
              'Licensed','Standard Compliance Certification (SCC) and In-Home',
              'Registered Tribal','Approved Relative',
              'Licensed','Standard Compliance Certification (SCC) and In-Home',
              'Registered Tribal','Approved Relative')
regionshell <- data.frame(location,category)



regionsums_full <- regionshell %>% 
  left_join(regionsums,by=c('location'='region',
                            'category'='providertype_group')) %>%
  mutate(count = replace_na(count, 0)) %>%
  mutate(locationtype='Planning Region')

```

```{r}
#format to database count child care
childcareprovidersbytype <- countysums_full %>%
  bind_rows(statesums_full) %>%
  bind_rows(regionsums_full) %>%
  rename(data=count) %>%
  mutate(state='North Dakota') %>%
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) %>%
  mutate(timeframe=as.numeric(year)) %>%
  mutate(dataformat='Number') %>%
  mutate(varname='childcareprovidersbytype')
```

```{r}
#add to database count of child care
dbWriteTable(con,'northdakota',childcareprovidersbytype,append=TRUE,row.names=FALSE)

```

```{r}
#write query from database to get needed format for KC data center
#COUNT OF CHILD CARE

upload_data <- dbGetQuery(con,"SELECT locationid,location,category,timeframe,dataformat,data
                     FROM northdakota
                     WHERE timeframe = '2020' AND varname = 'childcareprovidersbytype';")

upload_data2 <- upload_data %>%
  rename(LocationId=locationid,
         Location=location,
         Category=category,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data2,file=paste0("./Output/education/",state,"_",year,"_childcareprovidersbytype.csv"),row.names=FALSE)

```




```{r}
####CREATE STATEWIDE SUMMARY FOR CAPACITY
statesums_capacity <- child_data_2 %>%
  group_by(providertype_group) %>%
  summarise(count=sum(capacity)) %>%
  mutate(location='North Dakota')

#left merge with full list in order to capture when 0 occurs
location <- c('North Dakota','North Dakota','North Dakota','North Dakota')
category <- c('Licensed','Standard Compliance Certification (SCC) and In-Home','Registered Tribal',
         'Approved Relative')
stateshell <- data.frame(location,category)

statesums_full_capacity <- stateshell %>%
  left_join(statesums_capacity,by=c('location'='location',
                           'category'='providertype_group')) %>%
  mutate(count = replace_na(count,0)) %>%
  mutate(locationtype='State')

####CREATE COUNTY SUMMARY FOR CAPACITY
countysums_capacity <- child_data_2 %>%
  drop_na(county) %>%
  group_by(county,providertype_group) %>%
  summarise(count = sum(capacity))

#left merge with blank shell in order to capture when 0 occurs
countysums_full_capacity <- county_type %>% 
  left_join(countysums_capacity,by=c('ndcounty_name'='county',
                            'providertype_group'='providertype_group')) %>%
  mutate(count = replace_na(count, 0)) %>%
  rename(location=ndcounty_name,
         category=providertype_group) %>%
  mutate(locationtype='County')



####CREATE STATE PLANNING REGIONS SUMMARY FOR CAPACITY
child_data_3 <- child_data_2 %>% mutate(region = case_when(
  county=="Divide" | county=="McKenzie" | county=="Williams" ~
    "Planning Region 1",
  county=="Bottineau" | county=="Burke" | county=="McHenry" | 
    county=="Mountrail" | county=="Pierce" | county=="Pierce" | 
    county=="Renville" | county=="Ward" ~ "Planning Region 2",
  county=="Benson" | county=="Cavalier" | county=="Eddy" | 
    county=="Ramsey" | county=="Rolette" | county=="Towner"~
    "Planning Region 3",
  county=="Grand Forks" | county=="Nelson" | county=="Pembina" | 
    county=="Walsh" ~ "Planning Region 4",
  county=="Cass" | county=="Ransom" | county=="Richland" | 
    county=="Sargent" | county=="Steele" | county=="Traill" ~ 
    "Planning Region 5",
  county=="Barnes"| county=="Dickey" | county=="Foster" | 
    county=="Griggs" | county=="LaMoure" | county=="Logan" | 
    county=="McIntosh" | county=="Stutsman" | county=="Wells" ~ 
    "Planning Region 6",
  county=="Burleigh" | county=="Emmons" | county=="Grant" | 
    county=="Kidder" | county=="McLean" | county=="Mercer" | 
    county=="Morton" | county=="Oliver" | county=="Sheridan" |
    county=="Sioux" ~ "Planning Region 7",
  county=="Adams" | county=="Billings" | county=="Bowman" | 
    county=="Dunn" | county=="Golden Valley" | county=="Hettinger" | 
    county=="Slope" | county=="Stark" ~ "Planning Region 8"
))

regionsums_capacity <- child_data_3 %>%
  drop_na(region) %>%
  group_by(region,providertype_group) %>%
  summarise(count = sum(capacity))

#left merge with blank shell in order to capture when 0 occurs
location <- c('Planning Region 1','Planning Region 1','Planning Region 1',
              'Planning Region 1',
              'Planning Region 2','Planning Region 2','Planning Region 2',
              'Planning Region 2',
              'Planning Region 3','Planning Region 3','Planning Region 3',
              'Planning Region 3',
              'Planning Region 4','Planning Region 4','Planning Region 4',
              'Planning Region 4',
              'Planning Region 5','Planning Region 5','Planning Region 5',
              'Planning Region 5',
              'Planning Region 6','Planning Region 6','Planning Region 6',
              'Planning Region 6',
              'Planning Region 7','Planning Region 7','Planning Region 7',
              'Planning Region 7',
              'Planning Region 8','Planning Region 8','Planning Region 8',
              'Planning Region 8')
category <- c('Licensed','Standard Compliance Certification (SCC) and In-Home',
              'Registered Tribal','Approved Relative',
              'Licensed','Standard Compliance Certification (SCC) and In-Home',
              'Registered Tribal','Approved Relative',
              'Licensed','Standard Compliance Certification (SCC) and In-Home',
              'Registered Tribal','Approved Relative',
              'Licensed','Standard Compliance Certification (SCC) and In-Home',
              'Registered Tribal','Approved Relative',
              'Licensed','Standard Compliance Certification (SCC) and In-Home',
              'Registered Tribal','Approved Relative',
              'Licensed','Standard Compliance Certification (SCC) and In-Home',
              'Registered Tribal','Approved Relative',
              'Licensed','Standard Compliance Certification (SCC) and In-Home',
              'Registered Tribal','Approved Relative',
              'Licensed','Standard Compliance Certification (SCC) and In-Home',
              'Registered Tribal','Approved Relative')
regionshell <- data.frame(location,category)



regionsums_full_capacity <- regionshell %>% 
  left_join(regionsums_capacity,by=c('location'='region',
                            'category'='providertype_group')) %>%
  mutate(count = replace_na(count, 0)) %>%
  mutate(locationtype='Planning Region')

```


```{r}
#format to database
childcarecapacitybytype <- countysums_full_capacity %>%
  bind_rows(statesums_full_capacity) %>%
  bind_rows(regionsums_full_capacity) %>%
  rename(data=count) %>%
  mutate(state='North Dakota') %>%
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) %>%
  mutate(timeframe=as.numeric(year)) %>%
  mutate(dataformat='Number') %>%
  mutate(varname='childcarecapacitybytype')
```

```{r}
#add to database
dbWriteTable(con,'northdakota',childcarecapacitybytype,append=TRUE,row.names=FALSE)

```

```{r}
#create percentages using ACS data in database
#variable needed for denominator calculation is childrenages0to13parentsinlaborforce
#need denominator variable for two years prior
year_minus2 <- as.character(as.numeric(year)-2)

children_estimates <- dbGetQuery(con,"SELECT locationid,data
                                 FROM northdakota
                                 WHERE timeframe='2018' AND 
                                 varname='childrenages0to13parentsinlaborforce' AND 
                                 dataformat='Number' AND 
                                 age_group='0 to 13';")

children_estimates <- children_estimates %>%
  rename(children_estimate=data)

childcarecapacitybytype2 <- childcarecapacitybytype %>%
  rename(childcare_estimate=data) %>%
  mutate(dataformat='Percent')

childcare_percents <- childcarecapacitybytype2 %>%
  full_join(children_estimates,by='locationid') %>%
  mutate(data=(childcare_estimate/children_estimate))

```

```{r}
#format to database
childcarecapacitybytype_percent <- childcare_percents %>%
  mutate(state='North Dakota') %>%
  select(-children_estimate) %>%
  select(-childcare_estimate)
  
```

```{r}
#add to database
dbWriteTable(con,'northdakota',childcarecapacitybytype_percent,append=TRUE,row.names=FALSE)

```



```{r}
#write query from database to get needed format for KC data center

upload_data_capacity <- dbGetQuery(con,"SELECT locationid,location,category,timeframe,dataformat,data
                     FROM northdakota
                     WHERE timeframe = '2020' AND varname = 'childcarecapacitybytype';")

upload_data2_capacity <- upload_data_capacity %>%
  rename(LocationId=locationid,
         Location=location,
         Category=category,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data2_capacity,file=paste0("./Output/education/",state,"_",year,"_childcarecapacitybytype.csv"),row.names=FALSE)



```

