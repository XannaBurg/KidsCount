---
title: "Montana Child Care Data"
author: "Xanna Burg"
date: "September 2020"
output: html_document
---

## Indicator 1: Children receiving Best Beginnings Child Care Scholarship (child care assistance)
## Indicator 2: Licensed child care facilities by STARS level
## Indicator 3: Licensed child care capacity by STARS level
## Indicator 4: Licensed child care capacity meeting STAR level 3 or higher
## Indicator 5: Median wage for child care workers

**Created by:** Xanna Burg
**Date:** September 2020
**Updated by:**

**Data Source:** Montana Department of Public Health and Human Services, Early Childhood and Family Services Bureau
**Purpose:** Clean and process the public assistance data requested from DPHHS into correct format for Kids Count Data Center.

**Data format:** Final output csv to upload is in long format with the following variables: Location (character: name of location), TimeFrame (text: years), Data (numeric: number, percentage), DataFormat, LocationId (numeric: assigned for KIDS COUNT system)


**To use this code for a new year:**
* Update the year in the second code chunk for variable 'year'
* Check each dataset visually and through the report logs prior to commiting to the database.

* NOTE: the montanachildcare_raw.Rmd must be run first to create the summary files that DPHHS used to send.



```{r,message=FALSE}
#load required packages
library(tidyverse)
library(RPostgreSQL)
library(readxl)
library(naniar)
library(stringr)
```


```{r}

####UPDATE to reflect the current year data working with
year <- '2025'
statename <- 'Montana'


#run this code to create an object needed for the database (DO NOT EDIT)
database_state <- 'montana'

#input location ID file for MT
locationids <- read.csv("./Input/MT KC Location IDs.csv")
locationids$Location <- as.character(locationids$Location)

#county list to have full list of counties available for merging
countylist <- read.csv("./Input/MT County List.csv")
```



## ############################################# ##
## LICENSED CHILD CARE FACILITIES BY STARS LEVEL ##
## ############################################# ##

```{r}
licensing_star <- read_excel(path=paste0("./Input/education/Montana Child Care Raw Analysis/montana_childcaredata_",year,"_licensing_star.xlsx"))

#create a county list with indicator variable
countylist2 <- countylist %>%
  mutate(countyindicator=1)

#create all possible combos of categories and counties
category <- c('Non STAR','STAR 1','STAR 2','STAR 3','STAR 4','STAR 5','Non STAR, Started Process','Total')
categorylist <- as.data.frame(category)
county_categorylist <-crossing(countylist,categorylist)

#facilities first
facilities <- licensing_star %>%
  # Rename STAR Quality Level to category
  rename(category = `STAR Quality Level`) %>%
  select(location, category, total_providers, timeframe) %>%
  
  # Recode totals
  mutate(category = replace(category, category %in% c('County Total', 'State Total'), 'Total')) %>%
  mutate(category = replace(category, category == 'STAR - Participant', 'Non STAR, Started Process')) %>%
  
  # ---- ADD MISSING COUNTY × CATEGORY COMBINATIONS ----
  full_join(county_categorylist, by = c("location"="Location","category"="category")) %>%
  
  # Replace missing provider counts with 0
  mutate(total_providers = replace(total_providers, is.na(total_providers), 0)) %>%
  
  # Calculate county totals EXCLUDING the 'Total' rows
  group_by(location) %>%
  mutate(total_providers_county = sum(total_providers[category != 'Total'], na.rm = TRUE)) %>%
  ungroup() %>%
  
  # Calculate percentages
  mutate(providers_percent = total_providers / total_providers_county) %>%
  mutate(providers_percent = replace(providers_percent, is.na(providers_percent), 0)) %>%
  
  select(-total_providers_county) %>%
  
  # Long format
  pivot_longer(cols = c('total_providers','providers_percent'),
               names_to = 'dataformat',
               values_to = 'data') %>%
  
  mutate(dataformat = case_when(
    dataformat == 'total_providers' ~ 'Number',
    dataformat == 'providers_percent' ~ 'Percent'
  )) %>%
  
  # Metadata
  mutate(locationtype = ifelse(location == 'Montana','State','County'),
         state = 'Montana',
         timeframe = year,
         varname = 'licensedchildcarefacilitiesbystarslevel') %>%
  
  # IDs
  left_join(locationids, by = c('location' = 'Location')) %>%
  rename(locationid = LocationId)


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(facilities$locationid))>=1) {
  print(facilities$location[is.na(facilities$locationid)])
} else if (sum(is.na(facilities$locationid))==0) {
  'all locations match'
}


# 2. Visually inspect output data
View(facilities)
```

```{r}
#CHECK DATASET NAMED facilities TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
dbWriteTable(con,database_state,facilities,append=TRUE,row.names=FALSE)
```

```{r}
#write query from database to get needed format for KC data center

uploadnumber_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data, category FROM ", database_state," WHERE timeframe='",year,"' AND varname='licensedchildcarefacilitiesbystarslevel';")


upload_datacenter <- dbGetQuery(con,uploadnumber_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data,
         Category=category)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_datacenter,file=paste0("./Output/education/",database_state,"_",year,"_licensedchildcarefacilitiesbystarslevel.csv"),row.names=FALSE)
```  
  


## ########################################## ##
## LICENSED CHILD CARE CAPACITY BY STAR LEVEL ##
## ########################################## ##

```{r}
#overall capacity first
capacity <- licensing_star %>%
  # Rename STAR Quality Level to category
  rename(category = `STAR Quality Level`) %>%
  select(location, category, total_capacity, timeframe) %>%
  
  # Recode totals
  mutate(category = replace(category, category %in% c('County Total', 'State Total'), 'Total')) %>%
  mutate(category = replace(category, category == 'STAR - Participant', 'Non STAR, Started Process')) %>%
  
    # ---- ADD MISSING COUNTY × CATEGORY COMBINATIONS ----
  full_join(county_categorylist, by = c("location"="Location","category"="category")) %>%
  
  # Replace missing provider counts with 0
  mutate(total_capacity = replace(total_capacity, is.na(total_capacity), 0)) %>%
  
  # Compute county totals EXCLUDING 'Total' rows
  group_by(location) %>%
  mutate(total_capacity_county = sum(total_capacity[category != 'Total'], na.rm = TRUE)) %>%
  ungroup() %>%
  
  # Calculate percentages
  mutate(capacity_percent = total_capacity / total_capacity_county) %>%
  mutate(capacity_percent = replace(capacity_percent, is.na(capacity_percent), 0)) %>%
  
  select(-total_capacity_county) %>%
  
  # Long format
  pivot_longer(cols = c('total_capacity', 'capacity_percent'),
               names_to = 'dataformat',
               values_to = 'data') %>%
  
  mutate(dataformat = case_when(
    dataformat == 'total_capacity' ~ 'Number',
    dataformat == 'capacity_percent' ~ 'Percent'
  )) %>%
  
  # Add KC variables
  mutate(locationtype = ifelse(location == 'Montana', 'State', 'County'),
         state = 'Montana',
         timeframe = year,
         varname = 'licensedchildcarecapacitybystarslevel') %>%
  
  left_join(locationids, by = c('location' = 'Location')) %>%
  rename(locationid = LocationId)





####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(capacity$locationid))>=1) {
  print(capacity$location[is.na(capacity$locationid)])
} else if (sum(is.na(capacity$locationid))==0) {
  'all locations match'
}


# 2. Visually inspect output data
View(capacity)
```

```{r}
#CHECK DATASET NAMED capacity TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
dbWriteTable(con,database_state,capacity,append=TRUE,row.names=FALSE)
```

```{r}
#write query from database to get needed format for KC data center

uploadnumber_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data, category FROM ", database_state," WHERE timeframe='",year,"' AND varname='licensedchildcarecapacitybystarslevel';")


upload_datacenter <- dbGetQuery(con,uploadnumber_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data,
         Category=category)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_datacenter,file=paste0("./Output/education/",database_state,"_",year,"_licensedchildcarecapacitybystarslevel.csv"),row.names=FALSE)
```  



## ####################################################### ##
## LICENSED CHILD CARE CAPACITY FOR INFANTS BY STARS LEVEL ##
## ####################################################### ##

```{r}
#infant capacity
infant_capacity <- licensing_star %>%
  # Rename STAR Quality Level to category
  rename(category = `STAR Quality Level`) %>%
  select(location, category, total_under2, timeframe) %>%
  
  # Recode totals
  mutate(category = replace(category, category %in% c('County Total', 'State Total'), 'Total')) %>%
  mutate(category = replace(category, category == 'STAR - Participant', 'Non STAR, Started Process')) %>%
  
     # ---- ADD MISSING COUNTY × CATEGORY COMBINATIONS ----
  full_join(county_categorylist, by = c("location"="Location","category"="category")) %>%
  
  # Replace missing provider counts with 0
  mutate(total_under2 = replace(total_under2, is.na(total_under2), 0)) %>%
  
  #Compute county totals EXCLUDING 'Total' rows
  group_by(location) %>%
  mutate(total_under2_county = sum(total_under2[category != 'Total'], na.rm = TRUE)) %>%
  ungroup() %>%
  
  # Calculate percentages
  mutate(total_under2_percent = total_under2 / total_under2_county) %>%
  mutate(total_under2_percent = replace(total_under2_percent, is.na(total_under2_percent), 0)) %>%
  
  select(-total_under2_county) %>%
  
  # Long format
  pivot_longer(cols = c('total_under2', 'total_under2_percent'),
               names_to = 'dataformat',
               values_to = 'data') %>%
  
  mutate(dataformat = case_when(
    dataformat == 'total_under2' ~ 'Number',
    dataformat == 'total_under2_percent' ~ 'Percent'
  )) %>%
  
  # Add KC variables
  mutate(locationtype = ifelse(location == 'Montana', 'State', 'County'),
         state = 'Montana',
         timeframe = year,
         varname = 'licensedchildcarecapacityinfantsbystarslevel') %>%
  
  left_join(locationids, by = c('location' = 'Location')) %>%
  rename(locationid = LocationId)

####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(infant_capacity$locationid))>=1) {
  print(infant_capacity$location[is.na(infant_capacity$locationid)])
} else if (sum(is.na(infant_capacity$locationid))==0) {
  'all locations match'
}


# 2. Visually inspect output data
View(infant_capacity)
```

```{r}
#CHECK DATASET NAMED infant_capacity TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
dbWriteTable(con,database_state,infant_capacity,append=TRUE,row.names=FALSE)
```

```{r}
#write query from database to get needed format for KC data center

uploadnumber_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data, category FROM ", database_state," WHERE timeframe='",year,"' AND varname='licensedchildcarecapacityinfantsbystarslevel';")


upload_datacenter <- dbGetQuery(con,uploadnumber_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data,
         Category=category)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_datacenter,file=paste0("./Output/education/",database_state,"_",year,"_licensedchildcarecapacityinfantsbystarslevel.csv"),row.names=FALSE)
``` 




## ############################################################ ##
## LICENSED CHILD CARE  CAPACITY MEETING STAR LEVEL 3 OR HIGHER ##
## ############################################################ ##

```{r}
#use data from licensedchildcarecapacitybystarslevel
uploadnumber_sql <- paste0("SELECT locationid, location, locationtype, state, timeframe, dataformat, data, category FROM ", database_state," WHERE timeframe='",year,"' AND varname='licensedchildcarecapacitybystarslevel';")


qualitycapacity <- dbGetQuery(con,uploadnumber_sql) %>%
  subset(category=='STAR 3' | category=='STAR 4' | category=='STAR 5') %>%
  mutate(data=as.numeric(paste(data))) %>%
  group_by(location,locationid,locationtype,state,timeframe,dataformat) %>%
  summarise(data=sum(data),.groups='keep') %>%
  ungroup %>%
  mutate(varname='licensedchildcarecapacitymeeting3orhigher')



####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(qualitycapacity$locationid))>=1) {
  print(qualitycapacity$location[is.na(qualitycapacity$locationid)])
} else if (sum(is.na(qualitycapacity$locationid))==0) {
  'all locations match'
}


# 2. Visually inspect output data
View(qualitycapacity)

```

```{r}
#CHECK DATASET NAMED qualitycapacity TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
dbWriteTable(con,database_state,qualitycapacity,append=TRUE,row.names=FALSE)
```

```{r}
#write query from database to get needed format for KC data center

uploadnumber_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM ", database_state," WHERE timeframe='",year,"' AND varname='licensedchildcarecapacitymeeting3orhigher';")


upload_datacenter <- dbGetQuery(con,uploadnumber_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_datacenter,file=paste0("./Output/education/",database_state,"_",year,"_licensedchildcarecapacitymeeting3orhigher.csv"),row.names=FALSE)
```  


## ################################## ##
## MEDIAN WAGE FOR CHILD CARE WORKERS ##
## ################################## ##

```{r}
year_wage <- '2024'
median_wage <- read_excel(path='./Input/education/montana_allyears_childcaremedianwage.xlsx') %>%
  rename(locationid=LocationId,
         location=Location,
         timeframe=TimeFrame,
         dataformat=DataFormat,
         data=Data) %>%
  mutate(varname='childcareworkersmedianwage') %>%
  mutate(locationtype='State') %>%
  mutate(state='Montana') %>%
  
  #subset for just most recent year
  subset(timeframe==year_wage)

View(median_wage)
```

```{r}
dbWriteTable(con,'montana',median_wage,append=TRUE,row.names=FALSE)

```

```{r}
#write query from database to get needed format for KC data center

medianwage_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM montana WHERE timeframe='",year_wage,"' AND varname='childcareworkersmedianwage';")

upload_data_medianwage <- dbGetQuery(con,medianwage_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data_medianwage,file=paste0("./Output/health/",statefile,"_",year_wage,"_childcareworkersmedianwage.csv"),row.names=FALSE)
```

