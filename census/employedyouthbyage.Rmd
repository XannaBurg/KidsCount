---
title: "Children in poverty by age"
author: "Xanna Burg"
date: "September 2020"
output: html_document
---


## Indicator 1: Employed youth ages 16 to 24
**NOTE: code will process data for 16-19 and 20-24 age groups, but only outputs the total age range due to reliability concerns**

**Created by:** Xanna Burg
**Date:** September 2020
**Updated by:**

**Data Source:** U.S. Census Bureau, American Community Survey 5-year Estimates, Table B23001
**Purpose:** Connect to Census ACS data, clean data, and output dataset to upload to KIDS COUNT Data Center.

**Data format:** Final output csv to upload is in long format with the following variables: Location (character: name of location), TimeFrame (text: years), Age group (character), Data (numeric: number, percentage), DataFormat (character: "number" or "percent"), LocationId (numeric: assigned for KIDS COUNT system)

A secondary output is an Excel file to copy to the Margin of Error template in order to report margin of error for the estimates.

**To use this code for a new year:**
* Update the year and acsyear (5 year interval) in the third code chunk for variables 'year' and 'acsyear'
* Update the state name (exactly as appears in FIPS) of interest
* Check each dataset visually and through the report logs prior to commiting to the database.


```{r,message=FALSE}
#install required packages the first time you use this code
#install.packages('tidyverse')
#install.packages('tidycensus')
#install.packages('censusapi')
#install.packages('stringr')

#load required packages
library(tidyverse)
library(tidycensus)
library(censusapi)
library(stringr)
```

```{r}
#metadata for available variables
#acs_vars <- listCensusMetadata(name="2018/acs/acs5",
                               #type="variables")


#metadata for available geographies
#acs_geos <- listCensusMetadata(name="2018/acs/acs5",
                              # type="geography")


#county and state names that match fips codes (from tidycensus package)
fips <- fips_codes

#import tribal fips code (from file on local drive)
fips_tribal <- read.csv("../Input/AIANNHCE Codes.csv")

```

```{r}
#CHANGE THE OBJECTS 'statename' and 'year' TO MATCH THE STATE AND YEAR
#state should match exactly as is in FIPS code in order for code to correctly run
statename <- "South Dakota"
year <- "2018"
acsyear <- "2014-2018"


#run this code to create an object needed for the database (DO NOT EDIT)
if (statename=='Montana') {
  database_state <- 'montana'
} else if (statename=='North Dakota') {
  database_state <- 'northdakota'
} else if (statename=='South Dakota') {
  database_state <- 'southdakota'
}

#import the location ids matching the correct state (for MT, ND, and SD; DO NOT EDIT)
locationids <- if (statename=='Montana') {
  read.csv("../Input/MT KC Location IDs.csv")
} else if (statename=='North Dakota') {
  read.csv("../Input/ND KC Location IDs.csv")
} else if (statename=='South Dakota') {
  read.csv("../Input/SD KC Location IDs.csv")
}
locationids$Location <- as.character(locationids$Location) #assign as character instead of factor for merging

#import the region match file matching the correct state (for MT, ND, and SD; DO NOT EDIT)
regionids <- if (statename=='Montana') {
  read.csv("../Input/MT KC Region List.csv")
} else if (statename=='North Dakota') {
  read.csv("../Input/ND KC Region List.csv") 
} else if (statename=='South Dakota') {
  read.csv("../Input/SD KC Region List.csv")
}
regionids$county <- as.character(regionids$county)
regionids$region <- as.character(regionids$region)


#UPDATE THE BELOW FILE PATH IF USING THIS CODE OUTSIDE OF MT, ND, OR SD TO ADD LOCATION IDS
#the csv file should have 2 columns: "LocationId" and "Location"
#locationids <- read.csv("your_file_path_here.csv")

#UPDATE THE BELOW FILE PATH IF USING THIS CODE OUTSIDE OF MT, ND, OR SD TO ADD REGIONS (GROUPS OF COUNTIES)
#the csv file should have 2 columns: "county" and "region"
#regionids <- read.csv("your_file_path_here.csv")


#RUN THIS CODE, BUT NOT REQUIRED TO CHANGE ANYTHING
#the api will subset data to each state based on the state FIPS code: MT=30, North Dakota=38, South Dakota=46
statecode <- as.numeric(unique(fips$state_code[fips$state_name==statename]))
```

## ##################### ##
## EMPLOYED YOUTH BY AGE ##
## ##################### ##

## STEP 1: COMPILE DATA FOR COUNTY, STATE, AND STATE PLANNING REGION ##
```{r}
##UNDER THE getCensus() FUNCTION, ADD YOUR OWN CENSUS API KEY IN ORDER TO USE THIS CODE. OR FOLLOW THE INSTRUCTIONS ON THE PACKAGE DOCUMENTATION TO SET YOUR API KEY IN YOUR R ENVIRONMENT
#https://cran.r-project.org/web/packages/censusapi/vignettes/getting-started.html


#[year]/acs/acs5 table is: ACS 5-year estimates for detailed tables (those beginning with B) for the year specified
#see lookup table for categorical vars: https://api.census.gov/data/2018/acs/acs5/variables.html 

############
#COUNTY DATA
acs_county <- getCensus(name="acs/acs5",
          vintage=year,
          key=Sys.getenv("CENSUS_API_KEY"),
          vars=c("B23001_003E","B23001_003M","B23001_005E","B23001_005M",
                 "B23001_007E","B23001_007M","B23001_010E","B23001_010M",
                 "B23001_012E","B23001_012M","B23001_014E","B23001_014M",
                 "B23001_017E","B23001_017M","B23001_019E","B23001_019M",
                 "B23001_021E","B23001_021M","B23001_089E","B23001_089M",
                 "B23001_091E","B23001_091M","B23001_093E","B23001_093M",
                 "B23001_096E","B23001_096M","B23001_098E","B23001_098M",
                 "B23001_100E","B23001_100M","B23001_103E","B23001_103M",
                 "B23001_105E","B23001_105M","B23001_107E","B23001_107M"),
          region="county:*",
          regionin=paste0("state:",statecode)) %>%
  
  #clean the data that's been imported
  
  #assign location type to county
  mutate(locationtype='County') %>%
  
  #add in county name from fips codes, remove word 'county', add in state name
  left_join(fips,by=c('county'='county_code','state'='state_code')) %>% 
  mutate(county=gsub("\\s*\\w*$", "", county.y)) %>%
  
  #calculate the sums and percent
  
  #########################
  #for youth ages 16-19
  mutate(numerator_16to19=(B23001_005E+B23001_007E+B23001_091E+B23001_093E)) %>%
  mutate(numerator_16to19_moe=sqrt((B23001_005M^2)+(B23001_007M^2)+(B23001_091M^2)+(B23001_093M^2))) %>%
  mutate(denominator_16to19=B23001_003E+B23001_089E) %>%
  mutate(denominator_16to19_moe=sqrt((B23001_003M^2)+(B23001_089M^2))) %>%
  
  mutate(Number_16to19=numerator_16to19) %>%
  mutate(number_16to19_moe=numerator_16to19_moe) %>%
  mutate(Percent_16to19=numerator_16to19/denominator_16to19) %>%
  mutate(percent_16to19_moe=(1/denominator_16to19)*sqrt((numerator_16to19_moe^2)-((Percent_16to19^2)*(denominator_16to19_moe^2)))) %>%
  mutate(percent_16to19_moe=if_else(is.na(percent_16to19_moe),(1/denominator_16to19)*sqrt((numerator_16to19_moe^2)+((Percent_16to19^2)*(denominator_16to19_moe^2))),percent_16to19_moe)) %>%

 #calculate the relative standard error
  mutate(number_16to19_relativese=((number_16to19_moe/1.645)/Number_16to19)*100) %>%
  mutate(percent_16to19_relativese=((percent_16to19_moe/1.645)/Percent_16to19)*100) %>%
  mutate(keep_16to19=if_else(percent_16to19_relativese>30 | number_16to19_relativese>30,0,1)) %>%

  ##########################
  #for youth ages 20 to 24
  mutate(numerator_20to24=(B23001_012E+B23001_014E+B23001_019E+B23001_021E+B23001_098E+B23001_100E+B23001_105E+B23001_107E)) %>%
  mutate(numerator_20to24_moe=sqrt((B23001_012M^2)+(B23001_014M^2)+(B23001_019M^2)+(B23001_021M^2)+(B23001_098M^2)+(B23001_100M^2)+(B23001_105M^2)+(B23001_107M^2))) %>%
  mutate(denominator_20to24=B23001_010E+B23001_017E+B23001_096E+B23001_103E) %>%
  mutate(denominator_20to24_moe=sqrt((B23001_010M^2)+(B23001_017M^2)+(B23001_096M^2)+(B23001_103M^2))) %>%
  
  mutate(Number_20to24=numerator_20to24) %>%
  mutate(number_20to24_moe=numerator_20to24_moe) %>%
  mutate(Percent_20to24=numerator_20to24/denominator_20to24) %>%
  mutate(percent_20to24_moe=(1/denominator_20to24)*sqrt((numerator_20to24_moe^2)-((Percent_20to24^2)*(denominator_20to24_moe^2)))) %>%
  mutate(percent_20to24_moe=if_else(is.na(percent_20to24_moe),(1/denominator_20to24)*sqrt((numerator_20to24_moe^2)+((Percent_20to24^2)*(denominator_20to24_moe^2))),percent_20to24_moe)) %>%

 #calculate the relative standard error
  mutate(number_20to24_relativese=((number_20to24_moe/1.645)/Number_20to24)*100) %>%
  mutate(percent_20to24_relativese=((percent_20to24_moe/1.645)/Percent_20to24)*100) %>%
  mutate(keep_20to24=if_else(percent_20to24_relativese>30 | number_20to24_relativese>30,0,1)) %>%
  
  
  ##########################
  #for youth ages 16-24
  mutate(numerator_16to24=(B23001_005E+B23001_007E+B23001_091E+B23001_093E+B23001_012E+B23001_014E+B23001_019E+B23001_021E+B23001_098E+B23001_100E+B23001_105E+B23001_107E)) %>%
  mutate(numerator_16to24_moe=sqrt((B23001_005M^2)+(B23001_007M^2)+(B23001_091M^2)+(B23001_093M^2)+(B23001_012M^2)+(B23001_014M^2)+(B23001_019M^2)+(B23001_021M^2)+(B23001_098M^2)+(B23001_100M^2)+(B23001_105M^2)+(B23001_107M^2))) %>%
  mutate(denominator_16to24=B23001_003E+B23001_089E+B23001_010E+B23001_017E+B23001_096E+B23001_103E) %>%
  mutate(denominator_16to24_moe=sqrt((B23001_003M^2)+(B23001_089M^2)+(B23001_010M^2)+(B23001_017M^2)+(B23001_096M^2)+(B23001_103M^2))) %>%
  
  mutate(Number_16to24=numerator_16to24) %>%
  mutate(number_16to24_moe=numerator_16to24_moe) %>%
  mutate(Percent_16to24=numerator_16to24/denominator_16to24) %>%
  mutate(percent_16to24_moe=(1/denominator_16to24)*sqrt((numerator_16to24_moe^2)-((Percent_16to24^2)*(denominator_16to24_moe^2)))) %>%
  mutate(percent_16to24_moe=if_else(is.na(percent_16to24_moe),(1/denominator_16to24)*sqrt((numerator_16to24_moe^2)+((Percent_16to24^2)*(denominator_16to24_moe^2))),percent_16to24_moe)) %>%

 #calculate the relative standard error
  mutate(number_16to24_relativese=((number_16to24_moe/1.645)/Number_16to24)*100) %>%
  mutate(percent_16to24_relativese=((percent_16to24_moe/1.645)/Percent_16to24)*100) %>%
  mutate(keep_16to24=if_else(percent_16to24_relativese>30 | number_16to24_relativese>30,0,1)) %>%
  
  


  #select only needed variables and name to kids count database
  select(c(county,locationtype,Number_16to19,number_16to19_moe,Percent_16to19,percent_16to19_moe,keep_16to19,
           Number_20to24,number_20to24_moe,Percent_20to24,percent_20to24_moe,keep_20to24,
           Number_16to24,number_16to24_moe,Percent_16to24,percent_16to24_moe,keep_16to24)) %>%
  
  rename(location=county) %>%
  mutate(state=statename) %>%
  mutate(timeframe=acsyear) %>%
  mutate(varname='employedyouthbyage')
  

    
###########
#STATE DATA
acs_state <- getCensus(name="acs/acs5",
          vintage=year,
          key=Sys.getenv("CENSUS_API_KEY"),
          vars=c("B23001_003E","B23001_003M","B23001_005E","B23001_005M",
                 "B23001_007E","B23001_007M","B23001_010E","B23001_010M",
                 "B23001_012E","B23001_012M","B23001_014E","B23001_014M",
                 "B23001_017E","B23001_017M","B23001_019E","B23001_019M",
                 "B23001_021E","B23001_021M","B23001_089E","B23001_089M",
                 "B23001_091E","B23001_091M","B23001_093E","B23001_093M",
                 "B23001_096E","B23001_096M","B23001_098E","B23001_098M",
                 "B23001_100E","B23001_100M","B23001_103E","B23001_103M",
                 "B23001_105E","B23001_105M","B23001_107E","B23001_107M"),
          region=paste0("state:",statecode)) %>%
  
  #clean the data that's been imported
  
  #assign location type to county
  mutate(locationtype='State') %>%
  mutate(location=statename) %>%
  
  #calculate the sums and percent
  
  #########################
  #for youth ages 16-19
  mutate(numerator_16to19=(B23001_005E+B23001_007E+B23001_091E+B23001_093E)) %>%
  mutate(numerator_16to19_moe=sqrt((B23001_005M^2)+(B23001_007M^2)+(B23001_091M^2)+(B23001_093M^2))) %>%
  mutate(denominator_16to19=B23001_003E+B23001_089E) %>%
  mutate(denominator_16to19_moe=sqrt((B23001_003M^2)+(B23001_089M^2))) %>%
  
  mutate(Number_16to19=numerator_16to19) %>%
  mutate(number_16to19_moe=numerator_16to19_moe) %>%
  mutate(Percent_16to19=numerator_16to19/denominator_16to19) %>%
  mutate(percent_16to19_moe=(1/denominator_16to19)*sqrt((numerator_16to19_moe^2)-((Percent_16to19^2)*(denominator_16to19_moe^2)))) %>%
  mutate(percent_16to19_moe=if_else(is.na(percent_16to19_moe),(1/denominator_16to19)*sqrt((numerator_16to19_moe^2)+((Percent_16to19^2)*(denominator_16to19_moe^2))),percent_16to19_moe)) %>%

 #calculate the relative standard error
  mutate(number_16to19_relativese=((number_16to19_moe/1.645)/Number_16to19)*100) %>%
  mutate(percent_16to19_relativese=((percent_16to19_moe/1.645)/Percent_16to19)*100) %>%
  mutate(keep_16to19=if_else(percent_16to19_relativese>30 | number_16to19_relativese>30,0,1)) %>%

  ##########################
  #for youth ages 20 to 24
  mutate(numerator_20to24=(B23001_012E+B23001_014E+B23001_019E+B23001_021E+B23001_098E+B23001_100E+B23001_105E+B23001_107E)) %>%
  mutate(numerator_20to24_moe=sqrt((B23001_012M^2)+(B23001_014M^2)+(B23001_019M^2)+(B23001_021M^2)+(B23001_098M^2)+(B23001_100M^2)+(B23001_105M^2)+(B23001_107M^2))) %>%
  mutate(denominator_20to24=B23001_010E+B23001_017E+B23001_096E+B23001_103E) %>%
  mutate(denominator_20to24_moe=sqrt((B23001_010M^2)+(B23001_017M^2)+(B23001_096M^2)+(B23001_103M^2))) %>%
  
  mutate(Number_20to24=numerator_20to24) %>%
  mutate(number_20to24_moe=numerator_20to24_moe) %>%
  mutate(Percent_20to24=numerator_20to24/denominator_20to24) %>%
  mutate(percent_20to24_moe=(1/denominator_20to24)*sqrt((numerator_20to24_moe^2)-((Percent_20to24^2)*(denominator_20to24_moe^2)))) %>%
  mutate(percent_20to24_moe=if_else(is.na(percent_20to24_moe),(1/denominator_20to24)*sqrt((numerator_20to24_moe^2)+((Percent_20to24^2)*(denominator_20to24_moe^2))),percent_20to24_moe)) %>%

 #calculate the relative standard error
  mutate(number_20to24_relativese=((number_20to24_moe/1.645)/Number_20to24)*100) %>%
  mutate(percent_20to24_relativese=((percent_20to24_moe/1.645)/Percent_20to24)*100) %>%
  mutate(keep_20to24=if_else(percent_20to24_relativese>30 | number_20to24_relativese>30,0,1)) %>%
  
  
  ##########################
  #for youth ages 16-24
  mutate(numerator_16to24=(B23001_005E+B23001_007E+B23001_091E+B23001_093E+B23001_012E+B23001_014E+B23001_019E+B23001_021E+B23001_098E+B23001_100E+B23001_105E+B23001_107E)) %>%
  mutate(numerator_16to24_moe=sqrt((B23001_005M^2)+(B23001_007M^2)+(B23001_091M^2)+(B23001_093M^2)+(B23001_012M^2)+(B23001_014M^2)+(B23001_019M^2)+(B23001_021M^2)+(B23001_098M^2)+(B23001_100M^2)+(B23001_105M^2)+(B23001_107M^2))) %>%
  mutate(denominator_16to24=B23001_003E+B23001_089E+B23001_010E+B23001_017E+B23001_096E+B23001_103E) %>%
  mutate(denominator_16to24_moe=sqrt((B23001_003M^2)+(B23001_089M^2)+(B23001_010M^2)+(B23001_017M^2)+(B23001_096M^2)+(B23001_103M^2))) %>%
  
  mutate(Number_16to24=numerator_16to24) %>%
  mutate(number_16to24_moe=numerator_16to24_moe) %>%
  mutate(Percent_16to24=numerator_16to24/denominator_16to24) %>%
  mutate(percent_16to24_moe=(1/denominator_16to24)*sqrt((numerator_16to24_moe^2)-((Percent_16to24^2)*(denominator_16to24_moe^2)))) %>%
  mutate(percent_16to24_moe=if_else(is.na(percent_16to24_moe),(1/denominator_16to24)*sqrt((numerator_16to24_moe^2)+((Percent_16to24^2)*(denominator_16to24_moe^2))),percent_16to24_moe)) %>%

 #calculate the relative standard error
  mutate(number_16to24_relativese=((number_16to24_moe/1.645)/Number_16to24)*100) %>%
  mutate(percent_16to24_relativese=((percent_16to24_moe/1.645)/Percent_16to24)*100) %>%
  mutate(keep_16to24=if_else(percent_16to24_relativese>30 | number_16to24_relativese>30,0,1)) %>%
  
  


  #select only needed variables and name to kids count database
  select(c(location,locationtype,Number_16to19,number_16to19_moe,Percent_16to19,percent_16to19_moe,keep_16to19,
           Number_20to24,number_20to24_moe,Percent_20to24,percent_20to24_moe,keep_20to24,
           Number_16to24,number_16to24_moe,Percent_16to24,percent_16to24_moe,keep_16to24)) %>%
  
  mutate(state=statename) %>%
  mutate(timeframe=acsyear) %>%
  mutate(varname='employedyouthbyage')



###########################
#STATE PLANNING REGION DATA
acs_region <- getCensus(name="acs/acs5",
          vintage=year,
          key=Sys.getenv("CENSUS_API_KEY"),
          vars=c("B23001_003E","B23001_003M","B23001_005E","B23001_005M",
                 "B23001_007E","B23001_007M","B23001_010E","B23001_010M",
                 "B23001_012E","B23001_012M","B23001_014E","B23001_014M",
                 "B23001_017E","B23001_017M","B23001_019E","B23001_019M",
                 "B23001_021E","B23001_021M","B23001_089E","B23001_089M",
                 "B23001_091E","B23001_091M","B23001_093E","B23001_093M",
                 "B23001_096E","B23001_096M","B23001_098E","B23001_098M",
                 "B23001_100E","B23001_100M","B23001_103E","B23001_103M",
                 "B23001_105E","B23001_105M","B23001_107E","B23001_107M"),
          region="county:*",
          regionin=paste0("state:",statecode)) %>%
  
  #clean the data that's been imported
  
  #add in county name from fips codes, remove word 'county', add in state name
  left_join(fips,by=c('county'='county_code','state'='state_code')) %>% 
  mutate(county=gsub("\\s*\\w*$", "", county.y)) %>%
  
  #calculate the sums and percent
  
  #########################
  #for youth ages 16-19
  mutate(numerator_16to19=(B23001_005E+B23001_007E+B23001_091E+B23001_093E)) %>%
  mutate(numerator_16to19_moe=sqrt((B23001_005M^2)+(B23001_007M^2)+(B23001_091M^2)+(B23001_093M^2))) %>%
  mutate(denominator_16to19=B23001_003E+B23001_089E) %>%
  mutate(denominator_16to19_moe=sqrt((B23001_003M^2)+(B23001_089M^2))) %>%
  
  
  ##########################
  #for youth ages 20 to 24
  mutate(numerator_20to24=(B23001_012E+B23001_014E+B23001_019E+B23001_021E+B23001_098E+B23001_100E+B23001_105E+B23001_107E)) %>%
  mutate(numerator_20to24_moe=sqrt((B23001_012M^2)+(B23001_014M^2)+(B23001_019M^2)+(B23001_021M^2)+(B23001_098M^2)+(B23001_100M^2)+(B23001_105M^2)+(B23001_107M^2))) %>%
  mutate(denominator_20to24=B23001_010E+B23001_017E+B23001_096E+B23001_103E) %>%
  mutate(denominator_20to24_moe=sqrt((B23001_010M^2)+(B23001_017M^2)+(B23001_096M^2)+(B23001_103M^2))) %>%
  
  
  ##########################
  #for youth ages 16-24
  mutate(numerator_16to24=(B23001_005E+B23001_007E+B23001_091E+B23001_093E+B23001_012E+B23001_014E+B23001_019E+B23001_021E+B23001_098E+B23001_100E+B23001_105E+B23001_107E)) %>%
  mutate(numerator_16to24_moe=sqrt((B23001_005M^2)+(B23001_007M^2)+(B23001_091M^2)+(B23001_093M^2)+(B23001_012M^2)+(B23001_014M^2)+(B23001_019M^2)+(B23001_021M^2)+(B23001_098M^2)+(B23001_100M^2)+(B23001_105M^2)+(B23001_107M^2))) %>%
  mutate(denominator_16to24=B23001_003E+B23001_089E+B23001_010E+B23001_017E+B23001_096E+B23001_103E) %>%
  mutate(denominator_16to24_moe=sqrt((B23001_003M^2)+(B23001_089M^2)+(B23001_010M^2)+(B23001_017M^2)+(B23001_096M^2)+(B23001_103M^2))) %>%
  
 
  
  #select only needed variables for summing
  select(c(county,numerator_16to19,numerator_16to19_moe,denominator_16to19,denominator_16to19_moe,
           numerator_20to24,numerator_20to24_moe,denominator_20to24,denominator_20to24_moe,
           numerator_16to24,numerator_16to24_moe,denominator_16to24,denominator_16to24_moe)) %>%
  
  left_join(regionids,by=c('county'='county')) %>%
  subset(region!='') %>%
  
  group_by(region) %>%
  summarise(Number_16to19=sum(numerator_16to19),
            Number_20to24=sum(numerator_20to24),
            Number_16to24=sum(numerator_16to24),
            
            number_16to19_moe=sqrt(sum(numerator_16to19_moe^2)),
            number_20to24_moe=sqrt(sum(numerator_20to24_moe^2)),
            number_16to24_moe=sqrt(sum(numerator_16to24_moe^2)),
            
            Percent_16to19=sum(numerator_16to19)/sum(denominator_16to19),
            Percent_20to24=sum(numerator_20to24)/sum(denominator_20to24),
            Percent_16to24=sum(numerator_16to24)/sum(denominator_16to24),
            
            percent_16to19_moe=(1/sum(denominator_16to19))*sqrt((number_16to19_moe^2)-((Percent_16to19^2)*(sqrt(sum(denominator_16to19_moe))^2))),
            percent_20to24_moe=(1/sum(denominator_20to24))*sqrt((number_20to24_moe^2)-((Percent_20to24^2)*(sqrt(sum(denominator_20to24_moe))^2))),
            percent_16to24_moe=(1/sum(denominator_16to24))*sqrt((number_16to24_moe^2)-((Percent_16to24^2)*(sqrt(sum(denominator_16to24_moe))^2))),.groups='keep') %>%
  ungroup %>%
  
  #calculate the relative standard error
  mutate(number_16to19_relativese=((number_16to19_moe/1.645)/Number_16to19)*100) %>%
  mutate(percent_16to19_relativese=((percent_16to19_moe/1.645)/Percent_16to19)*100) %>%
  mutate(keep_16to19=if_else(percent_16to19_relativese>30 | number_16to19_relativese>30,0,1)) %>%
  
  mutate(number_20to24_relativese=((number_20to24_moe/1.645)/Number_20to24)*100) %>%
  mutate(percent_20to24_relativese=((percent_20to24_moe/1.645)/Percent_20to24)*100) %>%
  mutate(keep_20to24=if_else(percent_20to24_relativese>30 | number_20to24_relativese>30,0,1)) %>%
  
  mutate(number_16to24_relativese=((number_16to24_moe/1.645)/Number_16to24)*100) %>%
  mutate(percent_16to24_relativese=((percent_16to24_moe/1.645)/Percent_16to24)*100) %>%
  mutate(keep_16to24=if_else(percent_16to24_relativese>30 | number_16to24_relativese>30,0,1)) %>%



  rename(location=region) %>%
  mutate(state=statename) %>%
  mutate(locationtype='Planning Region') %>%
  mutate(timeframe=acsyear) %>%
  mutate(varname='employedyouthbyage')



```

## STEP 2: COMPILE DATA FOR TRIBAL AREAS, IF APPLICABLE TO STATE
```{r}
###########
#TRIBAL DATA
acs_tribal <- getCensus(name="acs/acs5",
          vintage=year,
          key=Sys.getenv("CENSUS_API_KEY"),
          vars=c("B23001_003E","B23001_003M","B23001_005E","B23001_005M",
                 "B23001_007E","B23001_007M","B23001_010E","B23001_010M",
                 "B23001_012E","B23001_012M","B23001_014E","B23001_014M",
                 "B23001_017E","B23001_017M","B23001_019E","B23001_019M",
                 "B23001_021E","B23001_021M","B23001_089E","B23001_089M",
                 "B23001_091E","B23001_091M","B23001_093E","B23001_093M",
                 "B23001_096E","B23001_096M","B23001_098E","B23001_098M",
                 "B23001_100E","B23001_100M","B23001_103E","B23001_103M",
                 "B23001_105E","B23001_105M","B23001_107E","B23001_107M"),
          region="american indian area/alaska native area/hawaiian home land (or part):*",
          regionin=paste0("state:",statecode)) %>%


   #clean the imported data
  
  #assign location type to county
  mutate(locationtype='Tribal Area') %>%
  
  #add in location name from fips codes
  mutate(american_indian_area_alaska_native_area_hawaiian_home_land_or_part=as.numeric(american_indian_area_alaska_native_area_hawaiian_home_land_or_part)) %>%
  left_join(fips_tribal,by=c('american_indian_area_alaska_native_area_hawaiian_home_land_or_part'='AIANNHCE')) %>% 
  
  #calculate the sums and percent
  
  #########################
  #for youth ages 16-19
  mutate(numerator_16to19=(B23001_005E+B23001_007E+B23001_091E+B23001_093E)) %>%
  mutate(numerator_16to19_moe=sqrt((B23001_005M^2)+(B23001_007M^2)+(B23001_091M^2)+(B23001_093M^2))) %>%
  mutate(denominator_16to19=B23001_003E+B23001_089E) %>%
  mutate(denominator_16to19_moe=sqrt((B23001_003M^2)+(B23001_089M^2))) %>%
  
  mutate(Number_16to19=numerator_16to19) %>%
  mutate(number_16to19_moe=numerator_16to19_moe) %>%
  mutate(Percent_16to19=numerator_16to19/denominator_16to19) %>%
  mutate(percent_16to19_moe=(1/denominator_16to19)*sqrt((numerator_16to19_moe^2)-((Percent_16to19^2)*(denominator_16to19_moe^2)))) %>%
  mutate(percent_16to19_moe=if_else(is.na(percent_16to19_moe),(1/denominator_16to19)*sqrt((numerator_16to19_moe^2)+((Percent_16to19^2)*(denominator_16to19_moe^2))),percent_16to19_moe)) %>%

 #calculate the relative standard error
  mutate(number_16to19_relativese=((number_16to19_moe/1.645)/Number_16to19)*100) %>%
  mutate(percent_16to19_relativese=((percent_16to19_moe/1.645)/Percent_16to19)*100) %>%
  mutate(keep_16to19=if_else(percent_16to19_relativese>30 | number_16to19_relativese>30,0,1)) %>%

  ##########################
  #for youth ages 20 to 24
  mutate(numerator_20to24=(B23001_012E+B23001_014E+B23001_019E+B23001_021E+B23001_098E+B23001_100E+B23001_105E+B23001_107E)) %>%
  mutate(numerator_20to24_moe=sqrt((B23001_012M^2)+(B23001_014M^2)+(B23001_019M^2)+(B23001_021M^2)+(B23001_098M^2)+(B23001_100M^2)+(B23001_105M^2)+(B23001_107M^2))) %>%
  mutate(denominator_20to24=B23001_010E+B23001_017E+B23001_096E+B23001_103E) %>%
  mutate(denominator_20to24_moe=sqrt((B23001_010M^2)+(B23001_017M^2)+(B23001_096M^2)+(B23001_103M^2))) %>%
  
  mutate(Number_20to24=numerator_20to24) %>%
  mutate(number_20to24_moe=numerator_20to24_moe) %>%
  mutate(Percent_20to24=numerator_20to24/denominator_20to24) %>%
  mutate(percent_20to24_moe=(1/denominator_20to24)*sqrt((numerator_20to24_moe^2)-((Percent_20to24^2)*(denominator_20to24_moe^2)))) %>%
  mutate(percent_20to24_moe=if_else(is.na(percent_20to24_moe),(1/denominator_20to24)*sqrt((numerator_20to24_moe^2)+((Percent_20to24^2)*(denominator_20to24_moe^2))),percent_20to24_moe)) %>%

 #calculate the relative standard error
  mutate(number_20to24_relativese=((number_20to24_moe/1.645)/Number_20to24)*100) %>%
  mutate(percent_20to24_relativese=((percent_20to24_moe/1.645)/Percent_20to24)*100) %>%
  mutate(keep_20to24=if_else(percent_20to24_relativese>30 | number_20to24_relativese>30,0,1)) %>%
  
  
  ##########################
  #for youth ages 16-24
  mutate(numerator_16to24=(B23001_005E+B23001_007E+B23001_091E+B23001_093E+B23001_012E+B23001_014E+B23001_019E+B23001_021E+B23001_098E+B23001_100E+B23001_105E+B23001_107E)) %>%
  mutate(numerator_16to24_moe=sqrt((B23001_005M^2)+(B23001_007M^2)+(B23001_091M^2)+(B23001_093M^2)+(B23001_012M^2)+(B23001_014M^2)+(B23001_019M^2)+(B23001_021M^2)+(B23001_098M^2)+(B23001_100M^2)+(B23001_105M^2)+(B23001_107M^2))) %>%
  mutate(denominator_16to24=B23001_003E+B23001_089E+B23001_010E+B23001_017E+B23001_096E+B23001_103E) %>%
  mutate(denominator_16to24_moe=sqrt((B23001_003M^2)+(B23001_089M^2)+(B23001_010M^2)+(B23001_017M^2)+(B23001_096M^2)+(B23001_103M^2))) %>%
  
  mutate(Number_16to24=numerator_16to24) %>%
  mutate(number_16to24_moe=numerator_16to24_moe) %>%
  mutate(Percent_16to24=numerator_16to24/denominator_16to24) %>%
  mutate(percent_16to24_moe=(1/denominator_16to24)*sqrt((numerator_16to24_moe^2)-((Percent_16to24^2)*(denominator_16to24_moe^2)))) %>%
  mutate(percent_16to24_moe=if_else(is.na(percent_16to24_moe),(1/denominator_16to24)*sqrt((numerator_16to24_moe^2)+((Percent_16to24^2)*(denominator_16to24_moe^2))),percent_16to24_moe)) %>%

 #calculate the relative standard error
  mutate(number_16to24_relativese=((number_16to24_moe/1.645)/Number_16to24)*100) %>%
  mutate(percent_16to24_relativese=((percent_16to24_moe/1.645)/Percent_16to24)*100) %>%
  mutate(keep_16to24=if_else(percent_16to24_relativese>30 | number_16to24_relativese>30,0,1)) %>%
  
  


  #select only needed variables and name to kids count database
  select(c(AIANNHNAME,Number_16to19,number_16to19_moe,Percent_16to19,percent_16to19_moe,keep_16to19,
           Number_20to24,number_20to24_moe,Percent_20to24,percent_20to24_moe,keep_20to24,
           Number_16to24,number_16to24_moe,Percent_16to24,percent_16to24_moe,keep_16to24)) %>%
  
  mutate(state=statename) %>%
  mutate(timeframe=acsyear) %>%
  
  rename(location=AIANNHNAME) %>%
  mutate(locationtype='Tribal Area') %>%
  mutate(timeframe=acsyear) %>%
  mutate(varname='employedyouthbyage') %>%
  
  #change from factor to character for correctly updating below
  mutate(location=as.character(location)) %>%
  
  #rename the location to match kids count location - for locations that cross state lines, to clarify which portion is included
  #includes locations for all three states
  mutate(location=replace(location, 
                          state=='North Dakota' & location=='Standing Rock Reservation', 
                          'Standing Rock Reservation (North Dakota portion)')) %>%
  
    mutate(location=replace(location, 
                          state=='South Dakota' & location=='Standing Rock Reservation', 
                          'Standing Rock Reservation (South Dakota portion)')) %>%
   
  mutate(location=replace(location, 
                          state=='North Dakota' & 
                            location=='Turtle Mountain Reservation and Off-Reservation Trust Land', 
                          'Turtle Mountain Reservation and Off-Reservation Trust Land (North Dakota portion)')) %>%
  
  mutate(location=replace(location, 
                          state=='North Dakota' & 
                            location=='Lake Traverse Reservation and Off-Reservation Trust Land', 
                          'Lake Traverse Reservation and Off-Reservation Trust Land (North Dakota portion)')) %>%
  
   mutate(location=replace(location, 
                          state=='South Dakota' & location=='Lake Traverse Reservation and Off-Reservation Trust Land', 
                          'Lake Traverse Reservation and Off-Reservation Trust Land (South Dakota portion)')) %>%
  
  
  #for North Dakota Lake Traverse data is too small to be meaningful, remove
  filter(state!='North Dakota' | location!='Lake Traverse Reservation and Off-Reservation Trust Land (North Dakota portion)') %>%
  
  #for Montana Turtle Mountain is too small to have data, remove
  filter(state!='Montana' | location !='Turtle Mountain Reservation and Off-Reservation Trust Land') %>%
  
  #for South Dakota Turtle Mountain is too small to have data, remove
  filter(state!='South Dakota' | location !='Turtle Mountain Reservation and Off-Reservation Trust Land') %>%
  
  #for South Dakota Northern Cheyenne is too small to have data, remove
  filter(state!='South Dakota' | location !='Northern Cheyenne Indian Reservation and Off-Reservation Trust Land') 


```

## STEP 3: COMBINE ALL AGE GROUPS AND GEOGRAPHIES
```{r}
######################
#create 16 to 19 dataset
data_16to19_number <- acs_county %>%
  bind_rows(acs_state) %>%
  bind_rows(acs_region) %>%
  bind_rows(acs_tribal) %>%
  select(c(location,locationtype,state,timeframe,varname,Number_16to19,number_16to19_moe,keep_16to19)) %>% mutate(dataformat='Number') %>%
  rename(data=Number_16to19,
         moe=number_16to19_moe,
         keep=keep_16to19) %>%
  mutate(age_group='16 to 19')

data_16to19_percent <- acs_county %>%
  bind_rows(acs_state) %>%
  bind_rows(acs_region) %>%
  bind_rows(acs_tribal) %>%
  select(c(location,locationtype,state,timeframe,varname,Percent_16to19,percent_16to19_moe,keep_16to19)) %>% mutate(dataformat='Percent') %>%
  rename(data=Percent_16to19,
         moe=percent_16to19_moe,
         keep=keep_16to19) %>%
  mutate(age_group='16 to 19')

#######################
#create 20 to 24 dataset
data_20to24_number <- acs_county %>%
  bind_rows(acs_state) %>%
  bind_rows(acs_region) %>%
  bind_rows(acs_tribal) %>%
  select(c(location,locationtype,state,timeframe,varname,Number_20to24,number_20to24_moe,keep_20to24)) %>% mutate(dataformat='Number') %>%
  rename(data=Number_20to24,
         moe=number_20to24_moe,
         keep=keep_20to24) %>%
  mutate(age_group='20 to 24')

data_20to24_percent <- acs_county %>%
  bind_rows(acs_state) %>%
  bind_rows(acs_region) %>%
  bind_rows(acs_tribal) %>%
  select(c(location,locationtype,state,timeframe,varname,Percent_20to24,percent_20to24_moe,keep_20to24)) %>% mutate(dataformat='Percent') %>%
  rename(data=Percent_20to24,
         moe=percent_20to24_moe,
         keep=keep_20to24) %>%
  mutate(age_group='20 to 24')

#######################
#create 20 to 24 dataset
data_16to24_number <- acs_county %>%
  bind_rows(acs_state) %>%
  bind_rows(acs_region) %>%
  bind_rows(acs_tribal) %>%
  select(c(location,locationtype,state,timeframe,varname,Number_16to24,number_16to24_moe,keep_16to24)) %>% mutate(dataformat='Number') %>%
  rename(data=Number_16to24,
         moe=number_16to24_moe,
         keep=keep_16to24) %>%
  mutate(age_group='16 to 24')

data_16to24_percent <- acs_county %>%
  bind_rows(acs_state) %>%
  bind_rows(acs_region) %>%
  bind_rows(acs_tribal) %>%
  select(c(location,locationtype,state,timeframe,varname,Percent_16to24,percent_16to24_moe,keep_16to24)) %>% mutate(dataformat='Percent') %>%
  rename(data=Percent_16to24,
         moe=percent_16to24_moe,
         keep=keep_16to24) %>%
  mutate(age_group='16 to 24')




data_all <- data_16to19_number %>%
  bind_rows(data_16to19_percent) %>%
  bind_rows(data_20to24_number) %>%
  bind_rows(data_20to24_percent) %>%
  bind_rows(data_16to24_number) %>%
  bind_rows(data_16to24_percent) %>%

  
  mutate(data=replace(data,keep==0,NA)) %>%
  mutate(moe=replace(moe,keep==0,NA)) %>%
  select(-c(keep)) %>%

  #merge in location ids
  mutate(location=replace(location, 
                          statename=='Montana' & location=='Lewis and Clark', 
                          'Lewis & Clark')) %>%
  mutate(location=replace(location, 
                          statename=='South Dakota' & location=='Shannon', 
                          'Oglala Lakota')) %>%
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) 
  

####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(data_all$locationid))>=1) {
  print(data_all$location[is.na(data_all$locationid)])
} else if (sum(is.na(data_all$locationid))==0) {
  'all locations match'
}

# 2. Output cases where percent data is greater than 1
temp_percheck <- data_all %>%
  subset(dataformat=='Percent' & data>1)
temp_rows <- as.numeric(nrow(temp_percheck))

if (temp_rows==0) {
  'no percents greater than 1'
} else if (temp_rows>=1) {
  print(temp_percheck)
}

# 3. Visually inspect output data
View(data_all)
```

## STEP 4: COMMIT TO DATABASE 
```{r}
#CHECK DATASET NAMED data_all TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
dbWriteTable(con,database_state,data_all,append=TRUE,row.names=FALSE)
```

## STEP 5a: OUTPUT FILES - INCLUDING TRIBAL AREAS (NORTH DAKOTA)
```{r}
#########################
##OUTPUT DATA CENTER FILE

#with tribal data (North Dakota)
datacenter_sql <- paste0("SELECT locationid, location, timeframe, age_group, dataformat, data FROM ", database_state," WHERE timeframe='",acsyear,"' AND varname='employedyouthbyage';")

upload_data <- dbGetQuery(con,datacenter_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data,
         'Age group'=age_group) %>%
  
  #only include age group 16-24 on data center due to reliability
  subset(`Age group`=='16 to 24') %>%
  select(-c(`Age group`))

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("../Output/economics/",database_state,"_",year,"_employedyouthbyage.csv"),row.names=FALSE)


#############################
##OUTPUT MARGIN OF ERROR FILE
moe_sql <- paste0("SELECT location, timeframe, dataformat, data, moe FROM ", database_state," WHERE timeframe='",acsyear,"' AND varname='employedyouthbyage' AND locationtype='County' AND age_group='16 to 24';")

#alphabetize counties
moe_output <- dbGetQuery(con,moe_sql) %>%
  pivot_wider(names_from=dataformat,values_from=c(data,moe)) %>%
  select(c(timeframe,location,
           'data_Number','moe_Number',
           'data_Percent','moe_Percent')) %>%
  arrange(location)

#state
moe_sql2 <- paste0("SELECT location, timeframe, dataformat, data, moe FROM ", database_state," WHERE timeframe='",acsyear,"' AND varname='employedyouthbyage' AND locationtype='State' AND age_group='16 to 24';")

moe_output2 <- dbGetQuery(con,moe_sql2) %>%
  pivot_wider(names_from=dataformat,values_from=c(data,moe)) %>%
  select(c(timeframe,location,
          'data_Number','moe_Number',
           'data_Percent','moe_Percent')) %>%
  arrange(location)

#state planning region
moe_sql3 <- paste0("SELECT location, timeframe, dataformat, data, moe FROM ", database_state," WHERE timeframe='",acsyear,"' AND varname='employedyouthbyage' AND locationtype='Planning Region' AND age_group='16 to 24';")

moe_output3 <- dbGetQuery(con,moe_sql3) %>%
  pivot_wider(names_from=dataformat,values_from=c(data,moe)) %>%
  select(c(timeframe,location,
           'data_Number','moe_Number',
           'data_Percent','moe_Percent')) %>%
  arrange(location)

#tribal area (North Dakota only)
moe_sql4 <- paste0("SELECT location, timeframe, dataformat, data, moe FROM ", database_state," WHERE timeframe='",acsyear,"' AND varname='employedyouthbyage' AND locationtype='Tribal Area' AND age_group='16 to 24';")

moe_output4 <- dbGetQuery(con,moe_sql4) %>%
  pivot_wider(names_from=dataformat,values_from=c(data,moe)) %>%
  select(c(timeframe,location,
          'data_Number','moe_Number',
           'data_Percent','moe_Percent')) %>%
  arrange(location)

#combine county and state/state planning region
moe_output_ordered <- moe_output %>%
  bind_rows(moe_output2) %>%
  bind_rows(moe_output3) %>%
  
  #for tribal area
  bind_rows(moe_output4)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(moe_output_ordered,file=paste0("../Output/economics/moe/",database_state,"_",year,"_employedyouthbyage_moe.csv"),row.names=FALSE)

```

## STEP 5b: OUTPUT FILES - DO NOT INCLUDE TRIBAL AREAS (MONTANA, SOUTH DAKOTA)
```{r}
#########################
##OUTPUT DATA CENTER FILE

#without tribal data (Montana, South Dakota)
datacenter_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM ", database_state," WHERE timeframe='",acsyear,"' AND varname='employedyouthbyage' AND age_group='16 to 24' AND locationtype <> 'Tribal Area' AND locationtype <> 'Planning Region';")

upload_data <- dbGetQuery(con,datacenter_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("../Output/economics/",database_state,"_",year,"_employedyouthbyage.csv"),row.names=FALSE)


#############################
##OUTPUT MARGIN OF ERROR FILE
moe_sql <- paste0("SELECT location, timeframe, dataformat, data, moe FROM ", database_state," WHERE timeframe='",acsyear,"' AND varname='employedyouthbyage' AND locationtype='County' AND age_group='16 to 24';")

#alphabetize counties
moe_output <- dbGetQuery(con,moe_sql) %>%
  pivot_wider(names_from=dataformat,values_from=c(data,moe)) %>%
  select(c(timeframe,location,
           'data_Number','moe_Number',
           'data_Percent','moe_Percent')) %>%
  arrange(location)

#state
moe_sql2 <- paste0("SELECT location, timeframe, dataformat, data, moe FROM ", database_state," WHERE timeframe='",acsyear,"' AND varname='employedyouthbyage' AND locationtype='State' AND age_group='16 to 24';")

moe_output2 <- dbGetQuery(con,moe_sql2) %>%
  pivot_wider(names_from=dataformat,values_from=c(data,moe)) %>%
  select(c(timeframe,location,
          'data_Number','moe_Number',
           'data_Percent','moe_Percent')) %>%
  arrange(location)



#combine county and state/state planning region
moe_output_ordered <- moe_output %>%
  bind_rows(moe_output2) 


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(moe_output_ordered,file=paste0("../Output/economics/moe/",database_state,"_",year,"_employedyouthbyage_moe.csv"),row.names=FALSE)

```

# STEP 5c: OUTPUT KIDS COUNT DATA CENTER FORMAT (SKIP ADDING TO DATABASE AND MARGINS OF ERROR)
#This is code that can be used by states that do not have a database to store KIDS COUNT data, but just need a .csv output to upload to the data center.
**You must add a file path and name the desired csv file to the write.csv code**
```{r}
poverty_kcdatacenter <- poverty %>%
  select(c(location,dataformat,data,age_group,timeframe,locationid)) %>%
  rename(Location=location,
         DataFormat=dataformat,
         Data=data,
         'Age group'=age_group,
         TimeFrame=timeframe,
         LocationId=locationid)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(poverty_kcdatacenter,file="your path/goes here/nameyourcsv.csv",row.names=FALSE)
```