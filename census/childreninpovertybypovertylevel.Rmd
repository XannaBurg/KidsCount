---
title: "Children in poverty by age"
author: "Xanna Burg"
output: html_document
---


## Indicator 1: Children in poverty by poverty level (5-year estimates)

**Created by:** Xanna Burg
**Date:** May 2020
**Updated by:**

**Data Source:** U.S. Census Bureau, American Community Survey 5-year Estimates, Table B17024
**Purpose:** Connect to Census ACS data, clean data, and output dataset to upload to KIDS COUNT Data Center.

**Data format:** Final output csv to upload is in long format with the following variables: Location (character: name of location), TimeFrame (text: years), Category (character), Data (numeric: number, percentage), DataFormat (character: "number" or "percent"), LocationId (numeric: assigned for KIDS COUNT system)

A secondary output is an Excel file to copy to the Margin of Error template in order to report margin of error for the estimates.

**To use this code for a new year:**
* Update the year and acsyear (5 year interval) in the third code chunk for variables 'year' and 'acsyear'
* Update the state name (exactly as appears in FIPS) of interest
* Check each dataset visually and through the report logs prior to commiting to the database.


```{r,message=FALSE}
#install required packages the first time you use this code
#install.packages('tidyverse')
#install.packages('tidycensus')
#install.packages('censusapi')
#install.packages('stringr')

#load required packages
library(tidyverse)
library(tidycensus)
library(censusapi)
library(stringr)
```

```{r}
#metadata for available variables
#acs_vars <- listCensusMetadata(name="2018/acs/acs5",
                               #type="variables")


#metadata for available geographies
#acs_geos <- listCensusMetadata(name="2018/acs/acs5",
                              # type="geography")


#county and state names that match fips codes (from tidycensus package)
fips <- fips_codes

#import tribal fips code (from file on local drive)
fips_tribal <- read.csv("../Input/AIANNHCE Codes.csv")

```

## UPDATE THIS CODE CHUNK
```{r}
#CHANGE THE OBJECTS 'statename' and 'year' TO MATCH THE STATE AND YEAR
#state should match exactly as is in FIPS code in order for code to correctly run
statename <- "North Dakota"
year <- "2021"
acsyear <- "2017-2021"


#run this code to create an object needed for the database (DO NOT EDIT)
if (statename=='Montana') {
  database_state <- 'montana'
} else if (statename=='North Dakota') {
  database_state <- 'northdakota'
} else if (statename=='South Dakota') {
  database_state <- 'southdakota'
}

#import the location ids matching the correct state (for MT, ND, and SD; DO NOT EDIT)
locationids <- if (statename=='Montana') {
  read.csv("../Input/MT KC Location IDs.csv")
} else if (statename=='North Dakota') {
  read.csv("../Input/ND KC Location IDs.csv")
} else if (statename=='South Dakota') {
  read.csv("../Input/SD KC Location IDs.csv")
}
locationids$Location <- as.character(locationids$Location) #assign as character instead of factor for merging

#import the region match file matching the correct state (for MT, ND, and SD; DO NOT EDIT)
regionids <- if (statename=='Montana') {
  read.csv("../Input/MT KC Region List.csv")
} else if (statename=='North Dakota') {
  read.csv("../Input/ND KC Region List.csv") 
} else if (statename=='South Dakota') {
  read.csv("../Input/SD KC Region List.csv")
}
regionids$county <- as.character(regionids$county)
regionids$region <- as.character(regionids$region)


#UPDATE THE BELOW FILE PATH IF USING THIS CODE OUTSIDE OF MT, ND, OR SD TO ADD LOCATION IDS
#the csv file should have 2 columns: "LocationId" and "Location"
#locationids <- read.csv("your_file_path_here.csv")

#UPDATE THE BELOW FILE PATH IF USING THIS CODE OUTSIDE OF MT, ND, OR SD TO ADD REGIONS (GROUPS OF COUNTIES)
#the csv file should have 2 columns: "county" and "region"
#regionids <- read.csv("your_file_path_here.csv")


#RUN THIS CODE, BUT NOT REQUIRED TO CHANGE ANYTHING
#the api will subset data to each state based on the state FIPS code: MT=30, North Dakota=38, South Dakota=46
statecode <- as.numeric(unique(fips$state_code[fips$state_name==statename]))
```

## ####################################################### ##
## CHILDREN IN POVERTY BY POVERTY LEVEL (5-YEAR ESTIMATES) ##
## ####################################################### ##

## STEP 1: COMPILE DATA FOR COUNTY, STATE, AND STATE PLANNING REGION ##
```{r}
##UNDER THE getCensus() FUNCTION, ADD YOUR OWN CENSUS API KEY IN ORDER TO USE THIS CODE. OR FOLLOW THE INSTRUCTIONS ON THE PACKAGE DOCUMENTATION TO SET YOUR API KEY IN YOUR R ENVIRONMENT
#https://cran.r-project.org/web/packages/censusapi/vignettes/getting-started.html


#[year]/acs/acs5 table is: ACS 5-year estimates for detailed tables (those beginning with B) for the year specified
#see lookup table for categorical vars: https://api.census.gov/data/2018/acs/acs5/variables.html 

############
#COUNTY DATA
acs_county <- getCensus(name="acs/acs5",
          vintage=year,
          key=Sys.getenv("CENSUS_API_KEY"),
          vars=c("B17024_002E","B17024_003E","B17024_004E","B17024_005E","B17024_006E","B17024_007E","B17024_008E","B17024_009E","B17024_010E","B17024_015E","B17024_016E","B17024_017E","B17024_018E","B17024_019E","B17024_020E","B17024_021E","B17024_022E","B17024_023E","B17024_028E","B17024_029E","B17024_030E","B17024_031E","B17024_032E","B17024_033E","B17024_034E","B17024_035E","B17024_036E","B17024_002M","B17024_003M","B17024_004M","B17024_005M","B17024_006M","B17024_007M","B17024_008M","B17024_009M","B17024_010M","B17024_015M","B17024_016M","B17024_017M","B17024_018M","B17024_019M","B17024_020M","B17024_021M","B17024_022M","B17024_023M","B17024_028M","B17024_029M","B17024_030M","B17024_031M","B17024_032M","B17024_033M","B17024_034M","B17024_035M","B17024_036M"),
          region="county:*",
          regionin=paste0("state:",statecode)) %>%
  
  #clean the data that's been imported
  
  #assign location type to county
  mutate(locationtype='County') %>%
  
  #add in county name from fips codes, remove word 'county', add in state name
  left_join(fips,by=c('county'='county_code','state'='state_code')) %>% 
  mutate(county=gsub("\\s*\\w*$", "", county.y)) %>%
  
  #calculate the sums and percent
  
  #########################
  #for under 0.5 
  mutate(numerator_under50=(B17024_003E+B17024_016E+B17024_029E)) %>%
  mutate(numerator_under50_moe=sqrt((B17024_003M^2)+(B17024_016M^2)+(B17024_029M^2))) %>%
  mutate(denominator_under50=B17024_002E+B17024_015E+B17024_028E) %>%
  mutate(denominator_under50_moe=sqrt((B17024_002M^2)+(B17024_015M^2)+(B17024_028M^2))) %>%
  
  mutate(Number_under50=numerator_under50) %>%
  mutate(number_under50_moe=numerator_under50_moe) %>%
  mutate(Percent_under50=numerator_under50/denominator_under50) %>%
  mutate(percent_under50_moe=(1/denominator_under50)*sqrt((numerator_under50_moe^2)-((Percent_under50^2)*(denominator_under50_moe^2)))) %>%
  mutate(percent_under50_moe=if_else(is.na(percent_under50_moe),(1/denominator_under50)*sqrt((numerator_under50_moe^2)+((Percent_under50^2)*(denominator_under50_moe^2))),percent_under50_moe)) %>%

 #calculate the relative standard error
  mutate(number_under50_relativese=((number_under50_moe/1.645)/Number_under50)*100) %>%
  mutate(percent_under50_relativese=((percent_under50_moe/1.645)/Percent_under50)*100) %>%
  mutate(keep_under50=if_else(percent_under50_relativese>30 | number_under50_relativese>30,0,1)) %>%
  
  
  #########################
  #for under 1.0 
  mutate(numerator_under100=(B17024_003E+B17024_004E+B17024_005E+B17024_016E+B17024_017E+B17024_018E+B17024_029E+B17024_030E+B17024_031E)) %>%
  mutate(numerator_under100_moe=sqrt((B17024_003M^2)+(B17024_004M^2)+(B17024_005M^2)+(B17024_016M^2)+(B17024_017M^2)+(B17024_018M^2)+(B17024_029M^2)+(B17024_030M^2)+(B17024_031M^2))) %>%
  mutate(denominator_under100=B17024_002E+B17024_015E+B17024_028E) %>%
  mutate(denominator_under100_moe=sqrt((B17024_002M^2)+(B17024_015M^2)+(B17024_028M^2))) %>%
  
  mutate(Number_under100=numerator_under100) %>%
  mutate(number_under100_moe=numerator_under100_moe) %>%
  mutate(Percent_under100=numerator_under100/denominator_under100) %>%
  mutate(percent_under100_moe=(1/denominator_under100)*sqrt((numerator_under100_moe^2)-((Percent_under100^2)*(denominator_under100_moe^2)))) %>%
  mutate(percent_under100_moe=if_else(is.na(percent_under100_moe),(1/denominator_under100)*sqrt((numerator_under100_moe^2)+((Percent_under100^2)*(denominator_under100_moe^2))),percent_under100_moe)) %>%

 #calculate the relative standard error
  mutate(number_under100_relativese=((number_under100_moe/1.645)/Number_under100)*100) %>%
  mutate(percent_under100_relativese=((percent_under100_moe/1.645)/Percent_under100)*100) %>%
  mutate(keep_under100=if_else(percent_under100_relativese>30 | number_under100_relativese>30,0,1)) %>%
  
  
  #########################
  #for under 1.50 
  mutate(numerator_under150=(B17024_003E+B17024_004E+B17024_005E+B17024_006E+B17024_007E+B17024_016E+B17024_017E+B17024_018E+B17024_019E+B17024_020E+B17024_029E+B17024_030E+B17024_031E+B17024_032E+B17024_033E)) %>%
  mutate(numerator_under150_moe=sqrt((B17024_003M^2)+(B17024_004M^2)+(B17024_005M^2)+(B17024_006M^2)+(B17024_007M^2)+(B17024_016M^2)+(B17024_017M^2)+(B17024_018M^2)+(B17024_019M^2)+(B17024_020M^2)+(B17024_029M^2)+(B17024_030M^2)+(B17024_031M^2)+(B17024_032M^2)+(B17024_033M^2))) %>%
  mutate(denominator_under150=B17024_002E+B17024_015E+B17024_028E) %>%
  mutate(denominator_under150_moe=sqrt((B17024_002M^2)+(B17024_015M^2)+(B17024_028M^2))) %>%
  
  mutate(Number_under150=numerator_under150) %>%
  mutate(number_under150_moe=numerator_under150_moe) %>%
  mutate(Percent_under150=numerator_under150/denominator_under150) %>%
  mutate(percent_under150_moe=(1/denominator_under150)*sqrt((numerator_under150_moe^2)-((Percent_under150^2)*(denominator_under150_moe^2)))) %>%
  mutate(percent_under150_moe=if_else(is.na(percent_under150_moe),(1/denominator_under150)*sqrt((numerator_under150_moe^2)+((Percent_under150^2)*(denominator_under150_moe^2))),percent_under150_moe)) %>%

 #calculate the relative standard error
  mutate(number_under150_relativese=((number_under150_moe/1.645)/Number_under150)*100) %>%
  mutate(percent_under150_relativese=((percent_under150_moe/1.645)/Percent_under150)*100) %>%
  mutate(keep_under150=if_else(percent_under150_relativese>30 | number_under150_relativese>30,0,1)) %>%
  
  
  #########################
  #for under 2.0
  mutate(numerator_under200=(B17024_003E+B17024_004E+B17024_005E+B17024_006E+B17024_007E+B17024_008E+B17024_009E+B17024_010E+B17024_016E+B17024_017E+B17024_018E+B17024_019E+B17024_020E+B17024_021E+B17024_022E+B17024_023E+B17024_029E+B17024_030E+B17024_031E+B17024_032E+B17024_033E+B17024_034E+B17024_035E+B17024_036E)) %>%
  mutate(numerator_under200_moe=sqrt((B17024_003M^2)+(B17024_004M^2)+(B17024_005M^2)+(B17024_006M^2)+(B17024_007M^2)+(B17024_008M^2)+(B17024_009M^2)+(B17024_010M^2)+(B17024_016M^2)+(B17024_017M^2)+(B17024_018M^2)+(B17024_019M^2)+(B17024_020M^2)+(B17024_021M^2)+(B17024_022M^2)+(B17024_023M^2)+(B17024_029M^2)+(B17024_030M^2)+(B17024_031M^2)+(B17024_032M^2)+(B17024_033M^2)+(B17024_034M^2)+(B17024_035M^2)+(B17024_036M^2))) %>%
  mutate(denominator_under200=B17024_002E+B17024_015E+B17024_028E) %>%
  mutate(denominator_under200_moe=sqrt((B17024_002M^2)+(B17024_015M^2)+(B17024_028M^2))) %>%
  
  mutate(Number_under200=numerator_under200) %>%
  mutate(number_under200_moe=numerator_under200_moe) %>%
  mutate(Percent_under200=numerator_under200/denominator_under200) %>%
  mutate(percent_under200_moe=(1/denominator_under200)*sqrt((numerator_under200_moe^2)-((Percent_under200^2)*(denominator_under200_moe^2)))) %>%
  mutate(percent_under200_moe=if_else(is.na(percent_under200_moe),(1/denominator_under200)*sqrt((numerator_under200_moe^2)+((Percent_under200^2)*(denominator_under200_moe^2))),percent_under200_moe)) %>%

 #calculate the relative standard error
  mutate(number_under200_relativese=((number_under200_moe/1.645)/Number_under200)*100) %>%
  mutate(percent_under200_relativese=((percent_under200_moe/1.645)/Percent_under200)*100) %>%
  mutate(keep_under200=if_else(percent_under200_relativese>30 | number_under200_relativese>30,0,1)) %>%
  


  #select only needed variables and name to kids count database
  select(c(county,locationtype,Number_under50,number_under50_moe,Percent_under50,percent_under50_moe,keep_under50,
           Number_under100,number_under100_moe,Percent_under100,percent_under100_moe,keep_under100,
           Number_under150,number_under150_moe,Percent_under150,percent_under150_moe,keep_under150,
           Number_under200,number_under200_moe,Percent_under200,percent_under200_moe,keep_under200)) %>%
  
  rename(location=county) %>%
  mutate(state=statename) %>%
  mutate(timeframe=acsyear) %>%
  mutate(varname='childreninpovertybypovertylevel_5yearestimates')
  

    
###########
#STATE DATA
acs_state <- getCensus(name="acs/acs5",
          vintage=year,
          key=Sys.getenv("CENSUS_API_KEY"),
          vars=c("B17024_002E","B17024_003E","B17024_004E","B17024_005E","B17024_006E","B17024_007E","B17024_008E","B17024_009E","B17024_010E","B17024_015E","B17024_016E","B17024_017E","B17024_018E","B17024_019E","B17024_020E","B17024_021E","B17024_022E","B17024_023E","B17024_028E","B17024_029E","B17024_030E","B17024_031E","B17024_032E","B17024_033E","B17024_034E","B17024_035E","B17024_036E","B17024_002M","B17024_003M","B17024_004M","B17024_005M","B17024_006M","B17024_007M","B17024_008M","B17024_009M","B17024_010M","B17024_015M","B17024_016M","B17024_017M","B17024_018M","B17024_019M","B17024_020M","B17024_021M","B17024_022M","B17024_023M","B17024_028M","B17024_029M","B17024_030M","B17024_031M","B17024_032M","B17024_033M","B17024_034M","B17024_035M","B17024_036M"),
          region=paste0("state:",statecode)) %>%
  
  #clean the data that's been imported
  
  #assign location type to county
  mutate(locationtype='State') %>%

  #calculate the sums and percent
  
  #########################
  #for under 0.5 
  mutate(numerator_under50=(B17024_003E+B17024_016E+B17024_029E)) %>%
  mutate(numerator_under50_moe=sqrt((B17024_003M^2)+(B17024_016M^2)+(B17024_029M^2))) %>%
  mutate(denominator_under50=B17024_002E+B17024_015E+B17024_028E) %>%
  mutate(denominator_under50_moe=sqrt((B17024_002M^2)+(B17024_015M^2)+(B17024_028M^2))) %>%
  
  mutate(Number_under50=numerator_under50) %>%
  mutate(number_under50_moe=numerator_under50_moe) %>%
  mutate(Percent_under50=numerator_under50/denominator_under50) %>%
  mutate(percent_under50_moe=(1/denominator_under50)*sqrt((numerator_under50_moe^2)-((Percent_under50^2)*(denominator_under50_moe^2)))) %>%
  mutate(percent_under50_moe=if_else(is.na(percent_under50_moe),(1/denominator_under50)*sqrt((numerator_under50_moe^2)+((Percent_under50^2)*(denominator_under50_moe^2))),percent_under50_moe)) %>%

 #calculate the relative standard error
  mutate(number_under50_relativese=((number_under50_moe/1.645)/Number_under50)*100) %>%
  mutate(percent_under50_relativese=((percent_under50_moe/1.645)/Percent_under50)*100) %>%
  mutate(keep_under50=if_else(percent_under50_relativese>30 | number_under50_relativese>30,0,1)) %>%
  
  
  #########################
  #for under 1.0 
  mutate(numerator_under100=(B17024_003E+B17024_004E+B17024_005E+B17024_016E+B17024_017E+B17024_018E+B17024_029E+B17024_030E+B17024_031E)) %>%
  mutate(numerator_under100_moe=sqrt((B17024_003M^2)+(B17024_004M^2)+(B17024_005M^2)+(B17024_016M^2)+(B17024_017M^2)+(B17024_018M^2)+(B17024_029M^2)+(B17024_030M^2)+(B17024_031M^2))) %>%
  mutate(denominator_under100=B17024_002E+B17024_015E+B17024_028E) %>%
  mutate(denominator_under100_moe=sqrt((B17024_002M^2)+(B17024_015M^2)+(B17024_028M^2))) %>%
  
  mutate(Number_under100=numerator_under100) %>%
  mutate(number_under100_moe=numerator_under100_moe) %>%
  mutate(Percent_under100=numerator_under100/denominator_under100) %>%
  mutate(percent_under100_moe=(1/denominator_under100)*sqrt((numerator_under100_moe^2)-((Percent_under100^2)*(denominator_under100_moe^2)))) %>%
  mutate(percent_under100_moe=if_else(is.na(percent_under100_moe),(1/denominator_under100)*sqrt((numerator_under100_moe^2)+((Percent_under100^2)*(denominator_under100_moe^2))),percent_under100_moe)) %>%

 #calculate the relative standard error
  mutate(number_under100_relativese=((number_under100_moe/1.645)/Number_under100)*100) %>%
  mutate(percent_under100_relativese=((percent_under100_moe/1.645)/Percent_under100)*100) %>%
  mutate(keep_under100=if_else(percent_under100_relativese>30 | number_under100_relativese>30,0,1)) %>%
  
  
  #########################
  #for under 1.50 
  mutate(numerator_under150=(B17024_003E+B17024_004E+B17024_005E+B17024_006E+B17024_007E+B17024_016E+B17024_017E+B17024_018E+B17024_019E+B17024_020E+B17024_029E+B17024_030E+B17024_031E+B17024_032E+B17024_033E)) %>%
  mutate(numerator_under150_moe=sqrt((B17024_003M^2)+(B17024_004M^2)+(B17024_005M^2)+(B17024_006M^2)+(B17024_007M^2)+(B17024_016M^2)+(B17024_017M^2)+(B17024_018M^2)+(B17024_019M^2)+(B17024_020M^2)+(B17024_029M^2)+(B17024_030M^2)+(B17024_031M^2)+(B17024_032M^2)+(B17024_033M^2))) %>%
  mutate(denominator_under150=B17024_002E+B17024_015E+B17024_028E) %>%
  mutate(denominator_under150_moe=sqrt((B17024_002M^2)+(B17024_015M^2)+(B17024_028M^2))) %>%
  
  mutate(Number_under150=numerator_under150) %>%
  mutate(number_under150_moe=numerator_under150_moe) %>%
  mutate(Percent_under150=numerator_under150/denominator_under150) %>%
  mutate(percent_under150_moe=(1/denominator_under150)*sqrt((numerator_under150_moe^2)-((Percent_under150^2)*(denominator_under150_moe^2)))) %>%
  mutate(percent_under150_moe=if_else(is.na(percent_under150_moe),(1/denominator_under150)*sqrt((numerator_under150_moe^2)+((Percent_under150^2)*(denominator_under150_moe^2))),percent_under150_moe)) %>%

 #calculate the relative standard error
  mutate(number_under150_relativese=((number_under150_moe/1.645)/Number_under150)*100) %>%
  mutate(percent_under150_relativese=((percent_under150_moe/1.645)/Percent_under150)*100) %>%
  mutate(keep_under150=if_else(percent_under150_relativese>30 | number_under150_relativese>30,0,1)) %>%
  
  
  #########################
  #for under 2.0
  mutate(numerator_under200=(B17024_003E+B17024_004E+B17024_005E+B17024_006E+B17024_007E+B17024_008E+B17024_009E+B17024_010E+B17024_016E+B17024_017E+B17024_018E+B17024_019E+B17024_020E+B17024_021E+B17024_022E+B17024_023E+B17024_029E+B17024_030E+B17024_031E+B17024_032E+B17024_033E+B17024_034E+B17024_035E+B17024_036E)) %>%
  mutate(numerator_under200_moe=sqrt((B17024_003M^2)+(B17024_004M^2)+(B17024_005M^2)+(B17024_006M^2)+(B17024_007M^2)+(B17024_008M^2)+(B17024_009M^2)+(B17024_010M^2)+(B17024_016M^2)+(B17024_017M^2)+(B17024_018M^2)+(B17024_019M^2)+(B17024_020M^2)+(B17024_021M^2)+(B17024_022M^2)+(B17024_023M^2)+(B17024_029M^2)+(B17024_030M^2)+(B17024_031M^2)+(B17024_032M^2)+(B17024_033M^2)+(B17024_034M^2)+(B17024_035M^2)+(B17024_036M^2))) %>%
  mutate(denominator_under200=B17024_002E+B17024_015E+B17024_028E) %>%
  mutate(denominator_under200_moe=sqrt((B17024_002M^2)+(B17024_015M^2)+(B17024_028M^2))) %>%
  
  mutate(Number_under200=numerator_under200) %>%
  mutate(number_under200_moe=numerator_under200_moe) %>%
  mutate(Percent_under200=numerator_under200/denominator_under200) %>%
  mutate(percent_under200_moe=(1/denominator_under200)*sqrt((numerator_under200_moe^2)-((Percent_under200^2)*(denominator_under200_moe^2)))) %>%
  mutate(percent_under200_moe=if_else(is.na(percent_under200_moe),(1/denominator_under200)*sqrt((numerator_under200_moe^2)+((Percent_under200^2)*(denominator_under200_moe^2))),percent_under200_moe)) %>%

 #calculate the relative standard error
  mutate(number_under200_relativese=((number_under200_moe/1.645)/Number_under200)*100) %>%
  mutate(percent_under200_relativese=((percent_under200_moe/1.645)/Percent_under200)*100) %>%
  mutate(keep_under200=if_else(percent_under200_relativese>30 | number_under200_relativese>30,0,1)) %>%
  


  #select only needed variables and name to kids count database
  select(c(locationtype,Number_under50,number_under50_moe,Percent_under50,percent_under50_moe,keep_under50,
           Number_under100,number_under100_moe,Percent_under100,percent_under100_moe,keep_under100,
           Number_under150,number_under150_moe,Percent_under150,percent_under150_moe,keep_under150,
           Number_under200,number_under200_moe,Percent_under200,percent_under200_moe,keep_under200)) %>%
  
  mutate(location=statename) %>%
  mutate(state=statename) %>%
  mutate(timeframe=acsyear) %>%
  mutate(varname='childreninpovertybypovertylevel_5yearestimates')



###########################
#STATE PLANNING REGION DATA
acs_region <- getCensus(name="acs/acs5",
          vintage=year,
          key=Sys.getenv("CENSUS_API_KEY"),
          vars=c("B17024_002E","B17024_003E","B17024_004E","B17024_005E","B17024_006E","B17024_007E","B17024_008E","B17024_009E","B17024_010E","B17024_015E","B17024_016E","B17024_017E","B17024_018E","B17024_019E","B17024_020E","B17024_021E","B17024_022E","B17024_023E","B17024_028E","B17024_029E","B17024_030E","B17024_031E","B17024_032E","B17024_033E","B17024_034E","B17024_035E","B17024_036E","B17024_002M","B17024_003M","B17024_004M","B17024_005M","B17024_006M","B17024_007M","B17024_008M","B17024_009M","B17024_010M","B17024_015M","B17024_016M","B17024_017M","B17024_018M","B17024_019M","B17024_020M","B17024_021M","B17024_022M","B17024_023M","B17024_028M","B17024_029M","B17024_030M","B17024_031M","B17024_032M","B17024_033M","B17024_034M","B17024_035M","B17024_036M"),
          region="county:*",
          regionin=paste0("state:",statecode)) %>%
  
  #clean the data that's been imported
  
  #add in county name from fips codes, remove word 'county', add in state name
  left_join(fips,by=c('county'='county_code','state'='state_code')) %>% 
  mutate(county=gsub("\\s*\\w*$", "", county.y)) %>%
  
  #calculate the sums and percent
  
  #########################
  #for under 0.5 
  mutate(numerator_under50=(B17024_003E+B17024_016E+B17024_029E)) %>%
  mutate(numerator_under50_moe=sqrt((B17024_003M^2)+(B17024_016M^2)+(B17024_029M^2))) %>%
  mutate(denominator_under50=B17024_002E+B17024_015E+B17024_028E) %>%
  mutate(denominator_under50_moe=sqrt((B17024_002M^2)+(B17024_015M^2)+(B17024_028M^2))) %>%
  
  mutate(Number_under50=numerator_under50) %>%
  mutate(number_under50_moe=numerator_under50_moe) %>%
  mutate(Percent_under50=numerator_under50/denominator_under50) %>%
  mutate(percent_under50_moe=(1/denominator_under50)*sqrt((numerator_under50_moe^2)-((Percent_under50^2)*(denominator_under50_moe^2)))) %>%
  mutate(percent_under50_moe=if_else(is.na(percent_under50_moe),(1/denominator_under50)*sqrt((numerator_under50_moe^2)+((Percent_under50^2)*(denominator_under50_moe^2))),percent_under50_moe)) %>%


  
  #########################
  #for under 1.0 
  mutate(numerator_under100=(B17024_003E+B17024_004E+B17024_005E+B17024_016E+B17024_017E+B17024_018E+B17024_029E+B17024_030E+B17024_031E)) %>%
  mutate(numerator_under100_moe=sqrt((B17024_003M^2)+(B17024_004M^2)+(B17024_005M^2)+(B17024_016M^2)+(B17024_017M^2)+(B17024_018M^2)+(B17024_029M^2)+(B17024_030M^2)+(B17024_031M^2))) %>%
  mutate(denominator_under100=B17024_002E+B17024_015E+B17024_028E) %>%
  mutate(denominator_under100_moe=sqrt((B17024_002M^2)+(B17024_015M^2)+(B17024_028M^2))) %>%
  
  mutate(Number_under100=numerator_under100) %>%
  mutate(number_under100_moe=numerator_under100_moe) %>%
  mutate(Percent_under100=numerator_under100/denominator_under100) %>%
  mutate(percent_under100_moe=(1/denominator_under100)*sqrt((numerator_under100_moe^2)-((Percent_under100^2)*(denominator_under100_moe^2)))) %>%
  mutate(percent_under100_moe=if_else(is.na(percent_under100_moe),(1/denominator_under100)*sqrt((numerator_under100_moe^2)+((Percent_under100^2)*(denominator_under100_moe^2))),percent_under100_moe)) %>%


  
  #########################
  #for under 1.50 
  mutate(numerator_under150=(B17024_003E+B17024_004E+B17024_005E+B17024_006E+B17024_007E+B17024_016E+B17024_017E+B17024_018E+B17024_019E+B17024_020E+B17024_029E+B17024_030E+B17024_031E+B17024_032E+B17024_033E)) %>%
  mutate(numerator_under150_moe=sqrt((B17024_003M^2)+(B17024_004M^2)+(B17024_005M^2)+(B17024_006M^2)+(B17024_007M^2)+(B17024_016M^2)+(B17024_017M^2)+(B17024_018M^2)+(B17024_019M^2)+(B17024_020M^2)+(B17024_029M^2)+(B17024_030M^2)+(B17024_031M^2)+(B17024_032M^2)+(B17024_033M^2))) %>%
  mutate(denominator_under150=B17024_002E+B17024_015E+B17024_028E) %>%
  mutate(denominator_under150_moe=sqrt((B17024_002M^2)+(B17024_015M^2)+(B17024_028M^2))) %>%
  
  mutate(Number_under150=numerator_under150) %>%
  mutate(number_under150_moe=numerator_under150_moe) %>%
  mutate(Percent_under150=numerator_under150/denominator_under150) %>%
  mutate(percent_under150_moe=(1/denominator_under150)*sqrt((numerator_under150_moe^2)-((Percent_under150^2)*(denominator_under150_moe^2)))) %>%
  mutate(percent_under150_moe=if_else(is.na(percent_under150_moe),(1/denominator_under150)*sqrt((numerator_under150_moe^2)+((Percent_under150^2)*(denominator_under150_moe^2))),percent_under150_moe)) %>%


  
  
  #########################
  #for under 2.0
  mutate(numerator_under200=(B17024_003E+B17024_004E+B17024_005E+B17024_006E+B17024_007E+B17024_008E+B17024_009E+B17024_010E+B17024_016E+B17024_017E+B17024_018E+B17024_019E+B17024_020E+B17024_021E+B17024_022E+B17024_023E+B17024_029E+B17024_030E+B17024_031E+B17024_032E+B17024_033E+B17024_034E+B17024_035E+B17024_036E)) %>%
  mutate(numerator_under200_moe=sqrt((B17024_003M^2)+(B17024_004M^2)+(B17024_005M^2)+(B17024_006M^2)+(B17024_007M^2)+(B17024_008M^2)+(B17024_009M^2)+(B17024_010M^2)+(B17024_016M^2)+(B17024_017M^2)+(B17024_018M^2)+(B17024_019M^2)+(B17024_020M^2)+(B17024_021M^2)+(B17024_022M^2)+(B17024_023M^2)+(B17024_029M^2)+(B17024_030M^2)+(B17024_031M^2)+(B17024_032M^2)+(B17024_033M^2)+(B17024_034M^2)+(B17024_035M^2)+(B17024_036M^2))) %>%
  mutate(denominator_under200=B17024_002E+B17024_015E+B17024_028E) %>%
  mutate(denominator_under200_moe=sqrt((B17024_002M^2)+(B17024_015M^2)+(B17024_028M^2))) %>%
  
  mutate(Number_under200=numerator_under200) %>%
  mutate(number_under200_moe=numerator_under200_moe) %>%
  mutate(Percent_under200=numerator_under200/denominator_under200) %>%
  mutate(percent_under200_moe=(1/denominator_under200)*sqrt((numerator_under200_moe^2)-((Percent_under200^2)*(denominator_under200_moe^2)))) %>%
  mutate(percent_under200_moe=if_else(is.na(percent_under200_moe),(1/denominator_under200)*sqrt((numerator_under200_moe^2)+((Percent_under200^2)*(denominator_under200_moe^2))),percent_under200_moe)) %>%


  #select only needed variables for summing
  select(c(county,numerator_under50,numerator_under50_moe,denominator_under50,denominator_under50_moe,
           numerator_under100,numerator_under100_moe,denominator_under100,denominator_under100_moe,
           numerator_under150,numerator_under150_moe,denominator_under150,denominator_under150_moe,
           numerator_under200,numerator_under200_moe,denominator_under200,denominator_under200_moe)) %>%
  
  left_join(regionids,by=c('county'='county')) %>%
  subset(region!='') %>%
  
  group_by(region) %>%
  summarise(Number_under50=sum(numerator_under50),
            Number_under100=sum(numerator_under100),
            Number_under150=sum(numerator_under150),
            Number_under200=sum(numerator_under200),
            
            number_under50_moe=sqrt(sum(numerator_under50_moe^2)),
            number_under100_moe=sqrt(sum(numerator_under100_moe^2)),
            number_under150_moe=sqrt(sum(numerator_under150_moe^2)),
            number_under200_moe=sqrt(sum(numerator_under200_moe^2)),
            
            Percent_under50=sum(numerator_under50)/sum(denominator_under50),
            Percent_under100=sum(numerator_under100)/sum(denominator_under100),
            Percent_under150=sum(numerator_under150)/sum(denominator_under150),
            Percent_under200=sum(numerator_under200)/sum(denominator_under200),
            
            percent_under50_moe=(1/sum(denominator_under50))*sqrt((number_under50_moe^2)-((Percent_under50^2)*(sqrt(sum(denominator_under50_moe))^2))),
            percent_under100_moe=(1/sum(denominator_under100))*sqrt((number_under100_moe^2)-((Percent_under100^2)*(sqrt(sum(denominator_under100_moe))^2))),
            percent_under150_moe=(1/sum(denominator_under150))*sqrt((number_under150_moe^2)-((Percent_under150^2)*(sqrt(sum(denominator_under150_moe))^2))),
            percent_under200_moe=(1/sum(denominator_under200))*sqrt((number_under200_moe^2)-((Percent_under200^2)*(sqrt(sum(denominator_under200_moe))^2)))) %>%
  ungroup %>%
  
  #calculate the relative standard error
  mutate(number_under50_relativese=((number_under50_moe/1.645)/Number_under50)*100) %>%
  mutate(percent_under50_relativese=((percent_under50_moe/1.645)/Percent_under50)*100) %>%
  mutate(keep_under50=if_else(percent_under50_relativese>30 | number_under50_relativese>30,0,1)) %>%
  
  mutate(number_under100_relativese=((number_under100_moe/1.645)/Number_under100)*100) %>%
  mutate(percent_under100_relativese=((percent_under100_moe/1.645)/Percent_under100)*100) %>%
  mutate(keep_under100=if_else(percent_under100_relativese>30 | number_under100_relativese>30,0,1)) %>%
  
  mutate(number_under150_relativese=((number_under150_moe/1.645)/Number_under150)*100) %>%
  mutate(percent_under150_relativese=((percent_under150_moe/1.645)/Percent_under150)*100) %>%
  mutate(keep_under150=if_else(percent_under150_relativese>30 | number_under150_relativese>30,0,1)) %>%
  
  mutate(number_under200_relativese=((number_under200_moe/1.645)/Number_under200)*100) %>%
  mutate(percent_under200_relativese=((percent_under200_moe/1.645)/Percent_under200)*100) %>%
  mutate(keep_under200=if_else(percent_under200_relativese>30 | number_under200_relativese>30,0,1)) %>%


  rename(location=region) %>%
  mutate(state=statename) %>%
  mutate(locationtype='Planning Region') %>%
  mutate(timeframe=acsyear) %>%
  mutate(varname='childreninpovertybypovertylevel_5yearestimates')

```

## STEP 2: COMPILE DATA FOR TRIBAL AREAS, IF APPLICABLE TO STATE
```{r}
###########
#TRIBAL DATA
acs_tribal <- getCensus(name="acs/acs5",
          vintage=year,
          key=Sys.getenv("CENSUS_API_KEY"),
          vars=c("B17024_002E","B17024_003E","B17024_004E","B17024_005E","B17024_006E","B17024_007E","B17024_008E","B17024_009E","B17024_010E","B17024_015E","B17024_016E","B17024_017E","B17024_018E","B17024_019E","B17024_020E","B17024_021E","B17024_022E","B17024_023E","B17024_028E","B17024_029E","B17024_030E","B17024_031E","B17024_032E","B17024_033E","B17024_034E","B17024_035E","B17024_036E","B17024_002M","B17024_003M","B17024_004M","B17024_005M","B17024_006M","B17024_007M","B17024_008M","B17024_009M","B17024_010M","B17024_015M","B17024_016M","B17024_017M","B17024_018M","B17024_019M","B17024_020M","B17024_021M","B17024_022M","B17024_023M","B17024_028M","B17024_029M","B17024_030M","B17024_031M","B17024_032M","B17024_033M","B17024_034M","B17024_035M","B17024_036M"),
          region="american indian area/alaska native area/hawaiian home land (or part):*",
          regionin=paste0("state:",statecode))  %>%
  
 #clean the data that's been imported
  
  #assign location type to tribal area
  mutate(locationtype='Tribal Area') %>%
  
  #add in location name from fips codes
  mutate(american_indian_area_alaska_native_area_hawaiian_home_land_or_part=as.numeric(american_indian_area_alaska_native_area_hawaiian_home_land_or_part)) %>%
  left_join(fips_tribal,by=c('american_indian_area_alaska_native_area_hawaiian_home_land_or_part'='AIANNHCE')) %>% 
  
  #calculate the sums and percent
  
  #########################
  #for under 0.5 
  mutate(numerator_under50=(B17024_003E+B17024_016E+B17024_029E)) %>%
  mutate(numerator_under50_moe=sqrt((B17024_003M^2)+(B17024_016M^2)+(B17024_029M^2))) %>%
  mutate(denominator_under50=B17024_002E+B17024_015E+B17024_028E) %>%
  mutate(denominator_under50_moe=sqrt((B17024_002M^2)+(B17024_015M^2)+(B17024_028M^2))) %>%
  
  mutate(Number_under50=numerator_under50) %>%
  mutate(number_under50_moe=numerator_under50_moe) %>%
  mutate(Percent_under50=numerator_under50/denominator_under50) %>%
  mutate(percent_under50_moe=(1/denominator_under50)*sqrt((numerator_under50_moe^2)-((Percent_under50^2)*(denominator_under50_moe^2)))) %>%
  mutate(percent_under50_moe=if_else(is.na(percent_under50_moe),(1/denominator_under50)*sqrt((numerator_under50_moe^2)+((Percent_under50^2)*(denominator_under50_moe^2))),percent_under50_moe)) %>%

 #calculate the relative standard error
  mutate(number_under50_relativese=((number_under50_moe/1.645)/Number_under50)*100) %>%
  mutate(percent_under50_relativese=((percent_under50_moe/1.645)/Percent_under50)*100) %>%
  mutate(keep_under50=if_else(percent_under50_relativese>30 | number_under50_relativese>30,0,1)) %>%
  
  
  #########################
  #for under 1.0 
  mutate(numerator_under100=(B17024_003E+B17024_004E+B17024_005E+B17024_016E+B17024_017E+B17024_018E+B17024_029E+B17024_030E+B17024_031E)) %>%
  mutate(numerator_under100_moe=sqrt((B17024_003M^2)+(B17024_004M^2)+(B17024_005M^2)+(B17024_016M^2)+(B17024_017M^2)+(B17024_018M^2)+(B17024_029M^2)+(B17024_030M^2)+(B17024_031M^2))) %>%
  mutate(denominator_under100=B17024_002E+B17024_015E+B17024_028E) %>%
  mutate(denominator_under100_moe=sqrt((B17024_002M^2)+(B17024_015M^2)+(B17024_028M^2))) %>%
  
  mutate(Number_under100=numerator_under100) %>%
  mutate(number_under100_moe=numerator_under100_moe) %>%
  mutate(Percent_under100=numerator_under100/denominator_under100) %>%
  mutate(percent_under100_moe=(1/denominator_under100)*sqrt((numerator_under100_moe^2)-((Percent_under100^2)*(denominator_under100_moe^2)))) %>%
  mutate(percent_under100_moe=if_else(is.na(percent_under100_moe),(1/denominator_under100)*sqrt((numerator_under100_moe^2)+((Percent_under100^2)*(denominator_under100_moe^2))),percent_under100_moe)) %>%

 #calculate the relative standard error
  mutate(number_under100_relativese=((number_under100_moe/1.645)/Number_under100)*100) %>%
  mutate(percent_under100_relativese=((percent_under100_moe/1.645)/Percent_under100)*100) %>%
  mutate(keep_under100=if_else(percent_under100_relativese>30 | number_under100_relativese>30,0,1)) %>%
  
  
  #########################
  #for under 1.50 
  mutate(numerator_under150=(B17024_003E+B17024_004E+B17024_005E+B17024_006E+B17024_007E+B17024_016E+B17024_017E+B17024_018E+B17024_019E+B17024_020E+B17024_029E+B17024_030E+B17024_031E+B17024_032E+B17024_033E)) %>%
  mutate(numerator_under150_moe=sqrt((B17024_003M^2)+(B17024_004M^2)+(B17024_005M^2)+(B17024_006M^2)+(B17024_007M^2)+(B17024_016M^2)+(B17024_017M^2)+(B17024_018M^2)+(B17024_019M^2)+(B17024_020M^2)+(B17024_029M^2)+(B17024_030M^2)+(B17024_031M^2)+(B17024_032M^2)+(B17024_033M^2))) %>%
  mutate(denominator_under150=B17024_002E+B17024_015E+B17024_028E) %>%
  mutate(denominator_under150_moe=sqrt((B17024_002M^2)+(B17024_015M^2)+(B17024_028M^2))) %>%
  
  mutate(Number_under150=numerator_under150) %>%
  mutate(number_under150_moe=numerator_under150_moe) %>%
  mutate(Percent_under150=numerator_under150/denominator_under150) %>%
  mutate(percent_under150_moe=(1/denominator_under150)*sqrt((numerator_under150_moe^2)-((Percent_under150^2)*(denominator_under150_moe^2)))) %>%
  mutate(percent_under150_moe=if_else(is.na(percent_under150_moe),(1/denominator_under150)*sqrt((numerator_under150_moe^2)+((Percent_under150^2)*(denominator_under150_moe^2))),percent_under150_moe)) %>%

 #calculate the relative standard error
  mutate(number_under150_relativese=((number_under150_moe/1.645)/Number_under150)*100) %>%
  mutate(percent_under150_relativese=((percent_under150_moe/1.645)/Percent_under150)*100) %>%
  mutate(keep_under150=if_else(percent_under150_relativese>30 | number_under150_relativese>30,0,1)) %>%
  
  
  #########################
  #for under 2.0
  mutate(numerator_under200=(B17024_003E+B17024_004E+B17024_005E+B17024_006E+B17024_007E+B17024_008E+B17024_009E+B17024_010E+B17024_016E+B17024_017E+B17024_018E+B17024_019E+B17024_020E+B17024_021E+B17024_022E+B17024_023E+B17024_029E+B17024_030E+B17024_031E+B17024_032E+B17024_033E+B17024_034E+B17024_035E+B17024_036E)) %>%
  mutate(numerator_under200_moe=sqrt((B17024_003M^2)+(B17024_004M^2)+(B17024_005M^2)+(B17024_006M^2)+(B17024_007M^2)+(B17024_008M^2)+(B17024_009M^2)+(B17024_010M^2)+(B17024_016M^2)+(B17024_017M^2)+(B17024_018M^2)+(B17024_019M^2)+(B17024_020M^2)+(B17024_021M^2)+(B17024_022M^2)+(B17024_023M^2)+(B17024_029M^2)+(B17024_030M^2)+(B17024_031M^2)+(B17024_032M^2)+(B17024_033M^2)+(B17024_034M^2)+(B17024_035M^2)+(B17024_036M^2))) %>%
  mutate(denominator_under200=B17024_002E+B17024_015E+B17024_028E) %>%
  mutate(denominator_under200_moe=sqrt((B17024_002M^2)+(B17024_015M^2)+(B17024_028M^2))) %>%
  
  mutate(Number_under200=numerator_under200) %>%
  mutate(number_under200_moe=numerator_under200_moe) %>%
  mutate(Percent_under200=numerator_under200/denominator_under200) %>%
  mutate(percent_under200_moe=(1/denominator_under200)*sqrt((numerator_under200_moe^2)-((Percent_under200^2)*(denominator_under200_moe^2)))) %>%
  mutate(percent_under200_moe=if_else(is.na(percent_under200_moe),(1/denominator_under200)*sqrt((numerator_under200_moe^2)+((Percent_under200^2)*(denominator_under200_moe^2))),percent_under200_moe)) %>%

 #calculate the relative standard error
  mutate(number_under200_relativese=((number_under200_moe/1.645)/Number_under200)*100) %>%
  mutate(percent_under200_relativese=((percent_under200_moe/1.645)/Percent_under200)*100) %>%
  mutate(keep_under200=if_else(percent_under200_relativese>30 | number_under200_relativese>30,0,1)) %>%
  


  #select only needed variables and name to kids count database
  select(c(AIANNHNAME,locationtype,Number_under50,number_under50_moe,Percent_under50,percent_under50_moe,keep_under50,
           Number_under100,number_under100_moe,Percent_under100,percent_under100_moe,keep_under100,
           Number_under150,number_under150_moe,Percent_under150,percent_under150_moe,keep_under150,
           Number_under200,number_under200_moe,Percent_under200,percent_under200_moe,keep_under200)) %>%
  
  rename(location=AIANNHNAME) %>%
  mutate(state=statename) %>%
  mutate(timeframe=acsyear) %>%
  mutate(varname='childreninpovertybypovertylevel_5yearestimates') %>%

  #change from factor to character for correctly updating below
  mutate(location=as.character(location)) %>%
  
  #rename the location to match kids count location - for locations that cross state lines, to clarify which portion is included
  #includes locations for all three states
  mutate(location=replace(location, 
                          state=='North Dakota' & location=='Standing Rock Reservation', 
                          'Standing Rock Reservation (North Dakota portion)')) %>%
  
    mutate(location=replace(location, 
                          state=='South Dakota' & location=='Standing Rock Reservation', 
                          'Standing Rock Reservation (South Dakota portion)')) %>%
   
  mutate(location=replace(location, 
                          state=='North Dakota' & 
                            location=='Turtle Mountain Reservation and Off-Reservation Trust Land', 
                          'Turtle Mountain Reservation and Off-Reservation Trust Land (North Dakota portion)')) %>%
  
  mutate(location=replace(location, 
                          state=='North Dakota' & 
                            location=='Lake Traverse Reservation and Off-Reservation Trust Land', 
                          'Lake Traverse Reservation and Off-Reservation Trust Land (North Dakota portion)')) %>%
  
   mutate(location=replace(location, 
                          state=='South Dakota' & location=='Lake Traverse Reservation and Off-Reservation Trust Land', 
                          'Lake Traverse Reservation and Off-Reservation Trust Land (South Dakota portion)')) %>%
  
  
  #for North Dakota Lake Traverse data is too small to be meaningful, remove
  filter(state!='North Dakota' | location!='Lake Traverse Reservation and Off-Reservation Trust Land (North Dakota portion)') %>%
  
  #for Montana Turtle Mountain is too small to have data, remove
  filter(state!='Montana' | location !='Turtle Mountain Reservation and Off-Reservation Trust Land') %>%
  
  #for South Dakota Turtle Mountain is too small to have data, remove
  filter(state!='South Dakota' | location !='Turtle Mountain Reservation and Off-Reservation Trust Land') %>%
  
  #for South Dakota Northern Cheyenne is too small to have data, remove
  filter(state!='South Dakota' | location !='Northern Cheyenne Indian Reservation and Off-Reservation Trust Land') %>%
  
  #for South Dakota Shakopee Mdewakanton Sioux Community is in Minnesota, remove
  filter(state!='South Dakota' | location !='Shakopee Mdewakanton Sioux Community and Off-Reservation Trust Land') 


```

## STEP 3: COMBINE ALL CATEGORIES AND GEOGRAPHIES
```{r}
######################
#create under50 dataset
poverty_under50_number <- acs_county %>%
  bind_rows(acs_state) %>%
  bind_rows(acs_region) %>%
  bind_rows(acs_tribal) %>%
  select(c(location,locationtype,state,timeframe,varname,Number_under50,number_under50_moe,keep_under50)) %>% mutate(dataformat='Number') %>%
  rename(data=Number_under50,
         moe=number_under50_moe,
         keep=keep_under50) %>%
  mutate(category='Under 50% of poverty')

poverty_under50_percent <- acs_county %>%
  bind_rows(acs_state) %>%
  bind_rows(acs_region) %>%
  bind_rows(acs_tribal) %>%
  select(c(location,locationtype,state,timeframe,varname,Percent_under50,percent_under50_moe,keep_under50)) %>% mutate(dataformat='Percent') %>%
  rename(data=Percent_under50,
         moe=percent_under50_moe,
         keep=keep_under50) %>%
  mutate(category='Under 50% of poverty')

#######################
#create under100 dataset
poverty_under100_number <- acs_county %>%
  bind_rows(acs_state) %>%
  bind_rows(acs_region) %>%
  bind_rows(acs_tribal) %>%
  select(c(location,locationtype,state,timeframe,varname,Number_under100,number_under100_moe,keep_under100)) %>% mutate(dataformat='Number') %>%
  rename(data=Number_under100,
         moe=number_under100_moe,
         keep=keep_under100) %>%
  mutate(category='Under 100% of poverty')

poverty_under100_percent <- acs_county %>%
  bind_rows(acs_state) %>%
  bind_rows(acs_region) %>%
  bind_rows(acs_tribal) %>%
  select(c(location,locationtype,state,timeframe,varname,Percent_under100,percent_under100_moe,keep_under100)) %>% mutate(dataformat='Percent') %>%
  rename(data=Percent_under100,
         moe=percent_under100_moe,
         keep=keep_under100) %>%
  mutate(category='Under 100% of poverty')

#######################
#create under150 dataset
poverty_under150_number <- acs_county %>%
  bind_rows(acs_state) %>%
  bind_rows(acs_region) %>%
  bind_rows(acs_tribal) %>%
  select(c(location,locationtype,state,timeframe,varname,Number_under150,number_under150_moe,keep_under150)) %>% mutate(dataformat='Number') %>%
  rename(data=Number_under150,
         moe=number_under150_moe,
         keep=keep_under150) %>%
  mutate(category='Under 150% of poverty')

poverty_under150_percent <- acs_county %>%
  bind_rows(acs_state) %>%
  bind_rows(acs_region) %>%
  bind_rows(acs_tribal) %>%
  select(c(location,locationtype,state,timeframe,varname,Percent_under150,percent_under150_moe,keep_under150)) %>% mutate(dataformat='Percent') %>%
  rename(data=Percent_under150,
         moe=percent_under150_moe,
         keep=keep_under150) %>%
  mutate(category='Under 150% of poverty')

#######################
#create under200 dataset
poverty_under200_number <- acs_county %>%
  bind_rows(acs_state) %>%
  bind_rows(acs_region) %>%
  bind_rows(acs_tribal) %>%
  select(c(location,locationtype,state,timeframe,varname,Number_under200,number_under200_moe,keep_under200)) %>% mutate(dataformat='Number') %>%
  rename(data=Number_under200,
         moe=number_under200_moe,
         keep=keep_under200) %>%
  mutate(category='Under 200% of poverty')

poverty_under200_percent <- acs_county %>%
  bind_rows(acs_state) %>%
  bind_rows(acs_region) %>%
  bind_rows(acs_tribal) %>%
  select(c(location,locationtype,state,timeframe,varname,Percent_under200,percent_under200_moe,keep_under200)) %>% mutate(dataformat='Percent') %>%
  rename(data=Percent_under200,
         moe=percent_under200_moe,
         keep=keep_under200) %>%
  mutate(category='Under 200% of poverty')


poverty <- poverty_under50_number %>%
  bind_rows(poverty_under50_percent) %>%
  bind_rows(poverty_under100_number) %>%
  bind_rows(poverty_under100_percent) %>%
  bind_rows(poverty_under150_number) %>%
  bind_rows(poverty_under150_percent) %>%
  bind_rows(poverty_under200_number) %>%
  bind_rows(poverty_under200_percent) %>%
  
  mutate(data=replace(data,keep==0,NA)) %>%
  mutate(moe=replace(moe,keep==0,NA)) %>%
  select(-c(keep)) %>%

  #merge in location ids
  mutate(location=replace(location, 
                          statename=='Montana' & location=='Lewis and Clark', 
                          'Lewis & Clark')) %>%
  mutate(location=replace(location, 
                          statename=='South Dakota' & location=='Shannon', 
                          'Oglala Lakota')) %>%
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) 
  

####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(poverty$locationid))>=1) {
  print(poverty$location[is.na(poverty$locationid)])
} else if (sum(is.na(poverty$locationid))==0) {
  'all locations match'
}

# 2. Output cases where percent data is greater than 1
temp_percheck <- poverty %>%
  subset(dataformat=='Percent' & data>1)
temp_rows <- as.numeric(nrow(temp_percheck))

if (temp_rows==0) {
  'no percents greater than 1'
} else if (temp_rows>=1) {
  print(temp_percheck)
}

# 3. Visually inspect output data
View(poverty)
```

## STEP 4a: COMMIT TO DATABASE (MONTANA & SOUTH DAKOTA WITHOUT PLANNING REGIONS)
```{r}
#CHECK DATASET NAMED poverty TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
poverty2 <- poverty %>% subset(locationtype != 'Planning Region')
dbWriteTable(con,database_state,poverty2,append=TRUE,row.names=FALSE)
```

## STEP 4b: COMMIT TO DATABASE (NORTH DAKOTA WITH PLANNING REGIONS)
```{r}
#CHECK DATASET NAMED poverty TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
dbWriteTable(con,database_state,poverty,append=TRUE,row.names=FALSE)
```

## STEP 5a: OUTPUT FILES - INCLUDING TRIBAL AREAS (NORTH DAKOTA)
```{r}
#########################
##OUTPUT DATA CENTER FILE

#with tribal data (North Dakota)
datacenter_sql <- paste0("SELECT locationid, location, timeframe, category, dataformat, data FROM ", database_state," WHERE timeframe='",acsyear,"' AND varname='childreninpovertybypovertylevel_5yearestimates';")

upload_data <- dbGetQuery(con,datacenter_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data,
         Category=category)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("../Output/economics/",database_state,"_",year,"_childreninpovertybypovertylevel_5yearestimates.csv"),row.names=FALSE)


#############################
##OUTPUT MARGIN OF ERROR FILE
moe_sql <- paste0("SELECT location, timeframe, category, dataformat, data, moe FROM ", database_state," WHERE timeframe='",acsyear,"' AND varname='childreninpovertybypovertylevel_5yearestimates' AND locationtype='County';")

#alphabetize counties
moe_output <- dbGetQuery(con,moe_sql) %>%
  pivot_wider(names_from=dataformat,values_from=c(data,moe)) %>%
  pivot_wider(names_from=category,values_from=c(data_Number,moe_Number,data_Percent,moe_Percent)) %>%
  select(c(timeframe,location,
           'data_Number_Under 50% of poverty','moe_Number_Under 50% of poverty',
           'data_Percent_Under 50% of poverty','moe_Percent_Under 50% of poverty',
           'data_Number_Under 100% of poverty','moe_Number_Under 100% of poverty',
           'data_Percent_Under 100% of poverty','moe_Percent_Under 100% of poverty',
           'data_Number_Under 150% of poverty','moe_Number_Under 150% of poverty',
           'data_Percent_Under 150% of poverty','moe_Percent_Under 150% of poverty',
           'data_Number_Under 200% of poverty','moe_Number_Under 200% of poverty',
           'data_Percent_Under 200% of poverty','moe_Percent_Under 200% of poverty')) %>%
  arrange(location)

#state
moe_sql2 <- paste0("SELECT location, timeframe, category, dataformat, data, moe FROM ", database_state," WHERE timeframe='",acsyear,"' AND varname='childreninpovertybypovertylevel_5yearestimates' AND locationtype='State';")

moe_output2 <- dbGetQuery(con,moe_sql2) %>%
  pivot_wider(names_from=dataformat,values_from=c(data,moe)) %>%
  pivot_wider(names_from=category,values_from=c(data_Number,moe_Number,data_Percent,moe_Percent)) %>%
  select(c(timeframe,location,
           'data_Number_Under 50% of poverty','moe_Number_Under 50% of poverty',
           'data_Percent_Under 50% of poverty','moe_Percent_Under 50% of poverty',
           'data_Number_Under 100% of poverty','moe_Number_Under 100% of poverty',
           'data_Percent_Under 100% of poverty','moe_Percent_Under 100% of poverty',
           'data_Number_Under 150% of poverty','moe_Number_Under 150% of poverty',
           'data_Percent_Under 150% of poverty','moe_Percent_Under 150% of poverty',
           'data_Number_Under 200% of poverty','moe_Number_Under 200% of poverty',
           'data_Percent_Under 200% of poverty','moe_Percent_Under 200% of poverty')) %>%
  arrange(location)

#state planning region
moe_sql3 <- paste0("SELECT location, timeframe, category, dataformat, data, moe FROM ", database_state," WHERE timeframe='",acsyear,"' AND varname='childreninpovertybypovertylevel_5yearestimates' AND locationtype='Planning Region';")

moe_output3 <- dbGetQuery(con,moe_sql3) %>%
  pivot_wider(names_from=dataformat,values_from=c(data,moe)) %>%
  pivot_wider(names_from=category,values_from=c(data_Number,moe_Number,data_Percent,moe_Percent)) %>%
  select(c(timeframe,location,
           'data_Number_Under 50% of poverty','moe_Number_Under 50% of poverty',
           'data_Percent_Under 50% of poverty','moe_Percent_Under 50% of poverty',
           'data_Number_Under 100% of poverty','moe_Number_Under 100% of poverty',
           'data_Percent_Under 100% of poverty','moe_Percent_Under 100% of poverty',
           'data_Number_Under 150% of poverty','moe_Number_Under 150% of poverty',
           'data_Percent_Under 150% of poverty','moe_Percent_Under 150% of poverty',
           'data_Number_Under 200% of poverty','moe_Number_Under 200% of poverty',
           'data_Percent_Under 200% of poverty','moe_Percent_Under 200% of poverty')) %>%
  arrange(location)

#tribal area (North Dakota only)
moe_sql4 <- paste0("SELECT location, timeframe, category, dataformat, data, moe FROM ", database_state," WHERE timeframe='",acsyear,"' AND varname='childreninpovertybypovertylevel_5yearestimates' AND locationtype='Tribal Area';")

moe_output4 <- dbGetQuery(con,moe_sql4) %>%
  pivot_wider(names_from=dataformat,values_from=c(data,moe)) %>%
  pivot_wider(names_from=category,values_from=c(data_Number,moe_Number,data_Percent,moe_Percent)) %>%
  select(c(timeframe,location,
           'data_Number_Under 50% of poverty','moe_Number_Under 50% of poverty',
           'data_Percent_Under 50% of poverty','moe_Percent_Under 50% of poverty',
           'data_Number_Under 100% of poverty','moe_Number_Under 100% of poverty',
           'data_Percent_Under 100% of poverty','moe_Percent_Under 100% of poverty',
           'data_Number_Under 150% of poverty','moe_Number_Under 150% of poverty',
           'data_Percent_Under 150% of poverty','moe_Percent_Under 150% of poverty',
           'data_Number_Under 200% of poverty','moe_Number_Under 200% of poverty',
           'data_Percent_Under 200% of poverty','moe_Percent_Under 200% of poverty')) %>%
  arrange(location)

#combine county and state/state planning region
moe_output_ordered <- moe_output %>%
  bind_rows(moe_output2) %>%
  bind_rows(moe_output3) %>%
  
  #for tribal area
  bind_rows(moe_output4)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(moe_output_ordered,file=paste0("../Output/economics/moe/",database_state,"_",year,"_childreninpovertybypovertylevel_5yearestimates_moe.csv"),row.names=FALSE)

```

## STEP 5b: OUTPUT FILES - DO NOT INCLUDE TRIBAL AREAS (MONTANA, SOUTH DAKOTA)
```{r}
#########################
##OUTPUT DATA CENTER FILE

#without tribal data (Montana, South Dakota)
datacenter_sql <- paste0("SELECT locationid, location, timeframe, category, dataformat, data FROM ", database_state," WHERE timeframe='",acsyear,"' AND varname='childreninpovertybypovertylevel_5yearestimates' AND locationtype <> 'Tribal Area';")

upload_data <- dbGetQuery(con,datacenter_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data,
         Category=category)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("../Output/economics/",database_state,"_",year,"_childreninpovertybypovertylevel_5yearestimates.csv"),row.names=FALSE)


#############################
##OUTPUT MARGIN OF ERROR FILE
moe_sql <- paste0("SELECT location, timeframe, category, dataformat, data, moe FROM ", database_state," WHERE timeframe='",acsyear,"' AND varname='childreninpovertybypovertylevel_5yearestimates' AND locationtype='County';")

#alphabetize counties
moe_output <- dbGetQuery(con,moe_sql) %>%
  pivot_wider(names_from=dataformat,values_from=c(data,moe)) %>%
  pivot_wider(names_from=category,values_from=c(data_Number,moe_Number,data_Percent,moe_Percent)) %>%
  select(c(timeframe,location,
            'data_Number_Under 50% of poverty','moe_Number_Under 50% of poverty',
           'data_Percent_Under 50% of poverty','moe_Percent_Under 50% of poverty',
           'data_Number_Under 100% of poverty','moe_Number_Under 100% of poverty',
           'data_Percent_Under 100% of poverty','moe_Percent_Under 100% of poverty',
           'data_Number_Under 150% of poverty','moe_Number_Under 150% of poverty',
           'data_Percent_Under 150% of poverty','moe_Percent_Under 150% of poverty',
           'data_Number_Under 200% of poverty','moe_Number_Under 200% of poverty',
           'data_Percent_Under 200% of poverty','moe_Percent_Under 200% of poverty')) %>%
  arrange(location)

#state
moe_sql2 <- paste0("SELECT location, timeframe, category, dataformat, data, moe FROM ", database_state," WHERE timeframe='",acsyear,"' AND varname='childreninpovertybypovertylevel_5yearestimates' AND locationtype='State';")

moe_output2 <- dbGetQuery(con,moe_sql2) %>%
  pivot_wider(names_from=dataformat,values_from=c(data,moe)) %>%
  pivot_wider(names_from=category,values_from=c(data_Number,moe_Number,data_Percent,moe_Percent)) %>%
  select(c(timeframe,location,
           'data_Number_Under 50% of poverty','moe_Number_Under 50% of poverty',
           'data_Percent_Under 50% of poverty','moe_Percent_Under 50% of poverty',
           'data_Number_Under 100% of poverty','moe_Number_Under 100% of poverty',
           'data_Percent_Under 100% of poverty','moe_Percent_Under 100% of poverty',
           'data_Number_Under 150% of poverty','moe_Number_Under 150% of poverty',
           'data_Percent_Under 150% of poverty','moe_Percent_Under 150% of poverty',
           'data_Number_Under 200% of poverty','moe_Number_Under 200% of poverty',
           'data_Percent_Under 200% of poverty','moe_Percent_Under 200% of poverty')) %>%
  arrange(location)



#combine county and state/state planning region
moe_output_ordered <- moe_output %>%
  bind_rows(moe_output2) 


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(moe_output_ordered,file=paste0("../Output/economics/moe/",database_state,"_",year,"_childreninpovertybypovertylevel_5yearestimates_moe.csv"),row.names=FALSE)

```

# STEP 5c: OUTPUT KIDS COUNT DATA CENTER FORMAT (SKIP ADDING TO DATABASE AND MARGINS OF ERROR)
#This is code that can be used by states that do not have a database to store KIDS COUNT data, but just need a .csv output to upload to the data center.
**You must add a file path and name the desired csv file to the write.csv code**
```{r}
poverty_kcdatacenter <- poverty %>%
  select(c(location,dataformat,data,category,timeframe,locationid)) %>%
  rename(Location=location,
         DataFormat=dataformat,
         Data=data,
         Category=category,
         TimeFrame=timeframe,
         LocationId=locationid)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(poverty_kcdatacenter,file="your path/goes here/nameyourcsv.csv",row.names=FALSE)
```


