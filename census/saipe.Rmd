---
title: "SAIPE"
author: "Xanna Burg"
output: html_document
---

## Indicator 1: Children in poverty (1-year estimates)
## Indicator 2: (for SD only) School district - Children ages 5-17 in poverty (1-year estimates)
## Indicator 3: Median household income

**Created by:** Xanna Burg
**Date:** May 2020
**Updated by:**

**Data Source:** U.S. Census Bureau, Small Area Income and Poverty Estimates https://www.census.gov/programs-surveys/saipe.html
**Purpose:** Connect to Census SAIPE data, clean data, and output dataset to upload to KIDS COUNT Data Center.

**Data format:** Final output csv to upload is in long format with the following variables: Location (character: name of location), TimeFrame (text: years), Age group (character), Data (numeric: number, percentage), DataFormat (character: "number" or "percent"), LocationId (numeric: assigned for KIDS COUNT system)

A secondary output is an Excel file to copy to the Margin of Error template in order to report margin of error for the estimates.

**To use this code for a new year:**
* Update the year in the third code chunk for variable 'year'
* Update the state name (exactly as appears in FIPS) of interest
* Check each dataset visually and through the report logs prior to commiting to the database.


```{r,message=FALSE}
#install required packages the first time you use this code
#install.packages('tidyverse')
#install.packages('tidycensus')
#install.packages('censusapi')
#install.packages('stringr')
#install.packages('gt')

#load required packages
library(tidyverse)
library(tidycensus)
library(censusapi)
library(stringr)
library(gt)
```


```{r}
#metadata for available variables
#saipe_vars <- listCensusMetadata(name="timeseries/poverty/saipe",
 #                             type="variables")

#saipe_vars <- listCensusMetadata(name="timeseries/poverty/saipe/schdist",
                              # type="variables")

#county and state names that match fips codes (from tidycensus package)
fips <- fips_codes

```

## UPDATE THIS CODE CHUNK
```{r}
#CHANGE THE OBJECTS 'statename' and 'year' TO MATCH THE STATE AND YEAR
#state should match exactly as is in FIPS code in order for code to correctly run
statename <- "South Dakota"
year <- "2023"


#run this code to create an object needed for the database (DO NOT EDIT)
if (statename=='Montana') {
  database_state <- 'montana'
} else if (statename=='North Dakota') {
  database_state <- 'northdakota'
} else if (statename=='South Dakota') {
  database_state <- 'southdakota'
}

#import the location ids matching the correct state (for MT, ND, and SD; DO NOT EDIT)
locationids <- if (statename=='Montana') {
  read.csv("../Input/MT KC Location IDs.csv")
} else if (statename=='North Dakota') {
  read.csv("../Input/ND KC Location IDs.csv")
} else if (statename=='South Dakota') {
  read.csv("../Input/SD KC Location IDs.csv")
}
locationids$Location <- as.character(locationids$Location) #assign as character instead of factor for merging

#import the region match file matching the correct state (for MT, ND, and SD; DO NOT EDIT)
regionids <- if (statename=='Montana') {
  read.csv("../Input/MT KC Region List.csv")
} else if (statename=='North Dakota') {
  read.csv("../Input/ND KC Region List.csv") 
} else if (statename=='South Dakota') {
  read.csv("../Input/SD KC Region List.csv")
}
regionids$county <- as.character(regionids$county)
regionids$region <- as.character(regionids$region)


#UPDATE THE BELOW FILE PATH IF USING THIS CODE OUTSIDE OF MT, ND, OR SD TO ADD LOCATION IDS
#the csv file should have 2 columns: "LocationId" and "Location"
#locationids <- read.csv("your_file_path_here.csv")

#UPDATE THE BELOW FILE PATH IF USING THIS CODE OUTSIDE OF MT, ND, OR SD TO ADD REGIONS (GROUPS OF COUNTIES)
#the csv file should have 2 columns: "county" and "region"
#regionids <- read.csv("your_file_path_here.csv")


#RUN THIS CODE, BUT NOT REQUIRED TO CHANGE ANYTHING
#the api will subset data to each state based on the state FIPS code: MT=30, North Dakota=38, South Dakota=46
statecode <- as.numeric(unique(fips$state_code[fips$state_name==statename]))
```



## ###################################### ##
## CHILDREN IN POVERTY (1-YEAR ESTIMATES) ##
## ###################################### ##

# STEP 1: CALCULATE FOR ALL AGES 0 TO 17
```{r}
##UNDER THE getCensus() FUNCTION, ADD YOUR OWN CENSUS API KEY IN ORDER TO USE THIS CODE. OR FOLLOW THE INSTRUCTIONS ON THE PACKAGE DOCUMENTATION TO SET YOUR API KEY IN YOUR R ENVIRONMENT
#https://cran.r-project.org/web/packages/censusapi/vignettes/getting-started.html


#timeseries/poverty/saipe table is: Small Area Income and Poverty Estimates

############
#COUNTY DATA
saipe_county <- getCensus(name="timeseries/poverty/saipe",
          key=Sys.getenv("CENSUS_API_KEY"),
          vars=c("NAME","SAEPOV0_17_PT","SAEPOV0_17_MOE","SAEPOVRT0_17_PT",
                 "SAEPOVRT0_17_MOE"),
          region="county:*",
          regionin=paste0("state:",statecode),
          YEAR=year) %>%

  #rename columns
  rename(Number=SAEPOV0_17_PT,
         number_moe=SAEPOV0_17_MOE,
         Percent=SAEPOVRT0_17_PT,
         percent_moe=SAEPOVRT0_17_MOE) %>%
  
  #calculate relative SE and remove data where relative standard error is greater than 30
  mutate(number_relativese=((number_moe/1.645)/Number)*100) %>%
  mutate(percent_relativese=((percent_moe/1.645)/Percent)*100) %>%
  mutate(keep=if_else(percent_relativese>30 | number_relativese>30,0,1)) %>%
  mutate(Number=replace(Number,keep==0,NA)) %>%
  mutate(Percent=replace(Percent,keep==0,NA)) %>%
  
  #change percent into decimals
  mutate(Percent=Percent/100) %>%
  mutate(percent_moe=percent_moe/100) %>%
  
  #calculate lower and upper bounds of confidence interval
  mutate(number_lci=Number-number_moe) %>%
  mutate(number_uci=Number+number_moe) %>%
  mutate(percent_lci=Percent-percent_moe) %>%
  mutate(percent_uci=Percent+percent_moe) %>%
  
  #add Kids Count variables and formatting
  mutate(location=gsub("\\s*\\w*$", "", NAME)) %>%
  select(-c(YEAR,state,county,NAME,keep,number_relativese,percent_relativese)) %>%
  
  #pivot longer
  pivot_longer(cols=c(Number,Percent),names_to='dataformat',values_to='data') %>%
  mutate(moe=case_when(
    dataformat=='Number' ~ number_moe,
    dataformat=='Percent' ~ percent_moe)) %>%
  mutate(lci=case_when(
    dataformat=='Number' ~ number_lci,
    dataformat=='Percent' ~ percent_lci)) %>%
  mutate(uci=case_when(
    dataformat=='Number' ~ number_uci,
    dataformat=='Percent' ~ percent_uci)) %>%
  select(-c(number_moe,percent_moe,number_uci,number_lci,percent_uci,percent_lci)) %>%
  
  mutate(age_group='Ages 0-17') %>%
  mutate(locationtype='County') %>%
  mutate(state=statename) %>%
  mutate(timeframe=year) %>%
  mutate(varname='saipe_childreninpoverty')

###########
#STATE DATA
saipe_state <- getCensus(name="timeseries/poverty/saipe",
          key=Sys.getenv("CENSUS_API_KEY"),
          vars=c("NAME","SAEPOV0_17_PT","SAEPOV0_17_MOE","SAEPOVRT0_17_PT",
                 "SAEPOVRT0_17_MOE"),
          region=paste0("state:",statecode),
          YEAR=year) %>%

  #rename columns
  rename(Number=SAEPOV0_17_PT,
         number_moe=SAEPOV0_17_MOE,
         Percent=SAEPOVRT0_17_PT,
         percent_moe=SAEPOVRT0_17_MOE) %>%
  
  #calculate relative SE and remove data where relative standard error is greater than 30
  mutate(number_relativese=((number_moe/1.645)/Number)*100) %>%
  mutate(percent_relativese=((percent_moe/1.645)/Percent)*100) %>%
  mutate(keep=if_else(percent_relativese>30 | number_relativese>30,0,1)) %>%
  mutate(Number=replace(Number,keep==0,NA)) %>%
  mutate(Percent=replace(Percent,keep==0,NA)) %>%
  
  #change percent into decimals
  mutate(Percent=Percent/100) %>%
  mutate(percent_moe=percent_moe/100) %>%
  
  #calculate lower and upper bounds of confidence interval
  mutate(number_lci=Number-number_moe) %>%
  mutate(number_uci=Number+number_moe) %>%
  mutate(percent_lci=Percent-percent_moe) %>%
  mutate(percent_uci=Percent+percent_moe) %>%
  
  #add Kids Count variables and formatting
  mutate(location=statename) %>%
  select(-c(YEAR,state,NAME,keep,number_relativese,percent_relativese)) %>%
  
  #pivot longer
  pivot_longer(cols=c(Number,Percent),names_to='dataformat',values_to='data') %>%
  mutate(moe=case_when(
    dataformat=='Number' ~ number_moe,
    dataformat=='Percent' ~ percent_moe)) %>%
  mutate(lci=case_when(
    dataformat=='Number' ~ number_lci,
    dataformat=='Percent' ~ percent_lci)) %>%
  mutate(uci=case_when(
    dataformat=='Number' ~ number_uci,
    dataformat=='Percent' ~ percent_uci)) %>%
  select(-c(number_moe,percent_moe,number_uci,number_lci,percent_uci,percent_lci)) %>%
  
  mutate(age_group='Ages 0-17') %>%
  mutate(locationtype='State') %>%
  mutate(state=statename) %>%
  mutate(timeframe=year) %>%
  mutate(varname='saipe_childreninpoverty')

############
#REGION DATA
saipe_region <- getCensus(name="timeseries/poverty/saipe",
          key=Sys.getenv("CENSUS_API_KEY"),
          vars=c("NAME","SAEPOV0_17_PT","SAEPOV0_17_MOE","SAEPOVRT0_17_PT",
                 "SAEPOVRT0_17_MOE","SAEPOVU_0_17"),
          region="county:*",
          regionin=paste0("state:",statecode),
          YEAR=year) %>%

  #rename columns
  rename(Number=SAEPOV0_17_PT,
         number_moe=SAEPOV0_17_MOE,
         Percent=SAEPOVRT0_17_PT,
         percent_moe=SAEPOVRT0_17_MOE,
         totalpop=SAEPOVU_0_17) %>%
  
  #merge in region ids
  mutate(location=gsub("\\s*\\w*$", "", NAME)) %>%
     mutate(location=replace(location, 
                          statename=='South Dakota' & location=='Shannon', 
                          'Oglala Lakota')) %>%
  left_join(regionids,by=c('location'='county')) %>%
  subset(region!='') %>%
  
  #group by region and aggregate measures
  group_by(region) %>%
  summarise(Number=sum(Number),
            Percent=sum(Number)/sum(totalpop),
            number_moe=sqrt(sum(number_moe^2)),
            percent_moe=(1/sum(totalpop))*sqrt((number_moe^2)-
                                                 ((Percent^2)*((sqrt(sum(percent_moe)))^2)))) %>%
  
  ungroup %>%
  
  #calculate relative SE and remove data where relative standard error is greater than 30
  mutate(number_relativese=((number_moe/1.645)/Number)*100) %>%
  mutate(percent_relativese=((percent_moe/1.645)/Percent)*100) %>%
  mutate(keep=if_else(percent_relativese>30 | number_relativese>30,0,1)) %>%
  mutate(Number=replace(Number,keep==0,NA)) %>%
  mutate(Percent=replace(Percent,keep==0,NA)) %>%

  
  #calculate lower and upper bounds of confidence interval
  mutate(number_lci=Number-number_moe) %>%
  mutate(number_uci=Number+number_moe) %>%
  mutate(percent_lci=Percent-percent_moe) %>%
  mutate(percent_uci=Percent+percent_moe) %>%
  
  #add Kids Count variables and formatting
  select(-c(keep,number_relativese,percent_relativese)) %>%
  rename(location=region) %>%
  
  #pivot longer
  pivot_longer(cols=c(Number,Percent),names_to='dataformat',values_to='data') %>%
  mutate(moe=case_when(
    dataformat=='Number' ~ number_moe,
    dataformat=='Percent' ~ percent_moe)) %>%
  mutate(lci=case_when(
    dataformat=='Number' ~ number_lci,
    dataformat=='Percent' ~ percent_lci)) %>%
  mutate(uci=case_when(
    dataformat=='Number' ~ number_uci,
    dataformat=='Percent' ~ percent_uci)) %>%
  select(-c(number_moe,percent_moe,number_uci,number_lci,percent_uci,percent_lci)) %>%
  
  mutate(age_group='Ages 0-17') %>%
  mutate(locationtype='Planning Region') %>%
  mutate(state=statename) %>%
  mutate(timeframe=year) %>%
  mutate(varname='saipe_childreninpoverty')


###############################################
#UNION COUNTY, STATE, AND STATE PLANNING REGION
saipe_ages0to17 <- saipe_county %>%
  bind_rows(saipe_state) %>%
  bind_rows(saipe_region) %>%
  
  #merge in location ids
  mutate(location=replace(location, 
                          statename=='Montana' & location=='Lewis and Clark', 
                          'Lewis & Clark')) %>%
  mutate(location=replace(location, 
                          statename=='South Dakota' & location=='Shannon', 
                          'Oglala Lakota')) %>%
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId)



####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(saipe_ages0to17$locationid))>=1) {
  print(saipe_ages0to17$location[is.na(saipe_ages0to17$locationid)])
} else if (sum(is.na(saipe_ages0to17$locationid))==0) {
  'all locations match'
}

# 2. Output cases where percent data is greater than 1
temp_percheck <- saipe_ages0to17 %>%
  subset(dataformat=='Percent' & data>1)
temp_rows <- as.numeric(nrow(temp_percheck))

if (temp_rows==0) {
  'no percents greater than 1'
} else if (temp_rows>=1) {
  print(temp_percheck)
}

# 3. Visually inspect output data
View(saipe_ages0to17)

```

# STEP 2: CALCULATE FOR AGE GROUP 5-17
```{r}
##UNDER THE getCensus() FUNCTION, ADD YOUR OWN CENSUS API KEY IN ORDER TO USE THIS CODE. OR FOLLOW THE INSTRUCTIONS ON THE PACKAGE DOCUMENTATION TO SET YOUR API KEY IN YOUR R ENVIRONMENT
#https://cran.r-project.org/web/packages/censusapi/vignettes/getting-started.html


#timeseries/poverty/saipe table is: Small Area Income and Poverty Estimates

############
#COUNTY DATA
saipe_county_5to17 <- getCensus(name="timeseries/poverty/saipe",
          key=Sys.getenv("CENSUS_API_KEY"),
          vars=c("NAME","SAEPOV5_17R_PT","SAEPOV5_17R_MOE","SAEPOVRT5_17R_PT",
                 "SAEPOVRT5_17R_MOE"),
          region="county:*",
          regionin=paste0("state:",statecode),
          YEAR=year) %>%

  #rename columns
  rename(Number=SAEPOV5_17R_PT,
         number_moe=SAEPOV5_17R_MOE,
         Percent=SAEPOVRT5_17R_PT,
         percent_moe=SAEPOVRT5_17R_MOE) %>%
  
  #calculate relative SE and remove data where relative standard error is greater than 30
  mutate(number_relativese=((number_moe/1.645)/Number)*100) %>%
  mutate(percent_relativese=((percent_moe/1.645)/Percent)*100) %>%
  mutate(keep=if_else(percent_relativese>30 | number_relativese>30,0,1)) %>%
  mutate(Number=replace(Number,keep==0,NA)) %>%
  mutate(Percent=replace(Percent,keep==0,NA)) %>%
  
  #change percent into decimals
  mutate(Percent=Percent/100) %>%
  mutate(percent_moe=percent_moe/100) %>%
  
  #calculate lower and upper bounds of confidence interval
  mutate(number_lci=Number-number_moe) %>%
  mutate(number_uci=Number+number_moe) %>%
  mutate(percent_lci=Percent-percent_moe) %>%
  mutate(percent_uci=Percent+percent_moe) %>%
  
  #add Kids Count variables and formatting
  mutate(location=gsub("\\s*\\w*$", "", NAME)) %>%
  select(-c(YEAR,state,county,NAME,keep,number_relativese,percent_relativese)) %>%
  
  #pivot longer
  pivot_longer(cols=c(Number,Percent),names_to='dataformat',values_to='data') %>%
  mutate(moe=case_when(
    dataformat=='Number' ~ number_moe,
    dataformat=='Percent' ~ percent_moe)) %>%
  mutate(lci=case_when(
    dataformat=='Number' ~ number_lci,
    dataformat=='Percent' ~ percent_lci)) %>%
  mutate(uci=case_when(
    dataformat=='Number' ~ number_uci,
    dataformat=='Percent' ~ percent_uci)) %>%
  select(-c(number_moe,percent_moe,number_uci,number_lci,percent_uci,percent_lci)) %>%
  
  mutate(age_group='Ages 5-17') %>%
  mutate(locationtype='County') %>%
  mutate(state=statename) %>%
  mutate(timeframe=year) %>%
  mutate(varname='saipe_childreninpoverty')

###########
#STATE DATA
saipe_state_5to17 <- getCensus(name="timeseries/poverty/saipe",
          key=Sys.getenv("CENSUS_API_KEY"),
          vars=c("NAME","SAEPOV5_17R_PT","SAEPOV5_17R_MOE","SAEPOVRT5_17R_PT",
                 "SAEPOVRT5_17R_MOE"),
          region=paste0("state:",statecode),
          YEAR=year) %>%

  #rename columns
  rename(Number=SAEPOV5_17R_PT,
         number_moe=SAEPOV5_17R_MOE,
         Percent=SAEPOVRT5_17R_PT,
         percent_moe=SAEPOVRT5_17R_MOE) %>%
  
  #calculate relative SE and remove data where relative standard error is greater than 30
  mutate(number_relativese=((number_moe/1.645)/Number)*100) %>%
  mutate(percent_relativese=((percent_moe/1.645)/Percent)*100) %>%
  mutate(keep=if_else(percent_relativese>30 | number_relativese>30,0,1)) %>%
  mutate(Number=replace(Number,keep==0,NA)) %>%
  mutate(Percent=replace(Percent,keep==0,NA)) %>%
  
  #change percent into decimals
  mutate(Percent=Percent/100) %>%
  mutate(percent_moe=percent_moe/100) %>%
  
  #calculate lower and upper bounds of confidence interval
  mutate(number_lci=Number-number_moe) %>%
  mutate(number_uci=Number+number_moe) %>%
  mutate(percent_lci=Percent-percent_moe) %>%
  mutate(percent_uci=Percent+percent_moe) %>%
  
  #add Kids Count variables and formatting
  mutate(location=statename) %>%
  select(-c(YEAR,state,NAME,keep,number_relativese,percent_relativese)) %>%
  
  #pivot longer
  pivot_longer(cols=c(Number,Percent),names_to='dataformat',values_to='data') %>%
  mutate(moe=case_when(
    dataformat=='Number' ~ number_moe,
    dataformat=='Percent' ~ percent_moe)) %>%
  mutate(lci=case_when(
    dataformat=='Number' ~ number_lci,
    dataformat=='Percent' ~ percent_lci)) %>%
  mutate(uci=case_when(
    dataformat=='Number' ~ number_uci,
    dataformat=='Percent' ~ percent_uci)) %>%
  select(-c(number_moe,percent_moe,number_uci,number_lci,percent_uci,percent_lci)) %>%
  
  mutate(age_group='Ages 5-17') %>%
  mutate(locationtype='State') %>%
  mutate(state=statename) %>%
  mutate(timeframe=year) %>%
  mutate(varname='saipe_childreninpoverty')

############
#REGION DATA
saipe_region_5to17 <- getCensus(name="timeseries/poverty/saipe",
          key=Sys.getenv("CENSUS_API_KEY"),
          vars=c("NAME","SAEPOV5_17R_PT","SAEPOV5_17R_MOE","SAEPOVRT5_17R_PT",
                 "SAEPOVRT5_17R_MOE","SAEPOVU_5_17R"),
          region="county:*",
          regionin=paste0("state:",statecode),
          YEAR=year) %>%

  #rename columns
  rename(Number=SAEPOV5_17R_PT,
         number_moe=SAEPOV5_17R_MOE,
         Percent=SAEPOVRT5_17R_PT,
         percent_moe=SAEPOVRT5_17R_MOE,
         totalpop=SAEPOVU_5_17R) %>%
  

  #merge in region ids
  mutate(location=gsub("\\s*\\w*$", "", NAME)) %>%
    mutate(location=replace(location, 
                          statename=='South Dakota' & location=='Shannon', 
                          'Oglala Lakota')) %>%
  left_join(regionids,by=c('location'='county')) %>%
  subset(region!='') %>%
  
  #group by region and aggregate measures
  group_by(region) %>%
  summarise(Number=sum(Number),
            Percent=sum(Number)/sum(totalpop),
            number_moe=sqrt(sum(number_moe^2)),
            percent_moe=(1/sum(totalpop))*sqrt((number_moe^2)-
                                                 ((Percent^2)*((sqrt(sum(percent_moe)))^2)))) %>%
  
  ungroup %>%
  
  #calculate relative SE and remove data where relative standard error is greater than 30
  mutate(number_relativese=((number_moe/1.645)/Number)*100) %>%
  mutate(percent_relativese=((percent_moe/1.645)/Percent)*100) %>%
  mutate(keep=if_else(percent_relativese>30 | number_relativese>30,0,1)) %>%
  mutate(Number=replace(Number,keep==0,NA)) %>%
  mutate(Percent=replace(Percent,keep==0,NA)) %>%

  
  #calculate lower and upper bounds of confidence interval
  mutate(number_lci=Number-number_moe) %>%
  mutate(number_uci=Number+number_moe) %>%
  mutate(percent_lci=Percent-percent_moe) %>%
  mutate(percent_uci=Percent+percent_moe) %>%
  
  #add Kids Count variables and formatting
  select(-c(keep,number_relativese,percent_relativese)) %>%
  rename(location=region) %>%
  
  #pivot longer
  pivot_longer(cols=c(Number,Percent),names_to='dataformat',values_to='data') %>%
  mutate(moe=case_when(
    dataformat=='Number' ~ number_moe,
    dataformat=='Percent' ~ percent_moe)) %>%
  mutate(lci=case_when(
    dataformat=='Number' ~ number_lci,
    dataformat=='Percent' ~ percent_lci)) %>%
  mutate(uci=case_when(
    dataformat=='Number' ~ number_uci,
    dataformat=='Percent' ~ percent_uci)) %>%
  select(-c(number_moe,percent_moe,number_uci,number_lci,percent_uci,percent_lci)) %>%
  
  mutate(age_group='Ages 5-17') %>%
  mutate(locationtype='Planning Region') %>%
  mutate(state=statename) %>%
  mutate(timeframe=year) %>%
  mutate(varname='saipe_childreninpoverty')


###############################################
#UNION COUNTY, STATE, AND STATE PLANNING REGION
saipe_ages5to17 <- saipe_county_5to17 %>%
  bind_rows(saipe_state_5to17) %>%
  bind_rows(saipe_region_5to17) %>%
  
  #merge in location ids
  mutate(location=replace(location, 
                          statename=='Montana' & location=='Lewis and Clark', 
                          'Lewis & Clark')) %>%
  mutate(location=replace(location, 
                          statename=='South Dakota' & location=='Shannon', 
                          'Oglala Lakota')) %>%
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId)



####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(saipe_ages5to17$locationid))>=1) {
  print(saipe_ages5to17$location[is.na(saipe_ages5to17$locationid)])
} else if (sum(is.na(saipe_ages5to17$locationid))==0) {
  'all locations match'
}

# 2. Output cases where percent data is greater than 1
temp_percheck <- saipe_ages5to17 %>%
  subset(dataformat=='Percent' & data>1)
temp_rows <- as.numeric(nrow(temp_percheck))

if (temp_rows==0) {
  'no percents greater than 1'
} else if (temp_rows>=1) {
  print(temp_percheck)
}

# 3. Visually inspect output data
View(saipe_ages5to17)

```

# STEP 3: CALCULATE FOR AGE GROUP 0-4 (STATEWIDE ONLY)
```{r}
##UNDER THE getCensus() FUNCTION, ADD YOUR OWN CENSUS API KEY IN ORDER TO USE THIS CODE. OR FOLLOW THE INSTRUCTIONS ON THE PACKAGE DOCUMENTATION TO SET YOUR API KEY IN YOUR R ENVIRONMENT
#https://cran.r-project.org/web/packages/censusapi/vignettes/getting-started.html


#timeseries/poverty/saipe table is: Small Area Income and Poverty Estimates

###########
#STATE DATA
saipe_state_0to4 <- getCensus(name="timeseries/poverty/saipe",
          key=Sys.getenv("CENSUS_API_KEY"),
          vars=c("NAME","SAEPOV0_4_PT","SAEPOV0_4_MOE","SAEPOVRT0_4_PT",
                 "SAEPOVRT0_4_MOE"),
          region=paste0("state:",statecode),
          YEAR=year) %>%

  #rename columns
  rename(Number=SAEPOV0_4_PT,
         number_moe=SAEPOV0_4_MOE,
         Percent=SAEPOVRT0_4_PT,
         percent_moe=SAEPOVRT0_4_MOE) %>%
  
  #calculate relative SE and remove data where relative standard error is greater than 30
  mutate(number_relativese=((number_moe/1.645)/Number)*100) %>%
  mutate(percent_relativese=((percent_moe/1.645)/Percent)*100) %>%
  mutate(keep=if_else(percent_relativese>30 | number_relativese>30,0,1)) %>%
  mutate(Number=replace(Number,keep==0,NA)) %>%
  mutate(Percent=replace(Percent,keep==0,NA)) %>%
  
  #change percent into decimals
  mutate(Percent=Percent/100) %>%
  mutate(percent_moe=percent_moe/100) %>%
  
  #calculate lower and upper bounds of confidence interval
  mutate(number_lci=Number-number_moe) %>%
  mutate(number_uci=Number+number_moe) %>%
  mutate(percent_lci=Percent-percent_moe) %>%
  mutate(percent_uci=Percent+percent_moe) %>%
  
  #add Kids Count variables and formatting
  mutate(location=statename) %>%
  select(-c(YEAR,state,NAME,keep,number_relativese,percent_relativese)) %>%
  
  #pivot longer
  pivot_longer(cols=c(Number,Percent),names_to='dataformat',values_to='data') %>%
  mutate(moe=case_when(
    dataformat=='Number' ~ number_moe,
    dataformat=='Percent' ~ percent_moe)) %>%
  mutate(lci=case_when(
    dataformat=='Number' ~ number_lci,
    dataformat=='Percent' ~ percent_lci)) %>%
  mutate(uci=case_when(
    dataformat=='Number' ~ number_uci,
    dataformat=='Percent' ~ percent_uci)) %>%
  select(-c(number_moe,percent_moe,number_uci,number_lci,percent_uci,percent_lci)) %>%
  
  mutate(age_group='Ages 0-4') %>%
  mutate(locationtype='State') %>%
  mutate(state=statename) %>%
  mutate(timeframe=year) %>%
  mutate(varname='saipe_childreninpoverty')



###############################################
#UNION COUNTY, STATE, AND STATE PLANNING REGION
saipe_ages0to4 <- saipe_state_0to4 %>%
  
  #merge in location ids
  mutate(location=replace(location, 
                          statename=='Montana' & location=='Lewis and Clark', 
                          'Lewis & Clark')) %>%
  mutate(location=replace(location, 
                          statename=='South Dakota' & location=='Shannon', 
                          'Oglala Lakota')) %>%
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId)



####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(saipe_ages0to4$locationid))>=1) {
  print(saipe_ages0to4$location[is.na(saipe_ages0to4$locationid)])
} else if (sum(is.na(saipe_ages0to4$locationid))==0) {
  'all locations match'
}

# 2. Output cases where percent data is greater than 1
temp_percheck <- saipe_ages0to4 %>%
  subset(dataformat=='Percent' & data>1)
temp_rows <- as.numeric(nrow(temp_percheck))

if (temp_rows==0) {
  'no percents greater than 1'
} else if (temp_rows>=1) {
  print(temp_percheck)
}

# 3. Visually inspect output data
View(saipe_ages0to4)

```

# STEP 4: COMBINE AGE GROUPS
```{r}
saipe <- saipe_ages0to17 %>%
  bind_rows(saipe_ages5to17) %>%
  bind_rows(saipe_ages0to4)
```

# STEP 5a: COMMIT TO DATABASE (MONTANA & SOUTH DAKOTA WITHOUT PLANNING REGIONS)
```{r}
#CHECK DATASET NAMED saipe TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
saipe2 <- saipe %>% subset(locationtype != 'Planning Region')
dbWriteTable(con,database_state,saipe2,append=TRUE,row.names=FALSE)
```

# STEP 5b: COMMIT TO DATABASE (NORTH DAKOTA WITH PLANNING REGIONS)
```{r}
#CHECK DATASET NAMED saipe TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
dbWriteTable(con,database_state,saipe,append=TRUE,row.names=FALSE)
```


# STEP 6A: OUTPUT FILE TO UPLOAD TO DATA CENTER (MONTANA & SOUTH DAKOTA WITHOUT PLANNING REGIONS)
```{r}
#########################
##OUTPUT DATA CENTER FILE

saipe_datacenter_sql <- paste0("SELECT locationid, location, timeframe, age_group, dataformat, data FROM ", database_state," WHERE timeframe='",year,"' AND varname='saipe_childreninpoverty';")

upload_data_saipe<- dbGetQuery(con,saipe_datacenter_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data,
         'Age group'=age_group)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data_saipe,file=paste0("../Output/economics/",database_state,"_",year,"_saipe_childreninpoverty.csv"),row.names=FALSE)


#############################
##OUTPUT MARGIN OF ERROR FILE
saipe_moe_sql <- paste0("SELECT location, timeframe, age_group, dataformat, data, lci, uci FROM ", database_state," WHERE timeframe='",year,"' AND varname='saipe_childreninpoverty' AND locationtype='County';")

#alphabetize counties
moe_output_saipe<- dbGetQuery(con,saipe_moe_sql) %>%
  pivot_wider(names_from=dataformat,values_from=c(data,lci,uci)) %>%
  pivot_wider(names_from=age_group,values_from=c(data_Number,lci_Number,uci_Number,data_Percent,lci_Percent,uci_Percent)) %>%
  select(c(timeframe,location,
           'data_Number_Ages 0-17','lci_Number_Ages 0-17','uci_Number_Ages 0-17',
           'data_Percent_Ages 0-17','lci_Percent_Ages 0-17','uci_Percent_Ages 0-17',
           'data_Number_Ages 5-17','lci_Number_Ages 5-17','uci_Number_Ages 5-17',
           'data_Percent_Ages 5-17','lci_Percent_Ages 5-17','uci_Percent_Ages 5-17')) %>%
  arrange(location)

#state
saipe_moe_sql2 <- paste0("SELECT location, timeframe, age_group, dataformat, data, lci, uci FROM ", database_state," WHERE timeframe='",year,"' AND varname='saipe_childreninpoverty' AND locationtype='State';")

moe_output_saipe2 <- dbGetQuery(con,saipe_moe_sql2) %>%
  pivot_wider(names_from=dataformat,values_from=c(data,lci,uci)) %>%
  pivot_wider(names_from=age_group,values_from=c(data_Number,lci_Number,uci_Number,data_Percent,lci_Percent,uci_Percent)) %>%
  select(c(timeframe,location,
           'data_Number_Ages 0-17','lci_Number_Ages 0-17','uci_Number_Ages 0-17',
           'data_Percent_Ages 0-17','lci_Percent_Ages 0-17','uci_Percent_Ages 0-17',
           'data_Number_Ages 5-17','lci_Number_Ages 5-17','uci_Number_Ages 5-17',
           'data_Percent_Ages 5-17','lci_Percent_Ages 5-17','uci_Percent_Ages 5-17',
           'data_Number_Ages 0-4','lci_Number_Ages 0-4','uci_Number_Ages 0-4',
           'data_Percent_Ages 0-4','lci_Percent_Ages 0-4','uci_Percent_Ages 0-4')) 



#combine county and state/state planning region
moe_output_saipe_ordered <- moe_output_saipe %>%
  bind_rows(moe_output_saipe2) 


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(moe_output_saipe_ordered,file=paste0("../Output/economics/moe/",database_state,"_",year,"_saipe_childreninpoverty_moe.csv"),row.names=FALSE)
```

# STEP 6B: OUTPUT FILE TO UPLOAD TO DATA CENTER (NORTH DAKOTA WITH PLANNING REGIONS)
```{r}
#########################
##OUTPUT DATA CENTER FILE

saipe_datacenter_sql <- paste0("SELECT locationid, location, timeframe, age_group, dataformat, data FROM ", database_state," WHERE timeframe='",year,"' AND varname='saipe_childreninpoverty';")

upload_data_saipe<- dbGetQuery(con,saipe_datacenter_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data,
         'Age group'=age_group)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data_saipe,file=paste0("../Output/economics/",database_state,"_",year,"_saipe_childreninpoverty.csv"),row.names=FALSE)


#############################
##OUTPUT MARGIN OF ERROR FILE
saipe_moe_sql <- paste0("SELECT location, timeframe, age_group, dataformat, data, lci, uci FROM ", database_state," WHERE timeframe='",year,"' AND varname='saipe_childreninpoverty' AND locationtype='County';")

#alphabetize counties
moe_output_saipe<- dbGetQuery(con,saipe_moe_sql) %>%
  pivot_wider(names_from=dataformat,values_from=c(data,lci,uci)) %>%
  pivot_wider(names_from=age_group,values_from=c(data_Number,lci_Number,uci_Number,data_Percent,lci_Percent,uci_Percent)) %>%
  select(c(timeframe,location,
           'data_Number_Ages 0-17','lci_Number_Ages 0-17','uci_Number_Ages 0-17',
           'data_Percent_Ages 0-17','lci_Percent_Ages 0-17','uci_Percent_Ages 0-17',
           'data_Number_Ages 5-17','lci_Number_Ages 5-17','uci_Number_Ages 5-17',
           'data_Percent_Ages 5-17','lci_Percent_Ages 5-17','uci_Percent_Ages 5-17')) %>%
  arrange(location)

#state
saipe_moe_sql2 <- paste0("SELECT location, timeframe, age_group, dataformat, data, lci, uci FROM ", database_state," WHERE timeframe='",year,"' AND varname='saipe_childreninpoverty' AND locationtype='State';")

moe_output_saipe2 <- dbGetQuery(con,saipe_moe_sql2) %>%
  pivot_wider(names_from=dataformat,values_from=c(data,lci,uci)) %>%
  pivot_wider(names_from=age_group,values_from=c(data_Number,lci_Number,uci_Number,data_Percent,lci_Percent,uci_Percent)) %>%
  select(c(timeframe,location,
           'data_Number_Ages 0-17','lci_Number_Ages 0-17','uci_Number_Ages 0-17',
           'data_Percent_Ages 0-17','lci_Percent_Ages 0-17','uci_Percent_Ages 0-17',
           'data_Number_Ages 5-17','lci_Number_Ages 5-17','uci_Number_Ages 5-17',
           'data_Percent_Ages 5-17','lci_Percent_Ages 5-17','uci_Percent_Ages 5-17',
           'data_Number_Ages 0-4','lci_Number_Ages 0-4','uci_Number_Ages 0-4',
           'data_Percent_Ages 0-4','lci_Percent_Ages 0-4','uci_Percent_Ages 0-4')) 

#state planning region
saipe_moe_sql3 <- paste0("SELECT location, timeframe, age_group, dataformat, data, lci, uci FROM ", database_state," WHERE timeframe='",year,"' AND varname='saipe_childreninpoverty' AND locationtype='Planning Region';")

moe_output_saipe3 <- dbGetQuery(con,saipe_moe_sql3) %>%
  pivot_wider(names_from=dataformat,values_from=c(data,lci,uci)) %>%
  pivot_wider(names_from=age_group,values_from=c(data_Number,lci_Number,uci_Number,data_Percent,lci_Percent,uci_Percent)) %>%
  select(c(timeframe,location,
           'data_Number_Ages 0-17','lci_Number_Ages 0-17','uci_Number_Ages 0-17',
           'data_Percent_Ages 0-17','lci_Percent_Ages 0-17','uci_Percent_Ages 0-17',
           'data_Number_Ages 5-17','lci_Number_Ages 5-17','uci_Number_Ages 5-17',
           'data_Percent_Ages 5-17','lci_Percent_Ages 5-17','uci_Percent_Ages 5-17')) 

#combine county and state/state planning region
moe_output_saipe_ordered <- moe_output_saipe %>%
  bind_rows(moe_output_saipe2) %>%
  bind_rows(moe_output_saipe3)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(moe_output_saipe_ordered,file=paste0("../Output/economics/moe/",database_state,"_",year,"_saipe_childreninpoverty_moe.csv"),row.names=FALSE)
```


# STEP 5B: OUTPUT KIDS COUNT DATA CENTER FORMAT (SKIP ADDING TO DATABASE AND MARGINS OF ERROR)
#This is code that can be used by states that do not have a database to store KIDS COUNT data, but just need a .csv output to upload to the data center.
**You must add a file path and name the desired csv file to the write.csv code**
```{r}
saipe_kcdatacenter <- saipe %>%
  select(c(location,dataformat,data,age_group,timeframe,locationid)) %>%
  rename(Location=location,
         DataFormat=dataformat,
         Data=data,
         'Age group'=age_group,
         TimeFrame=timeframe,
         LocationId=locationid)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(saipe_kcdatacenter,file="your path/goes here/nameyourcsv.csv",row.names=FALSE)
```



## ###################################### ##
## CHILDREN IN POVERTY BY SCHOOL DISTRICT ##
## ###################################### ##

#SOUTH DAKOTA
# STEP 1: CALCULATE FOR AGE GROUP 5-17
```{r}
##UNDER THE getCensus() FUNCTION, ADD YOUR OWN CENSUS API KEY IN ORDER TO USE THIS CODE. OR FOLLOW THE INSTRUCTIONS ON THE PACKAGE DOCUMENTATION TO SET YOUR API KEY IN YOUR R ENVIRONMENT
#https://cran.r-project.org/web/packages/censusapi/vignettes/getting-started.html


#timeseries/poverty/saipe/schdist table is: Small Area Income and Poverty Estimates for School Districts

#####################
#SCHOOL DISTRICT DATA
saipe_district_5to17 <- getCensus(name="timeseries/poverty/saipe/schdist",
          key=Sys.getenv("CENSUS_API_KEY"),
          vars=c("SD_NAME","SAEPOV5_17RV_PT","SAEPOVRAT5_17RV_PT"),
          region="school district (unified):*",
          regionin=paste0("state:",statecode),
          YEAR=year) %>%

  #rename columns
  rename(Number=SAEPOV5_17RV_PT,
         Percent=SAEPOVRAT5_17RV_PT) %>%
  
  #change percent into decimals
  mutate(Percent=Percent/100) %>%
  

  #add Kids Count variables and formatting
  mutate(location=tolower(SD_NAME)) %>% 
  mutate(location=tools::toTitleCase(location)) %>%
  select(c(location,Number,Percent)) %>%
  
  #pivot longer
  pivot_longer(cols=c(Number,Percent),names_to='dataformat',values_to='data') %>%
  
  mutate(age_group='Ages 5-17') %>%
  mutate(locationtype='School District') %>%
  mutate(state=statename) %>%
  mutate(timeframe=year) %>%
  mutate(varname='saipe_childreninpoverty_schooldistrict') %>%


  #merge in location ids
  mutate(location=replace(location, 
                          statename=='South Dakota' & location=='Shannon County School District 65-1', 
                          'Oglala Lakota County School District 65-1')) %>%
  mutate(location=replace(location, 
                          statename=='South Dakota' & location=='Mccook Central School District 43-7', 
                          'McCook Central School District 43-7')) %>%
      mutate(location=replace(location, 
                          statename=='South Dakota' & location=='Chester School District 39-1', 
                          'Chester Area District 39-1')) %>%
        mutate(location=replace(location, 
                          statename=='South Dakota' & location=='Mclaughlin School District 15-2', 
                          'McLaughlin School District 15-2')) %>%
          mutate(location=replace(location, 
                          statename=='South Dakota' & location=='Mcintosh School District 15-1', 
                          'McIntosh School District 15-1')) %>%
          mutate(location=replace(location, 
                          statename=='South Dakota' & location=='Corsica-Stickney 21-3', 
                          'Corsica-Stickney School District 21-3')) %>%
          mutate(location=replace(location, 
                          statename=='South Dakota' & location=='Oldham-Ramona-Rutland 39-6', 
                          'Oldham-Ramona-Rutland School District 39-6')) %>%
  mutate(location=replace(location, 
                          statename=='South Dakota' & location=='Viborg Hurley School District 60-6', 
                          'Viborg Hurley 60-6')) %>%
  
  

  
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) 



####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(saipe_district_5to17$locationid))>=1) {
  print(saipe_district_5to17$location[is.na(saipe_district_5to17$locationid)])
} else if (sum(is.na(saipe_district_5to17$locationid))==0) {
  'all locations match'
}

# 2. Output cases where percent data is greater than 1
temp_percheck <- saipe_district_5to17 %>%
  subset(dataformat=='Percent' & data>1)
temp_rows <- as.numeric(nrow(temp_percheck))

if (temp_rows==0) {
  'no percents greater than 1'
} else if (temp_rows>=1) {
  print(temp_percheck)
}

# 3. Visually inspect output data
View(saipe_district_5to17)

```

# STEP 2: COMMIT TO DATABASE AND CREATE FILES FOR OUTPUT
```{r}
#CHECK DATASET NAMED saipe_district_5to17 TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
dbWriteTable(con,database_state,saipe_district_5to17,append=TRUE,row.names=FALSE)
```

```{r}
#########################
##OUTPUT DATA CENTER FILE

saipe_district_datacenter_sql <- paste0("SELECT locationid, location, timeframe, age_group, dataformat, data FROM ", database_state," WHERE timeframe='",year,"' AND varname='saipe_childreninpoverty_schooldistrict' AND dataformat='Percent';")

#also include state data
saipe_state_datacenter_sql <- paste0("SELECT locationid, location, timeframe, age_group, dataformat, data FROM ", database_state," WHERE timeframe='",year,"' AND varname='saipe_childreninpoverty' AND dataformat='Percent' AND locationtype='State' AND age_group='Ages 5-17';")

upload_data_saipe_district <- dbGetQuery(con,saipe_district_datacenter_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data,
         'Age group'=age_group)

upload_data_saipe_state <- dbGetQuery(con,saipe_state_datacenter_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data,
         'Age group'=age_group)

#combine state and district
upload_data_saipe_disctrictstate <- upload_data_saipe_district %>%
  bind_rows(upload_data_saipe_state)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data_saipe_disctrictstate,file=paste0("../Output/economics/",database_state,"_",year,"_saipe_childreninpoverty_schooldistrict.csv"),row.names=FALSE)

```

# STEP 2B: OUTPUT KIDS COUNT DATA CENTER FORMAT (SKIP ADDING TO DATABASE)
#This is code that can be used by states that do not have a database to store KIDS COUNT data, but just need a .csv output to upload to the data center.
**You must add a file path and name the desired csv file to the write.csv code**
```{r}
saipe_schooldistrict_kcdatacenter <- saipe_district_5to17 %>%
  select(c(location,dataformat,data,age_group,timeframe,locationid)) %>%
  rename(Location=location,
         DataFormat=dataformat,
         Data=data,
         'Age group'=age_group,
         TimeFrame=timeframe,
         LocationId=locationid)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(saipe_schooldistrict_kcdatacenter,file="your path/goes here/nameyourcsv.csv",row.names=FALSE)
```




## ####################### ##
## MEDIAN HOUSEHOLD INCOME ##
## ####################### ##

# STEP 1: IMPORT AND CLEAN DATA
```{r}
##UNDER THE getCensus() FUNCTION, ADD YOUR OWN CENSUS API KEY IN ORDER TO USE THIS CODE. OR FOLLOW THE INSTRUCTIONS ON THE PACKAGE DOCUMENTATION TO SET YOUR API KEY IN YOUR R ENVIRONMENT
#https://cran.r-project.org/web/packages/censusapi/vignettes/getting-started.html


#timeseries/poverty/saipe table is: Small Area Income and Poverty Estimates

############
#COUNTY DATA
median_county <- getCensus(name="timeseries/poverty/saipe",
          key=Sys.getenv("CENSUS_API_KEY"),
          vars=c("NAME","SAEMHI_PT","SAEMHI_MOE","SAEMHI_LB90","SAEMHI_UB90"),
          region="county:*",
          regionin=paste0("state:",statecode),
          YEAR=year) %>%
  
  #rename columns
  rename(data=SAEMHI_PT,
         moe=SAEMHI_MOE,
         lci=SAEMHI_LB90,
         uci=SAEMHI_UB90,
         timeframe=YEAR) %>%
    
  #remove "County" from location
  mutate(location=gsub("\\s*\\w*$", "", NAME)) %>%
  #select KC database variables
  select(c(location,timeframe,data,moe,lci,uci)) %>%
  
  mutate(locationtype='County')

##########
#STAE DATA
median_state <- getCensus(name="timeseries/poverty/saipe",
          key=Sys.getenv("CENSUS_API_KEY"),
          vars=c("NAME","SAEMHI_PT","SAEMHI_MOE","SAEMHI_LB90","SAEMHI_UB90"),
          region=paste0("state:",statecode),
          YEAR=year) %>%
  
  #rename columns
  rename(location=NAME,
         data=SAEMHI_PT,
         moe=SAEMHI_MOE,
         lci=SAEMHI_LB90,
         uci=SAEMHI_UB90,
         timeframe=YEAR) %>%

  #select KC database variables
  select(c(location,timeframe,data,moe,lci,uci)) %>%
  
  mutate(locationtype='State')

#########################
#COMBINE STATE AND COUNTY
median_all <- median_county %>%
  bind_rows(median_state) %>%
  
  #calculate relative SE and remove data where relative standard error is greater than 30
  mutate(data=as.numeric(paste(data))) %>%
  mutate(moe=as.numeric(paste(moe))) %>%
  mutate(data_relativese=((moe/1.645)/data)*100) %>%
  mutate(keep=if_else(data_relativese>30,0,1)) %>%
  mutate(data=replace(data,keep==0,NA)) %>%
  mutate(moe=replace(moe,keep==0,NA)) %>%
  mutate(lci=replace(lci,keep==0,NA)) %>%
  mutate(uci=replace(uci,keep==0,NA)) %>%
  select(-c(keep,data_relativese)) %>%
  
  #add KC variables
  mutate(state=statename) %>%
  mutate(varname='medianhouseholdincome_saipe') %>%
  mutate(dataformat='Currency') %>%
  
#merge in location ids
  mutate(location=replace(location, 
                          statename=='Montana' & location=='Lewis and Clark', 
                          'Lewis & Clark')) %>%
  mutate(location=replace(location, 
                          statename=='South Dakota' & location=='Shannon', 
                          'Oglala Lakota')) %>%
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) 



####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(median_all$locationid))>=1) {
  print(median_all$location[is.na(median_all$locationid)])
} else if (sum(is.na(median_all$locationid))==0) {
  'all locations match'
}

# 2. Output cases where percent data is greater than 1
temp_percheck <- median_all %>%
  subset(dataformat=='Percent' & data>1)
temp_rows <- as.numeric(nrow(temp_percheck))

if (temp_rows==0) {
  'no percents greater than 1'
} else if (temp_rows>=1) {
  print(temp_percheck)
}

# 3. Visually inspect output data
View(median_all)
```

# STEP 2: COMMIT TO DATABASE AND CREATE FILES FOR OUTPUT
```{r}
#CHECK DATASET NAMED median_all TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
dbWriteTable(con,database_state,median_all,append=TRUE,row.names=FALSE)
```

```{r}
#########################
##OUTPUT DATA CENTER FILE

saipe_datacenter_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM ", database_state," WHERE timeframe='",year,"' AND varname='medianhouseholdincome_saipe';")

upload_data_saipe<- dbGetQuery(con,saipe_datacenter_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data_saipe,file=paste0("../Output/economics/",database_state,"_",year,"_medianhouseholdincome_saipe.csv"),row.names=FALSE)


#############################
##OUTPUT MARGIN OF ERROR FILE
saipe_moe_sql <- paste0("SELECT timeframe,location,data, lci, uci FROM ", database_state," WHERE timeframe='",year,"' AND varname='medianhouseholdincome_saipe' AND locationtype='County';")

#alphabetize counties
moe_output_saipe<- dbGetQuery(con,saipe_moe_sql) %>%
  arrange(location)

#state
saipe_moe_sql2 <- paste0("SELECT timeframe,location, data, lci, uci FROM ", database_state," WHERE timeframe='",year,"' AND varname='medianhouseholdincome_saipe' AND locationtype='State';")

moe_output_saipe2 <- dbGetQuery(con,saipe_moe_sql2)


#combine county and state
moe_output_saipe_ordered <- moe_output_saipe %>%
  bind_rows(moe_output_saipe2) 


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(moe_output_saipe_ordered,file=paste0("../Output/economics/moe/",database_state,"_",year,"_medianhouseholdincome_saipe_moe.csv"),row.names=FALSE)
```

# STEP 2B: OUTPUT KIDS COUNT DATA CENTER FORMAT (SKIP ADDING TO DATABASE AND MARGINS OF ERROR)
#This is code that can be used by states that do not have a database to store KIDS COUNT data, but just need a .csv output to upload to the data center.
**You must add a file path and name the desired csv file to the write.csv code**
```{r}
medianincome_kcdatacenter <- median_all %>%
  select(c(location,dataformat,data,timeframe,locationid)) %>%
  rename(Location=location,
         DataFormat=dataformat,
         Data=data,
         TimeFrame=timeframe,
         LocationId=locationid)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(medianincome_kcdatacenter,file="your path/goes here/nameyourcsv.csv",row.names=FALSE)
```





