---
title: "Child Population by Age Group by County"
author: Xanna Burg
output: html_document
---

## Indicator: Child Population by Age Group by County
**Created by:** Xanna Burg
**Date:** January, 2020
**Updated by:**

**Data Source:** U.S. Census Bureau, Annual Population Estimates. Specific table: pep/charagegroups 
**Purpose:** Connect to census data table, clean data, add to master database, output csv to upload to Data Center in correct format. Update Montana, North Dakota, and South Dakota KIDS COUNT Data Center indicator with most recent year of vintage data.
**Description:** this program calculates **Child population by age group by county**
* Age groups: Under age 5, Ages 5-13, Ages 14-17, Total under 18
* Geographies: state total, county, state planning regions (where applicable, which are groups of counties)
* Number - count of population
* Percent - the percent falling in the age range out of all children younger than 18 [numerater: count in age group/geography; denominator: all children under 18 in geography]

**Data format:** final output csv to upload is in long format with the following variables: Location (character: name of location), Age group (character), TimeFrame (numeric: year), Data (numeric: number or percentage), DataFormat (character: "number" or "percent"), LocationId (numeric: assigned for KIDS COUNT system)



```{r,message=FALSE}
#load required packages
library(tidyverse)
library(tidycensus)
library(censusapi)
library(stringr)
```

```{r}
#metadata for available variables
pop_vars <- listCensusMetadata(name="pep/charagegroups",
                               vintage="2018",
                               type="variables")
#view(pop_vars)

#metadata for available geographies
pop_geos <- listCensusMetadata(name="pep/charagegroups",
                               vintage="2018",
                               type="geography")
#view(pop_geos)

```

```{r}
#CHANGE THESE VARIABLES TO MATCH THE STATE AND YEAR
state <- "Montana"
year <- "2018vintage"
#if you want to rename previous years vintage and save in database, say yes
#otherwise if not vintage data, say no
vintage <- "no" 
#find the most recent database update data and add below
mostrecentdatabasedate <- "2020-01-24"
```

```{r}
#CHANGE THE API TO MATCH THE STATE

#write an API query
#pep/charagegroups table is: Population Estimates: Census Bureau Version: Demographic Characteristics Estimates by Age Groups
#api matches following query: #https://api.census.gov/data/2018/pep/charagegroups?get=POP,DATE_CODE,DATE_DESC&for=county:*&in=state:30&AGEGROUP=1&AGEGROUP=2&AGEGROUP=3&AGEGROUP=4

#see lookup table for categorical vars https://www.census.gov/data/developers/data-sets/popest-popproj/popest/popest-vars.Vintage_2018.html

#Montana=30
#North Dakota=38
#South Dakota=46

#ALL COUNTIES IN STATE
#MATCHING AGE GROUPS 1 (under age 5), 20 (Ages 5-13), 21 (ages 14-17), and 19 (under age 18)
if (state=="Montana") {
popest <- getCensus(name="pep/charagegroups",
          vintage="2018",
          key=Sys.getenv("CENSUS_API_KEY"),
          vars=c("POP","DATE_CODE","DATE_DESC","AGEGROUP"),
          region="county:*",
          regionin="state:30",
          AGEGROUP="1",
          AGEGROUP="19",
          AGEGROUP="20",
          AGEGROUP="21")
} else if (state=="North Dakota") {
popest <- getCensus(name="pep/charagegroups",
          vintage="2018",
          key=Sys.getenv("CENSUS_API_KEY"),
          vars=c("POP","DATE_CODE","DATE_DESC","AGEGROUP"),
          region="county:*",
          regionin="state:38",
          AGEGROUP="1",
          AGEGROUP="19",
          AGEGROUP="20",
          AGEGROUP="21")
} else if (state=="South Dakota") {
popest <- getCensus(name="pep/charagegroups",
          vintage="2018",
          key=Sys.getenv("CENSUS_API_KEY"),
          vars=c("POP","DATE_CODE","DATE_DESC","AGEGROUP"),
          region="county:*",
          regionin="state:46",
          AGEGROUP="1",
          AGEGROUP="19",
          AGEGROUP="20",
          AGEGROUP="21")}

```

```{r}
#clean the census data

#MERGE IN COUNTY AND STATE NAME USING FIPS CODES (from tidycensus package)
fips <- fips_codes
#remove leading zeroes from county string
fips$county_code = str_remove(fips$county_code, "^0+")


#MERGE FIPS STRING NAMES WITH POPULATION ESTIMATES
popest<- popest %>% 
  left_join(fips,by = c("state" = "state_code","county"="county_code"))

#REMOVE THE WORD COUNTY FROM COUNTY VARIABLE
popest$county.y<- gsub("\\s*\\w*$", "", popest$county.y)

#NAME COUNTY VARIABLE AS KC DATA CENTER WANTS - "Location"
popest$Location <- popest$county.y

#NAME POPULATION ESTIMATE AS KC DATA CENTER WANTS - "Data"
popest$Data <- popest$POP

#CREATE CHARACTER VARIABLE FOR AGE GROUPS
popest <- popest %>% mutate(Age_group = case_when(
  AGEGROUP==1 ~ "Under age 5",
  AGEGROUP==20 ~ "Ages 5-13",
  AGEGROUP==21 ~ "Ages 14-17",
  AGEGROUP==19 ~ "Under age 18"
))

#REMOVE CENSUS TIME FRAMES NOT USING
#DATE_CODE=2 is for decennial population estimate base
#DATE_CODE=3 is for decennial year estimates. 
#will use actual counts from decennial year, so removing DATE_CODE=2 & 3
popest <- subset(popest,DATE_CODE!="2" & DATE_CODE!="3")

#CREATE CHARACTER VARIABLE FOR TIME FRAMES
#these are vintage estimates, so need to update each year back to most recent decennial census
popest <- popest %>% mutate(TimeFrame = case_when(
  DATE_CODE==1 ~ 2010,
  DATE_CODE==4 ~ 2011,
  DATE_CODE==5 ~ 2012,
  DATE_CODE==6 ~ 2013,
  DATE_CODE==7 ~ 2014,
  DATE_CODE==8 ~ 2015,
  DATE_CODE==9 ~ 2016,
  DATE_CODE==10 ~2017,
  DATE_CODE==11 ~ 2018
))


#REMOVE VARIABLES NOT NEEDED AT THIS POINT
popest <- popest %>% select(Location,Age_group,TimeFrame,Data)

#CALCULATE PERCENT USING TOTAL BELOW AGE 18
#create a dataset that has total population under 18, location, time for merging
percent <- filter(popest,Age_group=="Under age 18")
percent$total_pop <- percent$Data
percent <- select(percent,Location,TimeFrame,total_pop)

#left join population estimates with total
popest <- popest %>%
  left_join(percent,by=NULL)

#calculate percent
popest$percent <- as.numeric(popest$Data)/as.numeric(popest$total_pop)

#CHANGE PERCENT INTO LONG FORMAT DATA SETUP
percent_temp <- select(popest,Location,Age_group,TimeFrame,percent)
percent_temp <- percent_temp %>% rename(Data=percent)
percent_temp$Data <- as.numeric(percent_temp$Data)
percent_temp$DataFormat <- "Percent"

popest_temp <- select(popest, Location, Age_group,TimeFrame,Data)
popest_temp$DataFormat <- "Number"
popest_temp$Data <- as.numeric(popest_temp$Data)

#UNION NUMBER AND PERCENT
popest_long <- popest_temp %>%
  bind_rows(percent_temp)

#ADD IN LOCATION TYPE AND VARIABLE NAME FOR DATABASE
popest_long$LocationType <- "County"
popest_long$VarName <- "childpopulationbyagegroupbycounty"

```

```{r}
##THESE NEXT STEPS ARE STATE DEPENDENT

#CREATE STATE TOTALS TO INCLUDE
state_totals <- filter(popest_long,DataFormat=="Number")
state_totals <- state_totals %>% 
  group_by(TimeFrame,Age_group) %>%
  summarise(Data = sum(Data))

state_totals$Location <- state

#CALCULATE PERCENT FOR STATE TOTALS
state_totals_percent <- filter(state_totals,Age_group=="Under age 18")
state_totals_percent <- rename(state_totals_percent, total_pop=Data)
state_totals_percent <- select(state_totals_percent,-Age_group)
  
#left join to incorporate back to full population dataset
state_totals_temp <- state_totals %>%
  left_join(state_totals_percent)

#calculate percent
state_totals_temp$percent <- state_totals_temp$Data/state_totals_temp$total_pop

#CHANGE PERCENT INTO LONG FORMAT DATA SETUP
percent_temp_state <- select(state_totals_temp,
                             Location,Age_group,TimeFrame,percent)
percent_temp_state <- percent_temp_state %>% rename(Data=percent)
percent_temp_state$Data <- as.numeric(percent_temp_state$Data)
percent_temp_state$DataFormat <- "Percent"

popest_temp_state <- select(state_totals_temp, 
                            Location, Age_group,TimeFrame,Data)
popest_temp_state$DataFormat <- "Number"
popest_temp_state$Data <- as.numeric(popest_temp_state$Data)

#UNION NUMBER AND PERCENT
popest_long_state <- popest_temp_state %>%
  bind_rows(percent_temp_state)

#ADD IN LOCATION TYPE AND VARIABLE NAME FOR DATABASE
popest_long_state$LocationType <- "State"
popest_long_state$VarName <- "childpopulationbyagegroupbycounty"

#UNION TO COUNTY DATA
popest_long <- popest_long %>%
  bind_rows(popest_long_state)

```

```{r}
##THESE NEXT STEPS ARE STATE DEPENDENT

#ADD IN STATE PLANNING REGIONS, IF AVAILABLE

#start with dataset that does not include state totals or percents
stateplanning <- filter(popest_long,Location!=state & DataFormat!="Percent")

if (state=="Montana") {
stateplanning <- stateplanning %>% mutate(region = case_when(
  Location=="Carter" | Location=="Custer" | Location=="Daniels" |
    Location=="Dawson" | Location=="Fallon" | Location=="Garfield" |
    Location=="McCone" | Location=="Phillips" | Location=="Powder River" | 
    Location=="Prairie" | Location=="Richland" | Location=="Roosevelt" | 
    Location=="Rosebud" | Location =="Sheridan" | Location=="Treasure" | 
    Location=="Valley" | Location=="Wibaux" ~ "Planning Region 1",
  Location=="Blaine" | Location=="Cascade" | Location=="Chouteau" | 
    Location=="Glacier" | Location=="Hill" | Location=="Liberty" | 
    Location=="Pondera" | Location=="Teton" | Location=="Toole" ~ 
    "Planning Region 2",
  Location=="Big Horn" | Location=="Carbon" | Location=="Fergus" | 
    Location=="Golden Valley" | Location=="Judith Basin" | 
    Location=="Musselshell" | Location=="Petroleum" | 
    Location=="Stillwater" | Location=="Sweet Grass" | 
    Location=="Wheatland" | Location=="Yellowstone" ~ 
    "Planning Region 3",
  Location=="Beaverhead" | Location=="Broadwater" | Location=="Deer Lodge" | 
    Location=="Gallatin" | Location=="Granite" | Location=="Jefferson" | 
    Location=="Lewis and Clark" | Location=="Madison" | 
    Location=="Meagher" | Location=="Park" | Location=="Powell" | 
    Location=="Silver Bow" ~ "Planning Region 4",
  Location=="Flathead" | Location=="Lake" | Location=="Lincoln" | 
    Location=="Mineral" | Location=="Missoula" | Location=="Ravalli" | 
    Location=="Sanders" ~ "Planning Region 5"
))

} else if (state=="North Dakota") {
  stateplanning <- stateplanning %>% mutate(region = case_when(
  Location=="Divide" | Location=="McKenzie" | Location=="Williams" ~
    "Planning Region 1",
  Location=="Bottineau" | Location=="Burke" | Location=="McHenry" | 
    Location=="Mountrail" | Location=="Pierce" | Location=="Pierce" | 
    Location=="Renville" | Location=="Ward" ~ "Planning Region 2",
  Location=="Benson" | Location=="Cavalier" | Location=="Eddy" | 
    Location=="Ramsey" | Location=="Rolette" | Location=="Towner"~
    "Planning Region 3",
  Location=="Grand Forks" | Location=="Nelson" | Location=="Pembina" | 
    Location=="Walsh" ~ "Planning Region 4",
  Location=="Cass" | Location=="Ransom" | Location=="Richland" | 
    Location=="Sargent" | Location=="Steele" | Location=="Traill" ~ 
    "Planning Region 5",
  Location=="Barnes"| Location=="Dickey" | Location=="Foster" | 
    Location=="Griggs" | Location=="LaMoure" | Location=="Logan" | 
    Location=="McIntosh" | Location=="Stutsman" | Location=="Wells" ~ 
    "Planning Region 6",
  Location=="Burleigh" | Location=="Emmons" | Location=="Grant" | 
    Location=="Kidder" | Location=="McLean" | Location=="Mercer" | 
    Location=="Morton" | Location=="Oliver" | Location=="Sheridan" |
    Location=="Sioux" ~ "Planning Region 7",
  Location=="Adams" | Location=="Billings" | Location=="Bowman" | 
    Location=="Dunn" | Location=="Golden Valley" | Location=="Hettinger" | 
    Location=="Slope" | Location=="Stark" ~ "Planning Region 8"
))
} else if (state=="South Dakota") {
  print("State does not have planning regions")
}

if (state=="Montana" | state=="North Dakota") {

stateplanning <- select(stateplanning,-c(Location,LocationType,VarName))
stateplanning <- rename(stateplanning,Location=region)


#CREATE STATE PLANNING TOTALS BY YEAR, AGE GROUP, AND REGION
stateplanning <- stateplanning %>% 
  group_by(TimeFrame,Age_group,Location) %>%
  summarise(Data = sum(Data))


stateplanning_totals <- filter(stateplanning,Age_group=="Under age 18")
stateplanning_totals <- rename(stateplanning_totals,delete=Age_group)

#CALCULATE PERCENT FOR STATE TOTALS
stateplanning_totals <- rename(stateplanning_totals, total_pop=Data)
  
#left join to incorporate back to full population dataset
stateplanning_totals_temp <- stateplanning %>%
  left_join(stateplanning_totals)

#calculate percent
stateplanning_totals_temp$percent <- stateplanning_totals_temp$Data/stateplanning_totals_temp$total_pop

#CHANGE PERCENT INTO LONG FORMAT DATA SETUP
percent_temp_stateplanning <- select(stateplanning_totals_temp,
                             Location,Age_group,TimeFrame,percent)
percent_temp_stateplanning <- percent_temp_stateplanning %>%
  rename(Data=percent)
percent_temp_stateplanning$Data <-
  as.numeric(percent_temp_stateplanning$Data)
percent_temp_stateplanning$DataFormat <- "Percent"

popest_temp_stateplanning <- select(stateplanning_totals_temp, 
                            Location, Age_group,TimeFrame,Data)
popest_temp_stateplanning$DataFormat <- "Number"
popest_temp_stateplanning$Data <- as.numeric(popest_temp_stateplanning$Data)

#UNION NUMBER AND PERCENT
popest_long_stateplanning <- popest_temp_stateplanning %>%
  bind_rows(percent_temp_stateplanning)

#ADD IN LOCATION TYPE AND VARIABLE NAME FOR DATABASE
popest_long_stateplanning$LocationType <- "State Planning"
popest_long_stateplanning$VarName <- "childpopulationbyagegroupbycounty"



#UNION TO COUNTY DATA
popest_long <- popest_long %>%
  bind_rows(popest_long_stateplanning)
}


```

```{r}
#LEFT JOIN TO INCORPORATE LOCATION IDS (FROM KIDS COUNT DATA CENTER)

mt <- read.csv("./Input/MT KC Location IDs.csv")
sd <- read.csv("./Input/SD KC Location IDs.csv")
nd <- read.csv("./Input/ND KC Location IDs.csv")

if (state=="Montana") {
popest_long_final <- popest_long %>%
  left_join(mt)
} else if (state=="North Dakota") {
  popest_long_final <- popest_long %>%
  left_join(nd)
} else if (state=="South Dakota") {
  popest_long_final <- popest_long %>%
  left_join(sd)
}

#CHANGE TIME FRAME VARIABLE TO CHARACTER
popest_long_final$TimeFrame <- as.character(popest_long_final$TimeFrame)

```

```{r}
#ADD DATA TO R DATABASE
#import current database

if (state=="Montana") {
load("./Output/DATABASE/MT_database.Rda")
} else if (state=="North Dakota") {
load("./Output/DATABASE/ND_database.Rda")
} else if (state=="South Dakota") {
load("./Output/DATABASE/SD_database.Rda")}

#IF USING VINTAGE DATA, NEED TO CHANGE LAST YEARS ESTIMATE YEARS
#otherwise, you will have duplicate years. The other option is to delete vintage data from previous years.
if (vintage=="yes" & state=="Montana") {
MT_database$TimeFrame[MT_database$VarName=="childpopulationbyagegroupbycounty" & 
                        MT_database$TimeFrame==2010] <- "2010_2018vintage"
MT_database$TimeFrame[MT_database$VarName=="childpopulationbyagegroupbycounty" & 
                        MT_database$TimeFrame==2011] <- "2011_2018vintage"
MT_database$TimeFrame[MT_database$VarName=="childpopulationbyagegroupbycounty" & 
                        MT_database$TimeFrame==2012] <- "2012_2018vintage"
MT_database$TimeFrame[MT_database$VarName=="childpopulationbyagegroupbycounty" & 
                        MT_database$TimeFrame==2013] <- "2013_2018vintage"
MT_database$TimeFrame[MT_database$VarName=="childpopulationbyagegroupbycounty" & 
                        MT_database$TimeFrame==2014] <- "2014_2018vintage"
MT_database$TimeFrame[MT_database$VarName=="childpopulationbyagegroupbycounty" & 
                        MT_database$TimeFrame==2015] <- "2015_2018vintage"
MT_database$TimeFrame[MT_database$VarName=="childpopulationbyagegroupbycounty" & 
                        MT_database$TimeFrame==2016] <- "2016_2018vintage"
MT_database$TimeFrame[MT_database$VarName=="childpopulationbyagegroupbycounty" & 
                        MT_database$TimeFrame==2017] <- "2017_2018vintage"
MT_database$TimeFrame[MT_database$VarName=="childpopulationbyagegroupbycounty" & 
                        MT_database$TimeFrame==2018] <- "2018_2018vintage"
} else if (vintage=="yes" & state=="North Dakota"){
ND_database$TimeFrame[ND_database$VarName=="childpopulationbyagegroupbycounty" & 
                        ND_database$TimeFrame==2010] <- "2010_2018vintage"
ND_database$TimeFrame[ND_database$VarName=="childpopulationbyagegroupbycounty" & 
                        ND_database$TimeFrame==2011] <- "2011_2018vintage"
ND_database$TimeFrame[ND_database$VarName=="childpopulationbyagegroupbycounty" & 
                        ND_database$TimeFrame==2012] <- "2012_2018vintage"
ND_database$TimeFrame[ND_database$VarName=="childpopulationbyagegroupbycounty" & 
                        ND_database$TimeFrame==2013] <- "2013_2018vintage"
ND_database$TimeFrame[ND_database$VarName=="childpopulationbyagegroupbycounty" & 
                        ND_database$TimeFrame==2014] <- "2014_2018vintage"
ND_database$TimeFrame[ND_database$VarName=="childpopulationbyagegroupbycounty" & 
                        ND_database$TimeFrame==2015] <- "2015_2018vintage"
ND_database$TimeFrame[ND_database$VarName=="childpopulationbyagegroupbycounty" & 
                        ND_database$TimeFrame==2016] <- "2016_2018vintage"
ND_database$TimeFrame[ND_database$VarName=="childpopulationbyagegroupbycounty" & 
                        ND_database$TimeFrame==2017] <- "2017_2018vintage"
ND_database$TimeFrame[ND_database$VarName=="childpopulationbyagegroupbycounty" & 
                        ND_database$TimeFrame==2018] <- "2018_2018vintage"
} else if (vintage=="yes" & state=="South Dakota") {
SD_database$TimeFrame[SD_database$VarName=="childpopulationbyagegroupbycounty" & 
                        SD_database$TimeFrame==2010] <- "2010_2018vintage"
SD_database$TimeFrame[SD_database$VarName=="childpopulationbyagegroupbycounty" & 
                        SD_database$TimeFrame==2011] <- "2011_2018vintage"
SD_database$TimeFrame[SD_database$VarName=="childpopulationbyagegroupbycounty" & 
                        SD_database$TimeFrame==2012] <- "2012_2018vintage"
SD_database$TimeFrame[SD_database$VarName=="childpopulationbyagegroupbycounty" & 
                        SD_database$TimeFrame==2013] <- "2013_2018vintage"
SD_database$TimeFrame[SD_database$VarName=="childpopulationbyagegroupbycounty" & 
                        SD_database$TimeFrame==2014] <- "2014_2018vintage"
SD_database$TimeFrame[SD_database$VarName=="childpopulationbyagegroupbycounty" & 
                        SD_database$TimeFrame==2015] <- "2015_2018vintage"
SD_database$TimeFrame[SD_database$VarName=="childpopulationbyagegroupbycounty" & 
                        SD_database$TimeFrame==2016] <- "2016_2018vintage"
SD_database$TimeFrame[SD_database$VarName=="childpopulationbyagegroupbycounty" & 
                        SD_database$TimeFrame==2017] <- "2017_2018vintage"
SD_database$TimeFrame[SD_database$VarName=="childpopulationbyagegroupbycounty" & 
                        SD_database$TimeFrame==2018] <- "2018_2018vintage" }



#UNION DATA TO CURRENT DATABASE
if (state=="Montana") {
MT_database <- MT_database %>%
  bind_rows(popest_long_final)
} else if (state=="North Dakota") {
ND_database <- ND_database %>%
  bind_rows(popest_long_final)
} else if (state=="South Dakota") {
SD_database <- SD_database %>%
  bind_rows(popest_long_final)}

```

```{r}
#SAVE THE NEW DATABASE
saveRDS(MT_database,"./Output/DATABASE/MT_database.Rda")

```

```{r}
#QUERY THE DATA NEEDED IN THE FORMAT FOR DATA CENTER UPLOAD

uploadexport <- filter(MT_database,VarName=="childpopulationbyagegroupbycounty" & 
                         TimeFrame==2018)
uploadexport <- select(MT_database,c(Location,Age_group,TimeFrame,DataFormat,
                                     Data,LocationId))

#add a space back to age group variable name
uploadexport <- rename(uploadexport,"Age group"=Age_group)

```

```{r}
#WRITE FINAL DATASET TO CSV
write.csv(uploadexport,file=paste0("./Output/childpopulationbyagegroupbycounty/",state,"_",year,"_childpopulationbyagegroupbycounty.csv"),row.names=FALSE)

```

