---
title: "Montana Vital Statistics 2"
output: html_document
---

## Indicator 1: Total births (1-year totals)
## Indicators 2-4: Low birthweight babies by county (5-year totals), Low birthweight babies (3-year totals), Low birthweight babies by county (1-year totals)
## Indicators 5-7: Births to women who initiatied prenatal care in the first trimester (5-year totals), Births to women who initiatied prenatal care in the first trimester (3-year totals), Births to women who initiatied prenatal care in the first trimester (1-year totals)
## Indicator 8: Births to mothers who smoked during pregnancy (5-year totals)
## Indicator 9: Teen (ages 15-19) birth rate per 1,000 females (5-year totals)
## Indicator 10: Births to women who initiated prenatal care in the first trimester by race (5-year totals)


**Created by:** Xanna Burg
**Date:** March 2020
**Updated by:**

**Data Source:** Montana Department of Public Health and Human Services, Office of Epidemiology and Scientific Support
**Purpose:** Input the statewide vital statistics data

**Data format:** final output csv to upload is in long format with the following variables: Location (character: name of location), TimeFrame (text: years), Race (for two indicators broken down by race; character) Data (numeric: number, percentage, rate), DataFormat (character: "number" or "percent" or "rate"), LocationId (numeric: assigned for KIDS COUNT system)

**To use this code for a new year:**
* Update the year in the second code chunk for variable 'year' and 'fullyear'
* Check each dataset visually and through the report logs prior to commiting to the database.


```{r,message=FALSE}
#load required packages
library(tidyverse)
library(RPostgreSQL)
library(readxl)
library(naniar)
```

```{r}
####UPDATE to reflect the current year data working with
year <- '2022'

year_minus3 <- as.character(as.numeric(year)-2)
year_minus5 <- as.character(as.numeric(year)-4)

threeyear <- paste0(year_minus3,"-",year)
fiveyear <-  paste0(year_minus5,"-",year)

statefile <- 'montana'
statename <- 'Montana'

#input location ID file for MT
locationids <- read.csv("./Input/MT KC Location IDs.csv")
locationids$Location <- as.character(locationids$Location)

#input region ID file for MT
regionids <- read.csv("./Input/MT KC Region List.csv")
regionids$county <- as.character(regionids$county)
```


## IMPORT THE DATA FILES THAT WILL BE USED
```{r}
montana_1year <- read_excel(path=paste0("./Input/health/montana_",year,"_vitalstatistics_KIDS_COUNT_",year,".xlsx"),sheet='Montana',skip=3) 

counties_1year <- read_excel(path=paste0("./Input/health/montana_",year,"_vitalstatistics_KIDS_COUNT_",year,".xlsx"),sheet='Counties',skip=3) 

montana_3year <- read_excel(path=paste0("./Input/health/montana_",year_minus3,"_",year,"_vitalstatistics_KIDS_COUNT_",year_minus3,"_",year,".xlsx"),sheet='Montana',skip=3) 

counties_3year <- read_excel(path=paste0("./Input/health/montana_",year_minus3,"_",year,"_vitalstatistics_KIDS_COUNT_",year_minus3,"_",year,".xlsx"),sheet='Counties',skip=3) 

montana_5year <- read_excel(path=paste0("./Input/health/montana_",year_minus5,"_",year,"_vitalstatistics_KIDS_COUNT_",year_minus5,"_",year,".xlsx"),sheet='Montana',skip=3) 

counties_5year <- read_excel(path=paste0("./Input/health/montana_",year_minus5,"_",year,"_vitalstatistics_KIDS_COUNT_",year_minus5,"_",year,".xlsx"),sheet='Counties',skip=3) 

```




## ############################ ##
## TOTAL BIRTHS (1-YEAR TOTALS) ##
## ############################ ##

## STEP 1: CLEAN DATA
```{r}
#COUNTY DATA
births_county <- counties_1year %>%
  #select only needed column
  select(c(County,`Number of Births`)) %>%
  
  #fix the formatting of the county names
  #lowercase county names
  mutate(County=tolower(County)) %>%
  mutate(County=str_to_title(County)) %>%
  
  #rename
  rename(location=County,
         data=`Number of Births`) %>%
  
  mutate(locationtype='County') %>%
  
  #fix the name on some counties
  mutate(location=replace(location,location=='Golden','Golden Valley')) %>%
  mutate(location=replace(location,location=='Mccone','McCone')) %>%
  mutate(data=as.numeric(paste(data))) %>%
  subset(location != '~Not Stated')


#STATE DATA
births_state <- montana_1year %>%
  #select only needed column
  select(c(Race,`Live Births`)) %>%
  
  #only select all
  subset(Race=='All') %>%
  
  #rename
  rename(location=Race,
         data=`Live Births`) %>%
  mutate(location='Montana') %>%
  
  mutate(locationtype='State')
  

#COMBINE GEOGRAPHIES
births_all <- births_county %>%
  bind_rows(births_state) %>%
  
  #add in KC variables
  mutate(timeframe=year,
         state='Montana',
         dataformat='Number',
         varname='totalbirths') %>%
  
  #merge location ids
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) %>%
  
  #suppress if less than 5
  mutate(data=replace(data,data<5 & data!=0,NA))


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(births_all$locationid))>=1) {
  print(births_all$location[is.na(births_all$locationid)])
} else if (sum(is.na(births_all$locationid))==0) {
  'all locations match'
}

#2. Check that no values are less than 5
temp_suppresscheck <- births_all %>% subset(data<5 & data>0)
temp_rows <- as.numeric(nrow(temp_suppresscheck))
if (temp_rows==0) {
  'data suppression followed at individual location level'
} else if (temp_rows>=1) {
  View(temp_suppresscheck)
}

#3. Check that there is no suppression or >1 suppression
########## MANUAL STEP #############
#need to check that county data cannot be identified using totals
temp_testsuppression <- births_all %>%
  subset(locationtype=='County') %>%
  group_by(location) %>%
  summarise_all(~sum(is.na(.))) %>%
  transmute(location,sumNA=rowSums(.[-1])) %>%
  subset(sumNA==1)

temp_rows <- as.numeric(nrow(temp_testsuppression))
if (temp_rows==0 | temp_rows>1) {
  'no additional data suppression needed'
} else if (temp_rows==1) {
  View(temp_testsuppression)
}

#if there is only one county, print the counties in ascending order
#temp_check <- births_all %>%
#  subset(locationtype=='County') %>%
#  arrange(data)
#View(temp_check)

#******
#CHANGE TO THE CORRECT COUNTY NAME HERE
#**Choose the county with the next lowest count of births; if there is a tie, suppress both
#births_all$data[births_all$location=='Billings'] <- NA


# 4. Visually inspect output data
View(births_all)

```

## STEP 2: ADD TO DATABASE
```{r}
#CHECK DATASET NAMED births_all TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#add to database
dbWriteTable(con,'montana',births_all,append=TRUE,row.names=FALSE)

```

## STEP 3: OUTPUT FILE FOR KC
```{r}
#write query from database to get needed format for KC data center

upload_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM montana WHERE timeframe='",year,"' AND varname='totalbirths';")

upload_data <- dbGetQuery(con,upload_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/health/",statefile,"_",year,"_totalbirths.csv"),row.names=FALSE)
```





## ###################################### ##
## LOW BIRTHWEIGHT BABIES (1-YEAR TOTALS) ## 
## ###################################### ##

## STEP 1: CLEAN DATA
```{r}
#COUNTY DATA
births_county <- counties_1year %>%
  #select only needed column
  select(c(County,`Low birth-weight births (birth-weight <2,500 g or 5lbs 8oz; as percent of live births)`)) %>%
  
  #fix the formatting of the county names
  #lowercase county names
  mutate(County=tolower(County)) %>%
  mutate(County=str_to_title(County)) %>%
  
  #rename
  rename(location=County,
         data=`Low birth-weight births (birth-weight <2,500 g or 5lbs 8oz; as percent of live births)`) %>%
  
  mutate(locationtype='County') %>%
  mutate(data=as.numeric(paste(data))) %>%
  
  #fix the name on some counties
  mutate(location=replace(location,location=='Golden','Golden Valley')) %>%
  mutate(location=replace(location,location=='Mccone','McCone')) %>%
  subset(location != '~Not Stated')


#STATE DATA
births_state <- montana_1year %>%
  #select only needed column
  select(c(Race,`Low birth-weight births (<5lbs 8oz; percent of all births)`)) %>%
  
  #only select all
  subset(Race=='All') %>%
  
  #rename
  rename(location=Race,
         data=`Low birth-weight births (<5lbs 8oz; percent of all births)`) %>%
  mutate(location='Montana') %>%
  
  mutate(locationtype='State')
  

#COMBINE GEOGRAPHIES
births_all <- births_county %>%
  bind_rows(births_state) %>%
  
  #add in KC variables
  mutate(timeframe=year,
         state='Montana',
         dataformat='Percent',
         varname='lowbirthweight1yeartotals') %>%
  
  #merge location ids
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) 


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(births_all$locationid))>=1) {
  print(births_all$location[is.na(births_all$locationid)])
} else if (sum(is.na(births_all$locationid))==0) {
  'all locations match'
}


#2. Check that there is no suppression or >1 suppression
########## MANUAL STEP #############
#need to check that county data cannot be identified using totals
temp_testsuppression <- births_all %>%
  subset(locationtype=='County') %>%
  group_by(location) %>%
  summarise_all(~sum(is.na(.))) %>%
  transmute(location,sumNA=rowSums(.[-1])) %>%
  subset(sumNA==1)

temp_rows <- as.numeric(nrow(temp_testsuppression))
if (temp_rows==0 | temp_rows>1) {
  'no additional data suppression needed'
} else if (temp_rows==1) {
  View(temp_testsuppression)
}

#if there is only one county, print the counties in ascending order
#temp_check <- counties_1year %>%
 # select(County,`Number of Low birth weight`) %>%
#  arrange(`Number of Low birth weight`)
#View(temp_check)
#View(temp_check)

#******
#CHANGE TO THE CORRECT COUNTY NAME HERE
#**Choose the county with the next lowest count of births; if there is a tie, suppress both
#births_all$data[births_all$location=='Billings'] <- NA


# 4. Visually inspect output data
View(births_all)

```

## STEP 2: ADD TO DATABASE
```{r}
#CHECK DATASET NAMED births_all TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#add to database
dbWriteTable(con,'montana',births_all,append=TRUE,row.names=FALSE)

```

## STEP 3: OUTPUT FILE FOR KC
```{r}
#write query from database to get needed format for KC data center

upload_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM montana WHERE timeframe='",year,"' AND varname='lowbirthweight1yeartotals';")

upload_data <- dbGetQuery(con,upload_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/health/",statefile,"_",year,"_lowbirthweight1yeartotals.csv"),row.names=FALSE)
```



## ###################################### ##
## LOW BIRTHWEIGHT BABIES (3-YEAR TOTALS) ## 
## ###################################### ##

## STEP 1: CLEAN DATA
```{r}
#COUNTY DATA
births_county <- counties_3year %>%
  #select only needed column
  select(c(County,`Low birth-weight births (birth-weight <2,500 g or 5lbs 8oz; as percent of live births)`)) %>%
  
  #fix the formatting of the county names
  #lowercase county names
  mutate(County=tolower(County)) %>%
  mutate(County=str_to_title(County)) %>%
  
  #rename
  rename(location=County,
         data=`Low birth-weight births (birth-weight <2,500 g or 5lbs 8oz; as percent of live births)`) %>%
  
  mutate(locationtype='County') %>%
  mutate(data=as.numeric(paste(data))) %>%
  
  #fix the name on some counties
  mutate(location=replace(location,location=='Golden','Golden Valley')) %>%
  mutate(location=replace(location,location=='Mccone','McCone')) %>%
  subset(location != '~Not Stated')


#STATE DATA
births_state <- montana_3year %>%
  #select only needed column
  select(c(Race,`Low birth-weight births (<5lbs 8oz; percent of all births)`)) %>%
  
  #only select all
  subset(Race=='All') %>%
  
  #rename
  rename(location=Race,
         data=`Low birth-weight births (<5lbs 8oz; percent of all births)`) %>%
  mutate(location='Montana') %>%
  
  mutate(locationtype='State')
  

#COMBINE GEOGRAPHIES
births_all <- births_county %>%
  bind_rows(births_state) %>%
  
  #add in KC variables
  mutate(timeframe=threeyear,
         state='Montana',
         dataformat='Percent',
         varname='lowbirthweight3yeartotals') %>%
  
  #merge location ids
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) 


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(births_all$locationid))>=1) {
  print(births_all$location[is.na(births_all$locationid)])
} else if (sum(is.na(births_all$locationid))==0) {
  'all locations match'
}


#2. Check that there is no suppression or >1 suppression
########## MANUAL STEP #############
#need to check that county data cannot be identified using totals
temp_testsuppression <- births_all %>%
  subset(locationtype=='County') %>%
  group_by(location) %>%
  summarise_all(~sum(is.na(.))) %>%
  transmute(location,sumNA=rowSums(.[-1])) %>%
  subset(sumNA==1)

temp_rows <- as.numeric(nrow(temp_testsuppression))
if (temp_rows==0 | temp_rows>1) {
  'no additional data suppression needed'
} else if (temp_rows==1) {
  View(temp_testsuppression)
}

#if there is only one county, print the counties in ascending order
#temp_check <- counties_3year %>%
 # select(County,`Number of Low birth weight`) %>%
#  arrange(`Number of Low birth weight`)
#View(temp_check)
#View(temp_check)

#******
#CHANGE TO THE CORRECT COUNTY NAME HERE
#**Choose the county with the next lowest count of births; if there is a tie, suppress both
#births_all$data[births_all$location=='Billings'] <- NA


# 4. Visually inspect output data
View(births_all)

```

## STEP 2: CHECK ON SUPPRESSION ACROSS YEARS
```{r}
year_minus3_interim <- as.character(as.numeric(year)-1)

check_years_sql <- paste0("SELECT location, timeframe, data FROM montana WHERE (timeframe='",year,"' OR timeframe='",year_minus3_interim,"' OR timeframe='",year_minus3,"') AND varname='lowbirthweight1yeartotals';")

check_years <- dbGetQuery(con,check_years_sql) %>%
  
  pivot_wider(names_from=timeframe,values_from=data) %>%
  
  #rename columns
  rename(year1=all_of(year_minus3),
         year2=all_of(year_minus3_interim),
         year3=all_of(year)) %>%
  
  mutate(indicator1=case_when(
    is.na(year1) ~ 1,
    !is.na(year1) ~ 0)) %>%
  mutate(indicator2=case_when(
    is.na(year2) ~ 1,
    !is.na(year2) ~ 0)) %>%
  mutate(indicator3=case_when(
    is.na(year3) ~ 1,
    !is.na(year3) ~ 0)) %>%
  
  #create sums
  mutate(sum_of_nas=indicator1+indicator2+indicator3) %>%
  subset(sum_of_nas==1)

temp_rows <- as.numeric(nrow(check_years))
if (temp_rows==0) {
  'no additional data suppression needed'
} else if (temp_rows>=1) {
  View(check_years)
}


#******
#CHANGE TO THE CORRECT COUNTY NAME HERE
#**Suppress the three year percentage if there is exactly one NA during the three years
#births_all$data[births_all$location=='Big Horn'] <- NA
```

## STEP 3: ADD TO DATABASE
```{r}
#CHECK DATASET NAMED births_all TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#add to database
dbWriteTable(con,'montana',births_all,append=TRUE,row.names=FALSE)
```

## STEP 4: OUTPUT FILE FOR KC
```{r}
#write query from database to get needed format for KC data center

upload_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM montana WHERE timeframe='",threeyear,"' AND varname='lowbirthweight3yeartotals';")

upload_data <- dbGetQuery(con,upload_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/health/",statefile,"_",year,"_lowbirthweight3yeartotals.csv"),row.names=FALSE)
```




## ###################################### ##
## LOW BIRTHWEIGHT BABIES (5-YEAR TOTALS) ## 
## ###################################### ##

## STEP 1: CLEAN DATA
```{r}
#COUNTY DATA
births_county <- counties_5year %>%
  #select only needed column
  select(c(County,`Low birth-weight births (birth-weight <2,500 g or 5lbs 8oz; as percent of live births)`)) %>%
  
  #fix the formatting of the county names
  #lowercase county names
  mutate(County=tolower(County)) %>%
  mutate(County=str_to_title(County)) %>%
  
  #rename
  rename(location=County,
         data=`Low birth-weight births (birth-weight <2,500 g or 5lbs 8oz; as percent of live births)`) %>%
  
  mutate(locationtype='County') %>%
  mutate(data=as.numeric(paste(data))) %>%
  
  #fix the name on some counties
  mutate(location=replace(location,location=='Golden','Golden Valley')) %>%
  mutate(location=replace(location,location=='Mccone','McCone')) %>%
  subset(location != '~Not Stated')


#STATE DATA
births_state <- montana_5year %>%
  #select only needed column
  select(c(Race,`Low birth-weight births (<5lbs 8oz; percent of all births)`)) %>%
  
  #only select all
  subset(Race=='All') %>%
  
  #rename
  rename(location=Race,
         data=`Low birth-weight births (<5lbs 8oz; percent of all births)`) %>%
  mutate(location='Montana') %>%
  
  mutate(locationtype='State')
  

#COMBINE GEOGRAPHIES
births_all <- births_county %>%
  bind_rows(births_state) %>%
  
  #add in KC variables
  mutate(timeframe=fiveyear,
         state='Montana',
         dataformat='Percent',
         varname='lowbirthweight5yeartotals') %>%
  
  #merge location ids
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) 


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(births_all$locationid))>=1) {
  print(births_all$location[is.na(births_all$locationid)])
} else if (sum(is.na(births_all$locationid))==0) {
  'all locations match'
}


#2. Check that there is no suppression or >1 suppression
########## MANUAL STEP #############
#need to check that county data cannot be identified using totals
temp_testsuppression <- births_all %>%
  subset(locationtype=='County') %>%
  group_by(location) %>%
  summarise_all(~sum(is.na(.))) %>%
  transmute(location,sumNA=rowSums(.[-1])) %>%
  subset(sumNA==1)

temp_rows <- as.numeric(nrow(temp_testsuppression))
if (temp_rows==0 | temp_rows>1) {
  'no additional data suppression needed'
} else if (temp_rows==1) {
  View(temp_testsuppression)
}

#if there is only one county, print the counties in ascending order
#temp_check <- counties_5year %>%
 # select(County,`Number of Low birth weight`) %>%
#  arrange(`Number of Low birth weight`)
#View(temp_check)

#******
#CHANGE TO THE CORRECT COUNTY NAME HERE
#**Choose the county with the next lowest count of births; if there is a tie, suppress both
#births_all$data[births_all$location=='Golden Valley'] <- NA


# 4. Visually inspect output data
View(births_all)

```

## STEP 2: CHECK ON SUPPRESSION ACROSS YEARS
```{r}
year_minus5_interim1 <- as.character(as.numeric(year)-1)
year_minus5_interim2 <- as.character(as.numeric(year)-3)

check_years_sql <- paste0("SELECT location, timeframe, data FROM montana WHERE (timeframe='",year,"' OR timeframe='",year_minus5_interim1,"' OR timeframe='",year_minus3,"' OR timeframe='",year_minus5_interim2,"' OR timeframe='",year_minus5,"') AND varname='lowbirthweight1yeartotals';")

check_years <- dbGetQuery(con,check_years_sql) %>%
  
  pivot_wider(names_from=timeframe,values_from=data) %>%
  
  #rename columns
  rename(year1=all_of(year_minus5),
         year2=all_of(year_minus5_interim2),
         year3=all_of(year_minus3),
         year4=all_of(year_minus5_interim1),
         year5=all_of(year)) %>%
  
  mutate(indicator1=case_when(
    is.na(year1) ~ 1,
    !is.na(year1) ~ 0)) %>%
  mutate(indicator2=case_when(
    is.na(year2) ~ 1,
    !is.na(year2) ~ 0)) %>%
  mutate(indicator3=case_when(
    is.na(year3) ~ 1,
    !is.na(year3) ~ 0)) %>%
  mutate(indicator4=case_when(
    is.na(year4) ~ 1,
    !is.na(year4) ~ 0)) %>%
  mutate(indicator5=case_when(
    is.na(year5) ~ 1,
    !is.na(year5) ~ 0)) %>%
  
  #create sums
  mutate(sum_of_nas=indicator1+indicator2+indicator3+indicator4+indicator5) %>%
  subset(sum_of_nas==1)

temp_rows <- as.numeric(nrow(check_years))
if (temp_rows==0) {
  'no additional data suppression needed'
} else if (temp_rows>=1) {
  View(check_years)
}


#******
#CHANGE TO THE CORRECT COUNTY NAME HERE
#**Suppress the three year percentage if there is exactly one NA during the five years
#births_all$data[births_all$location=='Lake'] <- NA
```

## STEP 3: ADD TO DATABASE
```{r}
#CHECK DATASET NAMED births_all TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#add to database
dbWriteTable(con,'montana',births_all,append=TRUE,row.names=FALSE)
```

## STEP 4: OUTPUT FILE FOR KC
```{r}
#write query from database to get needed format for KC data center

upload_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM montana WHERE timeframe='",fiveyear,"' AND varname='lowbirthweight5yeartotals';")

upload_data <- dbGetQuery(con,upload_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/health/",statefile,"_",year,"_lowbirthweight5yeartotals.csv"),row.names=FALSE)
```



## ############################################################## ##
## BIRTHS TO WOMEN RECEIVING PRENATAL CARE DURING FIRST TRIMESTER ## 
## ################ (1-YEAR TOTALS) ############################# ##
## ############################################################## ##

## STEP 1: CLEAN DATA
```{r}
#COUNTY DATA
births_county <- counties_1year %>%
  #select only needed column
  select(c(County,`Births to mothers starting prenatal care during 1st trimester (during first three months of pregnancy; as percent of live births)`)) %>%
  
  #fix the formatting of the county names
  #lowercase county names
  mutate(County=tolower(County)) %>%
  mutate(County=str_to_title(County)) %>%
  
  #rename
  rename(location=County,
         data=`Births to mothers starting prenatal care during 1st trimester (during first three months of pregnancy; as percent of live births)`) %>%
  
  mutate(locationtype='County') %>%
  mutate(data=as.numeric(paste(data))) %>%
  
  #fix the name on some counties
  mutate(location=replace(location,location=='Golden','Golden Valley')) %>%
  mutate(location=replace(location,location=='Mccone','McCone')) %>%
  subset(location != '~Not Stated')


#STATE DATA
births_state <- montana_1year %>%
  #select only needed column
  select(c(Race,`Births to mothers receiving prenatal care beginning in 1st trimester (percent of all births)`)) %>%
  
  #only select all
  subset(Race=='All') %>%
  
  #rename
  rename(location=Race,
         data=`Births to mothers receiving prenatal care beginning in 1st trimester (percent of all births)`) %>%
  mutate(location='Montana') %>%
  
  mutate(locationtype='State')
  

#COMBINE GEOGRAPHIES
births_all <- births_county %>%
  bind_rows(births_state) %>%
  
  #add in KC variables
  mutate(timeframe=year,
         state='Montana',
         dataformat='Percent',
         varname='firsttrimesterprenatal1yeartotals') %>%
  
  #merge location ids
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) 


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(births_all$locationid))>=1) {
  print(births_all$location[is.na(births_all$locationid)])
} else if (sum(is.na(births_all$locationid))==0) {
  'all locations match'
}


#2. Check that there is no suppression or >1 suppression
########## MANUAL STEP #############
#need to check that county data cannot be identified using totals
temp_testsuppression <- births_all %>%
  subset(locationtype=='County') %>%
  group_by(location) %>%
  summarise_all(~sum(is.na(.))) %>%
  transmute(location,sumNA=rowSums(.[-1])) %>%
  subset(sumNA==1)

temp_rows <- as.numeric(nrow(temp_testsuppression))
if (temp_rows==0 | temp_rows>1) {
  'no additional data suppression needed'
} else if (temp_rows==1) {
  View(temp_testsuppression)
}

#if there is only one county, print the counties in ascending order
#temp_check <- counties_1year %>%
#  select(County,`Number Starting PNC in 1st Trimester`) %>%
#  arrange(`Number Starting PNC in 1st Trimester`)
#View(temp_check)

#******
#CHANGE TO THE CORRECT COUNTY NAME HERE
#**Choose the county with the next lowest count of births; if there is a tie, suppress both
#births_all$data[births_all$location=='Billings'] <- NA


# 4. Visually inspect output data
View(births_all)

```

## STEP 2: ADD TO DATABASE
```{r}
#CHECK DATASET NAMED births_all TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#add to database
dbWriteTable(con,'montana',births_all,append=TRUE,row.names=FALSE)

```

## STEP 3: OUTPUT FILE FOR KC
```{r}
#write query from database to get needed format for KC data center

upload_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM montana WHERE timeframe='",year,"' AND varname='firsttrimesterprenatal1yeartotals';")

upload_data <- dbGetQuery(con,upload_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/health/",statefile,"_",year,"_firsttrimesterprenatal1yeartotals.csv"),row.names=FALSE)
```



## ############################################################## ##
## BIRTHS TO WOMEN RECEIVING PRENATAL CARE DURING FIRST TRIMESTER ## 
## ################ (3-YEAR TOTALS) ############################# ##
## ############################################################## ##

## STEP 1: CLEAN DATA
```{r}
#COUNTY DATA
births_county <- counties_3year %>%
  #select only needed column
  select(c(County,`Births to mothers starting prenatal care during 1st trimester (during first three months of pregnancy; as percent of live births)`)) %>%
  
  #fix the formatting of the county names
  #lowercase county names
  mutate(County=tolower(County)) %>%
  mutate(County=str_to_title(County)) %>%
  
  #rename
  rename(location=County,
         data=`Births to mothers starting prenatal care during 1st trimester (during first three months of pregnancy; as percent of live births)`) %>%
  
  mutate(locationtype='County') %>%
  mutate(data=as.numeric(paste(data))) %>%
  
  #fix the name on some counties
  mutate(location=replace(location,location=='Golden','Golden Valley')) %>%
  mutate(location=replace(location,location=='Mccone','McCone')) %>%
  subset(location != '~Not Stated')


#STATE DATA
births_state <- montana_3year %>%
  #select only needed column
  select(c(Race,`Births to mothers receiving prenatal care beginning in 1st trimester (percent of all births)`)) %>%
  
  #only select all
  subset(Race=='All') %>%
  
  #rename
  rename(location=Race,
         data=`Births to mothers receiving prenatal care beginning in 1st trimester (percent of all births)`) %>%
  mutate(location='Montana') %>%
  
  mutate(locationtype='State')
  

#COMBINE GEOGRAPHIES
births_all <- births_county %>%
  bind_rows(births_state) %>%
  
  #add in KC variables
  mutate(timeframe=threeyear,
         state='Montana',
         dataformat='Percent',
         varname='firsttrimesterprenatal3yeartotals') %>%
  
  #merge location ids
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) 


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(births_all$locationid))>=1) {
  print(births_all$location[is.na(births_all$locationid)])
} else if (sum(is.na(births_all$locationid))==0) {
  'all locations match'
}


#2. Check that there is no suppression or >1 suppression
########## MANUAL STEP #############
#need to check that county data cannot be identified using totals
temp_testsuppression <- births_all %>%
  subset(locationtype=='County') %>%
  group_by(location) %>%
  summarise_all(~sum(is.na(.))) %>%
  transmute(location,sumNA=rowSums(.[-1])) %>%
  subset(sumNA==1)

temp_rows <- as.numeric(nrow(temp_testsuppression))
if (temp_rows==0 | temp_rows>1) {
  'no additional data suppression needed'
} else if (temp_rows==1) {
  View(temp_testsuppression)
}

#if there is only one county, print the counties in ascending order
#temp_check <- counties_3year %>%
 # select(County,`Number Starting PNC in 1st Trimester`) %>%
  #arrange(`Number Starting PNC in 1st Trimester`)
#View(temp_check)

#******
#CHANGE TO THE CORRECT COUNTY NAME HERE
#**Choose the county with the next lowest count of births; if there is a tie, suppress both
#births_all$data[births_all$location=='Petroleium'] <- NA


# 4. Visually inspect output data
View(births_all)

```

## STEP 2: CHECK ON SUPPRESSION ACROSS YEARS
```{r}
year_minus3_interim <- as.character(as.numeric(year)-1)

check_years_sql <- paste0("SELECT location, timeframe, data FROM montana WHERE (timeframe='",year,"' OR timeframe='",year_minus3_interim,"' OR timeframe='",year_minus3,"') AND varname='firsttrimesterprenatal1yeartotals';")

check_years <- dbGetQuery(con,check_years_sql) %>%
  
  pivot_wider(names_from=timeframe,values_from=data) %>%
  
  #rename columns
  rename(year1=all_of(year_minus3),
         year2=all_of(year_minus3_interim),
         year3=all_of(year)) %>%
  
  mutate(indicator1=case_when(
    is.na(year1) ~ 1,
    !is.na(year1) ~ 0)) %>%
  mutate(indicator2=case_when(
    is.na(year2) ~ 1,
    !is.na(year2) ~ 0)) %>%
  mutate(indicator3=case_when(
    is.na(year3) ~ 1,
    !is.na(year3) ~ 0)) %>%
  
  #create sums
  mutate(sum_of_nas=indicator1+indicator2+indicator3) %>%
  subset(sum_of_nas==1)

temp_rows <- as.numeric(nrow(check_years))
if (temp_rows==0) {
  'no additional data suppression needed'
} else if (temp_rows>=1) {
  View(check_years)
}


#******
#CHANGE TO THE CORRECT COUNTY NAME HERE
#**Suppress the three year percentage if there is exactly one NA during the three years
#births_all$data[births_all$location=='Granite'] <- NA

```

## STEP 3: ADD TO DATABASE
```{r}
#CHECK DATASET NAMED births_all TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#add to database
dbWriteTable(con,'montana',births_all,append=TRUE,row.names=FALSE)
```

## STEP 4: OUTPUT FILE FOR KC
```{r}
#write query from database to get needed format for KC data center

upload_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM montana WHERE timeframe='",threeyear,"' AND varname='firsttrimesterprenatal3yeartotals';")

upload_data <- dbGetQuery(con,upload_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/health/",statefile,"_",year,"_firsttrimesterprenatal3yeartotals.csv"),row.names=FALSE)
```



## ############################################################## ##
## BIRTHS TO WOMEN RECEIVING PRENATAL CARE DURING FIRST TRIMESTER ## 
## ################ (5-YEAR TOTALS) ############################# ##
## ############################################################## ##

## STEP 1: CLEAN DATA
```{r}
#COUNTY DATA
births_county <- counties_5year %>%
  #select only needed column
  select(c(County,`Births to mothers starting prenatal care during 1st trimester (during first three months of pregnancy; as percent of live births)`)) %>%
  
  #fix the formatting of the county names
  #lowercase county names
  mutate(County=tolower(County)) %>%
  mutate(County=str_to_title(County)) %>%
  
  #rename
  rename(location=County,
         data=`Births to mothers starting prenatal care during 1st trimester (during first three months of pregnancy; as percent of live births)`) %>%
  
  mutate(locationtype='County') %>%
  mutate(data=as.numeric(paste(data))) %>%
  
  #fix the name on some counties
  mutate(location=replace(location,location=='Golden','Golden Valley')) %>%
  mutate(location=replace(location,location=='Mccone','McCone')) %>%
  subset(location != '~Not Stated')


#STATE DATA
births_state <- montana_5year %>%
  #select only needed column
  select(c(Race,`Births to mothers receiving prenatal care beginning in 1st trimester (percent of all births)`)) %>%
  
  #only select all
  subset(Race=='All') %>%
  
  #rename
  rename(location=Race,
         data=`Births to mothers receiving prenatal care beginning in 1st trimester (percent of all births)`) %>%
  mutate(location='Montana') %>%
  
  mutate(locationtype='State')
  

#COMBINE GEOGRAPHIES
births_all <- births_county %>%
  bind_rows(births_state) %>%
  
  #add in KC variables
  mutate(timeframe=fiveyear,
         state='Montana',
         dataformat='Percent',
         varname='firsttrimesterprenatal5yeartotals') %>%
  
  #merge location ids
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) 


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(births_all$locationid))>=1) {
  print(births_all$location[is.na(births_all$locationid)])
} else if (sum(is.na(births_all$locationid))==0) {
  'all locations match'
}


#2. Check that there is no suppression or >1 suppression
########## MANUAL STEP #############
#need to check that county data cannot be identified using totals
temp_testsuppression <- births_all %>%
  subset(locationtype=='County') %>%
  group_by(location) %>%
  summarise_all(~sum(is.na(.))) %>%
  transmute(location,sumNA=rowSums(.[-1])) %>%
  subset(sumNA==1)

temp_rows <- as.numeric(nrow(temp_testsuppression))
if (temp_rows==0 | temp_rows>1) {
  'no additional data suppression needed'
} else if (temp_rows==1) {
  View(temp_testsuppression)
}

#if there is only one county, print the counties in ascending order
#temp_check <- counties_5year %>%
#  select(County,`Number Starting PNC in 1st Trimester`) %>%
#  arrange(`Number Starting PNC in 1st Trimester`)
#View(temp_check)

#******
#CHANGE TO THE CORRECT COUNTY NAME HERE
#**Choose the county with the next lowest count of births; if there is a tie, suppress both
#births_all$data[births_all$location=='Sweet Grass'] <- NA


# 4. Visually inspect output data
View(births_all)

```

## STEP 2: CHECK ON SUPPRESSION ACROSS YEARS
```{r}
year_minus5_interim1 <- as.character(as.numeric(year)-1)
year_minus5_interim2 <- as.character(as.numeric(year)-3)

check_years_sql <- paste0("SELECT location, timeframe, data FROM montana WHERE (timeframe='",year,"' OR timeframe='",year_minus5_interim1,"' OR timeframe='",year_minus3,"' OR timeframe='",year_minus5_interim2,"' OR timeframe='",year_minus5,"') AND varname='firsttrimesterprenatal1yeartotals';")

check_years <- dbGetQuery(con,check_years_sql) %>%
  
  pivot_wider(names_from=timeframe,values_from=data) %>%
  
  #rename columns
  rename(year1=all_of(year_minus5),
         year2=all_of(year_minus5_interim2),
         year3=all_of(year_minus3),
         year4=all_of(year_minus5_interim1),
         year5=all_of(year)) %>%
  
  mutate(indicator1=case_when(
    is.na(year1) ~ 1,
    !is.na(year1) ~ 0)) %>%
  mutate(indicator2=case_when(
    is.na(year2) ~ 1,
    !is.na(year2) ~ 0)) %>%
  mutate(indicator3=case_when(
    is.na(year3) ~ 1,
    !is.na(year3) ~ 0)) %>%
  mutate(indicator4=case_when(
    is.na(year4) ~ 1,
    !is.na(year4) ~ 0)) %>%
  mutate(indicator5=case_when(
    is.na(year5) ~ 1,
    !is.na(year5) ~ 0)) %>%
  
  #create sums
  mutate(sum_of_nas=indicator1+indicator2+indicator3+indicator4+indicator5) %>%
  subset(sum_of_nas==1)

temp_rows <- as.numeric(nrow(check_years))
if (temp_rows==0) {
  'no additional data suppression needed'
} else if (temp_rows>=1) {
  View(check_years)
}


#******
#CHANGE TO THE CORRECT COUNTY NAME HERE
#**Suppress the three year percentage if there is exactly one NA during the three years
#births_all$data[births_all$location=='Billings'] <- NA
```

## STEP 3: ADD TO DATABASE
```{r}
#CHECK DATASET NAMED births_all TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#add to database
dbWriteTable(con,'montana',births_all,append=TRUE,row.names=FALSE)
```

## STEP 4: OUTPUT FILE FOR KC
```{r}
#write query from database to get needed format for KC data center

upload_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM montana WHERE timeframe='",fiveyear,"' AND varname='firsttrimesterprenatal5yeartotals';")

upload_data <- dbGetQuery(con,upload_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/health/",statefile,"_",year,"_firsttrimesterprenatal5yeartotals.csv"),row.names=FALSE)
```





## ############################################################# ##
## BIRTHS TO MOTHERS WHO SMOKED DURING PREGNANCY (5-YEAR TOTALS) ## 
## ############################################################# ##

## STEP 1: CLEAN DATA
```{r}
#COUNTY DATA
births_county <- counties_5year %>%
  #select only needed column
  select(c(County,`Births to mothers who smoked during pregnancy (as percent of live births)`)) %>%
  
  #fix the formatting of the county names
  #lowercase county names
  mutate(County=tolower(County)) %>%
  mutate(County=str_to_title(County)) %>%
  
  #rename
  rename(location=County,
         data=`Births to mothers who smoked during pregnancy (as percent of live births)`) %>%
  
  mutate(locationtype='County') %>%
  mutate(data=as.numeric(paste(data))) %>%
  
  #fix the name on some counties
  mutate(location=replace(location,location=='Golden','Golden Valley')) %>%
  mutate(location=replace(location,location=='Mccone','McCone')) %>%
  subset(location != '~Not Stated')


#STATE DATA
births_state <- montana_5year %>%
  #select only needed column
  select(c(Race,`Births to mothers who smoked during pregnancy (percent of all births)`)) %>%
  
  #only select all
  subset(Race=='All') %>%
  
  #rename
  rename(location=Race,
         data=`Births to mothers who smoked during pregnancy (percent of all births)`) %>%
  mutate(location='Montana') %>%
  
  mutate(locationtype='State')
  

#COMBINE GEOGRAPHIES
births_all <- births_county %>%
  bind_rows(births_state) %>%
  
  #add in KC variables
  mutate(timeframe=fiveyear,
         state='Montana',
         dataformat='Percent',
         varname='smokedprenatal5yeartotals') %>%
  
  #merge location ids
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) 


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(births_all$locationid))>=1) {
  print(births_all$location[is.na(births_all$locationid)])
} else if (sum(is.na(births_all$locationid))==0) {
  'all locations match'
}


#2. Check that there is no suppression or >1 suppression
########## MANUAL STEP #############
#need to check that county data cannot be identified using totals
temp_testsuppression <- births_all %>%
  subset(locationtype=='County') %>%
  group_by(location) %>%
  summarise_all(~sum(is.na(.))) %>%
  transmute(location,sumNA=rowSums(.[-1])) %>%
  subset(sumNA==1)

temp_rows <- as.numeric(nrow(temp_testsuppression))
if (temp_rows==0 | temp_rows>1) {
  'no additional data suppression needed'
} else if (temp_rows==1) {
  View(temp_testsuppression)
}

#if there is only one county, print the counties in ascending order
#temp_check <- counties_5year %>%
#  select(County,`Number Starting PNC in 1st Trimester`) %>%
#  arrange(`Number Starting PNC in 1st Trimester`)
#View(temp_check)

#******
#CHANGE TO THE CORRECT COUNTY NAME HERE
#**Choose the county with the next lowest count of births; if there is a tie, suppress both
#births_all$data[births_all$location=='Golden Valley'] <- NA


# 4. Visually inspect output data
View(births_all)

```

## STEP 2: ADD TO DATABASE
```{r}
#CHECK DATASET NAMED births_all TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#add to database
dbWriteTable(con,'montana',births_all,append=TRUE,row.names=FALSE)
```

## STEP 3: OUTPUT FILE FOR KC
```{r}
#write query from database to get needed format for KC data center

upload_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM montana WHERE timeframe='",fiveyear,"' AND varname='smokedprenatal5yeartotals';")

upload_data <- dbGetQuery(con,upload_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/health/",statefile,"_",year,"_smokedprenatal5yeartotals.csv"),row.names=FALSE)
```




## ############################################################## ##
## TEEN (AGES 15-19) BIRTH RATE PER 1,000 FEMALES (5-YEAR TOTALS) ## 
## ############################################################## ##

## STEP 1: CLEAN DATA
```{r}
#COUNTY DATA
#WHEN RATE CAN BE USED DIRECTLY FROM SPREADSHEET
births_county <- counties_5year %>%
  #select only needed column
  select(c(County,`Teen Birth Rate`)) %>%
  
  #fix the formatting of the county names
  #lowercase county names
  mutate(County=tolower(County)) %>%
  mutate(County=str_to_title(County)) %>%
  
  #rename
  rename(location=County,
         data=`Teen Birth Rate`) %>%
  
  mutate(locationtype='County') %>%
  mutate(data=as.numeric(paste(data))) %>%
  
  #fix the name on some counties
  mutate(location=replace(location,location=='Golden','Golden Valley')) %>%
  mutate(location=replace(location,location=='Mccone','McCone')) %>%
  subset(location != '~Not Stated')


#STATE DATA
#WHEN RATE CAN BE USED DIRECTLY FROM SPREADSHEET
births_state <- montana_5year %>%
  #select only needed column
  select(c(Race,`Teen Birth Rate`)) %>%
  
  #only select all
  subset(Race=='All') %>%
  
  #rename
  rename(location=Race,
         data=`Teen Birth Rate`) %>%
  mutate(location='Montana') %>%
  
  mutate(locationtype='State')


#pull data for population matching age 15-19 for females only
#fulldata <- read.csv(paste0("../Input/demographics/DATADELIVERY_ Vintage 2021 Population Estimates20221021073707/v2021_co_res_char11_mt.csv"))

#population_15_19 <- fulldata %>% 
 # mutate(age_group=as.numeric(paste(age_group))) %>%
  #mutate(data=as.numeric(paste(data))) %>%
  #subset(age_group >=15 & age_group <=19) %>%
  #group_by(location) %>%
  #summarise(age_15_19=sum(data))


#COMBINE GEOGRAPHIES
births_all <- births_county %>%
  bind_rows(births_state) %>%
  
  #calculate rate
 # left_join(population_15_19,by=c('location'='location')) %>%
  #mutate(data=(count/age_15_19)*1000) %>%
  #select(c(count)) %>%
  
  #add in KC variables
  mutate(timeframe=fiveyear,
         state='Montana',
         dataformat='Rate',
         varname='teenbirths5yeartotals') %>%
  
  #merge location ids
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) 


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(births_all$locationid))>=1) {
  print(births_all$location[is.na(births_all$locationid)])
} else if (sum(is.na(births_all$locationid))==0) {
  'all locations match'
}


#2. Check that there is no suppression or >1 suppression
########## MANUAL STEP #############
#need to check that county data cannot be identified using totals
temp_testsuppression <- births_all %>%
  subset(locationtype=='County') %>%
  group_by(location) %>%
  summarise_all(~sum(is.na(.))) %>%
  transmute(location,sumNA=rowSums(.[-1])) %>%
  subset(sumNA==1)

temp_rows <- as.numeric(nrow(temp_testsuppression))
if (temp_rows==0 | temp_rows>1) {
  'no additional data suppression needed'
} else if (temp_rows==1) {
  View(temp_testsuppression)
}

#if there is only one county, print the counties in ascending order
#temp_check <- counties_5year %>%
#  select(County,`Number Starting PNC in 1st Trimester`) %>%
#  arrange(`Number Starting PNC in 1st Trimester`)
#View(temp_check)

#******
#CHANGE TO THE CORRECT COUNTY NAME HERE
#**Choose the county with the next lowest count of births; if there is a tie, suppress both
#births_all$data[births_all$location=='Golden Valley'] <- NA


# 4. Visually inspect output data
View(births_all)

```

## STEP 2: ADD TO DATABASE
```{r}
#CHECK DATASET NAMED births_all TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#add to database
dbWriteTable(con,'montana',births_all,append=TRUE,row.names=FALSE)
```

## STEP 3: OUTPUT FILE FOR KC
```{r}
#write query from database to get needed format for KC data center

upload_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM montana WHERE timeframe='",fiveyear,"' AND varname='teenbirths5yeartotals';")

upload_data <- dbGetQuery(con,upload_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/health/",statefile,"_",year,"_teenbirths5yeartotals.csv"),row.names=FALSE)
```




## ###################################################################### ##
## BIRTHS TO WOMEN RECEIVING PRENATAL CARE DURING FIRST TRIMESTER BY RACE ## 
## ######################## (1-YEAR TOTALS) ############################# ##
## ###################################################################### ##

## STEP 1: CLEAN DATA
```{r}

#STATE DATA
births_all <- montana_1year %>%
  #select only needed column
  select(c(Race,`Births to mothers receiving prenatal care beginning in 1st trimester (percent of all births)`)) %>%
  
  #only select the two reported races
  subset(Race=='American Indian/Alaskan Native' | Race=='White') %>%
  
  #rename
  rename(race=Race,
         data=`Births to mothers receiving prenatal care beginning in 1st trimester (percent of all births)`) %>%
  mutate(race=if_else(race=='American Indian/Alaskan Native','American Indian','White')) %>%
  mutate(location='Montana') %>%
  
  mutate(locationtype='State') %>%
  
  #add in KC variables
  mutate(location='Montana',
         timeframe=year,
         state='Montana',
         dataformat='Percent',
         varname='firsttrimesterprenatalrace1yeartotals') %>%
  
  #merge location ids
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) 


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(births_all$locationid))>=1) {
  print(births_all$location[is.na(births_all$locationid)])
} else if (sum(is.na(births_all$locationid))==0) {
  'all locations match'
}


#2. Check that there is no suppression or >1 suppression
########## MANUAL STEP #############
#need to check that county data cannot be identified using totals
temp_testsuppression <- births_all %>%
  subset(locationtype=='County') %>%
  group_by(location) %>%
  summarise_all(~sum(is.na(.))) %>%
  transmute(location,sumNA=rowSums(.[-1])) %>%
  subset(sumNA==1)

temp_rows <- as.numeric(nrow(temp_testsuppression))
if (temp_rows==0 | temp_rows>1) {
  'no additional data suppression needed'
} else if (temp_rows==1) {
  View(temp_testsuppression)
}

#if there is only one county, print the counties in ascending order
#temp_check <- counties_1year %>%
#  select(County,`Number Starting PNC in 1st Trimester`) %>%
#  arrange(`Number Starting PNC in 1st Trimester`)
#View(temp_check)

#******
#CHANGE TO THE CORRECT COUNTY NAME HERE
#**Choose the county with the next lowest count of births; if there is a tie, suppress both
#births_all$data[births_all$location=='Billings'] <- NA


# 4. Visually inspect output data
View(births_all)

```

## STEP 2: ADD TO DATABASE
```{r}
#CHECK DATASET NAMED births_all TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#add to database
dbWriteTable(con,'montana',births_all,append=TRUE,row.names=FALSE)

```

## STEP 3: OUTPUT FILE FOR KC
```{r}
#write query from database to get needed format for KC data center

upload_sql <- paste0("SELECT locationid, location, timeframe, race, dataformat, data FROM montana WHERE timeframe='",year,"' AND varname='firsttrimesterprenatalrace1yeartotals';")

upload_data <- dbGetQuery(con,upload_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data,
         Race=race)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/health/",statefile,"_",year,"_firsttrimesterprenatalrace1yeartotals.csv"),row.names=FALSE)
```



