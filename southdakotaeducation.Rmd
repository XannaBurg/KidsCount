---
title: "southdakotaeducation"
author: "Xanna Burg"
date: "March, 2020"
output: html_document
---

## Indicator 1: Children enrolled in special education in public schools
## Indicator 2: Children enrolled in special education by type of impairment
## Indicator 3: Children enrolled in special education by age
## Indicator 4: Children enrolled in special education by grade
## Indicator 5: Public school enrollment grades Pre-K through 12
## Indicator 6: Public school enrollment grades K through 12
## Non-public school enrollment grades pre-K through 12
## Home school enrollment
## Grades 7 to 12 event drop-out rate
## High school completion rate
##Four-year cohort graduation rate
## Average expenditures per student in public schools
## Average ACT composite score
## Children enrolled in special education in public schools by race/ethnicity
## High school completion rate by race/ethnicity
## Four-year cohort graduation rate by race/ethnicity

**Created by:** Xanna Burg
**Date:** March 2020
**Updated by:**

**Data Source:** South Dakota Department of Education - Statistical Digest, Child Count, Report Card, and special request
**Purpose:** Input the statewide and district-level data

**Data format:** final output csv to upload is in long format with the following variables: Location (character: name of location), TimeFrame (text: years), Race (for three indicators broken down by race; character) Data (numeric: number, percentage), DataFormat (character: "number" or "percent" or "rate"), LocationId (numeric: assigned for KIDS COUNT system)


```{r,message=FALSE}
#load required packages
library(tidyverse)
library(RPostgreSQL)
library(readxl)
library(naniar)
library(stringr)
```

```{r}
####UPDATE to reflect the current year data working with
year <- '18_19'
fullyear <- '2018/19' 
statefile <- 'southdakota'
statename <- 'South Dakota'

#input location ID file for SD
locationids <- read.csv("./Input/SD KC Location IDs.csv")
```



**PUBLIC SCHOOL ENROLLMENT GRADES PRE-K THROUGH 12**
**PUBLIC SCHOOL ENROLLMENT GRADES K THROUGH 12**
#The same code can be used to run both enrollment indicators by changing the objects at the beginning of the first chunk
```{r}
#requested dataset for enrollment and dropouts
xl_data_enroll <- paste0("./Input/education/southdakota_",year,"_enrollmentdropout.xlsx")
df_enrollment <- read_excel(path=xl_data_enroll, sheet='Pubdisgr',skip=3)


#UPDATE THESE TWO VARIABLES PRIOR TO RUNNING THE CODE
#RUN THE CODE IN THESE CHUNKS THROUGH FOR EACH OF THE INDICATORS
columnname <- 'TOTAL KG-12'
input_dataformat <- 'Number'
variablename <- 'publicschoolk12enrollment'


enrollment_district <- df_enrollment %>%
  rename(location='District Name',
         data=columnname) %>%
  select(c(location,data)) %>%
  mutate(locationtype='School District') %>%
  mutate(state='South Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(dataformat=input_dataformat) %>%
  mutate(varname=variablename) %>%
  mutate(location=sub("[ ]+(?=[0-9])", 
                      ' School District ', location,perl=TRUE)) %>%
  mutate(location=ifelse(location=='Wolsey-Wessington Sch District 02-6',
                         'Wolsey-Wessington School District 02-6',location)) %>%
    mutate(location=ifelse(location=='Deubrook Area School District 05-6',
                         'Deubrook School District 05-6',location)) %>%
    mutate(location=ifelse(location=='Wagner Community School District 11-4',
                         'Wagner School District 11-4',location)) %>%
    mutate(location=ifelse(location=='Webster Area School District 18-5',
                         'Webster School District 18-5',location)) %>%
    mutate(location=ifelse(location=='Ipswich Public School District 22-6',
                         'Ipswich School District 22-6',location)) %>%
    mutate(location=ifelse(location=='Faulkton Area School District 24-4',
                         'Faulkton School District 24-4',location)) %>%
    mutate(location=ifelse(location=='Miller School District 29-4',
                         'Miller Area School District 29-4',location)) %>%
    mutate(location=ifelse(location=='Kadoka Area School District 35-2',
                         'Kadoka School District 35-2',location)) %>%
    mutate(location=ifelse(location=='Chester Area School District 39-1',
                         'Chester Area District 39-1',location)) %>%
    mutate(location=ifelse(location=='Langford Area School District 45-5',
                         'Langford School District 45-5',location)) %>%
    mutate(location=ifelse(location=='Rapid City Area School District 51-4',
                         'Rapid City School District 51-4',location)) %>%
    mutate(location=ifelse(location=='Viborg-Hurley School District 60-6',
                         'Viborg Hurley 60-6',location)) %>%
    mutate(location=ifelse(location=='Selby Area School District 62-5',
                         'Selby School District 62-5',location)) %>%
  mutate(location=ifelse(location=='Shannon County School District 65-1',
                         'Oglala Lakota County School District 65-1',location)) %>%
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) %>%
  subset(!is.na(locationid))


#calculate the state data from the district data
enrollment_state <- enrollment_district %>%
  group_by(state) %>%
  summarise(data=sum(data)) %>%
  mutate(location='South Dakota') %>%
  mutate(locationtype='State') %>%
  mutate(varname=variablename) %>%
  mutate(locationid=43) %>%
  mutate(dataformat=input_dataformat) %>%
  mutate(timeframe=fullyear)

enrollment <- enrollment_district %>%
  bind_rows(enrollment_state)

```

```{r}
#CHECK DATASET NAMED enrollment TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#add to database
dbWriteTable(con,'southdakota',enrollment,append=TRUE,row.names=FALSE)
```
```{r}
#write query from database to get needed format for KC data center

enroll_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM southdakota WHERE timeframe='",fullyear,"' AND  varname='",variablename,"';")

upload_data_enroll <-
  dbGetQuery(con,enroll_sql)

upload_data_enroll2 <- upload_data_enroll %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data_enroll,file=paste0("./Output/education/southdakota_",year,"_",variablename,".csv"),row.names=FALSE)
```


**NON-PUBLIC SCHOOL ENROLLMENT GRADES PRE-K THROUGH 12**
```{r}
state_data <- 16365
#######

#CALCULATE THE STATEWIDE DATA
nonpublic_state <- as.data.frame(state_data) %>%
  rename(data=state_data) %>%
  mutate(location='South Dakota') %>%
  mutate(locationtype='State') %>%
  mutate(locationid=43) %>%
  mutate(state='South Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(dataformat='Number') %>%
  mutate(varname='nonpublicschoolprek12enrollment')

```

```{r}
#CHECK DATASET NAMED nonpublic_state TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#add to database
dbWriteTable(con,'southdakota',nonpublic_state,append=TRUE,row.names=FALSE)
```

```{r}
#write query from database to get needed format for KC data center

nonpublic_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM southdakota WHERE timeframe='",fullyear,"' AND  varname='nonpublicschoolprek12enrollment';")

upload_data_nonpublic <-
  dbGetQuery(con,nonpublic_sql)

upload_data_nonpublic2 <- upload_data_nonpublic %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data_nonpublic,file=paste0("./Output/education/southdakota_",year,"_nonpublicschoolprek12enrollment.csv"),row.names=FALSE)
```





**GRADES 7 TO 12 EVENT DROP-OUT RATE**
**AVERAGE EXPENDITURES PER STUDENT IN PUBLIC SCHOOLS**
**AVERAGE ACT COMPOSITE SCORE**
**HOME SCHOOL ENROLLMENT GRADES K THROUGH 12**
**ELIGIBLE RECIPIENTS OF FREE OR REDUCED PRICE LUNCH - district and school**
#The same code can be used to run all indicators by changing the objects at the beginning of the first chunk
```{r}
#read in data from statistical digest - may need to confirm the number of rows to skip before columns begin
df_digest <- read_excel(path=paste0("./Input/education/southdakota_",year,"_educationstatisticaldigest.xlsx"),skip=4)

####### UPDATE THESE VARIABLES PRIOR TO RUNNING THE CODE
#verify column names prior to assigning, should be: 'Dropout Rate\r\n (%)' and 'Expenditure per ADM' and 'ACT Composite Score' and 'Fall Count of Home School Students' and 'Free & Reduced Lunch Eligibility Percentage'
#variable.names(df_digest)

columnname <- 'Fall Count of Home School Students'
input_dataformat <- 'Number'
variablename <- 'homeschoolk12enrollment'
#pull state data from the school profile on the statistical digest
state_data <- 3648
#######


#CALCULATE THE STATEWIDE DATA
digestdata_state <- as.data.frame(state_data) %>%
  rename(data=state_data) %>%
  mutate(location='South Dakota') %>%
  mutate(locationtype='State') %>%
  mutate(locationid=43) %>%
  mutate(state='South Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(dataformat=input_dataformat) %>%
  mutate(varname=variablename)

#CALCULATE THE DISTRICT DATA
digestdata_district <- df_digest %>%
  rename(location='District Name',
         data=columnname) %>%
  select(c(location,data)) %>%
  mutate(locationtype='School District') %>%
  mutate(state='South Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(dataformat=input_dataformat) %>%
  mutate(varname=variablename) %>%
  mutate(location=ifelse(location=='Wolsey-Wessington Sch District 02-6',
                         'Wolsey-Wessington School District 02-6',location)) %>%
    mutate(location=ifelse(location=='Deubrook Area School District 05-6',
                         'Deubrook School District 05-6',location)) %>%
    mutate(location=ifelse(location=='Wagner Community School District 11-4',
                         'Wagner School District 11-4',location)) %>%
    mutate(location=ifelse(location=='Webster Area School District 18-5',
                         'Webster School District 18-5',location)) %>%
    mutate(location=ifelse(location=='Ipswich Public School District 22-6',
                         'Ipswich School District 22-6',location)) %>%
    mutate(location=ifelse(location=='Faulkton Area Schools District 24-4',
                         'Faulkton School District 24-4',location)) %>%
    mutate(location=ifelse(location=='Miller School District 29-4',
                         'Miller Area School District 29-4',location)) %>%
    mutate(location=ifelse(location=='Kadoka Area School District 35-2',
                         'Kadoka School District 35-2',location)) %>%
    mutate(location=ifelse(location=='Chester Area School District 39-1',
                         'Chester Area District 39-1',location)) %>%
    mutate(location=ifelse(location=='Langford Area School District 45-5',
                         'Langford School District 45-5',location)) %>%
    mutate(location=ifelse(location=='Rapid City Area School District 51-4',
                         'Rapid City School District 51-4',location)) %>%
    mutate(location=ifelse(location=='Viborg-Hurley School District 60-6',
                         'Viborg Hurley 60-6',location)) %>%
    mutate(location=ifelse(location=='Selby Area School District 62-5',
                         'Selby School District 62-5',location)) %>%
  mutate(location=ifelse(location=='Shannon County School District 65-1',
                         'Oglala Lakota County School District 65-1',location)) %>%
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) %>%
  subset(!is.na(locationid))

#COMBINE STATE AND DISTRICT DATA
digestdata <- digestdata_state %>%
  bind_rows(digestdata_district)

```

```{r}
#CHECK DATASET NAMED digestdata TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#add to database
dbWriteTable(con,'southdakota',digestdata,append=TRUE,row.names=FALSE)
```

```{r}
#write query from database to get needed format for KC data center

digest_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM southdakota WHERE timeframe='",fullyear,"' AND  varname='",variablename,"';")

upload_data_digest <- dbGetQuery(con,digest_sql)

upload_data_digest2 <- upload_data_digest %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data_digest,file=paste0("./Output/education/southdakota_",year,"_",variablename,".csv"),row.names=FALSE)
```



```{r}
#READ IN THE SPECIAL EDUCATION DATA

#special education state data
xl_data <- paste0("./Input/education/southdakota_12_19_specialeducationstate.xlsx")
df_specialed_impairment <- read_excel(path=xl_data, range="A4:W23")
df_specialed_grade <- read_excel(path=xl_data, range="O26:V42")
df_specialed_age <- read_excel(path=xl_data, range="O67:V87")
df_specialed_race <- read_excel(path=xl_data, range="O49:V57")

#special education district data
xl_data_specialed_district <- paste0("./Input/education/southdakota_",year,"_specialeducationdistrict.xlsx")
df_specialed_district <- read_excel(path=xl_data_specialed_district,skip=3)
```


**CHILDREN ENROLLED IN SPECIAL EDUCATION IN PUBLIC SCHOOLS**
```{r}
specialed_count <- df_specialed_district %>%
  select(c('District Name','2019 TOTAL Child Count (ages 3-21)')) %>%
  rename(location='District Name',
         data='2019 TOTAL Child Count (ages 3-21)') %>%
  subset(!is.na(location) & location != 'TOTAL' & 
           location != 'Susan Woodmansey,') %>%
  mutate(locationtype='School District') %>%
  mutate(state='South Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(dataformat='Number') %>%
  mutate(varname='totalspecialeducation') %>%
  mutate(data=as.numeric(paste(data))) %>%
  mutate(location=sub("[ ]+(?=[0-9])", 
                      ' School District ', location,perl=TRUE)) %>%
  mutate(location=ifelse(location=='Chester Area School District 39-1', 
        'Chester Area District 39-1',location)) %>%
  mutate(location=ifelse(location=='Deubrook Area School District 05-6', 
        'Deubrook School District 05-6',location)) %>%
  mutate(location=ifelse(location=='Faulkton Area Schools School District 24-4','Faulkton School District 24-4',location)) %>%
  mutate(location=ifelse(location=='Ipswich Public School District 22-6', 
        'Ipswich School District 22-6',location)) %>%
  mutate(location=ifelse(location=='Kadoka Area School District 35-2',
        'Kadoka School District 35-2',location)) %>%
  mutate(location=ifelse(location=='Langford Area School District 45-5',
        'Langford School District 45-5',location)) %>%
  mutate(location=ifelse(location=='Miller School District 29-4', 
        'Miller Area School District 29-4',location)) %>%
  mutate(location=ifelse(location=='Oglala Lakota School District 65-1', 
        'Oglala Lakota County School District 65-1',location)) %>%
  mutate(location=ifelse(location=='Rapid City Area School District 51-4',
        'Rapid City School District 51-4',location)) %>%
  mutate(location=ifelse(location=='Selby Area School District 62-5',
        'Selby School District 62-5',location)) %>%
  mutate(location=ifelse(location=='Viborg-Hurley School District 60-6',
        'Viborg Hurley 60-6',location)) %>%
  mutate(location=ifelse(location=='Wagner Community School District 11-4',
        'Wagner School District 11-4',location)) %>%
  mutate(location=ifelse(location=='Webster Area School District 18-5',
        'Webster School District 18-5',location)) %>%
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId)

specialed_percent <- df_specialed_district %>%
  select(c('District Name','Child Count as % of Fall PK-12 Enrollment')) %>%
  rename(location='District Name',
         data='Child Count as % of Fall PK-12 Enrollment') %>%
  subset(!is.na(location) & location != 'TOTAL' & 
           location != 'Susan Woodmansey,') %>%
  mutate(locationtype='School District') %>%
  mutate(state='South Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(dataformat='Percent') %>%
  mutate(varname='totalspecialeducation') %>%
  mutate(location=sub("[ ]+(?=[0-9])", 
                      ' School District ', location,perl=TRUE)) %>%
  mutate(location=ifelse(location=='Chester Area School District 39-1', 
        'Chester Area District 39-1',location)) %>%
  mutate(location=ifelse(location=='Deubrook Area School District 05-6', 
        'Deubrook School District 05-6',location)) %>%
  mutate(location=ifelse(location=='Faulkton Area Schools School District 24-4','Faulkton School District 24-4',location)) %>%
  mutate(location=ifelse(location=='Ipswich Public School District 22-6', 
        'Ipswich School District 22-6',location)) %>%
  mutate(location=ifelse(location=='Kadoka Area School District 35-2',
        'Kadoka School District 35-2',location)) %>%
  mutate(location=ifelse(location=='Langford Area School District 45-5',
        'Langford School District 45-5',location)) %>%
  mutate(location=ifelse(location=='Miller School District 29-4', 
        'Miller Area School District 29-4',location)) %>%
  mutate(location=ifelse(location=='Oglala Lakota School District 65-1', 
        'Oglala Lakota County School District 65-1',location)) %>%
  mutate(location=ifelse(location=='Rapid City Area School District 51-4',
        'Rapid City School District 51-4',location)) %>%
  mutate(location=ifelse(location=='Selby Area School District 62-5',
        'Selby School District 62-5',location)) %>%
  mutate(location=ifelse(location=='Viborg-Hurley School District 60-6',
        'Viborg Hurley 60-6',location)) %>%
  mutate(location=ifelse(location=='Wagner Community School District 11-4',
        'Wagner School District 11-4',location)) %>%
  mutate(location=ifelse(location=='Webster Area School District 18-5',
        'Webster School District 18-5',location)) %>%
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId)


specialed_count_state <- df_specialed_district %>%
  rename(data='2019 TOTAL Child Count (ages 3-21)',
         location='District Name') %>%
  subset(location=='TOTAL') %>%
  select(c(data))  %>%
  mutate(location='South Dakota') %>%
  mutate(state='South Dakota') %>%
  mutate(locationtype='State') %>%
  mutate(locationid=43) %>%
  mutate(timeframe=fullyear) %>%
  mutate(dataformat='Number') %>%
  mutate(varname='totalspecialeducation') %>%
  mutate(data=as.numeric(paste(data)))

specialed_percent_state <- df_specialed_district %>%
  rename(data='Child Count as % of Fall PK-12 Enrollment',
         location='District Name') %>%
  subset(location=='TOTAL') %>%
  select(c(data))  %>%
  mutate(location='South Dakota') %>%
  mutate(state='South Dakota') %>%
  mutate(locationtype='State') %>%
  mutate(locationid=43) %>%
  mutate(timeframe=fullyear) %>%
  mutate(dataformat='Percent') %>%
  mutate(varname='totalspecialeducation')

  
upload_specialeducation_district <- specialed_count %>%
  bind_rows(specialed_percent) %>%
  bind_rows(specialed_count_state) %>%
  bind_rows(specialed_percent_state)
```

```{r}
#CHECK DATASET NAMED upload_specialeducation_district TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#add to database
dbWriteTable(con,'southdakota',upload_specialeducation_district,append=TRUE,row.names=FALSE)
```

```{r}
#write query from database to get needed format for KC data center

specialed_districtenrollment_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM southdakota WHERE timeframe='",fullyear,"' AND varname='totalspecialeducation';")

upload_data_specialed_district <-
  dbGetQuery(con,specialed_districtenrollment_sql)

upload_data_specialed_district2 <- upload_data_specialed_district %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data_specialed_district2,file=paste0("./Output/education/",statefile,"_",year,"_totalspecialeducation.csv"),row.names=FALSE)
```



**CHILDREN ENROLLED IN SPECIAL EDUCATION IN PUBLIC SCHOOLS BY TYPE OF IMPAIRMENT**
```{r}
#clean up the data
year_variable <- paste0("December ",fullyear_file)

specialed_impairment_count <- df_specialed_impairment %>%
  rename(data=year_variable,
         category_original='Disabling  Condition') %>%
  select(c(data,category_original)) %>%
  subset(!is.na(category_original) & 
           category_original != 'Total Ages 3-5' &
           category_original != 'Total Ages 6-21' & 
           category_original != 'TOTAL CHILD COUNT (Ages 3-21)') %>%
  mutate(category=case_when(
    category_original=='Autism (560)' ~ 'Autism Spectrum Disorder',
    category_original=='Cognitive Disability (510)' ~ 'Cognitive Disability',
    category_original=='Deaf (545)' ~ 'Deafness',
    category_original=='Emotionally Disturbed (505)' ~ 
      'Emotionally Disturbed',
    category_original=='Hearing Loss (515)' ~ 'Hearing Loss',
    category_original=='Multiple Disabilities (530)' ~ 
      'Multiple Disabilities',
    category_original=='Orthopedic Impairments (535)' ~ 
      'Orthopedic Impairments',
    category_original=='Other Health Impaired (555)' ~ 
      'Other Health Impairments',
    category_original=='Preschool 3-5 (570)' ~ 
      'Developmental Delay (Preschool Ages 3-5)',
    category_original=='Prolonged Assistance (Ages 0-2)' ~ 
      'Prolonged Assistance (Ages 0-2)',
    category_original=='Specific Learning Disabled (525)' ~ 
      'Specific Learning Disabled',
    category_original=='Speech/Language Impairments (550)' ~ 
      'Speech/Language Disorder',
    category_original=='Traumatic Brain Injury (565)' ~ 
      'Traumatic Brain Injury',
    category_original=='Vision Loss (540)' ~ 'Vision Loss')) %>%
  select(-c(category_original)) %>%
  subset(!is.na(category)) %>%
  mutate(location='South Dakota') %>%
  mutate(locationtype='State') %>%
  mutate(state='South Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(dataformat='Number') %>%
  mutate(varname='totalspecialeducationbyimpairment') %>%
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId)


specialed_impairment_percent <- df_specialed_impairment %>%
  rename(data_number=year_variable,
         category_original='Disabling  Condition') %>%
  select(c(data_number,category_original)) %>%
  subset(!is.na(category_original) & 
           category_original != 'Total Ages 3-5' &
           category_original != 'Total Ages 6-21') %>%
   mutate(total=data_number[category_original=='TOTAL CHILD COUNT (Ages 3-21)']) %>%
  subset(category_original != 'TOTAL CHILD COUNT (Ages 3-21)') %>%
  mutate(category=case_when(
    category_original=='Autism (560)' ~ 'Autism Spectrum Disorder',
    category_original=='Cognitive Disability (510)' ~ 'Cognitive Disability',
    category_original=='Deaf (545)' ~ 'Deafness',
    category_original=='Emotionally Disturbed (505)' ~ 
      'Emotionally Disturbed',
    category_original=='Hearing Loss (515)' ~ 'Hearing Loss',
    category_original=='Multiple Disabilities (530)' ~ 
      'Multiple Disabilities',
    category_original=='Orthopedic Impairments (535)' ~ 
      'Orthopedic Impairments',
    category_original=='Other Health Impaired (555)' ~ 
      'Other Health Impairments',
    category_original=='Preschool 3-5 (570)' ~ 
      'Developmental Delay (Preschool Ages 3-5)',
    category_original=='Prolonged Assistance (Ages 0-2)' ~ 
      'Prolonged Assistance (Ages 0-2)',
    category_original=='Specific Learning Disabled (525)' ~ 
      'Specific Learning Disabled',
    category_original=='Speech/Language Impairments (550)' ~ 
      'Speech/Language Disorder',
    category_original=='Traumatic Brain Injury (565)' ~ 
      'Traumatic Brain Injury',
    category_original=='Vision Loss (540)' ~ 'Vision Loss')) %>%
  mutate(data=data_number/total) %>%
  select(-c(category_original,data_number,total)) %>%
  subset(!is.na(category)) %>%
  mutate(location='South Dakota') %>%
  mutate(locationtype='State') %>%
  mutate(state='South Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(dataformat='Percent') %>%
  mutate(varname='totalspecialeducationbyimpairment') %>%
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId)


upload_specialeducation <- specialed_impairment_count %>%
  bind_rows(specialed_impairment_percent)
```

```{r}
#CHECK DATASET NAMED upload_specialeducation TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#add to database
dbWriteTable(con,'southdakota',upload_specialeducation,append=TRUE,row.names=FALSE)
```

```{r}
#write query from database to get needed format for KC data center

specialed_impairment_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data, category FROM southdakota WHERE timeframe='",fullyear,"' AND  varname='totalspecialeducationbyimpairment';")

upload_data_specialed_impairment <- dbGetQuery(con,specialed_impairment_sql)

upload_data_specialed_impairment2 <- upload_data_specialed_impairment %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data,
         Category=category)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data_specialed_impairment,file=paste0("./Output/education/",statefile,"_",year,"_totalspecialeducationbyimpairment.csv"),row.names=FALSE)
```


**CHILDREN ENROLLED IN SPECIAL EDUCATION IN PUBLIC SCHOOLS BY GRADE LEVEL**
```{r}
#clean up the data

specialed_grade_count <- df_specialed_grade %>%
  rename(data=fullyear_file,
         category_original=Grade) %>%
  select(c(data,category_original)) %>%
  subset(!is.na(category_original) & 
           category_original != 'TOTAL') %>%
  mutate(category=case_when(
    category_original=='Early Childhood' ~ 'EC',
    category_original=='Eighth Grade' ~ '8th Grade',
    category_original=='Eleventh Grade' ~ '11th Grade',
    category_original=='Fifth Grade' ~ '5th Grade',
    category_original=='First Grade' ~ '1st Grade',
    category_original=='Fourth Grade' ~ '4th Grade',
    category_original=='Kindergarten' ~ 'K',
    category_original=='Ninth Grade' ~ '9th Grade',
    category_original=='Pre-Kindergarten' ~ 'PK',
    category_original=='Second Grade' ~ '2nd Grade',
    category_original=='Seventh Grade' ~ '7th Grade',
    category_original=='Sixth Grade' ~ '6th Grade',
    category_original=='Tenth Grade' ~ '10th Grade',
    category_original=='Third Grade' ~ '3rd Grade',
    category_original=='Twelfth Grade' ~ '12th Grade')) %>%
  select(-c(category_original)) %>%
  subset(!is.na(category)) %>%
  mutate(location='South Dakota') %>%
  mutate(locationtype='State') %>%
  mutate(state='South Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(dataformat='Number') %>%
  mutate(varname='totalspecialeducationbygrade') %>%
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId)


specialed_grade_percent <- df_specialed_grade %>%
  rename(data_number=fullyear_file,
         category_original='Grade') %>%
  select(c(data_number,category_original)) %>%
  subset(!is.na(category_original)) %>%
   mutate(total=data_number[category_original=='TOTAL']) %>%
  subset(category_original != 'TOTAL') %>%
  mutate(category=case_when(
    category_original=='Early Childhood' ~ 'EC',
    category_original=='Eighth Grade' ~ '8th Grade',
    category_original=='Eleventh Grade' ~ '11th Grade',
    category_original=='Fifth Grade' ~ '5th Grade',
    category_original=='First Grade' ~ '1st Grade',
    category_original=='Fourth Grade' ~ '4th Grade',
    category_original=='Kindergarten' ~ 'K',
    category_original=='Ninth Grade' ~ '9th Grade',
    category_original=='Pre-Kindergarten' ~ 'PK',
    category_original=='Second Grade' ~ '2nd Grade',
    category_original=='Seventh Grade' ~ '7th Grade',
    category_original=='Sixth Grade' ~ '6th Grade',
    category_original=='Tenth Grade' ~ '10th Grade',
    category_original=='Third Grade' ~ '3rd Grade',
    category_original=='Twelfth Grade' ~ '12th Grade')) %>%
  mutate(data=data_number/total) %>%
  select(-c(category_original,data_number,total)) %>%
  subset(!is.na(category)) %>%
  mutate(location='South Dakota') %>%
  mutate(locationtype='State') %>%
  mutate(state='South Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(dataformat='Percent') %>%
  mutate(varname='totalspecialeducationbygrade') %>%
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId)


upload_specialeducation_grade <- specialed_grade_count %>%
  bind_rows(specialed_grade_percent)
```

```{r}
#CHECK DATASET NAMED upload_specialeducation_grade TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#add to database
dbWriteTable(con,'southdakota',upload_specialeducation_grade,append=TRUE,row.names=FALSE)
```

```{r}
#write query from database to get needed format for KC data center

specialed_grade_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data, category FROM southdakota WHERE timeframe='",fullyear,"' AND   varname='totalspecialeducationbygrade';")

upload_data_specialed_grade <- dbGetQuery(con,specialed_grade_sql)

upload_data_specialed_grade2 <- upload_data_specialed_grade %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data,
         'Grade Level'=category)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data_specialed_grade2,file=paste0("./Output/education/",statefile,"_",year,"_totalspecialeducationbygrade.csv"),row.names=FALSE)
```



**CHILDREN ENROLLED IN SPECIAL EDUCATION IN PUBLIC SCHOOLS BY AGE**
```{r}
#clean up the data

specialed_age_count <- df_specialed_age %>%
  rename(data=fullyear_file,
         category=Age) %>%
  select(c(data,category)) %>%
  subset(!is.na(category) & 
           category != 'TOTAL') %>%
  subset(!is.na(category)) %>%
  mutate(location='South Dakota') %>%
  mutate(locationtype='State') %>%
  mutate(state='South Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(dataformat='Number') %>%
  mutate(varname='totalspecialeducationbyage') %>%
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId)


specialed_age_percent <- df_specialed_age %>%
  rename(data_number=fullyear_file,
         category=Age) %>%
  select(c(data_number,category)) %>%
  subset(!is.na(category)) %>%
   mutate(total=data_number[category=='TOTAL']) %>%
  subset(category != 'TOTAL') %>%
  mutate(data=data_number/total) %>%
  select(-c(data_number,total)) %>%
  subset(!is.na(category)) %>%
  mutate(location='South Dakota') %>%
  mutate(locationtype='State') %>%
  mutate(state='South Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(dataformat='Percent') %>%
  mutate(varname='totalspecialeducationbyage') %>%
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId)


upload_specialeducation_age <- specialed_age_count %>%
  bind_rows(specialed_age_percent) %>%
  rename(age_group=category)

  
```

```{r}
#CHECK DATASET NAMED upload_specialeducation_age TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#add to database
dbWriteTable(con,'southdakota',upload_specialeducation_age,append=TRUE,row.names=FALSE)
```

```{r}
#write query from database to get needed format for KC data center

specialed_age_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data, age_group FROM southdakota WHERE timeframe='",fullyear,"' AND varname='totalspecialeducationbyage';")

upload_data_specialed_age <- dbGetQuery(con,specialed_age_sql)

upload_data_specialed_age2 <- upload_data_specialed_age %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data,
         'Age group'=age_group)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data_specialed_age2,file=paste0("./Output/education/",statefile,"_",year,"_totalspecialeducationbyage.csv"),row.names=FALSE)
```



**CHILDREN ENROLLED IN SPECIAL EDUCATION IN PUBLIC SCHOOLS BY RACE**
```{r}
#clean up the data

specialed_race_count <- df_specialed_race %>%
  rename(data=fullyear_file,
         category_original=Ethnicity) %>%
  select(c(data,category_original)) %>%
  subset(!is.na(category_original) & 
           category_original != 'TOTAL') %>%
  mutate(category=case_when(
    category_original=='Asian' ~ 'Asian',
    category_original=='Black' ~ 'Black or African American',
    category_original=='Hispanic' ~ 'Hispanic or Latino',
    category_original=='Multiple Race' ~ 'Multi-Race',
    category_original=='Native American' ~ 'Native American',
    category_original=='Pacific Islander' ~ 'Pacific Islander',
    category_original=='White' ~ 'White')) %>%
  subset(!is.na(category)) %>%
  select(-c(category_original)) %>%
  mutate(location='South Dakota') %>%
  mutate(locationtype='State') %>%
  mutate(state='South Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(dataformat='Number') %>%
  mutate(varname='totalspecialeducationbyrace') %>%
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId)


specialed_race_percent <- df_specialed_race %>%
  rename(data_number=fullyear_file,
         category_original=Ethnicity) %>%
  select(c(data_number,category_original)) %>%
  subset(!is.na(category_original)) %>%
   mutate(total=data_number[category_original=='TOTAL']) %>%
  subset(category_original != 'TOTAL') %>%
  mutate(data=data_number/total) %>%
  mutate(category=case_when(
    category_original=='Asian' ~ 'Asian',
    category_original=='Black' ~ 'Black or African American',
    category_original=='Hispanic' ~ 'Hispanic or Latino',
    category_original=='Multiple Race' ~ 'Multi-Race',
    category_original=='Native American' ~ 'Native American',
    category_original=='Pacific Islander' ~ 'Pacific Islander',
    category_original=='White' ~ 'White')) %>%
  select(-c(data_number,total,category_original)) %>%
  subset(!is.na(category)) %>%
  mutate(location='South Dakota') %>%
  mutate(locationtype='State') %>%
  mutate(state='South Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(dataformat='Percent') %>%
  mutate(varname='totalspecialeducationbyrace') %>%
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId)


upload_specialeducation_race <- specialed_race_count %>%
  bind_rows(specialed_race_percent) %>%
  rename(race=category)
```

```{r}
#CHECK DATASET NAMED upload_specialeducation_race TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#add to database
dbWriteTable(con,'southdakota',upload_specialeducation_race,append=TRUE,row.names=FALSE)
```

```{r}
#write query from database to get needed format for KC data center

specialed_race_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data, race FROM southdakota WHERE timeframe='",fullyear,"' AND varname='totalspecialeducationbyrace';")

upload_data_specialed_race <- dbGetQuery(con,specialed_race_sql)

upload_data_specialed_race2 <- upload_data_specialed_race %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data,
         Race=race)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data_specialed_race2,file=paste0("./Output/education/",statefile,"_",year,"_totalspecialeducationbyrace.csv"),row.names=FALSE)
```



**HIGH SCHOOL COMPLETION RATE**
**FOUR-YEAR COHORT GRADUATION RATE**
#The same code can be used to run both indicators
```{r}
#read in data from report card data - may need to confirm the number of rows to skip before columns begin
df_hsdata <- read_excel(path=paste0("./Input/education/southdakota_",year,"_educationhighschooldata.xlsx"),skip=2)

####### UPDATE THESE VARIABLES PRIOR TO RUNNING THE CODE
#verify column names prior to assigning
#The dataset isn't set up very nice in that there are three rows to uniquely identify each variable. Before using this data, need to verify the order of the columns as the order is how it is matched to the correct group.

#rename columns
df_hsdata2 <- df_hsdata %>%
  rename(completion_percentage=Percentage...9,
         graduation_percentage=Percentage...15) %>%
  subset(School=="All Schools") %>%
  select(District, completion_percentage,graduation_percentage)


#CALCULATE THE STATEWIDE AND DISTRICT DATA FOR BOTH VARIABLES
hsdata <- df_hsdata2 %>%
  mutate(location=case_when(
    District=="All Districts" ~ "South Dakota",
    District!="All Districts" ~ District)) %>%
  mutate(locationtype=case_when(
    location=='South Dakota' ~ 'State',
    location!='South Dakota' ~ 'County')) %>%
  mutate(state='South Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(dataformat='Percent') %>%
  select(-c(District)) %>%
  
  #add in school district to the locations for matching to KIDS COUNT
  mutate(location=sub("[ ]+(?=[0-9])", 
                      ' School District ', location,perl=TRUE)) %>%
  mutate(location=ifelse(location=='Chester Area School District 39-1',
                         'Chester Area District 39-1',location)) %>%
  mutate(location=ifelse(location=='Deubrook Area School District 05-6',
                         'Deubrook School District 05-6',location)) %>%
  mutate(location=ifelse(location=='Faulkton Area Schools School District 24-4',
                         'Faulkton School District 24-4',location)) %>%
  mutate(location=ifelse(location=='Ipswich Public School District 22-6',
                         'Ipswich School District 22-6',location)) %>%
  mutate(location=ifelse(location=='Webster Area School District 18-5',
                         'Webster School District 18-5',location)) %>%
  mutate(location=ifelse(location=='Kadoka Area School District 35-2',
                         'Kadoka School District 35-2',location)) %>%
  mutate(location=ifelse(location=='Langford Area School District 45-5',
                         'Langford School District 45-5',location)) %>%
  mutate(location=ifelse(location=='Miller School District 29-4',
                         'Miller Area School District 29-4',location)) %>%
  mutate(location=ifelse(location=='Selby Area School District 62-5',
                         'Selby School District 62-5',location)) %>%
  mutate(location=ifelse(location=='Rapid City Area School District 51-4',
                         'Rapid City School District 51-4',location)) %>%
  mutate(location=ifelse(location=='Viborg-Hurley School District 60-6',
                         'Viborg Hurley 60-6',location)) %>%
  mutate(location=ifelse(location=='Wagner Community School District 11-4',
                         'Wagner School District 11-4',location)) %>%
  
  #add in locationid
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId)



#CREATE THE HS COMPLETION DATASET
hs_completion <- hsdata %>%
  select(-c(graduation_percentage)) %>%
  rename(data=completion_percentage) %>%
  mutate(varname='highschoolcompletion')


#CREATE THE HS GRADUATION DATASET
hs_graduation <- hsdata %>%
  select(-c(completion_percentage)) %>%
  rename(data=graduation_percentage) %>%
  mutate(varname='graduationrate4cohort')
```

```{r}
#CHECK DATASET NAMED hs_completion TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#add to database
dbWriteTable(con,'southdakota',hs_completion,append=TRUE,row.names=FALSE)


#CHECK DATASET NAMED hs_graduation TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#add to database
dbWriteTable(con,'southdakota',hs_graduation,append=TRUE,row.names=FALSE)
```

```{r}
#write query from database to get needed format for KC data center
#code will pull data for both HS completion and graduation

completion_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM southdakota WHERE timeframe='",fullyear,"' AND  varname='highschoolcompletion';")

graduation_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM southdakota WHERE timeframe='",fullyear,"' AND  varname='graduationrate4cohort';")

upload_data_completion <- dbGetQuery(con,completion_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)

upload_data_graduation <- dbGetQuery(con,graduation_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data_completion,file=paste0("./Output/education/southdakota_",year,"_highschoolcompletion.csv"),row.names=FALSE)

write.csv(upload_data_graduation,file=paste0("./Output/education/southdakota_",year,"_graduationrate4cohort.csv"),row.names=FALSE)
```


**HIGH SCHOOL COMPLETION RATE BY RACE**
**FOUR-YEAR COHORT GRADUATION RATE BY RACE**
#The same code can be used to run both indicators
```{r}
#MANUALLY INPUT THE RACE DATA USING THE REPORT CARD
race <- c('American Indian/Alaska Native','Asian','Black or African American','Hispanic or Latino','White','All Races')
graduation <- c(.5365,.9045,.7867,.7354,.897,.8413)
completion <- c(.664,.9167,.863,.8296,.9458,.9035)

df_graduation_race <- data.frame(race,graduation) %>%
  rename(data=graduation) %>%
  mutate(location='South Dakota') %>%
  mutate(locationtype='State') %>%
  mutate(locationid=43) %>%
  mutate(state='South Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(dataformat='Percent') %>%
  mutate(varname='graduationrate4cohortbyrace')

df_completion_race <- data.frame(race,completion) %>%
  rename(data=completion) %>%
  mutate(location='South Dakota') %>%
  mutate(locationtype='State') %>%
  mutate(locationid=43) %>%
  mutate(state='South Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(dataformat='Percent') %>%
  mutate(varname='highschoolcompletionbyrace')

```

```{r}
#CHECK DATASET NAMED df_graduation_race TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#add to database
dbWriteTable(con,'southdakota',df_graduation_race,append=TRUE,row.names=FALSE)


#CHECK DATASET NAMED df_completion_race TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#add to database
dbWriteTable(con,'southdakota',df_completion_race,append=TRUE,row.names=FALSE)
```

```{r}
#write query from database to get needed format for KC data center
#code will pull data for both HS completion and graduation

completion_sql2 <- paste0("SELECT locationid, location, timeframe, dataformat, data, race FROM southdakota WHERE timeframe='",fullyear,"' AND  varname='highschoolcompletionbyrace';")

graduation_sql2 <- paste0("SELECT locationid, location, timeframe, dataformat, data, race FROM southdakota WHERE timeframe='",fullyear,"' AND  varname='graduationrate4cohortbyrace';")

upload_data_completion2 <- dbGetQuery(con,completion_sql2) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data,
         Race=race)

upload_data_graduation2 <- dbGetQuery(con,graduation_sql2) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data,
         Race=race)


#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data_completion2,file=paste0("./Output/education/southdakota_",year,"_highschoolcompletionbyrace.csv"),row.names=FALSE)

write.csv(upload_data_graduation2,file=paste0("./Output/education/southdakota_",year,"_graduationrate4cohortbyrace.csv"),row.names=FALSE)
```


