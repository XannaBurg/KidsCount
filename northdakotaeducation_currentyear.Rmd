---
title: "North Dakota Education"
author: "Xanna Burg"
date: "June 2020"
output: html_document
---

## Indicator 1: Eligible recipients of free or reduced-price lunch
## Indicator 2: Children ages 3 to 21 enrolled in special education in public schools
## Indicator 3: Children enrolled in special education in public schools by age (percent of special education enrollment)
## Indicator 4: Children enrolled in special education in public schools, by type of impairment (percent of special education enrollment)


*****NEED TO ADD ADDITIONAL STEPS FOR DATA SUPPRESSION DUE TO REGIONS REPORTING*******


**Created by:** Xanna Burg
**Date:** June 2020
**Updated by:**

**Data Source:** North Dakota Department of Public Instruction
**Purpose:** Import DPI data, clean data, and output dataset to upload to KIDS COUNT Data Center.

**Data format:** Final output csv to upload is in long format with the following variables: Location (character: name of location), TimeFrame (text: years), Category (character), Data (numeric: number, percentage), DataFormat (character: "number" or "percent"), LocationId (numeric: assigned for KIDS COUNT system)


**To use this code for a new year:**
* Update the year in the second code chunk for variable 'year'
* Manually enter the statewide data (from PDF)
* Check each dataset visually and through the report logs prior to commiting to the database.


```{r,message=FALSE}
#load required packages
library(tidyverse)
library(RPostgreSQL)
library(readxl)
library(naniar)
library(stringr)
```

```{r}
####UPDATE to reflect the current year data working with
year <- '23-24'
fullyear <- '2023/24' 
#fiscal year is the spring of reference school year
fiscalyear <- '2024'


statefile <- 'northdakota'
statename <- 'North Dakota'

#input location ID file for ND
locationids <- read.csv("./Input/ND KC Location IDs.csv")
locationids$Location <- as.character(locationids$Location)

#input region ID file for ND
regionids <- read.csv("./Input/ND KC Region List.csv")
regionids$county <- as.character(regionids$county)

#import the lookup table for county name
countyids <- read.csv("./Documentation/Indicator Documentation/North Dakota Data Requests/ND County Codes.csv")

#input the lookup table for schools on reservations
tribalschools <- read.csv("./Documentation/Indicator Documentation/North Dakota Data Requests/ND schools on reservations.csv",colClasses=c(id_nodash="character"))
tribalschools$schoolname <- as.character(tribalschools$schoolname)
tribalschools$id_dash <- as.character(paste((tribalschools$id_dash)))

```



## ELIGIBLE RECIPIENTS OF FREE OR REDUCED PRICE LUNCH ##
STEP 1: IMPORT AND CLEAN DATA
```{r}
#import data
frl_data <- read_excel(path=paste0("/Users/xannaburg/Documents/DO NOT DELETE/ND Education/ND Kids Count 2024 Request/1-InclusiveEnrollment.xlsx"),guess_max = 1048576)



############
#COUNTY DATA
frl_county <- frl_data %>%
  
  #change County to numeric in order to join
  mutate(County=as.numeric(paste(County))) %>%
  
  #import county name
  left_join(countyids,by=c("County"="ndcounty_number")) %>%

  #change FRL into indicator variable
  rename(lunchstatus='Lunch Status') %>%
  mutate(frl_indicator=case_when(
    lunchstatus == 'Not Eligible' ~ 0,
    lunchstatus == 'F/R Lunch' ~ 1)) %>%
  
  #create an indicator variable for counting total population
  mutate(enroll_indicator=case_when(
    !is.na(GradeName) ~ 1)) %>%
  
  #remove nonpublic schools (district ID >200) and students not enrolled in a school
  separate(SchoolStateIssuedID,c('county','district','school'),sep="-") %>%
  mutate(district=as.numeric(paste(district))) %>%
  subset(district<200) %>%
  subset(!is.na(school)) %>%
  
  #remove non counties
  subset(!is.na(ndcounty_name)) %>%

  #sum by county
  group_by(ndcounty_name) %>%
  summarise(frl_number=sum(frl_indicator),
            totalenroll=sum(enroll_indicator)) %>%
  ungroup %>%
  
  #create percent
  mutate(frl_percent=frl_number/totalenroll) %>%
  
  #add in locationtype
  rename(location=ndcounty_name) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='County')

###########
#STATE DATA
#start with  cleaned county data
frl_state <- frl_county %>%
  mutate(location='North Dakota') %>%
  group_by(location) %>%
  summarise(frl_number=sum(frl_number),
      totalenroll=sum(totalenroll)) %>%
  ungroup %>%
  #create percent
  mutate(frl_percent=frl_number/totalenroll) %>%

  #add in locationtype
  mutate(locationtype='State')

############
#REGION DATA
#start with cleaned county data
frl_region <- frl_county %>%
  
  #add in regions
  mutate(location=as.character(paste(location))) %>%
  left_join(regionids,by=c('location'='county')) %>%
  group_by(region) %>%
  summarise(frl_number=sum(frl_number),
      totalenroll=sum(totalenroll)) %>%
  ungroup %>%
  #create percent
  mutate(frl_percent=frl_number/totalenroll) %>%
  
  #add in locationtype
  rename(location=region) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='Planning Region')


#################
#TRIBAL AREA DATA
frl_tribal <- frl_data %>%
  
  #import tribal name
  left_join(tribalschools,by=c('SchoolStateIssuedID'='id_dash')) %>%
  subset(!is.na(tribalarea)) %>%
  
  #remove students not assigned to a school
  separate(SchoolStateIssuedID,c('county','district','school'),sep="-") %>%
  subset(!is.na(school)) %>%
  
  #change FRL into indicator variable
  rename(lunchstatus='Lunch Status') %>%
  mutate(frl_indicator=case_when(
    lunchstatus == 'Not Eligible' ~ 0,
    lunchstatus == 'F/R Lunch' ~ 1)) %>%
  
  #create an indicator variable for counting total population
  mutate(enroll_indicator=case_when(
    !is.na(GradeName) ~ 1)) %>%

  #sum by tribal area
  group_by(tribalarea) %>%
  summarise(frl_number=sum(frl_indicator),
            totalenroll=sum(enroll_indicator)) %>%
  ungroup %>%
  
  #create percent
  mutate(frl_percent=frl_number/totalenroll) %>%
  
  #add in locationtype
  rename(location=tribalarea) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='Tribal Area')
  
  
######################## 
#combine all geographies
frl_all <- frl_county %>%
  bind_rows(frl_state) %>%
  bind_rows(frl_region) %>%
  bind_rows(frl_tribal) %>%
  
  mutate(state='North Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(varname='freereducedlunch') %>%
  
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId) %>%
  
  #create indicators to suppress data

  #supress if denominator is less than 10
  mutate(suppress_denominator=if_else(totalenroll<10 | is.na(totalenroll),1,0)) %>%
 
  #suppress percentages of 0-1 if more than 300 in denominator
  mutate(suppress_0to1_300=if_else(totalenroll>300 & frl_percent<=.01,1,0)) %>%
  #suppress percentages of 99-100 if more than 300 in denominator
  mutate(suppress_99to100_300=if_else(totalenroll>300 & frl_percent>=.99,1,0)) %>%

  
  #suppress percentages of 0-2 if between 101 to 300 in denominator
  mutate(suppress_0to2_101=if_else((totalenroll>100 & totalenroll<=300) & 
                                     frl_percent<=0.02,1,0)) %>%
  #suppress percentages of 98-100 if between 101 to 300 in denominator
  mutate(suppress_98to100_101=if_else((totalenroll>100 & totalenroll<=300) & 
                                     frl_percent>=0.98,1,0)) %>%
  
  #suppress percentages of 0-5 if between 41 to 100 in denominator
  mutate(suppress_0to5_41=if_else((totalenroll>40 & totalenroll<=100) & 
                                     frl_percent<=0.05,1,0)) %>%
  #suppress percentages of 95-100 if between 41 to 100 in denominator
  mutate(suppress_95to100_41=if_else((totalenroll>40 & totalenroll<=100) & 
                                     frl_percent>=0.95,1,0)) %>%
  
  #suppress percentages of 0-10 if between 21 to 40 in denominator
  mutate(suppress_0to10_21=if_else((totalenroll>20 & totalenroll<=40) & 
                                     frl_percent<=0.10,1,0)) %>%
  #suppress percentages of 90-100 if between 21 to 40 in denominator
  mutate(suppress_90to100_21=if_else((totalenroll>20 & totalenroll<=40) & 
                                     frl_percent>=0.90,1,0)) %>%
  
  #suppress percentages of 0-20 if between 10 to 20 in denominator
  mutate(suppress_0to20_10=if_else((totalenroll>=10 & totalenroll<=20) & 
                                     frl_percent<=0.20,1,0)) %>%
  #suppress percentages of 80-100 if between 10 to 20 in denominator
  mutate(suppress_80to100_10=if_else((totalenroll>=10 & totalenroll<=20) & 
                                     frl_percent>=0.80,1,0)) %>%
  
  #create updated percent and number based on suppression rules
  mutate(frl_percent=as.character(paste(frl_percent))) %>%
  mutate(frl_percent_suppressed=case_when(
    suppress_denominator==1 ~ 'NA',
    suppress_0to1_300==1 ~ "<= 1%",
    suppress_99to100_300==1 ~ ">= 99%",
    suppress_0to2_101==1 ~ "<= 2%",
    suppress_98to100_101==1 ~ ">= 98%",
    suppress_0to5_41==1 ~ "<= 5%",
    suppress_95to100_41==1 ~ ">= 95%",
    suppress_0to10_21==1 ~ "<= 10%",
    suppress_90to100_21==1 ~ ">= 90%",
    suppress_0to20_10==1 ~ "<= 20%",
    suppress_80to100_10==1 ~ ">= 80%",
    suppress_denominator==0 & suppress_0to1_300==0 & suppress_99to100_300==0 & 
      suppress_0to2_101==0 & suppress_98to100_101==0 & 
      suppress_0to5_41==0 & suppress_95to100_41==0 & 
      suppress_0to10_21==0 & suppress_90to100_21==0 & 
      suppress_0to20_10==0 & suppress_80to100_10==0 ~ frl_percent)) %>%
  
  mutate(frl_number=as.character(paste(frl_number))) %>%
  mutate(frl_number_suppressed=case_when(
    suppress_denominator==1 | suppress_0to1_300==1 | suppress_99to100_300==1 | 
    suppress_0to2_101==1 |  suppress_98to100_101==1 |  suppress_0to5_41==1 | 
    suppress_95to100_41==1 | suppress_0to10_21==1 | suppress_90to100_21==1 | 
    suppress_0to20_10==1 |   suppress_80to100_10==1 ~ 'NA',
    suppress_denominator==0 & suppress_0to1_300==0 & suppress_99to100_300==0 & 
      suppress_0to2_101==0 & suppress_98to100_101==0 & 
      suppress_0to5_41==0 & suppress_95to100_41==0 & 
      suppress_0to10_21==0 & suppress_90to100_21==0 & 
      suppress_0to20_10==0 & suppress_80to100_10==0 ~ frl_number)) %>%
  
  select(c(location,locationtype,locationid,state,timeframe,varname,frl_number_suppressed,frl_percent_suppressed)) %>%
  
  #change from wide to long
  rename(Number=frl_number_suppressed,
         Percent=frl_percent_suppressed) %>%
  pivot_longer(cols=c(Number,Percent),names_to='dataformat',values_to='data')
  


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(frl_all$locationid))>=1) {
  print(frl_all$location[is.na(frl_all$locationid)])
} else if (sum(is.na(frl_all$locationid))==0) {
  'all locations match'
}

# 2. Output cases where percent data is greater than 1
temp_percheck <- frl_all %>%
  subset(dataformat=='Percent' & data>1 & is.na(data))
temp_rows <- as.numeric(nrow(temp_percheck))

if (temp_rows==0) {
  'no percents greater than 1'
} else if (temp_rows>=1) {
  print(temp_percheck)
}


#3. Check that there is no suppression or >1 suppression
########## MANUAL STEP #############
#need to check that county data cannot be identified using totals
temp_testsuppression <- frl_all %>%
  subset(locationtype=='County' & dataformat=='Number') %>%
  left_join(regionids,by=c('location'='county')) %>%
  subset(data=='NA') %>%
  select(location)

View(temp_testsuppression)

#if there is only one county, print the counties in ascending order
#temp_check <- frl_all %>%
 # subset(locationtype=='County' & dataformat=='Number') %>%
#  mutate(data=as.numeric(paste(data))) %>%
 # arrange(data)
#View(temp_check)

#******
#CHANGE TO THE CORRECT COUNTY NAME HERE
#**Choose the county with the next lowest count of births; if there is a tie, suppress both
#frl_all$data[frl_all$location=='Billings' & frl_all$dataformat=='Number'] <- 'NA'


#4. Check that there is no suppression or >1 suppression
########## MANUAL STEP #############
#need to check that county data cannot be identified using region totals
temp_testsuppression_region <- frl_all %>%
  subset(locationtype=='County') %>%
  left_join(regionids,by=c('location'='county')) %>%
  subset(data=='NA') %>%
  select(location,region)

View(temp_testsuppression_region)


# 5. Visually inspect output data
View(frl_all)

```

STEP 2: COMMIT TO DATABASE 
```{r}
#CHECK DATASET NAMED frl_all TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
dbWriteTable(con,'northdakota',frl_all,append=TRUE,row.names=FALSE)
```

STEP 3: OUTPUT DATASET FOR UPLOADING TO KC DATA CENTER
**Before uploading to Data Center, check on suppression guidelines. If only one location is suppressed, need to suppress another in order to adhere to guidelines**
```{r}
#########################
##OUTPUT DATA CENTER FILE

datacenter_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM northdakota WHERE timeframe='",fullyear,"' AND varname='freereducedlunch';")

upload_data <- dbGetQuery(con,datacenter_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/education/northdakota_",year,"_freereducedlunch.csv"),row.names=FALSE)

```




## CHILDREN AGES 3 TO 21 ENROLLED IN SPECIAL EDUCATION IN PUBLIC SCHOOLS ##
STEP 1: IMPORT AND CLEAN SPECIAL EDUCATION DATA
```{r}
#import data
specialed_data <- read_excel(paste0("/Users/xannaburg/Documents/DO NOT DELETE/ND Education/ND Kids Count 2024 Request/2-SpecialEdSnapshot.xlsx"))


############
#COUNTY DATA
specialed_county <- specialed_data %>%
  
  #convert county number to numeric for merging
  mutate(County=as.numeric(paste(County))) %>%
  
  #import county name
  left_join(countyids,by=c("County"="ndcounty_number")) %>%

  #change into indicator variable
  mutate(specialed_indicator=case_when(
    !is.na(Age) ~ 1)) %>%
  
  #remove nonpublic schools (district ID >200) 
  separate(SchoolStateIssuedID,c('county','district','school'),sep="-") %>%
  mutate(district=as.numeric(paste(district))) %>%
  subset(district<200) %>%

  
  #remove non counties
  subset(!is.na(ndcounty_name)) %>%

  #sum by county
  group_by(ndcounty_name) %>%
  summarise(specialed_number=sum(specialed_indicator)) %>%
  ungroup %>%

  #add in locationtype
  rename(location=ndcounty_name) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='County')

###########
#STATE DATA
#start with  cleaned county data
specialed_state <- specialed_county %>%
  mutate(location='North Dakota') %>%
  group_by(location) %>%
  summarise(specialed_number=sum(specialed_number)) %>%
  ungroup %>%

  #add in locationtype
  mutate(locationtype='State')

############
#REGION DATA
#start with cleaned county data
specialed_region <- specialed_county %>%
  
  #add in regions
  mutate(location=as.character(paste(location))) %>%
  left_join(regionids,by=c('location'='county')) %>%
  group_by(region) %>%
  summarise(specialed_number=sum(specialed_number)) %>%
  ungroup %>%

  
  #add in locationtype
  rename(location=region) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='Planning Region')


#################
#TRIBAL AREA DATA
specialed_tribal <- specialed_data %>%
  
  #import tribal name
  left_join(tribalschools,by=c('SchoolStateIssuedID'='id_dash')) %>%
  subset(!is.na(tribalarea)) %>%
  
  #change into indicator variable
  mutate(specialed_indicator=case_when(
    !is.na(Age) ~ 1)) %>%
  
  #remove nonpublic schools (district ID >200) 
  separate(SchoolStateIssuedID,c('county','district','school'),sep="-") %>%
  mutate(district=as.numeric(paste(district))) %>%
  subset(district<200) %>%
  #this remove students only enrolled in district if needed, TBD
  #subset(!is.na(school)) %>%


  #sum by tribal area
  group_by(tribalarea) %>%
  summarise(specialed_number=sum(specialed_indicator)) %>%
  ungroup %>%

  #add in locationtype
  rename(location=tribalarea) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='Tribal Area')
  
  
######################## 
#combine all geographies
specialed_all <- specialed_county %>%
  bind_rows(specialed_state) %>%
  bind_rows(specialed_region) %>%
  bind_rows(specialed_tribal) %>%
  
  mutate(state='North Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(varname='totalspecialeducation') %>%
  
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId)
```

STEP 2: CALCULATE DENOMINATOR FROM ENROLLMENT SNAPSHOT
```{r}
#import data
enroll_data <- read_excel(path=paste0("/Users/xannaburg/Documents/DO NOT DELETE/ND Education/ND Kids Count 2024 Request/1-InclusiveEnrollment.xlsx"),guess_max = 1048576)


############
#COUNTY DATA
enroll_county <- enroll_data %>%
  
  mutate(County=as.numeric(paste(County))) %>%
  #import county name
  left_join(countyids,by=c("County"="ndcounty_number")) %>%

  #create an indicator variable for counting total population
  mutate(enroll_indicator=case_when(
    !is.na(GradeName) ~ 1)) %>%
  
  #remove nonpublic schools (district ID >200) 
  separate(SchoolStateIssuedID,c('county','district','school'),sep="-") %>%
  mutate(district=as.numeric(paste(district))) %>%
  subset(district<200) %>%
  
  #remove non counties
  subset(!is.na(ndcounty_name)) %>%

  #sum by county
  group_by(ndcounty_name) %>%
  summarise(totalenroll=sum(enroll_indicator)) %>%
  ungroup %>%

  #add in locationtype
  rename(location=ndcounty_name) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='County')

###########
#STATE DATA
#start with  cleaned county data
enroll_state <- enroll_county %>%
  mutate(location='North Dakota') %>%
  group_by(location) %>%
  summarise(totalenroll=sum(totalenroll)) %>%
  ungroup %>%

  #add in locationtype
  mutate(locationtype='State')

############
#REGION DATA
#start with cleaned county data
enroll_region <- enroll_county %>%
  
  #add in regions
  mutate(location=as.character(paste(location))) %>%
  left_join(regionids,by=c('location'='county')) %>%
  group_by(region) %>%
  summarise(totalenroll=sum(totalenroll)) %>%
  ungroup %>%

  #add in locationtype
  rename(location=region) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='Planning Region')


#################
#TRIBAL AREA DATA
enroll_tribal <- enroll_data %>%
  
  #import tribal name
  left_join(tribalschools,by=c('SchoolStateIssuedID'='id_dash')) %>%
  subset(!is.na(tribalarea)) %>%
  
  #remove nonpublic schools (district ID >200) 
  separate(SchoolStateIssuedID,c('county','district','school'),sep="-") %>%
  mutate(district=as.numeric(paste(district))) %>%
  subset(district<200) %>%
  
  #create an indicator variable for counting total population
  mutate(enroll_indicator=case_when(
    !is.na(GradeName) ~ 1)) %>%

  #sum by tribal area
  group_by(tribalarea) %>%
  summarise(totalenroll=sum(enroll_indicator)) %>%
  ungroup %>%

  #add in locationtype
  rename(location=tribalarea) %>%
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='Tribal Area')

######################## 
#combine all geographies
enroll_all <- enroll_county %>%
  bind_rows(enroll_state) %>%
  bind_rows(enroll_region) %>%
  bind_rows(enroll_tribal) %>%
  
  mutate(state='North Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(varname='totalspecialeducation') %>%
  
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId)

```

STEP 3: COMBINE NUMERATOR AND DENOMINATOR TO CALCULATE PERCENTAGES
```{r}
specialed_enroll <- specialed_all %>%
  left_join(enroll_all,by = c("location", "locationtype", "state", "timeframe", "varname", "locationid")) %>%
  
  #calculate percent
  mutate(specialed_percent=specialed_number/totalenroll) %>%


  #create indicators to suppress data

  #supress if denominator is less than 10
  mutate(suppress_denominator=if_else(totalenroll<10 | is.na(totalenroll),1,0)) %>%
 
  #suppress percentages of 0-1 if more than 300 in denominator
  mutate(suppress_0to1_300=if_else(totalenroll>300 & specialed_percent<=.01,1,0)) %>%
  #suppress percentages of 99-100 if more than 300 in denominator
  mutate(suppress_99to100_300=if_else(totalenroll>300 & specialed_percent>=.99,1,0)) %>%

  
  #suppress percentages of 0-2 if between 101 to 300 in denominator
  mutate(suppress_0to2_101=if_else((totalenroll>100 & totalenroll<=300) & 
                                     specialed_percent<=0.02,1,0)) %>%
  #suppress percentages of 98-100 if between 101 to 300 in denominator
  mutate(suppress_98to100_101=if_else((totalenroll>100 & totalenroll<=300) & 
                                     specialed_percent>=0.98,1,0)) %>%
  
  #suppress percentages of 0-5 if between 41 to 100 in denominator
  mutate(suppress_0to5_41=if_else((totalenroll>40 & totalenroll<=100) & 
                                     specialed_percent<=0.05,1,0)) %>%
  #suppress percentages of 95-100 if between 41 to 100 in denominator
  mutate(suppress_95to100_41=if_else((totalenroll>40 & totalenroll<=100) & 
                                     specialed_percent>=0.95,1,0)) %>%
  
  #suppress percentages of 0-10 if between 21 to 40 in denominator
  mutate(suppress_0to10_21=if_else((totalenroll>20 & totalenroll<=40) & 
                                     specialed_percent<=0.10,1,0)) %>%
  #suppress percentages of 90-100 if between 21 to 40 in denominator
  mutate(suppress_90to100_21=if_else((totalenroll>20 & totalenroll<=40) & 
                                     specialed_percent>=0.90,1,0)) %>%
  
  #suppress percentages of 0-20 if between 10 to 20 in denominator
  mutate(suppress_0to20_10=if_else((totalenroll>=10 & totalenroll<=20) & 
                                     specialed_percent<=0.20,1,0)) %>%
  #suppress percentages of 80-100 if between 10 to 20 in denominator
  mutate(suppress_80to100_10=if_else((totalenroll>=10 & totalenroll<=20) & 
                                     specialed_percent>=0.80,1,0)) %>%
  
  #create updated percent and number based on suppression rules
  mutate(specialed_percent=as.character(paste(specialed_percent))) %>%
  mutate(specialed_percent_suppressed=case_when(
    suppress_denominator==1 ~ 'NA',
    suppress_0to1_300==1 ~ "<= 1%",
    suppress_99to100_300==1 ~ ">= 99%",
    suppress_0to2_101==1 ~ "<= 2%",
    suppress_98to100_101==1 ~ ">= 98%",
    suppress_0to5_41==1 ~ "<= 5%",
    suppress_95to100_41==1 ~ ">= 95%",
    suppress_0to10_21==1 ~ "<= 10%",
    suppress_90to100_21==1 ~ ">= 90%",
    suppress_0to20_10==1 ~ "<= 20%",
    suppress_80to100_10==1 ~ ">= 80%",
    suppress_denominator==0 & suppress_0to1_300==0 & suppress_99to100_300==0 & 
      suppress_0to2_101==0 & suppress_98to100_101==0 & 
      suppress_0to5_41==0 & suppress_95to100_41==0 & 
      suppress_0to10_21==0 & suppress_90to100_21==0 & 
      suppress_0to20_10==0 & suppress_80to100_10==0 ~ specialed_percent)) %>%
  
  mutate(specialed_number=as.character(paste(specialed_number))) %>%
  mutate(specialed_number_suppressed=case_when(
    suppress_denominator==1 | suppress_0to1_300==1 | suppress_99to100_300==1 | 
    suppress_0to2_101==1 |  suppress_98to100_101==1 |  suppress_0to5_41==1 | 
    suppress_95to100_41==1 | suppress_0to10_21==1 | suppress_90to100_21==1 | 
    suppress_0to20_10==1 |   suppress_80to100_10==1 ~ 'NA',
    suppress_denominator==0 & suppress_0to1_300==0 & suppress_99to100_300==0 & 
      suppress_0to2_101==0 & suppress_98to100_101==0 & 
      suppress_0to5_41==0 & suppress_95to100_41==0 & 
      suppress_0to10_21==0 & suppress_90to100_21==0 & 
      suppress_0to20_10==0 & suppress_80to100_10==0 ~ specialed_number)) %>%
  
  select(c(location,locationtype,locationid,state,timeframe,varname,specialed_number_suppressed,specialed_percent_suppressed)) %>%
  
  #change from wide to long
  rename(Number=specialed_number_suppressed,
         Percent=specialed_percent_suppressed) %>%
  pivot_longer(cols=c(Number,Percent),names_to='dataformat',values_to='data')
  


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(specialed_enroll$locationid))>=1) {
  print(specialed_enroll$location[is.na(specialed_enroll$locationid)])
} else if (sum(is.na(specialed_enroll$locationid))==0) {
  'all locations match'
}

# 2. Output cases where percent data is greater than 1
temp_percheck <- specialed_enroll %>%
  subset(dataformat=='Percent' & data>1 & is.na(data))
temp_rows <- as.numeric(nrow(temp_percheck))

if (temp_rows==0) {
  'no percents greater than 1'
} else if (temp_rows>=1) {
  print(temp_percheck)
}

#3. Check that there is no suppression or >1 suppression
########## MANUAL STEP #############
#need to check that county data cannot be identified using totals
temp_testsuppression <- specialed_enroll %>%
  subset(locationtype=='County' & dataformat=='Number') %>%
  left_join(regionids,by=c('location'='county')) %>%
  subset(data=='NA') %>%
  select(location)

View(temp_testsuppression)

#if there is only one county, print the counties in ascending order
#temp_check <- specialed_enroll %>%
  #subset(locationtype=='County' & dataformat=='Number') %>%
  #mutate(data=as.numeric(paste(data))) %>%
  #arrange(data)
#View(temp_check)

#******
#CHANGE TO THE CORRECT COUNTY NAME HERE
#**Choose the county with the next lowest count of births; if there is a tie, suppress both
#frl_all$data[specialed_enroll$location=='Billings' & specialed_enroll$dataformat=='Number'] <- 'NA'


#4. Check that there is no suppression or >1 suppression
########## MANUAL STEP #############
#need to check that county data cannot be identified using region totals
temp_testsuppression_region <- specialed_enroll %>%
  subset(locationtype=='County') %>%
  left_join(regionids,by=c('location'='county')) %>%
  subset(data=='NA') %>%
  select(location,region)

View(temp_testsuppression_region)

# 5. Visually inspect output data
View(specialed_enroll)
```

STEP 4: COMMIT TO DATABASE 
```{r}
#CHECK DATASET NAMED specialed_enroll TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
dbWriteTable(con,'northdakota',specialed_enroll,append=TRUE,row.names=FALSE)
```

STEP 5: OUTPUT DATASET FOR UPLOADING TO KC DATA CENTER
```{r}
#########################
##OUTPUT DATA CENTER FILE

datacenter_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM northdakota WHERE timeframe='",fullyear,"' AND varname='totalspecialeducation';")

upload_data <- dbGetQuery(con,datacenter_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/education/northdakota_",year,"_totalspecialeducation.csv"),row.names=FALSE)

```





## CHILDREN ENROLLED IN SPECIAL EDUCATION IN PUBLIC SCHOOLS BY AGE  (PERCENT OF SPECIAL EDUCATION ENROLLMENT) ##

*Total children ages 3 to 21 enrolled in special education (above) must have already been calculated before running this code. That indicator is used as a denominator*

STEP 1: IMPORT AND CLEAN SPECIAL EDUCATION DATA
```{r}
#import data
specialed_data <- read_excel(paste0("/Users/xannaburg/Documents/DO NOT DELETE/ND Education/ND Kids Count 2024 Request/2-SpecialEdSnapshot.xlsx")) 


############
#STATE DATA
specialed_age_state <- specialed_data %>%
  
  mutate(location='North Dakota') %>%

  #change age into categories
  mutate(age_group=case_when(
    Age>=3 & Age<=5 ~ '3 to 5',
    Age>=6 & Age <=11 ~ '6 to 11',
    Age>=12 & Age<=17 ~ '12 to 17',
    Age>=18 & Age<=21 ~ '18 to 21')) %>%
  
  #change into indicator variable
  mutate(specialed_indicator=case_when(
  !is.na(Age) ~ 1)) %>%
  
  #remove nonpublic schools (district ID >200) 
  separate(SchoolStateIssuedID,c('county','district','school'),sep="-") %>%
  mutate(district=as.numeric(paste(district))) %>%
  subset(district<200) %>%
  

  #sums
  group_by(location,age_group) %>%
  summarise(specialed_number=sum(specialed_indicator,na.rm=TRUE)) %>%
  ungroup %>%

  #add in locationtype
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='State') %>%

  mutate(state='North Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(varname='totalspecialeducationbyage') %>%
  
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId)
```

STEP 2: IMPORT DATA FOR TOTAL SPECIAL EDUCATION ENROLLMENT FROM DATABASE
```{r}
enroll_specialed_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM northdakota WHERE timeframe='",fullyear,"' AND varname='totalspecialeducation' AND dataformat='Number' AND locationtype='State';")

enroll_specialed <- dbGetQuery(con,enroll_specialed_sql) %>%
  rename(totalenroll=data)


#merge total special education enrollment and by age data
specialed_age_enroll <- specialed_age_state %>%
  left_join(enroll_specialed,by = c("location", "timeframe", "locationid")) %>%
  
  #calculate percent
  mutate(totalenroll=as.numeric(paste(totalenroll))) %>%
  mutate(specialed_percent=specialed_number/totalenroll) %>%
  
  #create indicators to suppress data

  #supress if denominator is less than 10
  mutate(suppress_denominator=if_else(totalenroll<10 | is.na(totalenroll),1,0)) %>%
 
  #suppress percentages of 0-1 if more than 300 in denominator
  mutate(suppress_0to1_300=if_else(totalenroll>300 & specialed_percent<=.01,1,0)) %>%
  #suppress percentages of 99-100 if more than 300 in denominator
  mutate(suppress_99to100_300=if_else(totalenroll>300 & specialed_percent>=.99,1,0)) %>%

  
  #suppress percentages of 0-2 if between 101 to 300 in denominator
  mutate(suppress_0to2_101=if_else((totalenroll>100 & totalenroll<=300) & 
                                     specialed_percent<=0.02,1,0)) %>%
  #suppress percentages of 98-100 if between 101 to 300 in denominator
  mutate(suppress_98to100_101=if_else((totalenroll>100 & totalenroll<=300) & 
                                     specialed_percent>=0.98,1,0)) %>%
  
  #suppress percentages of 0-5 if between 41 to 100 in denominator
  mutate(suppress_0to5_41=if_else((totalenroll>40 & totalenroll<=100) & 
                                     specialed_percent<=0.05,1,0)) %>%
  #suppress percentages of 95-100 if between 41 to 100 in denominator
  mutate(suppress_95to100_41=if_else((totalenroll>40 & totalenroll<=100) & 
                                     specialed_percent>=0.95,1,0)) %>%
  
  #suppress percentages of 0-10 if between 21 to 40 in denominator
  mutate(suppress_0to10_21=if_else((totalenroll>20 & totalenroll<=40) & 
                                     specialed_percent<=0.10,1,0)) %>%
  #suppress percentages of 90-100 if between 21 to 40 in denominator
  mutate(suppress_90to100_21=if_else((totalenroll>20 & totalenroll<=40) & 
                                     specialed_percent>=0.90,1,0)) %>%
  
  #suppress percentages of 0-20 if between 10 to 20 in denominator
  mutate(suppress_0to20_10=if_else((totalenroll>=10 & totalenroll<=20) & 
                                     specialed_percent<=0.20,1,0)) %>%
  #suppress percentages of 80-100 if between 10 to 20 in denominator
  mutate(suppress_80to100_10=if_else((totalenroll>=10 & totalenroll<=20) & 
                                     specialed_percent>=0.80,1,0)) %>%
  
  #create updated percent and number based on suppression rules
  mutate(specialed_percent=as.character(paste(specialed_percent))) %>%
  mutate(specialed_percent_suppressed=case_when(
    suppress_denominator==1 ~ 'NA',
    suppress_0to1_300==1 ~ "<= 1%",
    suppress_99to100_300==1 ~ ">= 99%",
    suppress_0to2_101==1 ~ "<= 2%",
    suppress_98to100_101==1 ~ ">= 98%",
    suppress_0to5_41==1 ~ "<= 5%",
    suppress_95to100_41==1 ~ ">= 95%",
    suppress_0to10_21==1 ~ "<= 10%",
    suppress_90to100_21==1 ~ ">= 90%",
    suppress_0to20_10==1 ~ "<= 20%",
    suppress_80to100_10==1 ~ ">= 80%",
    suppress_denominator==0 & suppress_0to1_300==0 & suppress_99to100_300==0 & 
      suppress_0to2_101==0 & suppress_98to100_101==0 & 
      suppress_0to5_41==0 & suppress_95to100_41==0 & 
      suppress_0to10_21==0 & suppress_90to100_21==0 & 
      suppress_0to20_10==0 & suppress_80to100_10==0 ~ specialed_percent)) %>%
  
  mutate(specialed_number=as.character(paste(specialed_number))) %>%
  mutate(specialed_number_suppressed=case_when(
    suppress_denominator==1 | suppress_0to1_300==1 | suppress_99to100_300==1 | 
    suppress_0to2_101==1 |  suppress_98to100_101==1 |  suppress_0to5_41==1 | 
    suppress_95to100_41==1 | suppress_0to10_21==1 | suppress_90to100_21==1 | 
    suppress_0to20_10==1 |   suppress_80to100_10==1 ~ 'NA',
    suppress_denominator==0 & suppress_0to1_300==0 & suppress_99to100_300==0 & 
      suppress_0to2_101==0 & suppress_98to100_101==0 & 
      suppress_0to5_41==0 & suppress_95to100_41==0 & 
      suppress_0to10_21==0 & suppress_90to100_21==0 & 
      suppress_0to20_10==0 & suppress_80to100_10==0 ~ specialed_number)) %>%
  
  select(c(location,locationtype,locationid,state,timeframe,varname,age_group,specialed_number_suppressed,specialed_percent_suppressed)) %>%
  
  #change from wide to long
  rename(Number=specialed_number_suppressed,
         Percent=specialed_percent_suppressed) %>%
  pivot_longer(cols=c(Number,Percent),names_to='dataformat',values_to='data')
  


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(specialed_age_enroll$locationid))>=1) {
  print(specialed_age_enroll$location[is.na(specialed_age_enroll$locationid)])
} else if (sum(is.na(specialed_age_enroll$locationid))==0) {
  'all locations match'
}

# 2. Output cases where percent data is greater than 1
temp_percheck <- specialed_age_enroll %>%
  subset(dataformat=='Percent' & data>1 & is.na(data))
temp_rows <- as.numeric(nrow(temp_percheck))

if (temp_rows==0) {
  'no percents greater than 1'
} else if (temp_rows>=1) {
  print(temp_percheck)
}

# 3. Visually inspect output data
View(specialed_age_enroll)
```

STEP 3: COMMIT TO DATABASE 
```{r}
#CHECK DATASET NAMED specialed_age_enroll TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
dbWriteTable(con,'northdakota',specialed_age_enroll,append=TRUE,row.names=FALSE)
```

STEP 4: OUTPUT DATASET FOR UPLOADING TO KC DATA CENTER
```{r}
#########################
##OUTPUT DATA CENTER FILE

datacenter_sql <- paste0("SELECT locationid, location, timeframe, dataformat, age_group, data FROM northdakota WHERE timeframe='",fullyear,"' AND varname='totalspecialeducationbyage';")

upload_data <- dbGetQuery(con,datacenter_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data,
         'Age group'=age_group)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/education/northdakota_",year,"_totalspecialeducationbyage.csv"),row.names=FALSE)

```




## CHILDREN ENROLLED IN SPECIAL EDUCATION IN PUBLIC SCHOOLS BY TYPE OF IMPAIRMENT (PERCENT OF SPECIAL EDUCATION ENROLLMENT)  ##
*Total children ages 3 to 21 enrolled in special education (above) must have already been calculated before running this code. That indicator is used as a denominator*

STEP 1: IMPORT AND CLEAN SPECIAL EDUCATION DATA
```{r}
#import data
specialed_data <- read_excel(paste0("/Users/xannaburg/Documents/DO NOT DELETE/ND Education/ND Kids Count 2024 Request/2-SpecialEdSnapshot.xlsx"))


############
#STATE DATA
specialed_type_state <- specialed_data %>%
  
  mutate(location='North Dakota') %>%

  #change age into categories
  mutate(category=case_when(
    PrimaryDisabilityDesc=='Autism'  ~ 'Autism',
    PrimaryDisabilityDesc=='Emotional Disturbance' ~ 'Emotionally Disturbed',
    PrimaryDisabilityDesc=='Speech/Language Impairments' ~ 'Speech or Language Impaired',
    PrimaryDisabilityDesc=='Intellectual Disability' ~ 'Intellectual Disability',
    PrimaryDisabilityDesc=='Specific Learning Disabilities' ~ 'Specific Learning Disability')) %>%
  
  #change into indicator variable
  mutate(specialed_indicator=case_when(
  !is.na(Age) ~ 1)) %>%
  
  #remove nonpublic schools (district ID >200) 
  separate(SchoolStateIssuedID,c('county','district','school'),sep="-") %>%
  mutate(district=as.numeric(paste(district))) %>%
  subset(district<200) %>%
  
  #sums
  group_by(location,category) %>%
  summarise(specialed_number=sum(specialed_indicator,na.rm=TRUE)) %>%
  ungroup %>%
  
  subset(!is.na(category)) %>%

  #add in locationtype
  mutate(location=as.character(paste(location))) %>%
  mutate(locationtype='State') %>%

  mutate(state='North Dakota') %>%
  mutate(timeframe=fullyear) %>%
  mutate(varname='totalspecialeducationbyimpairment') %>%
  
  left_join(locationids,by=c('location'='Location')) %>%
  rename(locationid=LocationId)
```

STEP 2: IMPORT DATA FOR TOTAL SPECIAL EDUCATION ENROLLMENT FROM DATABASE
```{r}
enroll_specialed_sql <- paste0("SELECT locationid, location, timeframe, dataformat, data FROM northdakota WHERE timeframe='",fullyear,"' AND varname='totalspecialeducation' AND dataformat='Number' AND locationtype='State';")

enroll_specialed <- dbGetQuery(con,enroll_specialed_sql) %>%
  rename(totalenroll=data)


#merge total special education enrollment and by age data
specialed_type_enroll <- specialed_type_state %>%
  left_join(enroll_specialed,by = c("location", "timeframe", "locationid")) %>%
  
  #calculate percent
  mutate(totalenroll=as.numeric(paste(totalenroll))) %>%
  mutate(specialed_percent=specialed_number/totalenroll) %>%
  
  #create indicators to suppress data

  #supress if denominator is less than 10
  mutate(suppress_denominator=if_else(totalenroll<10 | is.na(totalenroll),1,0)) %>%
 
  #suppress percentages of 0-1 if more than 300 in denominator
  mutate(suppress_0to1_300=if_else(totalenroll>300 & specialed_percent<=.01,1,0)) %>%
  #suppress percentages of 99-100 if more than 300 in denominator
  mutate(suppress_99to100_300=if_else(totalenroll>300 & specialed_percent>=.99,1,0)) %>%

  
  #suppress percentages of 0-2 if between 101 to 300 in denominator
  mutate(suppress_0to2_101=if_else((totalenroll>100 & totalenroll<=300) & 
                                     specialed_percent<=0.02,1,0)) %>%
  #suppress percentages of 98-100 if between 101 to 300 in denominator
  mutate(suppress_98to100_101=if_else((totalenroll>100 & totalenroll<=300) & 
                                     specialed_percent>=0.98,1,0)) %>%
  
  #suppress percentages of 0-5 if between 41 to 100 in denominator
  mutate(suppress_0to5_41=if_else((totalenroll>40 & totalenroll<=100) & 
                                     specialed_percent<=0.05,1,0)) %>%
  #suppress percentages of 95-100 if between 41 to 100 in denominator
  mutate(suppress_95to100_41=if_else((totalenroll>40 & totalenroll<=100) & 
                                     specialed_percent>=0.95,1,0)) %>%
  
  #suppress percentages of 0-10 if between 21 to 40 in denominator
  mutate(suppress_0to10_21=if_else((totalenroll>20 & totalenroll<=40) & 
                                     specialed_percent<=0.10,1,0)) %>%
  #suppress percentages of 90-100 if between 21 to 40 in denominator
  mutate(suppress_90to100_21=if_else((totalenroll>20 & totalenroll<=40) & 
                                     specialed_percent>=0.90,1,0)) %>%
  
  #suppress percentages of 0-20 if between 10 to 20 in denominator
  mutate(suppress_0to20_10=if_else((totalenroll>=10 & totalenroll<=20) & 
                                     specialed_percent<=0.20,1,0)) %>%
  #suppress percentages of 80-100 if between 10 to 20 in denominator
  mutate(suppress_80to100_10=if_else((totalenroll>=10 & totalenroll<=20) & 
                                     specialed_percent>=0.80,1,0)) %>%
  
  #create updated percent and number based on suppression rules
  mutate(specialed_percent=as.character(paste(specialed_percent))) %>%
  mutate(specialed_percent_suppressed=case_when(
    suppress_denominator==1 ~ 'NA',
    suppress_0to1_300==1 ~ "<= 1%",
    suppress_99to100_300==1 ~ ">= 99%",
    suppress_0to2_101==1 ~ "<= 2%",
    suppress_98to100_101==1 ~ ">= 98%",
    suppress_0to5_41==1 ~ "<= 5%",
    suppress_95to100_41==1 ~ ">= 95%",
    suppress_0to10_21==1 ~ "<= 10%",
    suppress_90to100_21==1 ~ ">= 90%",
    suppress_0to20_10==1 ~ "<= 20%",
    suppress_80to100_10==1 ~ ">= 80%",
    suppress_denominator==0 & suppress_0to1_300==0 & suppress_99to100_300==0 & 
      suppress_0to2_101==0 & suppress_98to100_101==0 & 
      suppress_0to5_41==0 & suppress_95to100_41==0 & 
      suppress_0to10_21==0 & suppress_90to100_21==0 & 
      suppress_0to20_10==0 & suppress_80to100_10==0 ~ specialed_percent)) %>%
  
  mutate(specialed_number=as.character(paste(specialed_number))) %>%
  mutate(specialed_number_suppressed=case_when(
    suppress_denominator==1 | suppress_0to1_300==1 | suppress_99to100_300==1 | 
    suppress_0to2_101==1 |  suppress_98to100_101==1 |  suppress_0to5_41==1 | 
    suppress_95to100_41==1 | suppress_0to10_21==1 | suppress_90to100_21==1 | 
    suppress_0to20_10==1 |   suppress_80to100_10==1 ~ 'NA',
    suppress_denominator==0 & suppress_0to1_300==0 & suppress_99to100_300==0 & 
      suppress_0to2_101==0 & suppress_98to100_101==0 & 
      suppress_0to5_41==0 & suppress_95to100_41==0 & 
      suppress_0to10_21==0 & suppress_90to100_21==0 & 
      suppress_0to20_10==0 & suppress_80to100_10==0 ~ specialed_number)) %>%
  
  select(c(location,locationtype,locationid,state,timeframe,varname,category,specialed_number_suppressed,specialed_percent_suppressed)) %>%
  
  #change from wide to long
  rename(Number=specialed_number_suppressed,
         Percent=specialed_percent_suppressed) %>%
  pivot_longer(cols=c(Number,Percent),names_to='dataformat',values_to='data')
  


####################
####################
#DATA QUALITY CHECKS
### Before moving forward, check the output log for errors in addition to checking specifically for these quality checks

# 1. Print name of location that has a mismatched location ID
if (sum(is.na(specialed_type_enroll$locationid))>=1) {
  print(specialed_type_enroll$location[is.na(specialed_type_enroll$locationid)])
} else if (sum(is.na(specialed_type_enroll$locationid))==0) {
  'all locations match'
}

# 2. Output cases where percent data is greater than 1
temp_percheck <- specialed_type_enroll %>%
  subset(dataformat=='Percent' & data>1 & is.na(data))
temp_rows <- as.numeric(nrow(temp_percheck))

if (temp_rows==0) {
  'no percents greater than 1'
} else if (temp_rows>=1) {
  print(temp_percheck)
}

# 3. Visually inspect output data
View(specialed_type_enroll)
```

STEP 3: COMMIT TO DATABASE 
```{r}
#CHECK DATASET NAMED specialed_type_enroll TO VERIFY DATA ISN'T MISSING AND APPEARS CORRECT
#this code adds kids count data to MBPC postgres database
#run postgres code (separate file) first
dbWriteTable(con,'northdakota',specialed_type_enroll,append=TRUE,row.names=FALSE)
```

STEP 4: OUTPUT DATASET FOR UPLOADING TO KC DATA CENTER
```{r}
#########################
##OUTPUT DATA CENTER FILE

datacenter_sql <- paste0("SELECT locationid, location, timeframe, dataformat, category, data FROM northdakota WHERE timeframe='",fullyear,"' AND varname='totalspecialeducationbyimpairment';")

upload_data <- dbGetQuery(con,datacenter_sql) %>%
  rename(LocationId=locationid,
         Location=location,
         TimeFrame=timeframe,
         DataFormat=dataformat,
         Data=data,
         Category=category)

#SAVE OUTPUT DATASET TO UPLOAD TO DATA CENTER
write.csv(upload_data,file=paste0("./Output/education/northdakota_",year,"_totalspecialeducationbyimpairment.csv"),row.names=FALSE)

```



